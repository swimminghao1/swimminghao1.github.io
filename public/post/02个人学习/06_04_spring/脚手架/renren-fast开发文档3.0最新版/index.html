<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>renren-fast开发文档3.0最新版 | swimminghao</title><meta name=keywords content="SpringBoot,脚手架"><meta name=description content="renren-fast开发文档3.0最新版 版权说明 本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述"><meta name=author content="swimminghao"><link rel=canonical href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/><meta name=yandex-verification content="73b1a797f62c0e98"><meta name=baidu-site-verification content="code-gnOrbP1RyC"><meta name=baidu_union_verify content="4c552c344295cb984c46ebe74962b067"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/satouriko/LxgwWenKai_Webfonts@v1.101/dist/LXGWWenKai-Light.css><link crossorigin=anonymous href=/assets/css/stylesheet.min.0a5d9aa21e56d0b7d41b1d4b56af0b911caf526faf5060a8d3717579bf27cb93.css integrity="sha256-Cl2aoh5W0LfUGx1LVq8LkRyvUm+vUGCo03F1eb8ny5M=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://swimminghao1.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://swimminghao1.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://swimminghao1.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://swimminghao1.github.io/apple-touch-icon.png><link rel=mask-icon href=https://swimminghao1.github.io/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.97.0"><link rel=manifest href=/manifest.json><script type=text/javascript>function downloadJSAtOnload(){var e=document.createElement("script");e.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7296634171837358",document.body.appendChild(e)}window.addEventListener?window.addEventListener("load",downloadJSAtOnload,!1):window.attachEvent?window.attachEvent("onload",downloadJSAtOnload):window.onload=downloadJSAtOnload</script><script async defer data-website-id=3d947a98-2774-46b0-805f-fe2e4877a1d7 src=https://umami.frytea.com/umami.js></script>
<script async src=https://swimminghao1.github.io/js/busuanzi.pure.mini.js></script>
<link rel=stylesheet href=/libs/font-awesome-4.7.0/css/font-awesome.min.css><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=https://swimminghao1.github.io/js/mermaid.min.js crossorigin=anonymous></script>
<script>const config={startOnLoad:!0,theme:"forest",themeVariables:{lineColor:"#fafafa"},flowchart:{useMaxWidth:!1,htmlLabels:!0}};mermaid.initialize(config),window.onload=()=>{window.mermaid.init(void 0,document.querySelectorAll(".language-mermaid"))}</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?c49e2f5be5e009382be07455c33b1394",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-136094326-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="renren-fast开发文档3.0最新版"><meta property="og:description" content="renren-fast开发文档3.0最新版 版权说明 本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述"><meta property="og:type" content="article"><meta property="og:url" content="https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/"><meta property="og:image" content="https://swimminghao1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-03-16T10:05:00+00:00"><meta property="article:modified_time" content="2022-03-16T10:05:00+00:00"><meta property="og:site_name" content="swimminghao"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://swimminghao1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="renren-fast开发文档3.0最新版"><meta name=twitter:description content="renren-fast开发文档3.0最新版 版权说明 本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://swimminghao1.github.io/post/"},{"@type":"ListItem","position":2,"name":"renren-fast开发文档3.0最新版","item":"https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"renren-fast开发文档3.0最新版","name":"renren-fast开发文档3.0最新版","description":"renren-fast开发文档3.0最新版 版权说明 本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述","keywords":["SpringBoot","脚手架"],"articleBody":"renren-fast开发文档3.0最新版 版权说明  本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述的内容受有关法律的版权保护，对本文档以任何形式的非法复制、泄露或散布到网络提供下载，都将导致相应的法律责任。\n 免责声明  本文档仅提供阶段性信息，所含内容可根据项目的实际情况随时更新，以人人开源社区公告为准。如因文档使用不当造成的直接或间接损失，人人开源不承担任何责任。\n 文档更新  本文档由人人开源于 2019 年 03 月 01 日最后修订。\n 第 1 章 项目介绍  人人权限系统是一套轻量级的权限系统，主要包括用户管理、角色管理、部门管理、菜单管理、定时任务、 参数管理、字典管理、文件上传、登录日志、操作日志、异常日志、文章管理、APP模块等功能。其中，还拥有多数据源、数据权限、国际化支持、Redis缓存动态开启与关闭、统一异常处理等技术特点。\n 1.1 项目描述 1.2 项目特点 1.3 数据交互 1.4 开发环境搭建 1.5 获取帮助 1.1 项目描述 renren-fast是一套轻量级的权限系统，主要包括用户管理、角色管理、菜单管理、定时任务、文件上传、系 统日志、APP模块等功能。其中，还拥有多数据源、Redis缓存动态开启与关闭、统一异常处理等技术特 点。\n1.2 项目特点  renren-fast采用SpringBoot 2.1、MyBatis、Shiro框架，开发的一套权限系统，极低门槛，拿来即用。设 计之初，就非常注重安全性，为企业系统保驾护航，让一切都变得如此简单。 灵活的权限控制，可控制到页面或按钮，满足绝大部分的权限需求 完善的 XSS 防范及脚本过滤，彻底杜绝 XSS 攻击 支持MySQL、Oracle、SQL Server、PostgreSQL等主流数据库   推荐使用阿里云服务器部署项目，免费领取阿里云优惠券，请点击【免费领取】\n1.3 数据交互  一般情况下，web项目都是通过session进行认证，每次请求数据时，都会把jsessionid放在cookie中，以便与服务端保持会话 本项目是前后端分离的，通过token进行认证（登录时，生成唯一的token凭证），每次请求数据时，都会把token放在header中，服务端解析token，并确定用户身份及用户权限，数据通过json交互 数据交互流程，如下所示：  1.4 开发环境搭建 1.4.1 软件需求  JDK 1.8+ Maven 3.0+ MySQL 5.5+ Oracle 11g+ SQL Server 2012+ PostgreSQL 9.4+  1.4.2 下载源码  通过 git ，下载renren-fast源码，如下：  git clone https://gitee.com/renrenio/renren-fast.git 1.4.3 IDEA 开发工具  IDEA打开项目， File - Open 如下图：  1.4.4 Eclipse 开发工具  Eclipse导入项目，如下图：  1.4.5 创建数据库  创建数据库 renren_fast ，数据库编码为UTF-8  CREATE DATABASE renren_fast CHARACTER SET utf8 COLLATE utf8_general_ci;  执行 db/mysql.sql 文件，初始化数据（默认支持MySQL）  1.4.6 修改配置文件  修改 application-dev.yml ，更新MySQL账号和密码 运行 io.renren.RenrenApplication.java 的 main 方法，则可启动项目 Swagger路径：http://localhost:8080/renren-fast/swagger/index.html Swagger注解路径：http://localhost:8080/renren-fast/swagger-ui.html  1.4.7 前端部署  renren-fast-vue基于vue、element-ui构建开发，实现renren-fast后台管理前端功能，提供一套更优的前端解决方案。 欢迎star或fork前端Git库，方便日后寻找，及二次开发\n  开发环境，需要安装node8.x最新版  # 克隆项目 git clone https://gitee.com/renrenio/renren-fast-vue.git # 安装依赖 npm install --registry=https://registry.npm.taobao.org # 启动服务 npm run dev  生产环境，打包并把dist目录文件，部署到Nginx里  #构建生产环境(默认) npm run build # 构建测试环境 npm run build --qa # 构建验收环境 npm run build --uat # 构建生产环境 npm run build --prod # 安装Nginx，并配置Nginx server { \tlisten 80; \tserver_name localhost; \tlocation / { \troot E:\\\\renren-fast-vue; \tindex index.html index.htm; \t} } # 启动Nginx后，访问如下路径即可 http://localhost  登录的账号密码：admin/admin  1.5 获取帮助   后端地址：https://gitee.com/renrenio/renren-fast\n  前端地址：https://github.com/renrenio/renren-fast-vue\n  代码生成器：https://gitee.com/renrenio/renren-generator\n  官方社区：https://www.renren.io/community\n  如需寻求帮助、项目建议、技术讨论等，请移步到官方社区，我会在第一时间进行解答或回复 如需关注项目最新动态，请Watch、Star项目，同时也是对项目最好的支持\n  第 2 章 数据库支持 2.1 MySQL 数据库支持 2.2 Oracle 数据库支持 2.3 SQL Server 数据库支持 2.4 PostgreSQL 数据库支持 2.1 MySQL 数据库支持  修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：  spring:  datasource:  druid:  driver-class-name: com.mysql.jdbc.Driver  url: jdbc:mysql://localhost:3306/renren_fast?allowMultiQueries=true\u0026useUnicode=true\u0026characterEncoding=UTF-8\u0026useSSL=false  username: root  password: 123456 执行db/mysql.sql，创建表及初始化数据，再启动项目即可  2.2 Oracle 数据库支持  修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：  spring:  datasource:  druid:  driver-class-name: oracle.jdbc.OracleDriver  url: jdbc:oracle:thin:@192.168.10.10:1521:renren  username: renren_fast  password: 123456 执行db/oracle.sql，创建表及初始化数据，再启动项目即可  2.3 SQL Server 数据库支持  修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：  spring:  datasource:  druid:  driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver  url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast  username: sa  password: 123456 执行db/sqlserver.sql，创建表及初始化数据，再启动项目即可  2.4 PostgreSQL 数据库支持  修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：  spring:  datasource:  druid:  driver-class-name: org.postgresql.Driver  url: jdbc:postgresql://192.168.10.10:5432/renren_fast  username: renren  password: 123456 修改quartz配置信息，quartz配置文件 ScheduleConfig.java ，打开注释，如下所示：  //PostgreSQL数据库，需要打开此注释 prop.put(\"org.quartz.jobStore.driverDelegateClass\", \"org.quartz.impl.jdbcjobstore.PostgreSQLD elegate\"); 执行db/postgresql.sql，创建表及初始化数据，再启动项目即可  第 3 章 多数据源支持 3.1 多数据源配置 3.2 多数据源使用 3.3 源码讲解 3.1 多数据源配置  多数据源的应用场景，主要针对跨多个数据库实例的情况，如果是同实例中的多个数据库，则没必要使用多数据源。\n #下面演示单实例，多数据库的使用情况 select * from db.table; #其中，db为数据库名，table为数据库表名  配置多数据源，如果是开发环境，则修改 application-dev.xml ，如下所示  多数据源的配置 dynamic:  datasource:  slave1:  driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver  url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast  username: sa  password: 123456  slave2:  driver-class-name: org.postgresql.Driver  url: jdbc:postgresql://192.168.10.10:5432/renren_fast  username: postgres  password: 123456 3.2 多数据源使用  多数据源的使用，只需在Service类、方法上添加@DataSource(\"\")注解即可，比如在类上添加了 @DataSource(“userDB”)注解，则表示该Service方法里的所有CURD，都会在 userDB 数据源里执行。\n  多数据源注解使用规则  支持在Service类或方法上，添加多数据源的注解@DataSource 在Service类上添加了@DataSource注解，则该类下的所有方法，都会使用@DataSource标注的数据源 在Service类、方法上都添加了@DataSource注解，则方法上的注解会覆盖Service类上的注解   编写DynamicDataSourceTestService.java，测试多数据源及事物  package io.renren.service;  import io.renren.commons.dynamic.datasource.annotation.DataSource; import io.renren.dao.SysUserDao; import io.renren.entity.SysUserEntity; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Service; import org.springframework.transaction.annotation.Transactional;  /** * 测试多数据源 * * @author Mark sunlightcs@gmail.com */ @Service //@DataSource(\"slave1\") 多数据源全局配置 public class DynamicDataSourceTestService {  @Autowired  private SysUserDao sysUserDao;   @Transactional  public void updateUser(Long id) {  SysUserEntity user = new SysUserEntity();  user.setUserId(id);  user.setMobile(\"13500000000\");  sysUserDao.updateById(user);  }   @Transactional  @DataSource(\"slave1\")  public void updateUserBySlave1(Long id) {  SysUserEntity user = new SysUserEntity();  user.setUserId(id);  user.setMobile(\"13500000001\");  sysUserDao.updateById(user);  }   @DataSource(\"slave2\")  @Transactional  public void updateUserBySlave2(Long id) {  SysUserEntity user = new SysUserEntity();  user.setUserId(id);  user.setMobile(\"13500000002\");  sysUserDao.updateById(user);  //测试事物  int i = 1 / 0;  } } 运行测试类DynamicDataSourceTest.java，即可测试多数据源及事物是生效的  package io.renren.service;  import org.junit.Test; import org.junit.runner.RunWith; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.test.context.junit4.SpringRunner;  /** * 多数据源测试 * * @author Mark sunlightcs@gmail.com */ @RunWith(SpringRunner.class) @SpringBootTest public class DynamicDataSourceTest {  @Autowired  private DynamicDataSourceTestService dynamicDataSourceTestService;   @Test  public void test() {  Long id = 1L;  dynamicDataSourceTestService.updateUser(id);  dynamicDataSourceTestService.updateUserBySlave1(id);  dynamicDataSourceTestService.updateUserBySlave2(id);  } } 其中， @DataSource(“slave1”) 、 @DataSource(“slave2”) 里的 slave1 、 slave2 值，是在application- dev.xml里配置的，如下所示：  dynamic:  datasource:  slave1:  driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver  url: jdbc:sqlserver://localhost:1433;DatabaseName=renren_security  username: sa  password: 123456  slave2:  driver-class-name: org.postgresql.Driver  url: jdbc:postgresql://localhost:5432/renren_security  username: renren  password: 123456 3.3 源码讲解  定义多数据源注解类@DataSource，使用多数据源时，只需在Service方法上添加@DataSource注解即可  import java.lang.annotation.*;  /** * 多数据源注解 * * @author Mark sunlightcs@gmail.com */ @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited public @interface DataSource {  String value() default \"\"; } 定义读取多数据源配置文件的类，如下所示：  /** * 多数据源属性 * * @author Mark sunlightcs@gmail.com */ public class DataSourceProperties {  private String driverClassName;  private String url;  private String username;  private String password;  /** * Druid默认参数 */  private int initialSize = 2;  private int maxActive = 10;  private int minIdle = -1;  private long maxWait = 60 * 1000L;  private long timeBetweenEvictionRunsMillis = 60 * 1000L;  private long minEvictableIdleTimeMillis = 1000L * 60L * 30L;  private long maxEvictableIdleTimeMillis = 1000L * 60L * 60L * 7;  private String validationQuery = \"select 1\";  private int validationQueryTimeout = -1;  private boolean testOnBorrow = false;  private boolean testOnReturn = false;  private boolean testWhileIdle = true;  private boolean poolPreparedStatements = false;  private int maxOpenPreparedStatements = -1;  private boolean sharePreparedStatements = false;  private String filters = \"stat,wall\";   public String getDriverClassName() {  return driverClassName;  }   public void setDriverClassName(String driverClassName) {  this.driverClassName = driverClassName;  }   public String getUrl() {  return url;  }   public void setUrl(String url) {  this.url = url;  }   public String getUsername() {  return username;  }   public void setUsername(String username) {  this.username = username;  }   public String getPassword() {  return password;  }   public void setPassword(String password) {  this.password = password;  }   public int getInitialSize() {  return initialSize;  }   public void setInitialSize(int initialSize) {  this.initialSize = initialSize;  }   public int getMaxActive() {  return maxActive;  }   public void setMaxActive(int maxActive) {  this.maxActive = maxActive;  }   public int getMinIdle() {  return minIdle;  }   public void setMinIdle(int minIdle) {  this.minIdle = minIdle;  }   public long getMaxWait() {  return maxWait;  }   public void setMaxWait(long maxWait) {  this.maxWait = maxWait;  }   public long getTimeBetweenEvictionRunsMillis() {  return timeBetweenEvictionRunsMillis;  }   public void setTimeBetweenEvictionRunsMillis(long timeBetweenEvictionRunsMillis) {  this.timeBetweenEvictionRunsMillis =  timeBetweenEvictionRunsMillis;  }   public long getMinEvictableIdleTimeMillis() {  return minEvictableIdleTimeMillis;  }   public void setMinEvictableIdleTimeMillis(long minEvictableIdleTimeMillis) {  this.minEvictableIdleTimeMillis =  minEvictableIdleTimeMillis;  }   public long getMaxEvictableIdleTimeMillis() {  return maxEvictableIdleTimeMillis;  }   public void setMaxEvictableIdleTimeMillis(long maxEvictableIdleTimeMillis) {  this.maxEvictableIdleTimeMillis =  maxEvictableIdleTimeMillis;  }   public String getValidationQuery() {  return validationQuery;  }   public void setValidationQuery(String validationQuery) {  this.validationQuery = validationQuery;  }   public int getValidationQueryTimeout() {  return validationQueryTimeout;  }   public void setValidationQueryTimeout(int validationQueryTimeout) {  this.validationQueryTimeout =  validationQueryTimeout;  }   public boolean isTestOnBorrow() {  return testOnBorrow;  }   public void setTestOnBorrow(boolean testOnBorrow) {  this.testOnBorrow = testOnBorrow;  }   public boolean isTestOnReturn() {  return testOnReturn;  }   public void setTestOnReturn(boolean testOnReturn) {  this.testOnReturn = testOnReturn;  }   public boolean isTestWhileIdle() {  return testWhileIdle;  }   public void setTestWhileIdle(boolean testWhileIdle) {  this.testWhileIdle = testWhileIdle;  }   public boolean isPoolPreparedStatements() {  return poolPreparedStatements;  }   public void setPoolPreparedStatements(boolean poolPreparedStatements) {  this.poolPreparedStatements =  poolPreparedStatements;  }   public int getMaxOpenPreparedStatements() {  return maxOpenPreparedStatements;  }   public void setMaxOpenPreparedStatements(int maxOpenPreparedStatements) {  this.maxOpenPreparedStatements =  maxOpenPreparedStatements;  }   public boolean isSharePreparedStatements() {  return sharePreparedStatements;  }   public void setSharePreparedStatements(boolean sharePreparedStatements) {  this.sharePreparedStatements =  sharePreparedStatements;  }   public String getFilters() {  return filters;  }   public void setFilters(String filters) {  this.filters = filters;  } } import org.springframework.boot.context.properties.ConfigurationProperties;  import java.util.LinkedHashMap; import java.util.Map;  /** * 多数据源属性 * * @author Mark sunlightcs@gmail.com */ @ConfigurationProperties(prefix = \"dynamic\") public class DynamicDataSourceProperties {  private MapString, DataSourceProperties datasource = new LinkedHashMap();   public MapString, DataSourceProperties getDatasource() {  return datasource;  }   public void setDatasource(MapString, DataSourceProperties datasource) {  this.datasource = datasource;  } } 扩展Spring的AbstractRoutingDataSource抽象类， AbstractRoutingDataSource中的抽象方法determineCurrentLookupKey是实现多数据源的核心，并对该方法进行Override，如下所示：  import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;  /** * 多数据源 * * @author Mark sunlightcs@gmail.com */ public class DynamicDataSource extends AbstractRoutingDataSource {  @Override  protected Object determineCurrentLookupKey() {  return DynamicContextHolder.peek();  } } 数据源上下  /** * 多数据源上下文 * * @author Mark sunlightcs@gmail.com */ public class DynamicContextHolder {  @SuppressWarnings(\"unchecked\")  private static final ThreadLocalDequeString CONTEXT_HOLDER = new ThreadLocal() {  @Override  protected Object initialValue() {  return new ArrayDeque();  }  };   /** * 获得当前线程数据源 * * @return 数据源名称 */  public static String peek() {  return CONTEXT_HOLDER.get().peek();  }   /** * 设置当前线程数据源 * * @param dataSource 数据源名称 */  public static void push(String dataSource) {  CONTEXT_HOLDER.get().push(dataSource);  }   /** * 清空当前线程数据源 */  public static void poll() {  DequeString deque = CONTEXT_HOLDER.get();  deque.poll();  if (deque.isEmpty()) {  CONTEXT_HOLDER.remove();  }  } } 配置多数据源，如下所示：  return druidDataSource; } } @DataSource注解的切面处理类，动态切换的核心代码  import com.alibaba.druid.pool.DruidDataSource; import io.renren.commons.dynamic.datasource.properties.DataSourceProperties; import io.renren.commons.dynamic.datasource.properties.DynamicDataSourceProperties; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.boot.context.properties.EnableConfigurationProperties; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration;  import java.util.HashMap; import java.util.Map;  /** * 配置多数据源 * * @author Mark sunlightcs@gmail.com */ @Configuration @EnableConfigurationProperties(DynamicDataSourceProperties.class) public class DynamicDataSourceConfig {  @Autowired  private DynamicDataSourceProperties properties;   @Bean  @ConfigurationProperties(prefix = \"spring.datasource.druid\")  public DataSourceProperties dataSourceProperties() {  return new DataSourceProperties();  } //因为DynamicDataSource是继承与AbstractRoutingDataSource，而AbstractRoutingDataSource又是继  承于AbstractDataSource，AbstractDataSource实现了统一的DataSource接口，  所以DynamicDataSource也可  以当做DataSource使用   @Bean  public DynamicDataSource dynamicDataSource(DataSourceProperties dataSourceProperties) {  DynamicDataSource dynamicDataSource = new DynamicDataSource();  dynamicDataSource.setTargetDataSources(getDynamicDataSource());  //默认数据源  DruidDataSource defaultDataSource = DynamicDataSourceFactory.buildDruidDataSource(dat  aSourceProperties);  dynamicDataSource.setDefaultTargetDataSource(defaultDataSource);  return dynamicDataSource;  }   private MapObject, Object getDynamicDataSource() {  MapObject, Object targetDataSources = new HashMap();  properties.getDatasource().forEach((k, v) - {  DruidDataSource druidDataSource = DynamicDataSourceFactory.buildDruidDataSource(v  );  targetDataSources.put(k, druidDataSource);  });  return targetDataSources;  } } import com.alibaba.druid.pool.DruidDataSource; import io.renren.commons.dynamic.datasource.properties.DataSourceProperties;  import java.sql.SQLException;  /** * DruidDataSource * * @author Mark sunlightcs@gmail.com */ public class DynamicDataSourceFactory {  public static DruidDataSource buildDruidDataSource(DataSourceProperties properties) {  DruidDataSource druidDataSource = new DruidDataSource();  druidDataSource.setDriverClassName(properties.getDriverClassName());  druidDataSource.setUrl(properties.getUrl());  druidDataSource.setUsername(properties.getUsername());  druidDataSource.setPassword(properties.getPassword());  druidDataSource.setInitialSize(properties.getInitialSize());  druidDataSource.setMaxActive(properties.getMaxActive());  druidDataSource.setMinIdle(properties.getMinIdle());  druidDataSource.setMaxWait(properties.getMaxWait());  druidDataSource.setTimeBetweenEvictionRunsMillis(properties.getTimeBetweenEvictionRun  sMillis());  druidDataSource.setMinEvictableIdleTimeMillis(properties.getMinEvictableIdleTimeMilli  s());  druidDataSource.setMaxEvictableIdleTimeMillis(properties.getMaxEvictableIdleTimeMilli  s());  druidDataSource.setValidationQuery(properties.getValidationQuery());  druidDataSource.setValidationQueryTimeout(properties.getValidationQueryTimeout());  druidDataSource.setTestOnBorrow(properties.isTestOnBorrow());  druidDataSource.setTestOnReturn(properties.isTestOnReturn());  druidDataSource.setPoolPreparedStatements(properties.isPoolPreparedStatements());  druidDataSource.setMaxOpenPreparedStatements(properties.getMaxOpenPreparedStatements(  ));  druidDataSource.setSharePreparedStatements(properties.isSharePreparedStatements());  try {  druidDataSource.setFilters(properties.getFilters());  druidDataSource.init();  } catch (SQLException e) {  e.printStackTrace();  }  return druidDataSource;  } } @DataSource注解的切面处理类，动态切换的核心代码  import io.renren.commons.dynamic.datasource.annotation.DataSource; import io.renren.commons.dynamic.datasource.config.DynamicContextHolder; import org.aspectj.lang.ProceedingJoinPoint; import org.aspectj.lang.annotation.Around; import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Pointcut; import org.aspectj.lang.reflect.MethodSignature; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.core.Ordered; import org.springframework.core.annotation.Order; import org.springframework.stereotype.Component;  import java.lang.reflect.Method;  /** * 多数据源，切面处理类 * * @author Mark sunlightcs@gmail.com */ @Aspect @Component @Order(Ordered.HIGHEST_PRECEDENCE) public class DataSourceAspect {  protected Logger logger = LoggerFactory.getLogger(getClass());   @Pointcut(\"@annotation(io.renren.commons.dynamic.datasource.annotation.DataSource) \" +  \"|| @within(io.renren.commons.dynamic.datasource.annotation.DataSource)\")  public void dataSourcePointCut() {  }   @Around(\"dataSourcePointCut()\")  public Object around(ProceedingJoinPoint point) throws Throwable {  MethodSignature signature = (MethodSignature) point.getSignature();  Class targetClass = point.getTarget().getClass();  Method method = signature.getMethod();  DataSource targetDataSource = (DataSource) targetClass.getAnnotation(DataSource.class);  DataSource methodDataSource = method.getAnnotation(DataSource.class);  if (targetDataSource != null || methodDataSource != null) {  String value;  if (methodDataSource != null) {  value = methodDataSource.value();  } else {  value = targetDataSource.value();  }  DynamicContextHolder.push(value);  logger.debug(\"set datasource is {}\", value);  }  try {  return point.proceed();  } finally {  DynamicContextHolder.poll();  logger.debug(\"clean datasource\");  }  } } 第 4 章 基础知识讲解 4.1 Spring MVC 使用 4.2 Swagger 使用 4.3 Mybatis-plus 使用 4.1 Spring MVC 使用  对Spring MVC不太熟悉的，需要理解Spring MVC常用的注解，也方便日后排查问题，常用的注解如下所示：\n 4.1.1 @Controller 注解 @Controller注解表明了一个类是作为控制器的角色而存在的。Spring不要求你去继承任何控制器基类，也不要求你去实现Servlet的那套API。当然，如果你需要的话也可以去使用任何与Servlet相关的特性。\n @Controller public class UserController { // ... } 4.1.2 @RequestMapping 注解 你可以使用@RequestMapping注解来将请求URL，如/user等，映射到整个类上或某个特定的处理器方法上。 一般来说，类级别的注解负责将一个特定（或符合某种模式）的请求路径映射到一个控制器上，同时通过方法级别的注解来细化映射，即根据特定的HTTP请求方法（GET、POST方法等）、HTTP请求中是否携带特 定参数等条件，将请求映射到匹配的方法上。\n @Controller public class UserController {   @RequestMapping(\"/user\")  public String user() {  return \"user\";  } } 以上代码没有指定请求必须是GET方法还是PUT/POST或其他方法，@RequestMapping注解默认会映射所有 的HTTP请求方法。如果仅想接收某种请求方法，请在注解中指定之@RequestMapping(path = “/user”, method = RequestMethod.GET)以缩小范围。\n4.1.3 @PathVariable 注解 在Spring MVC中你可以在方法参数上使用@PathVariable注解，将其与URI模板中的参数绑定起来，如下所 示：\n@RequestMapping(path = \"/user/{userId}\", method = RequestMethod.GET) public String userCenter(@PathVariable(\"userId\") String userId,Model model){  UserDTO user=userService.get(userId);  model.addAttribute(\"user\",user);  return\"userCenter\";  } URI模板\"/user/{userId}“指定了一个变量名为userId。当控制器处理这个请求的时候，userId的值就会被URI模 板中对应部分的值所填充。比如说，如果请求的URI是/userId/1，此时变量userId的值就是 1 。\n4.1.4 @GetMapping 注解 @GetMapping是一个组合注解，是@RequestMapping(method = RequestMethod.GET)的缩写。该注解将HTTP GET映射到特定的处理方法上。可以使用@GetMapping(\"/user”)来代替@RequestMapping(path=\"/user\",method=RequestMethod.GET)。还有@PostMapping、@PutMapping、 @DeleteMapping等同理。\n4.1.5 @RequestBody 注解 该注解用于读取Request请求的body部分数据，使用系统默认配置的HttpMessageConverter进行解析，然后把相应的数据绑定到要返回的对象上，再把HttpMessageConverter返回的对象数据绑定到Controller中方法的参数上。\n @Controller public class UserController {  @GetMapping(\"/user\")  public String user(@RequestBody User user) {  //...  return \"user\";  } } 4.1.6 @ResponseBody 注解 该注解用于将Controller的方法返回的对象，通过适当的HttpMessageConverter转换为指定格式后，写入到Response对象的body数据区。比如获取JSON数据，加上@ResponseBody后，会直接返回JSON数据，而不会被解析为视图。\n @Controller public class UserController {  @ResponseBody  @GetMapping(\"/user/{userId}\")  public User info(@PathVariable(\"userId\") String userId) {  UserDTO user = userService.get(userId);  return user;  } } 4.1.7 @RestController 注解 @RestController是一个组合注解，即@Controller + @ResponseBody的组合注解，请求完后，会返回JSON数据。\n4.2 Swagger 使用  Swagger是一个根据Swagger注解，即可生成接口文档的服务。\n 4.2.1 搭建 Swagger 环境  在pom.xml文件中添加swagger相关依赖，如下所示：     io.springfox  springfox-swagger2  ${springfox-version}   io.springfox springfox-swagger-ui ${springfox-version}   编写Swagger的Configuration配置文件，如下所示：  import io.swagger.annotations.ApiOperation; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurer; import springfox.documentation.builders.ApiInfoBuilder; import springfox.documentation.builders.PathSelectors; import springfox.documentation.builders.RequestHandlerSelectors; import springfox.documentation.service.ApiInfo; import springfox.documentation.service.ApiKey; import springfox.documentation.spi.DocumentationType; import springfox.documentation.spring.web.plugins.Docket; import springfox.documentation.swagger2.annotations.EnableSwagger2;  import java.util.List;  import static com.google.common.collect.Lists.newArrayList;  @Configuration @EnableSwagger2 public class SwaggerConfig implements WebMvcConfigurer {  @Bean  public Docket createRestApi() {  return new Docket(DocumentationType.SWAGGER_2)  .apiInfo(apiInfo())  .select()  //加了ApiOperation注解的类，才生成接口文档  .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))  //io.renren.controller包下的类，才生成接口文档  //.apis(RequestHandlerSelectors.basePackage(\"io.renren.controller\"))  .paths(PathSelectors.any())  .build()  .directModelSubstitute(java.util.Date.class, String.class);  }   private ApiInfo apiInfo() {  return new ApiInfoBuilder()  .title(\"人人开源\")  .description(\"人人开源接口文档\")  .termsOfServiceUrl(\"https://www.renren.io/community\")  .version(\"1.0.0\")  .build();  } } 4.2.2 Swagger 常用注解  @Api注解用在类上，说明该类的作用。可以标记一个Controller类做为swagger文档资源，如下所示：   @Api(tags = \"用户管理\") @RestController public class UserController {  }  @ApiOperation注解用在方法上，说明该方法的作用，如下所示：   @Api(tags = \"用户管理\") @RestController public class UserController {  @GetMapping(\"/user/list\")  @ApiOperation(\"列表\")  public ListUserDTO list() {  ListUserDTO list = userService.list();  return list;  } }  @ApiParam注解用在方法参数上，如下所示：   @Api(tags = \"用户管理\") @RestController public class UserController {  @GetMapping(\"/user/list\")  @ApiOperation(\"列表\")  public List list(@ApiParam(value = \"用户名\", required = true) String username) {  List list = userService.list();  return list;  } }   @ApiImplicitParams注解用在方法上，主要用于一组参数说明\n  @ApiImplicitParam注解用在@ApiImplicitParams注解中，指定一个请求参数的信息，如下所示：\n  @GetMapping(\"page\") @ApiOperation(\"分页\") @ApiImplicitParams({  @ApiImplicitParam(name = \"page\", value = \"当前页码，从 1 开始\", paramType = \"query\", requ ired=true, dataType = \"int\"),  @ApiImplicitParam(name = \"limit\", value = \"每页显示记录数\", paramType = \"query\", requir ed=true, dataType = \"int\"),  @ApiImplicitParam(name = \"order_field\", value = \"排序字段\", paramType = \"query\", dataT ype=\"String\"),  @ApiImplicitParam(name = \"order\", value = \"排序方式，可选值(asc、desc)\", paramType = \"q uery\", dataType = \"String\"),  @ApiImplicitParam(name = \"username\", value = \"用户名\", paramType = \"query\", dataType = \"String\") }) public ResultPageData page(@ApiIgnore @RequestParam MapString, Object par ams){  PageData page=sysUserService.page(params);  return new ResultPageData().ok(page);  }  @ApiIgnore注解，可用于类、方法或参数上，表示生成Swagger接口文档时，忽略类、方法或参数。  4.3 Mybatis-plus 使用 在项目的pom.xml里引入依赖，如下所示：\n   com.baomidou  mybatis-plus-boot-starter  ${mybatisplus.version}  在yml配置文件里，配置mybatis-plus，如下所示：\nmybatis-plus:  mapper-locations: classpath*:/mapper/**/*.xml  #实体扫描，多个package用逗号或者分号分隔  typeAliasesPackage: io.renren.modules.*.entity  global-config:  #数据库相关配置  db-config:  #主键类型 AUTO:\"数据库ID自增\", INPUT:\"用户输入ID\", ID_WORKER:\"全局唯一ID (数字类型唯一ID)\"  , UUID:\"全局唯一ID UUID\";  id-type: AUTO  #字段策略 IGNORED:\"忽略判断\",NOT_NULL:\"非 NULL 判断\"),NOT_EMPTY:\"非空判断\"  field-strategy: NOT_NULL  #驼峰下划线转换  column-underline: true  logic-delete-value: -1  logic-not-delete-value: 0  banner: false  #原生配置  configuration:  map-underscore-to-camel-case: true  cache-enabled: false  call-setters-on-nulls: true  jdbc-type-for-null: 'null' 第 5 章 项目实战 5.1 需求说明 5.2 代码生成器 5.1 需求说明  我们来完成一个商品的列表、添加、修改、删除功能，熟悉如何快速开发自己的业务功能模块。\n  我们先建一个商品表tb_goods，表结构如下所示：  CREATE TABLE `tb_goods` (  `goods_id` bigint NOT NULL AUTO_INCREMENT COMMENT '商品ID',  `name` varchar(50) COMMENT '商品名',  `intro` varchar(500) COMMENT '介绍',  `price` decimal(10, 2) COMMENT '价格',  `num` int COMMENT '数量',  PRIMARY KEY (`goods_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='商品管理'; 5.1 代码生成器  使用代码生成器前，我们先来看下代码生成器的配置，看看那些是可配置的，打开renren-generator模块 的配置文件generator.properties，如下所示：  #代码生成器，配置信息 mainPath=io.renren #包名 package=io.renren.modules moduleName=generator #作者 author=Mark #Email email=sunlightcs@gmail.com #表前缀(类名不会包含表前缀) tablePrefix=tb_ #类型转换，配置信息 tinyint=Integer smallint=Integer mediumint=Integer int=Integer integer=Integer bigint=Long float=Float double=Double decimal=BigDecimal bit=Boolean char=String varchar=String tinytext=String text=String mediumtext=String longtext=String date=Date datetime=Date timestamp=Date NUMBER=Integer INT=Integer INTEGER=Integer BINARY_INTEGER=Integer LONG=String FLOAT=Float BINARY_FLOAT=Float DOUBLE=Double BINARY_DOUBLE=Double DECIMAL=BigDecimal CHAR=String VARCHAR=String VARCHAR2=String NVARCHAR=String NVARCHAR2=String CLOB=String BLOB=String DATE=Date DATETIME=Date TIMESTAMP=Date TIMESTAMP(6)=Date int8=Long int4=Integer int2=Integer numeric=BigDecimal 上面的配置文件，可以配置包名、作者信息、表前缀、模块名称、类型转换等信息。其中，类型转换是指， MySQL中的类型与JavaBean中的类型，是怎么一个对应关系。如果有缺少的类型，可自行在generator.properties文件中补充。\n 再看看renren-generator模块的application.yml配置文件，我们只要修改数据库名、账号、密码，就可以 了。其中，数据库名是指待生成的表，所在的数据库。  server:  port: 80 # mysql spring:  datasource:  type: com.alibaba.druid.pool.DruidDataSource  #MySQL配置  driverClassName: com.mysql.jdbc.Driver  url: jdbc:mysql://localhost:3306/renren_fast?useUnicode=true\u0026characterEncoding=UTF-8\u0026useS  SL=false  username: renren  password: 123456  #oracle配置  # driverClassName: oracle.jdbc.OracleDriver  # url: jdbc:oracle:thin:@47.100.206.162:1521:xe  # username: renren  # password: 123456  #SQLServer配置  # driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver  # url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast  # username: sa  # password: 123456  #PostgreSQL配置  # driverClassName: org.postgresql.Driver  # url: jdbc:postgresql://192.168.10.10:5432/renren_fast  # username: postgres  # password: 123456  jackson:  time-zone: GMT+8 date-format: yyyy-MM-dd HH:mm:ss resources:  static-locations: classpath:/static/,classpath:/views/  mybatis:  mapperLocations: classpath:mapper/**/*.xml  pagehelper:  reasonable: true  supportMethodsArguments: true  params: count=countSql  #指定数据库，可选值有【mysql、oracle、sqlserver、postgresql】  renren:  database: mysql   在数据库renren_fast中，执行建表语句，创建tb_goods表，再启动renren-generator项目(运行 RenrenApplication.java的main方法即可)，如下所示：\n  在浏览器里输入项目地址(http://localhost)，如下所示：\n   我们只需勾选tb_goods，点击【生成代码】按钮，则可生成相应代码，如下所示：   我们来看下生成的代码结构，如下所示：   生成好代码后，我们只需在数据库renren_fast中，执行goods_menu.sql语句，这个SQL是生成菜单的， SQL语句如下所示：  # -- 菜单SQL  INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) VALUES ('1', '商品管理', 'generator/goods', NULL, '1', 'config', '6');  # -- 按钮父菜单ID  set @parentId = @@identity;  -- 菜单对应按钮SQL INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId,  '查看',  null,  'generator:goods:list,generator:goods:info',  '2',  null,  '6 '; INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId, '新增', null, 'generator:goods:save', '2', null, '6';  INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId, '修改', null, 'generator:goods:update', '2', null, '6'; INSERT INTO `sys_menu` ( `parent_id`, `name`  , `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId, '删除', null, 'generator:goods:delete', '2', null, '6';  接下来，再把刚生成的后端代码，添加到项目renren-fast里，前端vue代码，添加到前端项目renren-fast- vue里，在启动renren-fast项目，如下所示：   现在，我们就可以新增、修改、删除等操作  第 6 章 后端源码分析 6.1 前后端分离 6.2 权限设计思路 6.3 XSS 脚本过滤 6.4 SQL 注入 6.5 Redis 缓存 6.6 异常处理机制 6.7 后端效验机制 6.8 系统日志 6.9 添加菜单 6.10 添加角色 6.11 添加管理员 6.12 定时任务模块 6.13 云存储模块 6.14 APP 模块 6.1 前后端分离  要实现前后端分离，需要考虑以下 2 个问题：\n1. 项目不再基于session了，如何知道访问者是谁？ 1. 如何确认访问者的权限？ 3. 前后端分离\n  一般都是通过token实现，本项目也是一样；用户登录时，生成token及token过期时间，token与用户是一一对应关系，调用接口的时候，把token放到header或请求参数中，服务端就知道是谁在调用接口，登录如下所示：  /** * 验证码 */ @GetMapping(\"captcha.jpg\") public void captcha(HttpServletResponse response, String uuid) throws ServletException, IOException {  response.setHeader(\"Cache-Control\", \"no-store, no-cache\");  response.setContentType(\"image/jpeg\");  //获取图片验证码  BufferedImage image = sysCaptchaService.getCaptcha(uuid);  ServletOutputStream out = response.getOutputStream();  ImageIO.write(image, \"jpg\", out);  IOUtils.closeQuietly(out); }  /** * 登录 */ @PostMapping(\"/sys/login\") public MapString, Object login(@RequestBody SysLoginForm form) throws IOException {  boolean captcha = sysCaptchaService.validate(form.getUuid(), form.getCaptcha());  if (!captcha) {  return R.error(\"验证码不正确\");  }   //用户信息  SysUserEntity user = sysUserService.queryByUserName(form.getUsername());   //账号不存在、密码错误  if (user == null || !user.getPassword().equals(new Sha256Hash(form.getPassword(), user.get  Salt()).toHex())) {  return R.error(\"账号或密码不正确\");  }  //账号锁定  if (user.getStatus() == 0) {  return R.error(\"账号已被锁定,请联系管理员\");  }  //生成token，并保存到数据库  R r = sysUserTokenService.createToken(user.getUserId());  return r; }   //生产token public R createToken(long userId) {  //生成一个token，可以是uuid  String token = TokenGenerator.generateValue();  //当前时间  Date now = new Date();  //过期时间  Date expireTime = new Date(now.getTime() + EXPIRE * 1000);  //判断是否生成过token  SysUserTokenEntity tokenEntity = queryByUserId(userId);  if (tokenEntity == null) {  tokenEntity = new SysUserTokenEntity();  tokenEntity.setUserId(userId);  tokenEntity.setToken(token);  tokenEntity.setUpdateTime(now);  tokenEntity.setExpireTime(expireTime);  //保存token  save(tokenEntity);  } else {  tokenEntity.setToken(token);  tokenEntity.setUpdateTime(now);  tokenEntity.setExpireTime(expireTime);  //更新token  update(tokenEntity);  }  R r = R.ok().put(\"token\", token).put(\"expire\", EXPIRE);  return r; } 其中，下面的这行代码，是加盐操作；可能有人不理解为何要加盐，其目的是防止被拖库后，黑客轻易的 （通过密码库对比），就能拿到你的密码\nnew Sha256Hash(password, user.getSalt()).toHex())  调用接口时，接受传过来的token后，如何保证token有效及用户权限呢？其实，shiro提供了 AuthenticatingFilter抽象类，继承AuthenticatingFilter抽象类即可。  步骤 1 ，所有请求全部拒绝访问\n@Override protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) {  return false; } 步骤 2 ，拒绝访问的请求，会调用onAccessDenied方法，onAccessDenied方法先获取token，再调用 executeLogin方法\n@Override protected boolean onAccessDenied(ServletRequest request, ServletResponse response) throws Exception {  //获取请求token，如果token不存在，直接返回 401  String token = getRequestToken((HttpServletRequest) request);  if (StringUtils.isBlank(token)) {  HttpServletResponse httpResponse = (HttpServletResponse) response;  String json = new Gson().toJson(R.error(HttpStatus.SC_UNAUTHORIZED, \"invalid token\"));  httpResponse.getWriter().print(json);  return false;  }  return executeLogin(request, response); }  /** * 获取请求的token */ private String getRequestToken(HttpServletRequest httpRequest) {  //从header中获取token  String token = httpRequest.getHeader(\"token\");  //如果header中不存在token，则从参数中获取token  if (StringUtils.isBlank(token)) {  token = httpRequest.getParameter(\"token\");  }  return token; } 步骤 3 ，阅读AuthenticatingFilter抽象类中executeLogin方法，我们发现调用了 subject.login(token) ，这是shiro的登录方法，且需要token参数，我们自定义OAuth2Token类，只要实现AuthenticationToken接口，就可以了\n//AuthenticatingFilter类中的方法 protected boolean executeLogin(ServletRequest request,ServletResponse response) throws Exception{  AuthenticationToken token=createToken(request,response);  if(token==null){  String msg=\"createToken method implementation returned null. A valid non-null A uthenticationToken\" +  \"must be created in order to execute a login attempt.\";  throw new IllegalStateException(msg);  }  try{  Subject subject=getSubject(request,response);  subject.login(token);  return onLoginSuccess(token,subject,request,response);  }catch(AuthenticationException e){  return onLoginFailure(token,e,request,response);  } }   //subject.login(token)中的token对象，需要实现AuthenticationToken接口 public class OAuth2Token implements AuthenticationToken {  private String token;   public OAuth2Token(String token) {  this.token = token;  }   @Override  public String getPrincipal() {  return token;  }   @Override  public Object getCredentials() {  return token;  } } 步骤 4 ，定义OAuth2Realm类，并继承AuthorizingRealm抽象类，调用 subject.login(token) 时，则会调用doGetAuthenticationInfo方法，进行登录\n/** * authentication身份认证(登录时调用) */ // 9. 前面被authc拦截后，需要认证，SecurityBean会调用这里进行认证 @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {  String accessToken = (String) token.getPrincipal();   //根据accessToken，查询用户信息  SysUserTokenEntity tokenEntity = shiroService.queryByToken(accessToken);  //token失效   if(tokenEntity == null || tokenEntity.getExpireTime().getTime()  System.currentTimeMillis()){  throw new IncorrectCredentialsException(\"token失效，请重新登录\");  }  // 9.1. token生效才能登录  //查询用户信息  SysUserEntity user = shiroService.queryUser(tokenEntity.getUserId());  //账号锁定  if(user.getStatus() == 0){  throw new LockedAccountException(\"账号已被锁定,请联系管理员\");  }   SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(user, accessToken, getName());  return info; } 步骤 5 ，登录失败后，则调用onLoginFailure，进行失败处理，整个流程结束\n@Override protected boolean onLoginFailure(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response) {  HttpServletResponse httpResponse = (HttpServletResponse) response;  httpResponse.setContentType(\"application/json;charset=utf-8\");  try {  //处理登录失败的异常  Throwable throwable = e.getCause() == null ? e : e.getCause();  R r = R.error(HttpStatus.SC_UNAUTHORIZED, throwable.getMessage());  String json = new Gson().toJson(r);  httpResponse.getWriter().print(json);  } catch (IOException e1) {  }  return false; } 步骤 6 ，登录成功后，则调用doGetAuthorizationInfo方法，查询用户的权限，再调用具体的接口，整个流程 结束\n/** * authorization授权(验证权限时调用) */ // 10. 前面被roles拦截后，需要授权才能登录，SecurityManager需要调用这里进行权限查询 @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {  SysUserEntity user = (SysUserEntity)principals.getPrimaryPrincipal();  Long userId = user.getUserId();   //用户权限列表  SetString permsSet = shiroService.getUserPermissions(userId);   SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();  info.setStringPermissions(permsSet);  return info; } 6.2 权限设计思路 权限相关的表结构，如下图所示：\n sys_user[用户]表，保存用户相关数据，通过sys_user_role[用户与角色关联]表，与sys_role[角色]表关联；sys_menu[菜单]表通过sys_role_menu[菜单与角色关联]表，与sys_role[角色]表关联 sys_menu表，保存菜单相关数据，并在perms字段里，保存了shiro的权限标识，也就是说，拥有此菜单，就拥有perms字段里的所有权限，比如，某用户拥有的菜单权限标识 sys:user:info ，就可以访问下面的方法  @RequestMapping(\"/info/{userId}\") @RequiresPermissions(\"sys:user:info\") public R info(@PathVariable(\"userId\") Long userId){ } 在shiro配置代码里，配置为 anon 的，表示不经过shiro处理，配置为 oauth2 的，表示经过 OAuth2Filter 处理，前后端分离的接口，都会交给 OAuth2Filter处理，这样就保证，没有权限的请求，拒绝访问  /** * Shiro配置 * * @author Mark sunlightcs@gmail.com */ @Configuration public class ShiroConfig {   /** * Shiro自带的过滤器，可以在这里配置拦截页面 */  @Bean(\"shiroFilter\")  public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) {   // 1. 初始化一个ShiroFilter工程类  ShiroFilterFactoryBean shiroFilter = new ShiroFilterFactoryBean();  // 2. 我们知道Shiro是通过SecurityManager来管理整个认证和授权流程的，这个SecurityManager可以在下面初始化  shiroFilter.setSecurityManager(securityManager);   //自定义Oauth2Filter过滤器  MapString, Filter filters = new HashMap();  filters.put(\"oauth2\", new OAuth2Filter());  shiroFilter.setFilters(filters);   // 3. 上面我们讲过，有的页面不需登录任何人可以直接访问，有的需要登录才能访问，有的不仅要登录还需要相关权限才能访问  MapString, String filterMap = new LinkedHashMap();   // 4. Shiro过滤器常用的有如下几种  // 4.1. anon 任何人都能访问，如登录页面  // 4.2. authc 需要登录才能访问，如系统内的全体通知页面  // 4.3. roles 需要相应的角色才能访问  filterMap.put(\"/webjars/**\", \"anon\");  filterMap.put(\"/druid/**\", \"anon\");  filterMap.put(\"/app/**\", \"anon\");  filterMap.put(\"/sys/login\", \"anon\");  filterMap.put(\"/swagger/**\", \"anon\");  filterMap.put(\"/v2/api-docs\", \"anon\");  filterMap.put(\"/swagger-ui.html\", \"anon\");  filterMap.put(\"/swagger-resources/**\", \"anon\");  filterMap.put(\"/captcha.jpg\", \"anon\");  filterMap.put(\"/aaa.txt\", \"anon\");  filterMap.put(\"/**\", \"oauth2\");  // 5. 让ShiroFilter按这个规则拦截  shiroFilter.setFilterChainDefinitionMap(filterMap);   // 6. 用户没登录被拦截后，当然需要调转到登录页了，这里配置登录页  //shiroFilterFactoryBean.setLoginUrl(\"/api/user/login\");  return shiroFilter;  }    @Bean(\"securityManager\")  public SecurityManager securityManager(OAuth2Realm oAuth2Realm) {  // 7. 新建一个SecurityManager供ShiroFilterFactoryBean使用  DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();  // 8. SecurityManager既然管理认证等信息，那他就需要一个类来帮他查数据库吧。这就是Realm类  securityManager.setRealm(oAuth2Realm);  securityManager.setRememberMeManager(null);  return securityManager;  }    @Bean(\"lifecycleBeanPostProcessor\")  public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() {  return new LifecycleBeanPostProcessor();  }   @Bean  public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager) {  AuthorizationAttributeSourceAdvisor advisor = new AuthorizationAttributeSourceAdvisor();  advisor.setSecurityManager(securityManager);  return advisor;  } } 6.3 XSS 脚本过滤  XSS跨站脚本攻击的基本原理和SQL注入攻击类似，都是利用系统执行了未经过滤的危险代码，不同点 在于XSS是一种基于网页脚本的注入方式，也就是将脚本攻击载荷写入网页执行以达到对网页客户端访问用户攻击的目的，属于客户端攻击。程序员往往不太关心安全这块，这就给有心之人，提供了机会，本系统针对XSS攻击，提供了过滤功能，可以有效防止XSS攻击，代码如下：\n public class XssFilter implements Filter {  @Override  public void init(FilterConfig config) throws ServletException {  }   public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)  throws IOException, ServletException {  XssHttpServletRequestWrapper xssRequest = new XssHttpServletRequestWrapper(  (HttpServletRequest) request);  chain.doFilter(xssRequest, response);  }   @Override  public void destroy() {  } }  @Configuration public class FilterConfig {  @Bean  public FilterRegistrationBean xssFilterRegistration() {  FilterRegistrationBean registration = new FilterRegistrationBean();  registration.setDispatcherTypes(DispatcherType.REQUEST);  registration.setFilter(new XssFilter());  registration.addUrlPatterns(\"/*\");  registration.setName(\"xssFilter\");  registration.setOrder(Integer.MAX_VALUE);  return registration;  } }  自定义XssFilter过滤器，用来过滤所有请求，具体过滤还是在XssHttpServletRequestWrapper里实现的， 如下所示：  public class XssHttpServletRequestWrapper extends HttpServletRequestWrapper {  //没被包装过的HttpServletRequest（特殊场景，需要自己过滤）  HttpServletRequest orgRequest;  //html过滤  private final static HTMLFilter htmlFilter = new HTMLFilter();   public XssHttpServletRequestWrapper(HttpServletRequest request) {  super(request);  orgRequest = request;  }   @Override  public ServletInputStream getInputStream() throws IOException { //非json类型，直接返回  if (!MediaType.APPLICATION_JSON_VALUE.equalsIgnoreCase(super.getHeader(HttpHeaders.CON  TENT_TYPE))) {  return super.getInputStream();  } //为空，直接返回  String json = IOUtils.toString(super.getInputStream(), \"utf-8\");  if (StringUtils.isBlank(json)) {  return super.getInputStream();  } //xss过滤  json = xssEncode(json);  final ByteArrayInputStream bis = new ByteArrayInputStream(json.getBytes(\"utf-8\"));  return new ServletInputStream() {  @Override  public boolean isFinished() {  return true;  }   @Override  public boolean isReady() {  return true;  }   @Override  public void setReadListener(ReadListener readListener) {  }   @Override  public int read() throws IOException {  return bis.read();  }  };  }   @Override  public String getParameter(String name) {  String value = super.getParameter(xssEncode(name));  if (StringUtils.isNotBlank(value)) {  value = xssEncode(value);  }  return value;  }   @Override  public String[] getParameterValues(String name) {  String[] parameters = super.getParameterValues(name);  if (parameters == null || parameters.length == 0) {  return null;  }  for (int i = 0; i  parameters.length; i++) {  parameters[i] = xssEncode(parameters[i]);  }  return parameters;  }   @Override  public MapString, String[] getParameterMap() {  MapString, String[] map = new LinkedHashMap();  MapString, String[] parameters = super.getParameterMap();  for (String key : parameters.keySet()) {  String[] values = parameters.get(key);  for (int i = 0; i  values.length; i++) {  values[i] = xssEncode(values[i]);  }  map.put(key, values);  }  return map;  }   @Override  public String getHeader(String name) {  String value = super.getHeader(xssEncode(name));  if (StringUtils.isNotBlank(value)) {  value = xssEncode(value);  }  return value;  }   private String xssEncode(String input) {  return htmlFilter.filter(input);  }   /** * 获取最原始的request */  public HttpServletRequest getOrgRequest() {  return orgRequest;  }   /** * 获取最原始的request */  public static HttpServletRequest getOrgRequest(HttpServletRequest request) {  if (request instanceof XssHttpServletRequestWrapper) {  return ((XssHttpServletRequestWrapper) request).getOrgRequest();  }  return request;  } } 如果需要处理富文本数据，可以通过 XssHttpServletRequestWrapper.getOrgRequest(request) ，拿到原始 的 request 对象后，再自行处理富文本数据，如：\npublic R data(HttpServletRequest request){  HttpServletRequest orgRequest=XssHttpServletRequestWrapper.getOrgRequest(request);  String content=orgRequest.getParameter(\"content\");  //富文本数据  System.out.println(content);  return R.ok();  } 6.4 SQL 注入  本系统使用的是Mybatis，如果使用${}拼接SQL，则存在SQL注入风险，可以对参数进行过滤，避免 SQL注入，如下:\n public class SQLFilter {  /** * SQL注入过滤 * @param str 待验证的字符串 */  public static String sqlInject(String str) {  if (StringUtils.isBlank(str)) {  return null;  }  //去掉'|\"|;|\\字符  str = StringUtils.replace(str, \"'\", \"\");  str = StringUtils.replace(str, \"\\\"\", \"\");  str = StringUtils.replace(str, \";\", \"\");  str = StringUtils.replace(str, \"\\\\\", \"\");  //转换成小写\\  str = str.toLowerCase();  //非法字符  String[] keywords = {\"master\", \"truncate\", \"insert\", \"select\", \"delete\", \"update\", \"declare\", \"alter\", \"drop\"};  //判断是否包含非法字符  for (String keyword : keywords) {  if (str.indexOf(keyword) != -1) {  throw new RRException(\"包含非法字符\");  }  }  return str;  } } 像查询列表，涉及排序问题，排序字段是从前台传过来的，则存在SQL注入风险，需经如下处理：\npublic class QueryT {  public IPageT getPage(MapString, Object params) {  return this.getPage(params, null, false);  }   public IPageT getPage(MapString, Object params, String defaultOrderField, boolean isAsc) {  //分页参数  long curPage = 1;  long limit = 10;  if (params.get(Constant.PAGE) != null) {  curPage = Long.parseLong((String) params.get(Constant.PAGE));  }  if (params.get(Constant.LIMIT) != null) {  limit = Long.parseLong((String) params.get(Constant.LIMIT));  }   //分页对象  PageT page = new Page(curPage, limit);  //分页参数  params.put(Constant.PAGE, page);   //排序字段  //防止SQL注入（因为sidx、order是通过拼接SQL实现排序的，会有SQL注入风险）  String orderField = SQLFilter.sqlInject((String) params.get(Constant.ORDER_FIELD));  String order = (String) params.get(Constant.ORDER);   //前端字段排序  if (StringUtils.isNotEmpty(orderField) \u0026\u0026 StringUtils.isNotEmpty(order)) {  if (Constant.ASC.equalsIgnoreCase(order)) {  return page.setAsc(orderField);  } else {  return page.setDesc(orderField);  }  }  //默认排序  if (isAsc) {  page.setAsc(defaultOrderField);  } else {  page.setDesc(defaultOrderField);  }  return page;  } } 6.5 Redis 缓存  缓存大家都很熟悉，但能否灵活运用，就不一定了。一般设计缓存架构时，我们需要考虑如下几个问 题：\n   查询数据的时候，尽量减少DB查询，DB主要负责写数据\n  尽量不使用 LEFT JOIN 等关联查询，缓存命中率不高，还浪费内存\n  多使用单表查询，缓存命中率最高\n  数据库 insert 、 update 、 delete 时，同步更新缓存数据\n  合理运用Redis数据结构，也许有质的飞跃\n  对于访问量不大的项目，使用缓存只会增加项目的复杂度\n  本系统采用Redis作为缓存，并可配置是否开启redis缓存，主要还是通过Spring AOP实现的，配置如下所示：\nredis: database: 0 host: localhost port: 6379 password: # 密码（默认为空） timeout: 6000ms # 连接超时时长（毫秒） jedis: pool: max-active: 1000 # 连接池最大连接数（使用负值表示没有限制） max-wait: -1ms # 连接池最大阻塞等待时间（使用负值表示没有限制） max-idle: 10 # 连接池中的最大空闲连接 min-idle: 5 # 连接池中的最小空闲连接 renren: redis: open: false #是否开启redis缓存 true开启 false关闭 本项目中，使用Redis服务的代码，如下所示：\npublic class SysConfigServiceImpl implements SysConfigService {  @Autowired  private SysConfigDao sysConfigDao;  @Autowired  private SysConfigRedis sysConfigRedis;   @Override  @Transactional  public void save(SysConfigEntity config) {  sysConfigDao.save(config);  sysConfigRedis.saveOrUpdate(config);  }   @Override  @Transactional  public void update(SysConfigEntity config) {  sysConfigDao.update(config);  sysConfigRedis.saveOrUpdate(config);  }   @Override  @Transactional  public void updateValueByKey(String key, String value) {  sysConfigDao.updateValueByKey(key, value);  sysConfigRedis.delete(key);  }   @Override  @Transactional  public void deleteBatch(Long[] ids) {  sysConfigDao.deleteBatch(ids);  for (Long id : ids) {  SysConfigEntity config = queryObject(id);  sysConfigRedis.delete(config.getKey());  }  } }  @Component public class SysConfigRedis {  @Autowired  private RedisUtils redisUtils;   public void saveOrUpdate(SysConfigEntity config) {  if (config == null) {  return;  }  String key = RedisKeys.getSysConfigKey(config.getKey());  redisUtils.set(key, config);  }   public void delete(String configKey) {  String key = RedisKeys.getSysConfigKey(configKey);  redisUtils.delete(key);  }   public SysConfigEntity get(String configKey) {  String key = RedisKeys.getSysConfigKey(configKey);  return redisUtils.get(key, SysConfigEntity.class);  } }  @Component public class RedisUtils {  @Autowired  private RedisTemplateString, Object redisTemplate;  @Autowired  private ValueOperationsString, String valueOperations;  @Autowired  private HashOperationsString, String, Object hashOperations;  @Autowired  private ListOperationsString, Object listOperations;  @Autowired  private SetOperationsString, Object setOperations;  @Autowired  private ZSetOperationsString, Object zSetOperations;  /** * 默认过期时长，单位：秒 */  public final static long DEFAULT_EXPIRE = 60 * 60 * 24;  /** * 不设置过期时长 */  public final static long NOT_EXPIRE = -1;  private final static Gson gson = new Gson();   public void set(String key, Object value, long expire) {  valueOperations.set(key, toJson(value));  if (expire != NOT_EXPIRE) {  redisTemplate.expire(key, expire, TimeUnit.SECONDS);  }  }   public void set(String key, Object value) {  set(key, value, DEFAULT_EXPIRE);  }   public T T get(String key, ClassT clazz, long expire) {  String value = valueOperations.get(key);  if (expire != NOT_EXPIRE) {  redisTemplate.expire(key, expire, TimeUnit.SECONDS);  }  return value == null ? null : fromJson(value, clazz);  }   public T T get(String key, ClassT clazz) {  return get(key, clazz, NOT_EXPIRE);  }   public String get(String key, long expire) {  String value = valueOperations.get(key);  if (expire != NOT_EXPIRE) {  redisTemplate.expire(key, expire, TimeUnit.SECONDS);  }  return value;  }   public String get(String key) {  return get(key, NOT_EXPIRE);  }   public void delete(String key) {  redisTemplate.delete(key);  }   /** * Object转成JSON数据 */  private String toJson(Object object) {  if (object instanceof Integer || object instanceof Long || object instanceof Float ||  object instanceof Double || object instanceof Boolean || object instanceof St  ring) {  return String.valueOf(object);  }  return gson.toJson(object);  }   /** * JSON数据，转成Object */  private T T fromJson(String json, ClassT clazz) {  return gson.fromJson(json, clazz);  } } 大家可能会有疑问，认为这个项目必须要配置Redis缓存，不然会报错，因为有操作Redis的代码，其实不 然，通过Spring AOP，我们可以控制，是否真的使用Redis，代码如下：\n @Aspect @Component public class RedisAspect {  private Logger logger = LoggerFactory.getLogger(getClass());  /** * 是否开启redis缓存 true开启 false关闭 */  @Value(\"${renren.redis.open: false}\")  private boolean open;   @Around(\"execution(* io.renren.common.utils.RedisUtils.*(..))\")  public Object around(ProceedingJoinPoint point) throws Throwable {  Object result = null;  if (open) {  try {  result = point.proceed();  } catch (Exception e) {  logger.error(\"redis error\", e);  throw new RRException(\"Redis服务异常\");  }  }  return result;  } } 6.6 异常处理机制  本项目通过RRException异常类，抛出自定义异常，RRException继承RuntimeException，不能继承 Exception，如果继承Exception，则Spring事务不会回滚。\n RRException代码如下所示：\npublic class RRException extends RuntimeException {  private static final long serialVersionUID = 1L;  private String msg;  private int code = 500;   public RRException(String msg) {  super(msg);  this.msg = msg;  }   public RRException(String msg, Throwable e) {  super(msg, e);  this.msg = msg;  }   public RRException(String msg, int code) {  super(msg);  this.msg = msg;  this.code = code;  }   public RRException(String msg, int code, Throwable e) {  super(msg, e);  this.msg = msg;  this.code = code;  }   public String getMsg() {  return msg;  }   public void setMsg(String msg) {  this.msg = msg;  }   public int getCode() {  return code;  }   public void setCode(int code) {  this.code = code;  } }  如何处理抛出的异常呢，我们定义了RRExceptionHandler类，并加上注解@RestControllerAdvice，就可以处理所有抛出的异常，并返回JSON数据。@RestControllerAdvice是由@ControllerAdvice、@ResponseBody注解组合而来的，可以查找@ControllerAdvice相关的资料，理解@ControllerAdvice注解 的使用。\n RRExceptionHandler代码如下所示：\n @RestControllerAdvice public class RRExceptionHandler {  private Logger logger = LoggerFactory.getLogger(getClass());   /** * 处理自定义异常 */  @ExceptionHandler(RRException.class)  public R handleRRException(RRException e) {  R r = new R();  r.put(\"code\", e.getCode());  r.put(\"msg\", e.getMessage());  return r;  }   @ExceptionHandler(DuplicateKeyException.class)  public R handleDuplicateKeyException(DuplicateKeyException e) {  logger.error(e.getMessage(), e);  return R.error(\"数据库中已存在该记录\");  }   @ExceptionHandler(AuthorizationException.class)  public R handleAuthorizationException(AuthorizationException e) {  logger.error(e.getMessage(), e);  return R.error(\"没有权限，请联系管理员授权\");  }   @ExceptionHandler(Exception.class)  public R handleException(Exception e) {  logger.error(e.getMessage(), e);  return R.error();  } } 6.7 后端效验机制  本项目，后端效验使用的是Hibernate Validator校验框架，且自定义ValidatorUtils工具类，用来效验数 据。\n Hibernate Validator官方文档： http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/ ValidatorUtils代码如下所示：\npublic class ValidatorUtils {  private static Validator validator;   static {  validator = Validation.buildDefaultValidatorFactory().getValidator();  }   /** * 校验对象 * @param object 待校验对象 * @param groups 待校验的组 * @throws RRException 校验不通过，则报RRException异常 */  public static void validateEntity(Object object, Class... groups) throws RRException {  SetConstraintViolationObject constraintViolations = validator.validate(object, groups);  if (!constraintViolations.isEmpty()) {  ConstraintViolationObject constraint = (ConstraintViolationObject) constraintV  iolations.iterator().next();  throw new RRException(constraint.getMessage());  }  } } 使用案例：\n @RestController @RequestMapping(\"/sys/user\") public class SysUserController extends AbstractController {  /** * 保存用户 */  @SysLog(\"保存用户\")  @RequestMapping(\"/save\")  @RequiresPermissions(\"sys:user:save\")  public R save(@RequestBody SysUserEntity user) { //保存用户时，效验SysUserEntity里，带有AddGroup注解的属性  ValidatorUtils.validateEntity(user, AddGroup.class);  user.setCreateUserId(getUserId());  sysUserService.save(user);  return R.ok();  }   /** * 修改用户 */  @SysLog(\"修改用户\")  @RequestMapping(\"/update\")  @RequiresPermissions(\"sys:user:update\")  public R update(@RequestBody SysUserEntity user) { //修改用户时，效验SysUserEntity里，带有UpdateGroup注解的属性  ValidatorUtils.validateEntity(user, UpdateGroup.class);  user.setCreateUserId(getUserId());  sysUserService.update(user);  return R.ok();  } } public class SysUserEntity implements Serializable {  /** * 用户ID */  private Long userId;  /** * 用户名 */  @NotBlank(message = \"用户名不能为空\", groups = {AddGroup.class, UpdateGroup.class})  private String username;  /** * 密码 */  @NotBlank(message = \"密码不能为空\", groups = AddGroup.class)  private String password;  /** * 盐 */  private String salt;  /** * 邮箱 */  @NotBlank(message = \"邮箱不能为空\", groups = {AddGroup.class, UpdateGroup.class})  @Email(message = \"邮箱格式不正确\", groups = {AddGroup.class, UpdateGroup.class})  private String email;  /** * 手机号 */  private String mobile;  /** * 状态 0：禁用 1：正常 */  private Integer status;  /** * 角色ID列表 */  private ListLong roleIdList;  /** * 创建者ID */  private Long createUserId;  /** * 创建时间 */  private Date createTime; } 通过分析上面的代码，我们来理解Hibernate Validator校验框架的使用。 其中，username属性，表示保存或修改用户时，都会效验username属性；而password属性，表示只有保存用户时，才会效验password属性，也就是说，修改用户时，password可以不填写，允许为空。\n如果不指定属性的groups，则默认属于javax.validation.groups.Default.class分组，可以通过ValidatorUtils.validateEntity(user)进行效验。\n6.8 系统日志 系统日志是通过Spring AOP实现的，我们自定义了注解 @SysLog ，且只能在方法上使用，如下所示：\n @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface SysLog {  String value() default \"\"; } 下面是自定义注解 @SysLog 的使用方式，如下所示：\n @RestController @RequestMapping(\"/sys/user\") public class SysUserController extends AbstractController {  @SysLog(\"保存用户\")  @RequestMapping(\"/save\")  @RequiresPermissions(\"sys:user:save\")  public R save(@RequestBody SysUserEntity user) {  ValidatorUtils.validateEntity(user, AddGroup.class);  user.setCreateUserId(getUserId());  sysUserService.save(user);  return R.ok();  } } 我们可以发现，只需要在保存日志的请求方法上，加上 @SysLog 注解，就可以把日志保存到数据库里了。 具体是在哪里把数据保存到数据库里的呢，我们定义了 SysLogAspect 处理类，就是来干这事的，如下所 示：\n/** * 系统日志，切面处理类 */ @Aspect @Component public class SysLogAspect {  @Autowired  private SysLogService sysLogService;   @Pointcut(\"@annotation(io.renren.common.annotation.SysLog)\")  public void logPointCut() {  }   @Around(\"logPointCut()\")  public Object around(ProceedingJoinPoint point) throws Throwable {  long beginTime = System.currentTimeMillis(); //执行方法  Object result = point.proceed(); //执行时长(毫秒)  long time = System.currentTimeMillis() - beginTime; //保存日志  saveSysLog(point, time);  return result;  }   private void saveSysLog(ProceedingJoinPoint joinPoint, long time) {  MethodSignature signature = (MethodSignature) joinPoint.getSignature();  Method method = signature.getMethod();  SysLogEntity sysLog = new SysLogEntity();  SysLog syslog = method.getAnnotation(SysLog.class);  if (syslog != null) { //注解上的描述  sysLog.setOperation(syslog.value());  } //请求的方法名  String className = joinPoint.getTarget().getClass().getName();  String methodName = signature.getName();  sysLog.setMethod(className + \".\" + methodName + \"()\"); //请求的参数  Object[] args = joinPoint.getArgs();  try {  String params = new Gson().toJson(args[0]);  sysLog.setParams(params);  } catch (Exception e) {  } //获取request  HttpServletRequest request = HttpContextUtils.getHttpServletRequest(); //设置IP地址  sysLog.setIp(IPUtils.getIpAddr(request)); //用户名  String username = ((SysUserEntity) SecurityUtils.getSubject().getPrincipal()).getUser  name();  sysLog.setUsername(username);  sysLog.setTime(time);  sysLog.setCreateDate(new Date()); //保存系统日志  sysLogService.save(sysLog);  } } SysLogAspect 类定义了一个切入点，请求 @SysLog 注解的方法时，会进入 around方法，把系统日志保存到数据库中。\n6.9 添加菜单  菜单管理，主要是对【目录、菜单、按钮】进行动态的新增、修改、删除等操作，方便开发者管理菜单。\n 上图是拿现有的菜单进行讲解。其中，授权标识与shiro中的注解@RequiresPermissions，定义的授权标识是 一一对应的，如下所示：\n @RestController @RequestMapping(\"/sys/config\") public class SysConfigController extends AbstractController {  @RequestMapping(\"/list\")  @RequiresPermissions(\"sys:config:list\")  public R list(@RequestParam MapString, Object params) {  }   @RequestMapping(\"/info/{id}\")  @RequiresPermissions(\"sys:config:info\")  public R info(@PathVariable(\"id\") Long id) {  }   @RequestMapping(\"/save\")  @RequiresPermissions(\"sys:config:save\")  public R save(@RequestBody SysConfigEntity config) {  }   @RequestMapping(\"/update\")  @RequiresPermissions(\"sys:config:update\")  public R update(@RequestBody SysConfigEntity config) {   }   @RequestMapping(\"/delete\")  @RequiresPermissions(\"sys:config:delete\")  public R delete(@RequestBody Long[] ids) {   }  } 6.10 添加角色  管理员权限是通过角色进行管理的，给管理员分配权限时，要先创建好角色。\n 下面创建了一个【开发角色】，如下图所示：\n6.11 添加管理员  本系统默认就创建了admin账号，无需分配任何角色，就拥有最高权限。 一个管理员是可以拥有多个角 色的。\n 下面创建一个【zhangsan】的管理员账号，并属于【开发角色】，如下所示：\n6.12 定时任务模块  本系统使用开源框架Quartz，实现的定时任务，已实现分布式定时任务，可部署多台服务器，不重复执行，以及动态增加、修改、删除、暂停、恢复、立即执行定时任务。 Quartz自带了各数据库的SQL脚本，如果想更改成其他数据库，可参考Quartz相应的SQL脚本。\n 6.12.1 新增定时任务 新增一个定时任务，其实很简单，只要定义一个普通的Spring Bean即可，如下所示：\n@Component(\"testTask\") public class TestTask implements ITask {  private Logger logger = LoggerFactory.getLogger(getClass());   @Override  public void run(String params) {  logger.debug(\"TestTask定时任务正在执行，参数为：{}\", params);  } } 如何让Quartz，定时执行testTask里的方法呢？只需要在管理后台，新增一个定时任务即可，如下图所示：\n刚才配置的定时任务，每隔 30 分钟，就会调用TestTask的test方法了，是不是很简单啊。\n6.12.2 源码分析 Quartz提供了相关的API，我们可以调用API，对Quartz进行增加、修改、删除、暂停、恢复、立即执行等。 本系统中， ScheduleUtils 类就是对Quartz API进行的封装，代码如下所示：\npublic class ScheduleUtils {  private final static String JOB_NAME = \"TASK_\";   /** * 获取触发器key */  private static TriggerKey getTriggerKey(Long jobId) {  return TriggerKey.triggerKey(JOB_NAME + jobId);  }   /** * 获取jobKey */  private static JobKey getJobKey(Long jobId) {  return JobKey.jobKey(JOB_NAME + jobId);  }   /** * 获取表达式触发器 */  public static CronTrigger getCronTrigger(Scheduler scheduler, Long jobId) {  try {  return (CronTrigger) scheduler.getTrigger(getTriggerKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"getCronTrigger异常，请检查qrtz开头的表，是否有脏数据\", e);  }  }   /** * 创建定时任务 */  public static void createScheduleJob(Scheduler scheduler, ScheduleJobEntity scheduleJob) {  try { //构建job信息  JobDetail jobDetail = JobBuilder.newJob(ScheduleJob.class).withIdentity(getJobKey  (scheduleJob.getJobId())).build(); //表达式调度构建器  CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(scheduleJo  b.getCronExpression())  .withMisfireHandlingInstructionDoNothing(); //按新的cronExpression表达式构建一个新的trigger  CronTrigger trigger = TriggerBuilder.newTrigger().withIdentity(getTriggerKey(sche  duleJob.getJobId())).  withSchedule(scheduleBuilder).build(); //放入参数，运行时的方法可以获取  jobDetail.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY, new Gson().toJson(  scheduleJob));  scheduler.scheduleJob(jobDetail, trigger); //暂停任务  if (scheduleJob.getStatus() == ScheduleStatus.PAUSE.getValue()) {  pauseJob(scheduler, scheduleJob.getJobId());  }  } catch (SchedulerException e) {  throw new RRException(\"创建定时任务失败\", e);  }  }   /** * 更新定时任务 */  public static void updateScheduleJob(Scheduler scheduler, ScheduleJobEntity scheduleJob) {  try {  TriggerKey triggerKey = getTriggerKey(scheduleJob.getJobId()); //表达式调度构建器  CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(scheduleJo  b.getCronExpression())  .withMisfireHandlingInstructionDoNothing();  CronTrigger trigger = getCronTrigger(scheduler, scheduleJob.getJobId()); //按新的cronExpression表达式重新构建trigger  trigger = trigger.getTriggerBuilder().withIdentity(triggerKey).withSchedule(sched  uleBuilder).build(); //参数  trigger.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY, new Gson().toJson(sc  heduleJob));  scheduler.rescheduleJob(triggerKey, trigger); //暂停任务  if (scheduleJob.getStatus() == ScheduleStatus.PAUSE.getValue()) {  pauseJob(scheduler, scheduleJob.getJobId());  }  } catch (SchedulerException e) {  throw new RRException(\"更新定时任务失败\", e);  }  }   /** * 立即执行任务 */  public static void run(Scheduler scheduler, ScheduleJobEntity scheduleJob) {  try { //参数  JobDataMap dataMap = new JobDataMap();  dataMap.put(ScheduleJobEntity.JOB_PARAM_KEY, new Gson().toJson(scheduleJob));  scheduler.triggerJob(getJobKey(scheduleJob.getJobId()), dataMap);  } catch (SchedulerException e) {  throw new RRException(\"立即执行定时任务失败\", e);  }  }   /** * 暂停任务 */  public static void pauseJob(Scheduler scheduler, Long jobId) {  try {  scheduler.pauseJob(getJobKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"暂停定时任务失败\", e);  }  }   /** * 恢复任务 */  public static void resumeJob(Scheduler scheduler, Long jobId) {  try {  scheduler.resumeJob(getJobKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"暂停定时任务失败\", e);  }  }   /** * 删除定时任务 */  public static void deleteScheduleJob(Scheduler scheduler, Long jobId) {  try {  scheduler.deleteJob(getJobKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"删除定时任务失败\", e);  }  } } 以下是几个核心的方法：\n  createScheduleJob【创建定时任务】：在管理后台新增任务时，会调用该方法，把任务添加到Quartz 中，再根据cron表达式，定时执行任务。\n  updateScheduleJob【更新定时任务】：修改任务时，调用该方法，修改Quartz中的任务信息。\n  run【立即执行定时任务】：马上执行一次该任务，只执行一次。\n  pauseJob【暂停定时任务】：这个不是暂停正在执行的任务，而是以后不再执行这个定时任务了。正在 执行的任务，还是照常执行完。\n  resumeJob【恢复定时任务】：这个是针对pauseJob来的，如果任务暂停了，以后都不会再执行，要想再执行，则需要调用resumeJob，使定时任务恢复执行。\n  deleteScheduleJob【删除定时任务】：删除定时任务\n  其中， createScheduleJob 、 updateScheduleJob 在启动项目的时候，也会调用，把数据库里，新增或修 改的任务，更新到Quartz中，如下所示：\n @Service(\"scheduleJobService\") public class ScheduleJobServiceImpl implements ScheduleJobService {  /** * 项目启动时，初始化定时器 */  @PostConstruct  public void init() {  ListScheduleJobEntity scheduleJobList = schedulerJobDao.queryList(new HashMap());  for (ScheduleJobEntity scheduleJob : scheduleJobList) {  CronTrigger cronTrigger = ScheduleUtils.getCronTrigger(scheduler, scheduleJob.getJobId());  //如果不存在，则创建  if (cronTrigger == null) {  ScheduleUtils.createScheduleJob(scheduler, scheduleJob);  } else {  ScheduleUtils.updateScheduleJob(scheduler, scheduleJob);  }  }  } } 大家是不是还有疑问呢，怎么就能定时执行，刚才在管理后台新增的任务testTask呢？ 下面我们再来分析 下 createScheduleJob 方法，创建定时任务的时候，要调用该方法，代码如下所示：\n//构建一个新的定时任务，JobBuilder.newJob()只能接受Job类型的参数 //把ScheduleJob.class作为参数传进去，ScheduleJob继承QuartzJobBean，而QuartzJobBean实现了Job接口 JobDetail jobDetail=JobBuilder.newJob(ScheduleJob.class).withIdentity(getJobKey(scheduleJob.getJobId())).build(); //构建cron，定时任务的周期  CronScheduleBuilder scheduleBuilder=CronScheduleBuilder.cronSchedule(scheduleJob.getCronExpression()).withMisfireHandlingInstructionDoNothing(); //根据cron，构建一个CronTrigger  CronTrigger trigger=TriggerBuilder.newTrigger().withIdentity(getTriggerKey(scheduleJob.getJobId())).withSchedule(scheduleBuilder).build(); //放入参数，运行时的方法可以获取  jobDetail.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY,new Gson().toJson(scheduleJob)); //把任务添加到Quartz中  scheduler.scheduleJob(jobDetail,trigger); 把任务添加到 Quartz 后，等cron定义的时间周期到了，就会执行 ScheduleJob 类的 executeInternal 方 法， ScheduleJob 代码如下所示：\npublic class ScheduleJob extends QuartzJobBean {  private Logger logger = LoggerFactory.getLogger(getClass());   @Override  protected void executeInternal(JobExecutionContext context) throws JobExecutionException {  ScheduleJobEntity scheduleJob = (ScheduleJobEntity) context.getMergedJobDataMap()  .get(ScheduleJobEntity.JOB_PARAM_KEY);  //获取spring bean  ScheduleJobLogService scheduleJobLogService = (ScheduleJobLogService) SpringContextUt  ils.getBean(\"scheduleJobLogService\");  //数据库保存执行记录  ScheduleJobLogEntity log = new ScheduleJobLogEntity();  log.setJobId(scheduleJob.getJobId());  log.setBeanName(scheduleJob.getBeanName());  log.setParams(scheduleJob.getParams());  log.setCreateTime(new Date());  //任务开始时间  long startTime = System.currentTimeMillis();  try {  //执行任务  logger.info(\"任务准备执行，任务ID：\" + scheduleJob.getJobId());   Object target = SpringContextUtils.getBean(scheduleJob.getBeanName());  Method method = target.getClass().getDeclaredMethod(\"run\", String.class);  method.invoke(target, scheduleJob.getParams());  //任务执行总时长  long times = System.currentTimeMillis() - startTime;  log.setTimes((int) times);  //任务状态 0 ：成功 1 ：失败   log.setStatus(0);  logger.info(\"任务执行完毕，任务ID：\" + scheduleJob.getJobId() + \" 总共耗时：\" + tim es + \"毫秒\");  } catch (Exception e) {  logger.error(\"任务执行失败，任务ID：\" + scheduleJob.getJobId(), e);  //任务执行总时长  long times = System.currentTimeMillis() - startTime;  log.setTimes((int) times);  //任务状态 0 ：成功 1 ：失败  log.setStatus(1);  log.setError(StringUtils.substring(e.toString(), 0, 2000));  } finally {  scheduleJobLogService.save(log);  }  } } 6.13 云存储模块  图片、文件上传，使用的是七牛、阿里云、腾讯云的存储服务，不能上传到本地服务器。上传到本地 服务器，不利于维护，访问速度慢等缺点，所以推荐使用云存储服务。\n 6.13.1 七牛的配置  如果没有七牛账号，则需要注册七牛账号，才能进行配置，下面演示注册七牛账号并配置，步骤如 下：\n  [注册七牛账号][34]，并登录后，再创建七牛空间，如下图：  进入管理后端，填写七牛配置信息，如下图：  必填项有域名、AccessKey、SecretKey、空间名。其中，空间名就是才创建的空间名 ios-app ，填进去就可 以了。域名、AccessKey、SecretKey可以通过下图找到：\n6.13.2 阿里云的配置  进入管理后端，填写阿里云配置信息，如下图：   进去阿里云管理后台，并创建Bucket，如下图：   通过下面的界面，可以找到域名、BucketName、EndPoint   通过下面的界面，可以找到AccessKeyId、AccessKeySecret  6.13.3 腾讯云的配置  进入管理后端，填写腾讯云配置信息，如下图：   进去腾讯云管理后台，并创建Bucket，如下图：   通过下面的界面，可以找到域名、BucketName、Bucket所属地区   通过下面的界面，可以找到AppId、SecretId、SecretKey  6.13.4 源码分析 本项目的文件上传，使用的是七牛、阿里云、腾讯云，则需要引入他们的SDK，如下：\n   com.qiniu  qiniu-java-sdk  ${qiniu.version}   com.aliyun.oss aliyun-sdk-oss ${aliyun.oss.version}   com.qcloud cos_api ${qcloud.cos.version}     org.slf4j  slf4j-log4j12     定义抽象类 CloudStorageService ，用来声明上传的公共接口，如下所示：\npublic abstract class CloudStorageService {  /** * 云存储配置信息 */  CloudStorageConfig config;   /** * 文件路径 * * @param prefix 前缀 * @param suffix 后缀 * @return 返回上传路径 */  public String getPath(String prefix, String suffix) {  //生成uuid  String uuid = UUID.randomUUID().toString().replaceAll(\"-\", \"\");  //文件路径  String path = DateUtils.format(new Date(), \"yyyyMMdd\") + \"/\" + uuid;  if (StringUtils.isNotBlank(prefix)) {  path = prefix + \"/\" + path;  }  return path + suffix;  }   /** * 文件上传 * * @param data 文件字节数组 * @param path 文件路径，包含文件名 * @return 返回http地址 */  public abstract String upload(byte[] data, String path);   /** * 文件上传 * * @param data 文件字节数组 * @param suffix 后缀 * @return 返回http地址 */  public abstract String uploadSuffix(byte[] data, String suffix);   /** * 文件上传 * * @param inputStream 字节流 * @param path 文件路径，包含文件名 * @return 返回http地址 */  public abstract String upload(InputStream inputStream, String path);   /** * 文件上传 * * @param inputStream 字节流 * @param suffix 后缀 * @return 返回http地址 */  public abstract String uploadSuffix(InputStream inputStream, String suffix); }  七牛上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示：  import com.qiniu.common.Zone; import com.qiniu.http.Response; import com.qiniu.storage.Configuration; import com.qiniu.storage.UploadManager; import com.qiniu.util.Auth; import io.renren.common.exception.RRException; import org.apache.commons.io.IOUtils;  import java.io.IOException; import java.io.InputStream;  /** * 七牛云存储 * * @author Mark sunlightcs@gmail.com */ public class QiniuCloudStorageService extends CloudStorageService {  private UploadManager uploadManager;  private String token;   public QiniuCloudStorageService(CloudStorageConfig config) {  this.config = config; //初始化  init();  }   private void init() {  uploadManager = new UploadManager(new Configuration(Zone.autoZone()));  token = Auth.create(config.getQiniuAccessKey(), config.getQiniuSecretKey()).  uploadToken(config.getQiniuBucketName());  }   @Override  public String upload(byte[] data, String path) {  try {  Response res = uploadManager.put(data, path, token);  if (!res.isOK()) {  throw new RuntimeException(\"上传七牛出错：\" + res.toString());  }  } catch (Exception e) {  throw new RRException(\"上传文件失败，请核对七牛配置信息\", e);  }  return config.getQiniuDomain() + \"/\" + path;  }   @Override  public String upload(InputStream inputStream, String path) {  try {  byte[] data = IOUtils.toByteArray(inputStream);  return this.upload(data, path);  } catch (IOException e) {  throw new RRException(\"上传文件失败\", e);  }  }   @Override  public String uploadSuffix(byte[] data, String suffix) {  return upload(data, getPath(config.getQiniuPrefix(), suffix));  }   @Override  public String uploadSuffix(InputStream inputStream, String suffix) {  return upload(inputStream, getPath(config.getQiniuPrefix(), suffix));  } }  阿里云上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示  import com.aliyun.oss.OSSClient; import io.renren.common.exception.RRException;  import java.io.ByteArrayInputStream; import java.io.InputStream;  /** * 阿里云存储 * * @author Mark sunlightcs@gmail.com */ public class AliyunCloudStorageService extends CloudStorageService {  private OSSClient client;   public AliyunCloudStorageService(CloudStorageConfig config) {  this.config = config; //初始化  init();  }   private void init() {  client = new OSSClient(config.getAliyunEndPoint(), config.getAliyunAccessKeyId(),  config.getAliyunAccessKeySecret());  }   @Override  public String upload(byte[] data, String path) {  return upload(new ByteArrayInputStream(data), path);  }   @Override  public String upload(InputStream inputStream, String path) {  try {  client.putObject(config.getAliyunBucketName(), path, inputStream);  } catch (Exception e) {  throw new RRException(\"上传文件失败，请检查配置信息\", e);  }  return config.getAliyunDomain() + \"/\" + path;  }   @Override  public String uploadSuffix(byte[] data, String suffix) {  return upload(data, getPath(config.getAliyunPrefix(), suffix));  }   @Override  public String uploadSuffix(InputStream inputStream, String suffix) {  return upload(inputStream, getPath(config.getAliyunPrefix(), suffix));  } }  腾讯云上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示：  import com.qcloud.cos.COSClient; import com.qcloud.cos.ClientConfig; import com.qcloud.cos.request.UploadFileRequest; import com.qcloud.cos.sign.Credentials; import io.renren.common.exception.RRException; import net.sf.json.JSONObject; import org.apache.commons.io.IOUtils;  import java.io.IOException; import java.io.InputStream;  /** * 腾讯云存储 * * @author Mark sunlightcs@gmail.com */ public class QcloudCloudStorageService extends CloudStorageService {  private COSClient client;   public QcloudCloudStorageService(CloudStorageConfig config) {  this.config = config; //初始化  init();  }   private void init() {  Credentials credentials = new Credentials(config.getQcloudAppId(), config.getQcloudSe  cretId(),  config.getQcloudSecretKey()); //初始化客户端配置  ClientConfig clientConfig = new ClientConfig(); //设置bucket所在的区域，华南：gz 华北：tj 华东：sh  clientConfig.setRegion(config.getQcloudRegion());  client = new COSClient(clientConfig, credentials);  }   @Override  public String upload(byte[] data, String path) { //腾讯云必需要以\"/\"开头  if (!path.startsWith(\"/\")) {  path = \"/\" + path;  } //上传到腾讯云  UploadFileRequest request = new UploadFileRequest(config.getQcloudBucketName(), path,  data);  String response = client.uploadFile(request);  JSONObject jsonObject = JSONObject.fromObject(response);  if (jsonObject.getInt(\"code\") != 0) {  throw new RRException(\"文件上传失败，\" + jsonObject.getString(\"message\"));  }  return config.getQcloudDomain() + path;  }   @Override  public String upload(InputStream inputStream, String path) {  try {  byte[] data = IOUtils.toByteArray(inputStream);  return this.upload(data, path);  } catch (IOException e) {  throw new RRException(\"上传文件失败\", e);  }  }   @Override  public String uploadSuffix(byte[] data, String suffix) {  return upload(data, getPath(config.getQcloudPrefix(), suffix));  }   @Override  public String uploadSuffix(InputStream inputStream, String suffix) {  return upload(inputStream, getPath(config.getQcloudPrefix(), suffix));  } }  对外提供了OSSFactory工厂，可方便业务的调用，如下所示：  public final class OSSFactory {  private static SysConfigService sysConfigService;   static {  OSSFactory.sysConfigService = (SysConfigService) SpringContextUtils.getBean(\"sysConfi gService\");  }   public static CloudStorageService build() { //获取云存储配置信息  CloudStorageConfig config = sysConfigService.getConfigObject(ConfigConstant.CLOUD_STO  RAGE_CONFIG_KEY, CloudStorageConfig.class);  if (config.getType() == Constant.CloudService.QINIU.getValue()) {  return new QiniuCloudStorageService(config);  } else if (config.getType() == Constant.CloudService.ALIYUN.getValue()) {  return new AliyunCloudStorageService(config);  } else if (config.getType() == Constant.CloudService.QCLOUD.getValue()) {  return new QcloudCloudStorageService(config);  }  return null;  } }  文件上传的例子，如下： @RequestMapping(\"/upload\")  @RequestMapping(\"/upload\") public R upload(@RequestParam(\"file\") MultipartFile file)throws Exception{  if(file.isEmpty()){  throw new RRException(\"上传文件不能为空\");  }  //上传文件，并返回文件的http地址  String url=OSSFactory.build().upload(file.getBytes());  }  } 6.14 APP 模块  APP模块，是针对APP使用的，如IOS、Android等，主要是解决用户认证的问题。\n 6.14.1 APP 的使用  APP的设计思路：用户通过APP，输入手机号、密码登录后，系统会生成与登录用户一一对应的 token，用户调用需要登录的接口时，只需把token传过来，服务端就知道是谁在访问接口，token如果过期，则拒绝访问，从而保证系统的安全性。\n 使用很简单，看看下面的例子，就会使用了。仔细观察，我们会发现，有 2 个自定义的注解。其中， @LoginUser注解是获取当前登录用户的信息，有哪些信息，下面会分析的。@Login注解则是需要用户认证，没有登录的用户，不能访问该接口。\nimport io.renren.modules.app.annotation.Login; import io.renren.modules.app.annotation.LoginUser; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestAttribute; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController;  @RestController @RequestMapping(\"/app\") public class ApiTestController {  /** * 获取用户信息 */  @Login  @GetMapping(\"userInfo\")  public R userInfo(@LoginUser UserEntity user) {  return R.ok().put(\"user\", user);  }   /** * 获取用户ID */  @Login  @GetMapping(\"userId\")  public R userInfo(@RequestAttribute(\"userId\") Integer userId) {  return R.ok().put(\"userId\", userId);  }   /** * 忽略Token验证测试 */  @GetMapping(\"notToken\")  public R notToken() {  return R.ok().put(\"msg\", \"无需token也能访问。。。\");  } } 6.14.2 源码分析  我们先来看看，APP用户登录的时候，都干了那些事情，如下所示：   @RestController @RequestMapping(\"/app\") @Api(\"APP登录接口\") public class ApiLoginController {  @Autowired  private UserService userService;  @Autowired  private JwtUtils jwtUtils;   /** * 登录 */  @PostMapping(\"login\")  @ApiOperation(\"登录\")  public R login(@RequestBody LoginForm form) { \t//表单校验  ValidatorUtils.validateEntity(form); \t//用户登录  long userId = userService.login(form); \t//生成token  String token = jwtUtils.generateToken(userId);  MapString, Object map = new HashMap();  map.put(\"token\", token);  map.put(\"expire\", jwtUtils.getExpire());  return R.ok(map);  } } /** * jwt工具类 */ @ConfigurationProperties(prefix = \"renren.jwt\") @Component public class JwtUtils {  private Logger logger = LoggerFactory.getLogger(getClass());  private String secret;  private long expire;  private String header;   /** * 生成jwt token */  public String generateToken(long userId) {  Date nowDate = new Date(); \t//过期时间  Date expireDate = new Date(nowDate.getTime() + expire * 1000);  return Jwts.builder()  .setHeaderParam(\"typ\", \"JWT\")  .setSubject(userId + \"\")  .setIssuedAt(nowDate)  .setExpiration(expireDate)  .signWith(SignatureAlgorithm.HS512, secret)  .compact();  }   public Claims getClaimByToken(String token) {  try {  return Jwts.parser()  .setSigningKey(secret)  .parseClaimsJws(token)  .getBody();  } catch (Exception e) {  logger.debug(\"validate is token error \", e);  return null;  }  }   /** * token是否过期 * * @return true：过期 */  public boolean isTokenExpired(Date expiration) {  return expiration.before(new Date());  }   public String getSecret() {  return secret;  }   public void setSecret(String secret) {  this.secret = secret;  }   public long getExpire() {  return expire;  }   public void setExpire(long expire) {  this.expire = expire;  }   public String getHeader() {  return header;  }   public void setHeader(String header) {  this.header = header;  } } 我们从上面的代码，可以看到，用户每次登录的时候，都会生成一个唯一的token，这个token是通过jwt生成 的。\n APP模块的核心配置，如下所示：  import io.renren.modules.api.interceptor.AuthorizationInterceptor; import io.renren.modules.api.resolver.LoginUserHandlerMethodArgumentResolver; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.context.annotation.Configuration; import org.springframework.web.method.support.HandlerMethodArgumentResolver; import org.springframework.web.servlet.config.annotation.InterceptorRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;  @Configuration public class WebMvcConfig extends WebMvcConfigurerAdapter {  @Autowired  private AuthorizationInterceptor authorizationInterceptor;  @Autowired  private LoginUserHandlerMethodArgumentResolver loginUserHandlerMethodArgumentResolver;   @Override  public void addInterceptors(InterceptorRegistry registry) {  registry.addInterceptor(authorizationInterceptor).addPathPatterns(\"/app/**\");  }   @Override  public void addArgumentResolvers(ListHandlerMethodArgumentResolver argumentResolvers) {  argumentResolvers.add(loginUserHandlerMethodArgumentResolver);  } } 我们可以看到，配置了个Interceptor，用来拦截 /app 开头的所有请求，拦截后，会到 AuthorizationInterceptor类preHandle方法处理。只有以 /app开头的请求，API模块认证才会起作用，如果要以/api 开头，则需要修改此处。还配置了argumentResolver，别忽略了啊，下面会讲解。\n温馨提示，别忘了配置shiro，不然会被shiro拦截掉的，如下所示：\n @Configuration public class ShiroConfig {  @Bean(\"shiroFilter\")  public ShiroFilterFactoryBean shirFilter(SecurityManager securityManager) { //部分代码省略...  MapString, String filterMap = new LinkedHashMap(); //让shiro放过，以/app开头的请求  filterMap.put(\"/app/**\", \"anon\"); //部分代码省略...  shiroFilter.setFilterChainDefinitionMap(filterMap);  return shiroFilter;  } }  分析AuthorizationInterceptor类，我们可以发现，拦截 /app 开头的请求后，都干了些什么，如下所示：  import io.jsonwebtoken.Claims; import io.renren.common.exception.RRException; import io.renren.modules.app.utils.JwtUtils; import io.renren.modules.app.annotation.Login; import org.apache.commons.lang.StringUtils; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.HttpStatus; import org.springframework.stereotype.Component; import org.springframework.web.method.HandlerMethod; import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;  import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse;  /** * 权限(Token)验证 */ @Component public class AuthorizationInterceptor extends HandlerInterceptorAdapter {  @Autowired  private JwtUtils jwtUtils;  public static final String USER_KEY = \"userId\";   @Override  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object  handler) throws Exception {  Login annotation;  if (handler instanceof HandlerMethod) {  annotation = ((HandlerMethod) handler).getMethodAnnotation(Login.class);  } else {  return true;  }  if (annotation == null) {  return true;  } \t//获取用户凭证  String token = request.getHeader(jwtUtils.getHeader());  if (StringUtils.isBlank(token)) {  token = request.getParameter(jwtUtils.getHeader());  } \t//凭证为空  if (StringUtils.isBlank(token)) {  throw new RRException(jwtUtils.getHeader() + \"不能为空\", HttpStatus.UNAUTHORIZED.v  alue());  }  Claims claims = jwtUtils.getClaimByToken(token);  if (claims == null || jwtUtils.isTokenExpired(claims.getExpiration())) {  throw new RRException(jwtUtils.getHeader() + \"失效，请重新登录\", HttpStatus.UNAUTHO  RIZED.value());  } \t//设置userId到request里，后续根据userId，获取用户信息  request.setAttribute(USER_KEY, Long.parseLong(claims.getSubject()));  return true;  } } 我们可以发现，进入 /app 请求的接口之前，会判断请求的接口，是否加了@Login注解(需要token认证)，如果没有@Login注解，则不验证token，可以直接访问接口。如果有@Login注解，则需要验证token的正确性，并把userId放到request的USER_KEY里，后续会用到。\n 此时，@Login注解的作用，相信大家都明白了。再看看下面的代码，加了@LoginUser注解后，user对象里，就变成当前登录用户的信息，这是什么时候设置进去的呢？  /** * 获取用户信息 */ @GetMapping(\"userInfo\") public R userInfo(@LoginUser UserEntity user){  return R.ok().put(\"user\",user); }  设置user对象进去，其实是在LoginUserHandlerMethodArgumentResolver里干的,LoginUserHandlerMethodArgumentResolver是我们自定义的参数转换器，只要实现HandlerMethodArgumentResolver接口即可，代码如下所示：  import io.renren.modules.api.annotation.LoginUser; import io.renren.modules.api.entity.UserEntity; import io.renren.modules.api.interceptor.AuthorizationInterceptor; import io.renren.modules.api.service.UserService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.core.MethodParameter; import org.springframework.stereotype.Component; import org.springframework.web.bind.support.WebDataBinderFactory; import org.springframework.web.context.request.NativeWebRequest; import org.springframework.web.context.request.RequestAttributes; import org.springframework.web.method.support.HandlerMethodArgumentResolver; import org.springframework.web.method.support.ModelAndViewContainer;  @Component public class LoginUserHandlerMethodArgumentResolver implements HandlerMethodArgumentResolver {  @Autowired  private UserService userService;   @Override  public boolean supportsParameter(MethodParameter parameter) { //如果方法的参数是UserEntity，且参数前面有@LoginUser注解，则进入resolveArgument方法，进行  处理  return parameter.getParameterType().isAssignableFrom(UserEntity.class) \u0026\u0026 parameter.h  asParameterAnnotation(LoginUser.class);  }   @Override  public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer container,  NativeWebRequest request, WebDataBinderFactory factory) thr   ows Exception   { //获取用户ID，之前设置进去的，还有印象吧  Object object = request.getAttribute(AuthorizationInterceptor.USER_KEY, RequestAttrib  utes.SCOPE_REQUEST);  if (object == null) {  return null;  } //通过userId，获取用户信息  UserEntity user = userService.queryObject((Long) object); //把当前用户信息，设置到UserEntity参数的user对象里  return user;  } } 第 7 章 生产环境部署  部署项目前，需要准备JDK8、Maven、MySQL5.5+环境，参考开发环境搭建。\n 7.1 jar 包部署 7.2 docker 部署 7.3 集群部署 7.1 jar 包部署  Spring Boot项目，推荐打成jar包的方式，部署到服务器上。\n  Spring Boot内置了Tomcat，可配置Tomcat的端口号、初始化线程数、最大线程数、连接超时时长、https 等等，如下所示：  server: tomcat: uri-encoding: UTF-8 max-threads: 1000 min-spare-threads: 30 port: 8080 connection-timeout: 5000ms servlet: context-path: /renren-fast session: cookie: http-only: true ssl: key-store: classpath:.keystore key-store-type: JKS key-password: 123456 key-alias: tomcat  当然，还可以指定jvm的内存大小，如下所示：  java -Xms4g -Xmx4g -Xmn1g -server -jar renren-fast.jar  在windows下部署，只需打开cmd窗口，输入如下命令：  java -jar renren-fast.jar --spring.profiles.active=prod  在Linux下部署，只需输入如下命令，即可在Linux后台运行：  nohup java -jar renren-fast.jar --spring.profiles.active=prod  renren.log \u0026  在Linux环境下，我们一般可以创建shell脚本，用于重启项目，如下所示：  #创建启动的shell脚本 [root@renren renren-fast]# vim start.sh #!/bin/sh  process=`ps -fe|grep \"renren-fast.jar\" |grep -ivE \"grep|cron\" |awk '{print $2}'` if [ !$process ]; then \techo \"stop erp process $process.....\" \tkill -9 $process  sleep 1 fi  echo \"start erp process.....\" nohup java -Dspring.profiles.active=prod -jar renren-fast.jar --server.port=8080 --server.servlet.context-path=/renren-fast 2\u00261 | cronolog log.%Y-%m-%d.out  /dev/null \u0026  echo \"start erp success!\"  #通过shell脚本启动项目 [root@renren renren-fast]# yum install -y cronolog [root@renren renren-fast]# chomd +x start.sh [root@renren renren-fast]# ./start.sh 7.2 docker 部署 安装docker环境\n#安装docker [root@mark ~]# curl -sSL https://get.docker.com/ | sh  #启动docker [root@mark ~]# service docker start  #查看docker版本信息 [root@mark ~]# docker version Client:  Version: 17.07.0-ce  API version: 1.31  Go version: go1.8.3  Git commit: 8784753  Built: Tue Aug 29 17:42:01 2017  OS/Arch: linux/amd64 Server:  Version: 17.07.0-ce  API version: 1.31 (minimum version 1.12)  Go version: go1.8.3  Git commit: 8784753  Built: Tue Aug 29 17:43:23 2017  OS/Arch: linux/amd64  Experimental: false  还需要准备java、maven环境，请自行安装 通过maven插件，构建docker镜像  打包并构建项目镜像 [root@mark renren-fast]# mvn clean package docker:build #省略打包log... [INFO] Building image renren/fast Step 1/6 : FROM java:8 \t--- d23bdf5b1b1b Step 2/6 : EXPOSE 8080  --- Using cache  --- 8e33aadb2c18 Step 3/6 : VOLUME /tmp  --- Using cache  --- c5dc0c509062 Step 4/6 : ADD renren-fast-1.2.0.jar /app.jar  --- 831bc3ca84bc Step 5/6 : RUN bash -c 'touch /app.jar'  --- Running in fe3ef9343e4c  --- b3d6dd6fc297 Removing intermediate container fe3ef9343e4c Step 6/6 : ENTRYPOINT java -jar /app.jar  --- Running in 89adce4ae167  --- a4ae60970a77 Removing intermediate container 89adce4ae167 ProgressMessage{id=null, status=null, stream=null, error=null, progress=null, progressDetail= null} Successfully built a4ae60970a77 Successfully tagged renren/fast:latest   # 查看镜像 [root@mark renren-fast]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE renren/fast latest a4ae60970a77 14 seconds ago 714MB java 8 d23bdf5b1b1b 7 months ago 643MB  安装docker-compose，用来管理容器  #下载地址：https://github.com/docker/compose/releases #下载docker-compose [root@mark renren-fast]# curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m`  /usr/local/bin/docker-compose #增加可执行权限 [root@mark renren-fast]# chmod +x /usr/local/bin/docker-compose #查看版本信息 [root@mark renren-fast]# docker-compose version docker-compose version 1.16.1, build 6d1ac21 docker-py version: 2.5.1 CPython version: 2.7.13 OpenSSL version: OpenSSL 1.0.1t 3 May 2016 如果下载不了，可以用迅雷将https://github.com/docker/compose/releases/download/1.16.1/docker-compose- Linux-x86_64下载到本地，再上传到服务器\n 通过docker-compose，启动项目，如下所示：  #启动项目 [root@mark renren-fast]# docker-compose up -d Creating network \"renrenfast_default\" with the default driver Creating renrenfast_campus_1 ... Creating renrenfast_campus_1 ... done  #查看启动的容器 [root@mark renren-fast]# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES f4e3fcdd8dd4 renren/fast \"java -jar /app.jar\" 55 seconds ago Up 3 seconds 0.0.0.0:8080-8080/tcp renrenfast_renren-fast_1    #停掉并删除，docker-compose管理的容器 [root@mark renren-fast]# docker-compose down Stopping renrenfast_renren-fast_1 ... done Removing renrenfast_renren-fast_1 ... done Removing network renrenfast_default 7.3 集群部署  本系统支持集群部署，集群部署，只需启动多个节点，并配置Nginx即可。\n  配置Nginx  http { upstream renren { server localhost:8080; server localhost:8081; } server { listen 80; server_name localhost; location /renren-fast { proxy_pass http://renren; client_max_body_size 1024m; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $host; proxy_redirect off; } } }  通过http://localhost/renren-fast，就可以访问了  ","wordCount":"23128","inLanguage":"zh","datePublished":"2022-03-16T10:05:00Z","dateModified":"2022-03-16T10:05:00Z","author":{"@type":"Person","name":"swimminghao"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/"},"publisher":{"@type":"Organization","name":"swimminghao","logo":{"@type":"ImageObject","url":"https://swimminghao1.github.io/favicon.ico"}}}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://swimminghao1.github.io/ accesskey=h title="🍀 swimminghao (Alt + H)">🍀 swimminghao</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://swimminghao1.github.io/categories/ title="🗂 归类"><span>🗂 归类</span></a></li><li><a href=https://swimminghao1.github.io/tags/ title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li><a href=https://swimminghao1.github.io/archives/ title="⏱️ 时间轴"><span>⏱️ 时间轴</span></a></li><li><a href=https://swimminghao1.github.io/search/ title="🔍 索引 (Alt + /)" accesskey=/><span>🔍 索引</span></a></li><li><a href=https://swimminghao1.github.io/friends title="🧑‍🤝‍🧑 友链"><span>🧑‍🤝‍🧑 友链</span></a></li><li><a href=https://www.travellings.cn/go.html title=🚇><span>🚇</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://swimminghao1.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://swimminghao1.github.io/post/>📚文章</a></div><h1 class=post-title><a href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/>renren-fast开发文档3.0最新版</a></h1><div class=post-meta>March 16, 2022&nbsp;·&nbsp;47 分钟&nbsp;·&nbsp;23128 字&nbsp;·&nbsp;swimminghao&nbsp;|&nbsp;<a href=https://github.com/songtianlun/songtianlun.github.io/edit/main/content/post/02%e4%b8%aa%e4%ba%ba%e5%ad%a6%e4%b9%a0/06_04_spring/%e8%84%9a%e6%89%8b%e6%9e%b6/renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88.md rel="noopener noreferrer" target=_blank>PR</a>
<span>| <span class=waline-pageview-count data-path=/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/><i class="fa fa-spinner fa-spin"></i></span> Hits</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a330%e6%9c%80%e6%96%b0%e7%89%88 aria-label=renren-fast开发文档3.0最新版>renren-fast开发文档3.0最新版</a></li><li><a href=#%e7%89%88%e6%9d%83%e8%af%b4%e6%98%8e aria-label=版权说明>版权说明</a></li><li><a href=#%e5%85%8d%e8%b4%a3%e5%a3%b0%e6%98%8e aria-label=免责声明>免责声明</a></li><li><a href=#%e6%96%87%e6%a1%a3%e6%9b%b4%e6%96%b0 aria-label=文档更新>文档更新</a></li><li><a href=#%e7%ac%ac-1-%e7%ab%a0-%e9%a1%b9%e7%9b%ae%e4%bb%8b%e7%bb%8d aria-label="第 1 章 项目介绍">第 1 章 项目介绍</a><ul><li><a href=#11-%e9%a1%b9%e7%9b%ae%e6%8f%8f%e8%bf%b0 aria-label="1.1 项目描述">1.1 项目描述</a></li><li><a href=#12-%e9%a1%b9%e7%9b%ae%e7%89%b9%e7%82%b9 aria-label="1.2 项目特点">1.2 项目特点</a></li><li><a href=#13-%e6%95%b0%e6%8d%ae%e4%ba%a4%e4%ba%92 aria-label="1.3 数据交互">1.3 数据交互</a></li><li><a href=#14-%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba aria-label="1.4 开发环境搭建">1.4 开发环境搭建</a></li><li><a href=#15-%e8%8e%b7%e5%8f%96%e5%b8%ae%e5%8a%a9 aria-label="1.5 获取帮助">1.5 获取帮助</a></li><li><a href=#11-%e9%a1%b9%e7%9b%ae%e6%8f%8f%e8%bf%b0-1 aria-label="1.1 项目描述">1.1 项目描述</a></li><li><a href=#12-%e9%a1%b9%e7%9b%ae%e7%89%b9%e7%82%b9-1 aria-label="1.2 项目特点">1.2 项目特点</a></li><li><a href=#13-%e6%95%b0%e6%8d%ae%e4%ba%a4%e4%ba%92-1 aria-label="1.3 数据交互">1.3 数据交互</a></li><li><a href=#14-%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba-1 aria-label="1.4 开发环境搭建">1.4 开发环境搭建</a><ul><li><a href=#141-%e8%bd%af%e4%bb%b6%e9%9c%80%e6%b1%82 aria-label="1.4.1 软件需求">1.4.1 软件需求</a></li><li><a href=#142-%e4%b8%8b%e8%bd%bd%e6%ba%90%e7%a0%81 aria-label="1.4.2 下载源码">1.4.2 下载源码</a></li><li><a href=#143-idea-%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7 aria-label="1.4.3 IDEA 开发工具">1.4.3 IDEA 开发工具</a></li><li><a href=#144-eclipse-%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7 aria-label="1.4.4 Eclipse 开发工具">1.4.4 Eclipse 开发工具</a></li><li><a href=#145-%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93 aria-label="1.4.5 创建数据库">1.4.5 创建数据库</a></li><li><a href=#146-%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="1.4.6 修改配置文件">1.4.6 修改配置文件</a></li><li><a href=#147-%e5%89%8d%e7%ab%af%e9%83%a8%e7%bd%b2 aria-label="1.4.7 前端部署">1.4.7 前端部署</a></li></ul></li><li><a href=#15-%e8%8e%b7%e5%8f%96%e5%b8%ae%e5%8a%a9-1 aria-label="1.5 获取帮助">1.5 获取帮助</a></li></ul></li><li><a href=#%e7%ac%ac-2-%e7%ab%a0-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="第 2 章 数据库支持">第 2 章 数据库支持</a><ul><li><a href=#21-mysql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.1 MySQL 数据库支持">2.1 MySQL 数据库支持</a></li><li><a href=#22-oracle-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.2 Oracle 数据库支持">2.2 Oracle 数据库支持</a></li><li><a href=#23-sql-server-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.3 SQL Server 数据库支持">2.3 SQL Server 数据库支持</a></li><li><a href=#24-postgresql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.4 PostgreSQL 数据库支持">2.4 PostgreSQL 数据库支持</a></li><li><a href=#21-mysql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.1 MySQL 数据库支持">2.1 MySQL 数据库支持</a></li><li><a href=#22-oracle-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.2 Oracle 数据库支持">2.2 Oracle 数据库支持</a></li><li><a href=#23-sql-server-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.3 SQL Server 数据库支持">2.3 SQL Server 数据库支持</a></li><li><a href=#24-postgresql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.4 PostgreSQL 数据库支持">2.4 PostgreSQL 数据库支持</a></li></ul></li><li><a href=#%e7%ac%ac-3-%e7%ab%a0-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e6%94%af%e6%8c%81 aria-label="第 3 章 多数据源支持">第 3 章 多数据源支持</a><ul><li><a href=#31-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e9%85%8d%e7%bd%ae aria-label="3.1 多数据源配置">3.1 多数据源配置</a></li><li><a href=#32-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e4%bd%bf%e7%94%a8 aria-label="3.2 多数据源使用">3.2 多数据源使用</a></li><li><a href=#33-%e6%ba%90%e7%a0%81%e8%ae%b2%e8%a7%a3 aria-label="3.3 源码讲解">3.3 源码讲解</a></li><li><a href=#31-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e9%85%8d%e7%bd%ae-1 aria-label="3.1 多数据源配置">3.1 多数据源配置</a></li><li><a href=#%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e9%85%8d%e7%bd%ae aria-label=多数据源的配置>多数据源的配置</a></li><li><a href=#32-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e4%bd%bf%e7%94%a8-1 aria-label="3.2 多数据源使用">3.2 多数据源使用</a></li><li><a href=#33-%e6%ba%90%e7%a0%81%e8%ae%b2%e8%a7%a3-1 aria-label="3.3 源码讲解">3.3 源码讲解</a></li></ul></li><li><a href=#%e7%ac%ac-4-%e7%ab%a0-%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86%e8%ae%b2%e8%a7%a3 aria-label="第 4 章 基础知识讲解">第 4 章 基础知识讲解</a><ul><li><a href=#41-spring-mvc-%e4%bd%bf%e7%94%a8 aria-label="4.1 Spring MVC 使用">4.1 Spring MVC 使用</a></li><li><a href=#42-swagger-%e4%bd%bf%e7%94%a8 aria-label="4.2 Swagger 使用">4.2 Swagger 使用</a></li><li><a href=#43-mybatis-plus-%e4%bd%bf%e7%94%a8 aria-label="4.3 Mybatis-plus 使用">4.3 Mybatis-plus 使用</a></li><li><a href=#41-spring-mvc-%e4%bd%bf%e7%94%a8-1 aria-label="4.1 Spring MVC 使用">4.1 Spring MVC 使用</a><ul><li><a href=#411-controller-%e6%b3%a8%e8%a7%a3 aria-label="4.1.1 @Controller 注解">4.1.1 @Controller 注解</a></li><li><a href=#412-requestmapping-%e6%b3%a8%e8%a7%a3 aria-label="4.1.2 @RequestMapping 注解">4.1.2 @RequestMapping 注解</a></li><li><a href=#413-pathvariable-%e6%b3%a8%e8%a7%a3 aria-label="4.1.3 @PathVariable 注解">4.1.3 @PathVariable 注解</a></li><li><a href=#414-getmapping-%e6%b3%a8%e8%a7%a3 aria-label="4.1.4 @GetMapping 注解">4.1.4 @GetMapping 注解</a></li><li><a href=#415-requestbody-%e6%b3%a8%e8%a7%a3 aria-label="4.1.5 @RequestBody 注解">4.1.5 @RequestBody 注解</a></li><li><a href=#416-responsebody-%e6%b3%a8%e8%a7%a3 aria-label="4.1.6 @ResponseBody 注解">4.1.6 @ResponseBody 注解</a></li><li><a href=#417-restcontroller-%e6%b3%a8%e8%a7%a3 aria-label="4.1.7 @RestController 注解">4.1.7 @RestController 注解</a></li></ul></li><li><a href=#42-swagger-%e4%bd%bf%e7%94%a8-1 aria-label="4.2 Swagger 使用">4.2 Swagger 使用</a><ul><li><a href=#421-%e6%90%ad%e5%bb%ba-swagger-%e7%8e%af%e5%a2%83 aria-label="4.2.1 搭建 Swagger 环境">4.2.1 搭建 Swagger 环境</a></li><li><a href=#422-swagger-%e5%b8%b8%e7%94%a8%e6%b3%a8%e8%a7%a3 aria-label="4.2.2 Swagger 常用注解">4.2.2 Swagger 常用注解</a></li></ul></li><li><a href=#43-mybatis-plus-%e4%bd%bf%e7%94%a8-1 aria-label="4.3 Mybatis-plus 使用">4.3 Mybatis-plus 使用</a></li></ul></li><li><a href=#%e7%ac%ac-5-%e7%ab%a0-%e9%a1%b9%e7%9b%ae%e5%ae%9e%e6%88%98 aria-label="第 5 章 项目实战">第 5 章 项目实战</a><ul><li><a href=#51-%e9%9c%80%e6%b1%82%e8%af%b4%e6%98%8e aria-label="5.1 需求说明">5.1 需求说明</a></li><li><a href=#52-%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e5%99%a8 aria-label="5.2 代码生成器">5.2 代码生成器</a></li><li><a href=#51-%e9%9c%80%e6%b1%82%e8%af%b4%e6%98%8e-1 aria-label="5.1 需求说明">5.1 需求说明</a></li><li><a href=#51-%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e5%99%a8 aria-label="5.1 代码生成器">5.1 代码生成器</a></li></ul></li><li><a href=#%e7%ac%ac-6-%e7%ab%a0-%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="第 6 章 后端源码分析">第 6 章 后端源码分析</a><ul><li><a href=#61-%e5%89%8d%e5%90%8e%e7%ab%af%e5%88%86%e7%a6%bb aria-label="6.1 前后端分离">6.1 前后端分离</a></li><li><a href=#62-%e6%9d%83%e9%99%90%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af aria-label="6.2 权限设计思路">6.2 权限设计思路</a></li><li><a href=#63-xss-%e8%84%9a%e6%9c%ac%e8%bf%87%e6%bb%a4 aria-label="6.3 XSS 脚本过滤">6.3 XSS 脚本过滤</a></li><li><a href=#64-sql-%e6%b3%a8%e5%85%a5 aria-label="6.4 SQL 注入">6.4 SQL 注入</a></li><li><a href=#65-redis-%e7%bc%93%e5%ad%98 aria-label="6.5 Redis 缓存">6.5 Redis 缓存</a></li><li><a href=#66-%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86%e6%9c%ba%e5%88%b6 aria-label="6.6 异常处理机制">6.6 异常处理机制</a></li><li><a href=#67-%e5%90%8e%e7%ab%af%e6%95%88%e9%aa%8c%e6%9c%ba%e5%88%b6 aria-label="6.7 后端效验机制">6.7 后端效验机制</a></li><li><a href=#68-%e7%b3%bb%e7%bb%9f%e6%97%a5%e5%bf%97 aria-label="6.8 系统日志">6.8 系统日志</a></li><li><a href=#69-%e6%b7%bb%e5%8a%a0%e8%8f%9c%e5%8d%95 aria-label="6.9 添加菜单">6.9 添加菜单</a></li><li><a href=#610-%e6%b7%bb%e5%8a%a0%e8%a7%92%e8%89%b2 aria-label="6.10 添加角色">6.10 添加角色</a></li><li><a href=#611-%e6%b7%bb%e5%8a%a0%e7%ae%a1%e7%90%86%e5%91%98 aria-label="6.11 添加管理员">6.11 添加管理员</a></li><li><a href=#612-%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e6%a8%a1%e5%9d%97 aria-label="6.12 定时任务模块">6.12 定时任务模块</a></li><li><a href=#613-%e4%ba%91%e5%ad%98%e5%82%a8%e6%a8%a1%e5%9d%97 aria-label="6.13 云存储模块">6.13 云存储模块</a></li><li><a href=#614-app-%e6%a8%a1%e5%9d%97 aria-label="6.14 APP 模块">6.14 APP 模块</a></li><li><a href=#61-%e5%89%8d%e5%90%8e%e7%ab%af%e5%88%86%e7%a6%bb-1 aria-label="6.1 前后端分离">6.1 前后端分离</a></li><li><a href=#62-%e6%9d%83%e9%99%90%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af-1 aria-label="6.2 权限设计思路">6.2 权限设计思路</a></li><li><a href=#63-xss-%e8%84%9a%e6%9c%ac%e8%bf%87%e6%bb%a4-1 aria-label="6.3 XSS 脚本过滤">6.3 XSS 脚本过滤</a></li><li><a href=#64-sql-%e6%b3%a8%e5%85%a5-1 aria-label="6.4 SQL 注入">6.4 SQL 注入</a></li><li><a href=#65-redis-%e7%bc%93%e5%ad%98-1 aria-label="6.5 Redis 缓存">6.5 Redis 缓存</a></li><li><a href=#66-%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86%e6%9c%ba%e5%88%b6-1 aria-label="6.6 异常处理机制">6.6 异常处理机制</a></li><li><a href=#67-%e5%90%8e%e7%ab%af%e6%95%88%e9%aa%8c%e6%9c%ba%e5%88%b6-1 aria-label="6.7 后端效验机制">6.7 后端效验机制</a></li><li><a href=#68-%e7%b3%bb%e7%bb%9f%e6%97%a5%e5%bf%97-1 aria-label="6.8 系统日志">6.8 系统日志</a></li><li><a href=#69-%e6%b7%bb%e5%8a%a0%e8%8f%9c%e5%8d%95-1 aria-label="6.9 添加菜单">6.9 添加菜单</a></li><li><a href=#610-%e6%b7%bb%e5%8a%a0%e8%a7%92%e8%89%b2-1 aria-label="6.10 添加角色">6.10 添加角色</a></li><li><a href=#611-%e6%b7%bb%e5%8a%a0%e7%ae%a1%e7%90%86%e5%91%98-1 aria-label="6.11 添加管理员">6.11 添加管理员</a></li><li><a href=#612-%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e6%a8%a1%e5%9d%97-1 aria-label="6.12 定时任务模块">6.12 定时任务模块</a><ul><li><a href=#6121-%e6%96%b0%e5%a2%9e%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1 aria-label="6.12.1 新增定时任务">6.12.1 新增定时任务</a><ul><li><a href=#6122-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="6.12.2 源码分析">6.12.2 源码分析</a></li></ul></li></ul></li><li><a href=#613-%e4%ba%91%e5%ad%98%e5%82%a8%e6%a8%a1%e5%9d%97-1 aria-label="6.13 云存储模块">6.13 云存储模块</a><ul><li><a href=#6131-%e4%b8%83%e7%89%9b%e7%9a%84%e9%85%8d%e7%bd%ae aria-label="6.13.1 七牛的配置">6.13.1 七牛的配置</a></li><li><a href=#6132-%e9%98%bf%e9%87%8c%e4%ba%91%e7%9a%84%e9%85%8d%e7%bd%ae aria-label="6.13.2 阿里云的配置">6.13.2 阿里云的配置</a><ul><li><a href=#6133-%e8%85%be%e8%ae%af%e4%ba%91%e7%9a%84%e9%85%8d%e7%bd%ae aria-label="6.13.3 腾讯云的配置">6.13.3 腾讯云的配置</a></li><li><a href=#6134-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="6.13.4 源码分析">6.13.4 源码分析</a></li></ul></li></ul></li><li><a href=#614-app-%e6%a8%a1%e5%9d%97-1 aria-label="6.14 APP 模块">6.14 APP 模块</a><ul><li><a href=#6141-app-%e7%9a%84%e4%bd%bf%e7%94%a8 aria-label="6.14.1 APP 的使用">6.14.1 APP 的使用</a></li><li><a href=#6142-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="6.14.2 源码分析">6.14.2 源码分析</a></li></ul></li></ul></li><li><a href=#%e7%ac%ac-7-%e7%ab%a0-%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83%e9%83%a8%e7%bd%b2 aria-label="第 7 章 生产环境部署">第 7 章 生产环境部署</a><ul><li><a href=#71-jar-%e5%8c%85%e9%83%a8%e7%bd%b2 aria-label="7.1 jar 包部署">7.1 jar 包部署</a></li><li><a href=#72-docker-%e9%83%a8%e7%bd%b2 aria-label="7.2 docker 部署">7.2 docker 部署</a></li><li><a href=#73-%e9%9b%86%e7%be%a4%e9%83%a8%e7%bd%b2 aria-label="7.3 集群部署">7.3 集群部署</a><ul><li><a href=#71-jar-%e5%8c%85%e9%83%a8%e7%bd%b2-1 aria-label="7.1 jar 包部署">7.1 jar 包部署</a></li></ul></li><li><a href=#72-docker-%e9%83%a8%e7%bd%b2-1 aria-label="7.2 docker 部署">7.2 docker 部署</a></li><li><a href=#%e6%89%93%e5%8c%85%e5%b9%b6%e6%9e%84%e5%bb%ba%e9%a1%b9%e7%9b%ae%e9%95%9c%e5%83%8f aria-label=打包并构建项目镜像>打包并构建项目镜像</a></li><li><a href=#73-%e9%9b%86%e7%be%a4%e9%83%a8%e7%bd%b2-1 aria-label="7.3 集群部署">7.3 集群部署</a></li></ul></li></ul></div><div><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7296634171837358 data-ad-slot=9161921641 data-ad-format=auto data-full-width-responsive=true></ins></div><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></details></div><div class=post-content><blockquote style=margin-top:8px><p style=text-align:center;text-indent:0><a href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/>本文</a>
首发于
<a href=https://swimminghao1.github.io/>🍀 永浩</a>，
<a href=/disclaimer/>转载</a> 请注明
<a href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/>来源</a>。</p></blockquote><h1 id=renren-fast开发文档30最新版>renren-fast开发文档3.0最新版<a hidden class=anchor aria-hidden=true href=#renren-fast开发文档30最新版>#</a></h1><h1 id=版权说明>版权说明<a hidden class=anchor aria-hidden=true href=#版权说明>#</a></h1><blockquote><p>本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述的内容受有关法律的版权保护，对本文档以任何形式的非法复制、泄露或散布到网络提供下载，都将导致相应的法律责任。</p></blockquote><h1 id=免责声明>免责声明<a hidden class=anchor aria-hidden=true href=#免责声明>#</a></h1><blockquote><p>本文档仅提供阶段性信息，所含内容可根据项目的实际情况随时更新，以人人开源社区公告为准。如因文档使用不当造成的直接或间接损失，人人开源不承担任何责任。</p></blockquote><h1 id=文档更新>文档更新<a hidden class=anchor aria-hidden=true href=#文档更新>#</a></h1><blockquote><p>本文档由人人开源于 2019 年 03 月 01 日最后修订。</p></blockquote><h1 id=第-1-章-项目介绍>第 1 章 项目介绍<a hidden class=anchor aria-hidden=true href=#第-1-章-项目介绍>#</a></h1><blockquote><p>人人权限系统是一套轻量级的权限系统，主要包括用户管理、角色管理、部门管理、菜单管理、定时任务、 参数管理、字典管理、文件上传、登录日志、操作日志、异常日志、文章管理、APP模块等功能。其中，还拥有多数据源、数据权限、国际化支持、Redis缓存动态开启与关闭、统一异常处理等技术特点。</p></blockquote><h2 id=11-项目描述>1.1 项目描述<a hidden class=anchor aria-hidden=true href=#11-项目描述>#</a></h2><h2 id=12-项目特点>1.2 项目特点<a hidden class=anchor aria-hidden=true href=#12-项目特点>#</a></h2><h2 id=13-数据交互>1.3 数据交互<a hidden class=anchor aria-hidden=true href=#13-数据交互>#</a></h2><h2 id=14-开发环境搭建>1.4 开发环境搭建<a hidden class=anchor aria-hidden=true href=#14-开发环境搭建>#</a></h2><h2 id=15-获取帮助>1.5 获取帮助<a hidden class=anchor aria-hidden=true href=#15-获取帮助>#</a></h2><h2 id=11-项目描述-1>1.1 项目描述<a hidden class=anchor aria-hidden=true href=#11-项目描述-1>#</a></h2><p>renren-fast是一套轻量级的权限系统，主要包括用户管理、角色管理、菜单管理、定时任务、文件上传、系 统日志、APP模块等功能。其中，还拥有多数据源、Redis缓存动态开启与关闭、统一异常处理等技术特 点。</p><h2 id=12-项目特点-1>1.2 项目特点<a hidden class=anchor aria-hidden=true href=#12-项目特点-1>#</a></h2><ul><li><a href=https://gitee.com/renrenio/renren-fast>renren-fast</a>采用SpringBoot 2.1、MyBatis、Shiro框架，开发的一套权限系统，极低门槛，拿来即用。设
计之初，就非常注重安全性，为企业系统保驾护航，让一切都变得如此简单。</li><li>灵活的权限控制，可控制到页面或按钮，满足绝大部分的权限需求</li><li>完善的 XSS 防范及脚本过滤，彻底杜绝 XSS 攻击</li><li>支持MySQL、Oracle、SQL Server、PostgreSQL等主流数据库</li><li></li></ul><p>推荐使用阿里云服务器部署项目，免费领取阿里云优惠券，请点击<a href="https://www.aliyun.com/minisite/goods?userCode=y93lfwbg&productCode=dmspre&utm_source=y93lfwbg">【免费领取】</a></p><h2 id=13-数据交互-1>1.3 数据交互<a hidden class=anchor aria-hidden=true href=#13-数据交互-1>#</a></h2><ul><li>一般情况下，web项目都是通过session进行认证，每次请求数据时，都会把jsessionid放在cookie中，以便与服务端保持会话</li><li>本项目是前后端分离的，通过token进行认证（登录时，生成唯一的token凭证），每次请求数据时，都会把token放在header中，服务端解析token，并确定用户身份及用户权限，数据通过json交互</li><li>数据交互流程，如下所示：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7nZ7nU.png alt></p><h2 id=14-开发环境搭建-1>1.4 开发环境搭建<a hidden class=anchor aria-hidden=true href=#14-开发环境搭建-1>#</a></h2><h3 id=141-软件需求>1.4.1 软件需求<a hidden class=anchor aria-hidden=true href=#141-软件需求>#</a></h3><ul><li>JDK 1.8+</li><li>Maven 3.0+</li><li>MySQL 5.5+</li><li>Oracle 11g+</li><li>SQL Server 2012+</li><li>PostgreSQL 9.4+</li></ul><h3 id=142-下载源码>1.4.2 下载源码<a hidden class=anchor aria-hidden=true href=#142-下载源码>#</a></h3><ul><li>通过 git ，下载renren-fast源码，如下：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://gitee.com/renrenio/renren-fast.git
</span></span></code></pre></div><h3 id=143-idea-开发工具>1.4.3 IDEA 开发工具<a hidden class=anchor aria-hidden=true href=#143-idea-开发工具>#</a></h3><ul><li>IDEA打开项目， File -> Open 如下图：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/EVCSoB.png alt></p><h3 id=144-eclipse-开发工具>1.4.4 Eclipse 开发工具<a hidden class=anchor aria-hidden=true href=#144-eclipse-开发工具>#</a></h3><ul><li>Eclipse导入项目，如下图：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/C4IoHO.png alt></p><h3 id=145-创建数据库>1.4.5 创建数据库<a hidden class=anchor aria-hidden=true href=#145-创建数据库>#</a></h3><ul><li>创建数据库 renren_fast ，数据库编码为<code>UTF-8</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DATABASE</span> renren_fast CHARACTER <span style=color:#66d9ef>SET</span> utf8 <span style=color:#66d9ef>COLLATE</span> utf8_general_ci;
</span></span></code></pre></div><ul><li>执行 db/mysql.sql 文件，初始化数据（默认支持MySQL）</li></ul><h3 id=146-修改配置文件>1.4.6 修改配置文件<a hidden class=anchor aria-hidden=true href=#146-修改配置文件>#</a></h3><ul><li>修改 <code>application-dev.yml</code> ，更新MySQL账号和密码</li><li>运行 io.renren.RenrenApplication.java 的 main 方法，则可启动项目</li><li>Swagger路径：http://localhost:8080/renren-fast/swagger/index.html</li><li>Swagger注解路径：http://localhost:8080/renren-fast/swagger-ui.html</li></ul><h3 id=147-前端部署>1.4.7 前端部署<a hidden class=anchor aria-hidden=true href=#147-前端部署>#</a></h3><blockquote><p>renren-fast-vue基于vue、element-ui构建开发，实现renren-fast后台管理前端功能，提供一套更优的前端解决方案。 欢迎star或fork前端Git库，方便日后寻找，及二次开发</p></blockquote><ul><li>开发环境，需要安装node8.x最新版</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 克隆项目</span>
</span></span><span style=display:flex><span>git clone https://gitee.com/renrenio/renren-fast-vue.git
</span></span><span style=display:flex><span><span style=color:#75715e># 安装依赖</span>
</span></span><span style=display:flex><span>npm install --registry<span style=color:#f92672>=</span>https://registry.npm.taobao.org
</span></span><span style=display:flex><span><span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>npm run dev
</span></span></code></pre></div><ul><li>生产环境，打包并把dist目录文件，部署到Nginx里</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#构建生产环境(默认)</span>
</span></span><span style=display:flex><span>npm run build
</span></span><span style=display:flex><span><span style=color:#75715e># 构建测试环境</span>
</span></span><span style=display:flex><span>npm run build --qa
</span></span><span style=display:flex><span><span style=color:#75715e># 构建验收环境</span>
</span></span><span style=display:flex><span>npm run build --uat
</span></span><span style=display:flex><span><span style=color:#75715e># 构建生产环境</span>
</span></span><span style=display:flex><span>npm run build --prod
</span></span><span style=display:flex><span><span style=color:#75715e># 安装Nginx，并配置Nginx</span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		listen 80;
</span></span><span style=display:flex><span>		server_name localhost;
</span></span><span style=display:flex><span>		location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				root E:<span style=color:#ae81ff>\\</span>renren-fast-vue;
</span></span><span style=display:flex><span>				index index.html index.htm;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动Nginx后，访问如下路径即可</span>
</span></span><span style=display:flex><span>http://localhost
</span></span></code></pre></div><ul><li>登录的账号密码：admin/admin</li></ul><h2 id=15-获取帮助-1>1.5 获取帮助<a hidden class=anchor aria-hidden=true href=#15-获取帮助-1>#</a></h2><ul><li><p>后端地址：https://gitee.com/renrenio/renren-fast</p></li><li><p>前端地址：https://github.com/renrenio/renren-fast-vue</p></li><li><p>代码生成器：https://gitee.com/renrenio/renren-generator</p></li><li><p>官方社区：https://www.renren.io/community</p></li><li><p>如需寻求帮助、项目建议、技术讨论等，请移步到官方社区，我会在第一时间进行解答或回复 如需关注项目最新动态，请Watch、Star项目，同时也是对项目最好的支持</p></li></ul><h1 id=第-2-章-数据库支持>第 2 章 数据库支持<a hidden class=anchor aria-hidden=true href=#第-2-章-数据库支持>#</a></h1><h2 id=21-mysql-数据库支持>2.1 MySQL 数据库支持<a hidden class=anchor aria-hidden=true href=#21-mysql-数据库支持>#</a></h2><h2 id=22-oracle-数据库支持>2.2 Oracle 数据库支持<a hidden class=anchor aria-hidden=true href=#22-oracle-数据库支持>#</a></h2><h2 id=23-sql-server-数据库支持>2.3 SQL Server 数据库支持<a hidden class=anchor aria-hidden=true href=#23-sql-server-数据库支持>#</a></h2><h2 id=24-postgresql-数据库支持>2.4 PostgreSQL 数据库支持<a hidden class=anchor aria-hidden=true href=#24-postgresql-数据库支持>#</a></h2><h2 id=21-mysql-数据库支持-1>2.1 MySQL 数据库支持<a hidden class=anchor aria-hidden=true href=#21-mysql-数据库支持-1>#</a></h2><ol><li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://localhost:3306/renren_fast?allowMultiQueries=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>执行db/mysql.sql，创建表及初始化数据，再启动项目即可</li></ol><h2 id=22-oracle-数据库支持-1>2.2 Oracle 数据库支持<a hidden class=anchor aria-hidden=true href=#22-oracle-数据库支持-1>#</a></h2><ol><li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>oracle.jdbc.OracleDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:oracle:thin:@192.168.10.10:1521:renren</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>执行db/oracle.sql，创建表及初始化数据，再启动项目即可</li></ol><h2 id=23-sql-server-数据库支持-1>2.3 SQL Server 数据库支持<a hidden class=anchor aria-hidden=true href=#23-sql-server-数据库支持-1>#</a></h2><ol><li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>sa</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>执行db/sqlserver.sql，创建表及初始化数据，再启动项目即可</li></ol><h2 id=24-postgresql-数据库支持-1>2.4 PostgreSQL 数据库支持<a hidden class=anchor aria-hidden=true href=#24-postgresql-数据库支持-1>#</a></h2><ol><li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>org.postgresql.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://192.168.10.10:5432/renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>修改quartz配置信息，quartz配置文件 ScheduleConfig.java ，打开注释，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ae81ff>//PostgreSQL数据库，需要打开此注释</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>prop.put(&#34;org.quartz.jobStore.driverDelegateClass&#34;, &#34;org.quartz.impl.jdbcjobstore.PostgreSQLD</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>elegate&#34;);</span>
</span></span></code></pre></div><ol start=3><li>执行db/postgresql.sql，创建表及初始化数据，再启动项目即可</li></ol><h1 id=第-3-章-多数据源支持>第 3 章 多数据源支持<a hidden class=anchor aria-hidden=true href=#第-3-章-多数据源支持>#</a></h1><h2 id=31-多数据源配置>3.1 多数据源配置<a hidden class=anchor aria-hidden=true href=#31-多数据源配置>#</a></h2><h2 id=32-多数据源使用>3.2 多数据源使用<a hidden class=anchor aria-hidden=true href=#32-多数据源使用>#</a></h2><h2 id=33-源码讲解>3.3 源码讲解<a hidden class=anchor aria-hidden=true href=#33-源码讲解>#</a></h2><h2 id=31-多数据源配置-1>3.1 多数据源配置<a hidden class=anchor aria-hidden=true href=#31-多数据源配置-1>#</a></h2><blockquote><p>多数据源的应用场景，主要针对跨多个数据库实例的情况，如果是同实例中的多个数据库，则没必要使用多数据源。</p></blockquote><pre tabindex=0><code>#下面演示单实例，多数据库的使用情况
select * from db.table;
#其中，db为数据库名，table为数据库表名
</code></pre><ul><li>配置多数据源，如果是开发环境，则修改 application-dev.xml ，如下所示</li></ul><h2 id=多数据源的配置>多数据源的配置<a hidden class=anchor aria-hidden=true href=#多数据源的配置>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>dynamic</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>slave1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>sa</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>slave2</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>org.postgresql.Driver</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://192.168.10.10:5432/renren_fast</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>username</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><h2 id=32-多数据源使用-1>3.2 多数据源使用<a hidden class=anchor aria-hidden=true href=#32-多数据源使用-1>#</a></h2><blockquote><p>多数据源的使用，只需在Service类、方法上添加@DataSource("")注解即可，比如在类上添加了 @DataSource(&ldquo;userDB&rdquo;)注解，则表示该Service方法里的所有CURD，都会在 userDB 数据源里执行。</p></blockquote><ol><li>多数据源注解使用规则<ul><li>支持在Service类或方法上，添加多数据源的注解@DataSource</li><li>在Service类上添加了@DataSource注解，则该类下的所有方法，都会使用@DataSource标注的数据源</li><li>在Service类、方法上都添加了@DataSource注解，则方法上的注解会覆盖Service类上的注解</li></ul></li><li>编写DynamicDataSourceTestService.java，测试多数据源及事物</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> io.renren.service<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.annotation.DataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.dao.SysUserDao<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.entity.SysUserEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Service<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.transaction.annotation.Transactional<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 测试多数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//@DataSource(&#34;slave1&#34;) 多数据源全局配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceTestService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysUserDao sysUserDao<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateUser</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setMobile</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;13500000000&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysUserDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateById</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DataSource</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;slave1&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateUserBySlave1</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setMobile</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;13500000001&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysUserDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateById</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DataSource</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;slave2&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateUserBySlave2</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setMobile</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;13500000002&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysUserDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateById</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//测试事物
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 1 <span style=color:#f92672>/</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>运行测试类DynamicDataSourceTest.java，即可测试多数据源及事物是生效的</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> io.renren.service<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.Test<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.runner.RunWith<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit4.SpringRunner<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 多数据源测试
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span><span style=color:#f92672>(</span>SpringRunner<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> DynamicDataSourceTestService dynamicDataSourceTestService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Long id <span style=color:#f92672>=</span> 1L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        dynamicDataSourceTestService<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        dynamicDataSourceTestService<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUserBySlave1</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        dynamicDataSourceTestService<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUserBySlave2</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>其中， @DataSource(&ldquo;slave1&rdquo;) 、 @DataSource(&ldquo;slave2&rdquo;) 里的 slave1 、 slave2 值，是在application- dev.xml里配置的，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>dynamic</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>slave1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:sqlserver://localhost:1433;DatabaseName=renren_security</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>sa</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>slave2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>org.postgresql.Driver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://localhost:5432/renren_security</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><h2 id=33-源码讲解-1>3.3 源码讲解<a hidden class=anchor aria-hidden=true href=#33-源码讲解-1>#</a></h2><ol><li>定义多数据源注解类@DataSource，使用多数据源时，只需在Service方法上添加@DataSource注解即可</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.annotation.*<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 多数据源注解
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>({</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>METHOD</span><span style=color:#f92672>,</span> ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Inherited</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> DataSource <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>value</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>default</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=2><li>定义读取多数据源配置文件的类，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 多数据源属性
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DataSourceProperties</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String driverClassName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Druid默认参数
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> initialSize <span style=color:#f92672>=</span> 2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> maxActive <span style=color:#f92672>=</span> 10<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> minIdle <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> maxWait <span style=color:#f92672>=</span> 60 <span style=color:#f92672>*</span> 1000L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> timeBetweenEvictionRunsMillis <span style=color:#f92672>=</span> 60 <span style=color:#f92672>*</span> 1000L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> minEvictableIdleTimeMillis <span style=color:#f92672>=</span> 1000L <span style=color:#f92672>*</span> 60L <span style=color:#f92672>*</span> 30L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> maxEvictableIdleTimeMillis <span style=color:#f92672>=</span> 1000L <span style=color:#f92672>*</span> 60L <span style=color:#f92672>*</span> 60L <span style=color:#f92672>*</span> 7<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String validationQuery <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;select 1&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> validationQueryTimeout <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> testOnBorrow <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> testOnReturn <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> testWhileIdle <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> poolPreparedStatements <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> maxOpenPreparedStatements <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> sharePreparedStatements <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String filters <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;stat,wall&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getDriverClassName</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> driverClassName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDriverClassName</span><span style=color:#f92672>(</span>String driverClassName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>driverClassName</span> <span style=color:#f92672>=</span> driverClassName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getUrl</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUrl</span><span style=color:#f92672>(</span>String url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getUsername</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUsername</span><span style=color:#f92672>(</span>String username<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPassword</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span>String password<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getInitialSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> initialSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setInitialSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> initialSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>initialSize</span> <span style=color:#f92672>=</span> initialSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMaxActive</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxActive<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxActive</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> maxActive<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxActive</span> <span style=color:#f92672>=</span> maxActive<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMinIdle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> minIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMinIdle</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> minIdle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>minIdle</span> <span style=color:#f92672>=</span> minIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getMaxWait</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxWait<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxWait</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> maxWait<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxWait</span> <span style=color:#f92672>=</span> maxWait<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getTimeBetweenEvictionRunsMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> timeBetweenEvictionRunsMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTimeBetweenEvictionRunsMillis</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> timeBetweenEvictionRunsMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeBetweenEvictionRunsMillis</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                timeBetweenEvictionRunsMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getMinEvictableIdleTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> minEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMinEvictableIdleTimeMillis</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> minEvictableIdleTimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>minEvictableIdleTimeMillis</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                minEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getMaxEvictableIdleTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxEvictableIdleTimeMillis</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> maxEvictableIdleTimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxEvictableIdleTimeMillis</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                maxEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getValidationQuery</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> validationQuery<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setValidationQuery</span><span style=color:#f92672>(</span>String validationQuery<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>validationQuery</span> <span style=color:#f92672>=</span> validationQuery<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getValidationQueryTimeout</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> validationQueryTimeout<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setValidationQueryTimeout</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> validationQueryTimeout<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>validationQueryTimeout</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                validationQueryTimeout<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTestOnBorrow</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> testOnBorrow<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTestOnBorrow</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> testOnBorrow<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>testOnBorrow</span> <span style=color:#f92672>=</span> testOnBorrow<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTestOnReturn</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> testOnReturn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTestOnReturn</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> testOnReturn<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>testOnReturn</span> <span style=color:#f92672>=</span> testOnReturn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTestWhileIdle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> testWhileIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTestWhileIdle</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> testWhileIdle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>testWhileIdle</span> <span style=color:#f92672>=</span> testWhileIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isPoolPreparedStatements</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> poolPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPoolPreparedStatements</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> poolPreparedStatements<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>poolPreparedStatements</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                poolPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMaxOpenPreparedStatements</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxOpenPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxOpenPreparedStatements</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> maxOpenPreparedStatements<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxOpenPreparedStatements</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                maxOpenPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isSharePreparedStatements</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sharePreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setSharePreparedStatements</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> sharePreparedStatements<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sharePreparedStatements</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                sharePreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getFilters</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> filters<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setFilters</span><span style=color:#f92672>(</span>String filters<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>filters</span> <span style=color:#f92672>=</span> filters<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.ConfigurationProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.LinkedHashMap<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Map<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 多数据源属性
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dynamic&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceProperties</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> DataSourceProperties<span style=color:#f92672>&gt;</span> datasource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> DataSourceProperties<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getDatasource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> datasource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDatasource</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> DataSourceProperties<span style=color:#f92672>&gt;</span> datasource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>datasource</span> <span style=color:#f92672>=</span> datasource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>扩展Spring的AbstractRoutingDataSource抽象类，
AbstractRoutingDataSource中的抽象方法determineCurrentLookupKey是实现多数据源的核心，并对该方法进行Override，如下所示：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 多数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSource</span> <span style=color:#66d9ef>extends</span> AbstractRoutingDataSource <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>determineCurrentLookupKey</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DynamicContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=4><li>数据源上下</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 多数据源上下文
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicContextHolder</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ThreadLocal<span style=color:#f92672>&lt;</span>Deque<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;&gt;</span> CONTEXT_HOLDER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocal<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>initialValue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ArrayDeque<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获得当前线程数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 数据源名称
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 设置当前线程数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param dataSource 数据源名称
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>String dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>dataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 清空当前线程数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>poll</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Deque<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> deque <span style=color:#f92672>=</span> CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        deque<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>deque<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=5><li>配置多数据源，如下所示：</li></ol><pre tabindex=0><code>return druidDataSource;
}
}
</code></pre><ol start=5><li>@DataSource注解的切面处理类，动态切换的核心代码</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.druid.pool.DruidDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.properties.DataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.properties.DynamicDataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.ConfigurationProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.EnableConfigurationProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.HashMap<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Map<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 配置多数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span><span style=color:#f92672>(</span>DynamicDataSourceProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> DynamicDataSourceProperties properties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.druid&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSourceProperties <span style=color:#a6e22e>dataSourceProperties</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataSourceProperties<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//因为DynamicDataSource是继承与AbstractRoutingDataSource，而AbstractRoutingDataSource又是继
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    承于AbstractDataSource<span style=color:#960050;background-color:#1e0010>，</span>AbstractDataSource实现了统一的DataSource接口<span style=color:#960050;background-color:#1e0010>，</span>
</span></span><span style=display:flex><span>    所以DynamicDataSource也可
</span></span><span style=display:flex><span>            以当做DataSource使用
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DynamicDataSource <span style=color:#a6e22e>dynamicDataSource</span><span style=color:#f92672>(</span>DataSourceProperties dataSourceProperties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        DynamicDataSource dynamicDataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DynamicDataSource<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        dynamicDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTargetDataSources</span><span style=color:#f92672>(</span>getDynamicDataSource<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//默认数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DruidDataSource defaultDataSource <span style=color:#f92672>=</span> DynamicDataSourceFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>buildDruidDataSource</span><span style=color:#f92672>(</span>dat
</span></span><span style=display:flex><span>                aSourceProperties<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        dynamicDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultTargetDataSource</span><span style=color:#f92672>(</span>defaultDataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dynamicDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getDynamicDataSource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> targetDataSources <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getDatasource</span><span style=color:#f92672>().</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>((</span>k<span style=color:#f92672>,</span> v<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            DruidDataSource druidDataSource <span style=color:#f92672>=</span> DynamicDataSourceFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>buildDruidDataSource</span><span style=color:#f92672>(</span>v
</span></span><span style=display:flex><span>            <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            targetDataSources<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>k<span style=color:#f92672>,</span> druidDataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> targetDataSources<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.druid.pool.DruidDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.properties.DataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.sql.SQLException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * DruidDataSource
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceFactory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> DruidDataSource <span style=color:#a6e22e>buildDruidDataSource</span><span style=color:#f92672>(</span>DataSourceProperties properties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        DruidDataSource druidDataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DruidDataSource<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setDriverClassName</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getDriverClassName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setUrl</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getUrl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setUsername</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsername</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getPassword</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setInitialSize</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getInitialSize</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxActive</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxActive</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMinIdle</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinIdle</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxWait</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxWait</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTimeBetweenEvictionRunsMillis</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getTimeBetweenEvictionRun</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>sMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMinEvictableIdleTimeMillis</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinEvictableIdleTimeMilli</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>s</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxEvictableIdleTimeMillis</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxEvictableIdleTimeMilli</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>s</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setValidationQuery</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getValidationQuery</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setValidationQueryTimeout</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getValidationQueryTimeout</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTestOnBorrow</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isTestOnBorrow</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTestOnReturn</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isTestOnReturn</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setPoolPreparedStatements</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isPoolPreparedStatements</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxOpenPreparedStatements</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxOpenPreparedStatements</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setSharePreparedStatements</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isSharePreparedStatements</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilters</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getFilters</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>init</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SQLException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> druidDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=5><li>@DataSource注解的切面处理类，动态切换的核心代码</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.annotation.DataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.config.DynamicContextHolder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.ProceedingJoinPoint<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Around<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Aspect<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Pointcut<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.reflect.MethodSignature<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.Ordered<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.annotation.Order<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.reflect.Method<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 多数据源，切面处理类
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span>Ordered<span style=color:#f92672>.</span><span style=color:#a6e22e>HIGHEST_PRECEDENCE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DataSourceAspect</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;@annotation(io.renren.commons.dynamic.datasource.annotation.DataSource) &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;|| @within(io.renren.commons.dynamic.datasource.annotation.DataSource)&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dataSourcePointCut</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dataSourcePointCut()&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>around</span><span style=color:#f92672>(</span>ProceedingJoinPoint point<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        MethodSignature signature <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>MethodSignature<span style=color:#f92672>)</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Class targetClass <span style=color:#f92672>=</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>getTarget</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Method method <span style=color:#f92672>=</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        DataSource targetDataSource <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>DataSource<span style=color:#f92672>)</span> targetClass<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        DataSource methodDataSource <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>targetDataSource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> methodDataSource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>methodDataSource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                value <span style=color:#f92672>=</span> methodDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                value <span style=color:#f92672>=</span> targetDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            DynamicContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;set datasource is {}&#34;</span><span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            DynamicContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;clean datasource&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=第-4-章-基础知识讲解>第 4 章 基础知识讲解<a hidden class=anchor aria-hidden=true href=#第-4-章-基础知识讲解>#</a></h1><h2 id=41-spring-mvc-使用>4.1 Spring MVC 使用<a hidden class=anchor aria-hidden=true href=#41-spring-mvc-使用>#</a></h2><h2 id=42-swagger-使用>4.2 Swagger 使用<a hidden class=anchor aria-hidden=true href=#42-swagger-使用>#</a></h2><h2 id=43-mybatis-plus-使用>4.3 Mybatis-plus 使用<a hidden class=anchor aria-hidden=true href=#43-mybatis-plus-使用>#</a></h2><h2 id=41-spring-mvc-使用-1>4.1 Spring MVC 使用<a hidden class=anchor aria-hidden=true href=#41-spring-mvc-使用-1>#</a></h2><blockquote><p>对Spring MVC不太熟悉的，需要理解Spring MVC常用的注解，也方便日后排查问题，常用的注解如下所示：</p></blockquote><h3 id=411-controller-注解>4.1.1 @Controller 注解<a hidden class=anchor aria-hidden=true href=#411-controller-注解>#</a></h3><p>@Controller注解表明了一个类是作为控制器的角色而存在的。Spring不要求你去继承任何控制器基类，也不要求你去实现Servlet的那套API。当然，如果你需要的话也可以去使用任何与Servlet相关的特性。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=412-requestmapping-注解>4.1.2 @RequestMapping 注解<a hidden class=anchor aria-hidden=true href=#412-requestmapping-注解>#</a></h3><p>你可以使用@RequestMapping注解来将请求URL，如/user等，映射到整个类上或某个特定的处理器方法上。
一般来说，类级别的注解负责将一个特定（或符合某种模式）的请求路径映射到一个控制器上，同时通过方法级别的注解来细化映射，即根据特定的HTTP请求方法（GET、POST方法等）、HTTP请求中是否携带特 定参数等条件，将请求映射到匹配的方法上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>user</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以上代码没有指定请求必须是GET方法还是PUT/POST或其他方法，@RequestMapping注解默认会映射所有 的HTTP请求方法。如果仅想接收某种请求方法，请在注解中指定之@RequestMapping(path = &ldquo;/user&rdquo;, method = RequestMethod.GET)以缩小范围。</p><h3 id=413-pathvariable-注解>4.1.3 @PathVariable 注解<a hidden class=anchor aria-hidden=true href=#413-pathvariable-注解>#</a></h3><p>在Spring MVC中你可以在方法参数上使用@PathVariable注解，将其与URI模板中的参数绑定起来，如下所 示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/user/{userId}&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>userCenter</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> String userId<span style=color:#f92672>,</span>Model model<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        UserDTO user<span style=color:#f92672>=</span>userService<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        model<span style=color:#f92672>.</span><span style=color:#a6e22e>addAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>,</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#e6db74>&#34;userCenter&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>URI模板"/user/{userId}&ldquo;指定了一个变量名为userId。当控制器处理这个请求的时候，userId的值就会被URI模 板中对应部分的值所填充。比如说，如果请求的URI是/userId/1，此时变量userId的值就是 1 。</p><h3 id=414-getmapping-注解>4.1.4 @GetMapping 注解<a hidden class=anchor aria-hidden=true href=#414-getmapping-注解>#</a></h3><p>@GetMapping是一个组合注解，是@RequestMapping(method = RequestMethod.GET)的缩写。该注解将HTTP GET映射到特定的处理方法上。可以使用@GetMapping("/user&rdquo;)来代替@RequestMapping(path="/user",method=RequestMethod.GET)。还有@PostMapping、@PutMapping、 @DeleteMapping等同理。</p><h3 id=415-requestbody-注解>4.1.5 @RequestBody 注解<a hidden class=anchor aria-hidden=true href=#415-requestbody-注解>#</a></h3><p>该注解用于读取Request请求的body部分数据，使用系统默认配置的HttpMessageConverter进行解析，然后把相应的数据绑定到要返回的对象上，再把HttpMessageConverter返回的对象数据绑定到Controller中方法的参数上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>user</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> User user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=416-responsebody-注解>4.1.6 @ResponseBody 注解<a hidden class=anchor aria-hidden=true href=#416-responsebody-注解>#</a></h3><p>该注解用于将Controller的方法返回的对象，通过适当的HttpMessageConverter转换为指定格式后，写入到Response对象的body数据区。比如获取JSON数据，加上@ResponseBody后，会直接返回JSON数据，而不会被解析为视图。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ResponseBody</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{userId}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> String userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        UserDTO user <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> user<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=417-restcontroller-注解>4.1.7 @RestController 注解<a hidden class=anchor aria-hidden=true href=#417-restcontroller-注解>#</a></h3><p>@RestController是一个组合注解，即@Controller + @ResponseBody的组合注解，请求完后，会返回JSON数据。</p><h2 id=42-swagger-使用-1>4.2 Swagger 使用<a hidden class=anchor aria-hidden=true href=#42-swagger-使用-1>#</a></h2><blockquote><p>Swagger是一个根据Swagger注解，即可生成接口文档的服务。</p></blockquote><h3 id=421-搭建-swagger-环境>4.2.1 搭建 Swagger 环境<a hidden class=anchor aria-hidden=true href=#421-搭建-swagger-环境>#</a></h3><ul><li>在pom.xml文件中添加swagger相关依赖，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>io.springfox<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>springfox-swagger2<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${springfox-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;groupId&gt;</span>io.springfox<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;artifactId&gt;</span>springfox-swagger-ui<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;version&gt;</span>${springfox-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ul><li>编写Swagger的Configuration配置文件，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.annotations.ApiOperation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.builders.ApiInfoBuilder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.builders.PathSelectors<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.builders.RequestHandlerSelectors<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.service.ApiInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.service.ApiKey<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.spi.DocumentationType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.spring.web.plugins.Docket<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.swagger2.annotations.EnableSwagger2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> com.google.common.collect.Lists.newArrayList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableSwagger2</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SwaggerConfig</span> <span style=color:#66d9ef>implements</span> WebMvcConfigurer <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Docket <span style=color:#a6e22e>createRestApi</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Docket<span style=color:#f92672>(</span>DocumentationType<span style=color:#f92672>.</span><span style=color:#a6e22e>SWAGGER_2</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>apiInfo</span><span style=color:#f92672>(</span>apiInfo<span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//加了ApiOperation注解的类，才生成接口文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>apis</span><span style=color:#f92672>(</span>RequestHandlerSelectors<span style=color:#f92672>.</span><span style=color:#a6e22e>withMethodAnnotation</span><span style=color:#f92672>(</span>ApiOperation<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//io.renren.controller包下的类，才生成接口文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//.apis(RequestHandlerSelectors.basePackage(&#34;io.renren.controller&#34;))
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>paths</span><span style=color:#f92672>(</span>PathSelectors<span style=color:#f92672>.</span><span style=color:#a6e22e>any</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>directModelSubstitute</span><span style=color:#f92672>(</span>java<span style=color:#f92672>.</span><span style=color:#a6e22e>util</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Date</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ApiInfo <span style=color:#a6e22e>apiInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ApiInfoBuilder<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>title</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;人人开源&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>description</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;人人开源接口文档&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>termsOfServiceUrl</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;https://www.renren.io/community&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>version</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;1.0.0&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=422-swagger-常用注解>4.2.2 Swagger 常用注解<a hidden class=anchor aria-hidden=true href=#422-swagger-常用注解>#</a></h3><ul><li>@Api注解用在类上，说明该类的作用。可以标记一个Controller类做为swagger文档资源，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span>tags <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用户管理&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>@ApiOperation注解用在方法上，说明该方法的作用，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span>tags <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用户管理&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;列表&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>UserDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>UserDTO<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>@ApiParam注解用在方法参数上，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span>tags <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用户管理&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;列表&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List <span style=color:#a6e22e>list</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@ApiParam</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用户名&#34;</span><span style=color:#f92672>,</span> required <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> String username<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List list <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><p>@ApiImplicitParams注解用在方法上，主要用于一组参数说明</p></li><li><p>@ApiImplicitParam注解用在@ApiImplicitParams注解中，指定一个请求参数的信息，如下所示：</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;page&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;分页&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ApiImplicitParams</span><span style=color:#f92672>({</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;page&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;当前页码，从 1 开始&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> requ ired<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;int&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;limit&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;每页显示记录数&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> requir ed<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;int&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;order_field&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;排序字段&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> dataT ype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;String&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;order&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;排序方式，可选值(asc、desc)&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;q uery&#34;</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;String&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用户名&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;String&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result<span style=color:#f92672>&lt;</span>PageData<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@ApiIgnore</span> <span style=color:#a6e22e>@RequestParam</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> par ams<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        PageData page<span style=color:#f92672>=</span>sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>page</span><span style=color:#f92672>(</span>params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result<span style=color:#f92672>&lt;</span>PageData<span style=color:#f92672>&gt;().</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>(</span>page<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>@ApiIgnore注解，可用于类、方法或参数上，表示生成Swagger接口文档时，忽略类、方法或参数。</li></ul><h2 id=43-mybatis-plus-使用-1>4.3 Mybatis-plus 使用<a hidden class=anchor aria-hidden=true href=#43-mybatis-plus-使用-1>#</a></h2><p>在项目的pom.xml里引入依赖，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.baomidou<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${mybatisplus.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在yml配置文件里，配置mybatis-plus，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>mybatis-plus</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mapper-locations</span>: <span style=color:#ae81ff>classpath*:/mapper/**/*.xml</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#实体扫描，多个package用逗号或者分号分隔</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>typeAliasesPackage</span>: <span style=color:#ae81ff>io.renren.modules.*.entity</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>global-config</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>#数据库相关配置</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>db-config</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>#主键类型 AUTO:&#34;数据库ID自增&#34;, INPUT:&#34;用户输入ID&#34;, ID_WORKER:&#34;全局唯一ID (数字类型唯一ID)&#34;</span>
</span></span><span style=display:flex><span>    , <span style=color:#ae81ff>UUID:&#34;全局唯一ID UUID&#34;;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>id-type</span>: <span style=color:#ae81ff>AUTO</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#字段策略 IGNORED:&#34;忽略判断&#34;,NOT_NULL:&#34;非 NULL 判断&#34;),NOT_EMPTY:&#34;非空判断&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>field-strategy</span>: <span style=color:#ae81ff>NOT_NULL</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#驼峰下划线转换</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>column-underline</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>logic-delete-value</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>logic-not-delete-value</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>banner</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#原生配置</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>configuration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>map-underscore-to-camel-case</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cache-enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>call-setters-on-nulls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jdbc-type-for-null</span>: <span style=color:#e6db74>&#39;null&#39;</span>
</span></span></code></pre></div><h1 id=第-5-章-项目实战>第 5 章 项目实战<a hidden class=anchor aria-hidden=true href=#第-5-章-项目实战>#</a></h1><h2 id=51-需求说明>5.1 需求说明<a hidden class=anchor aria-hidden=true href=#51-需求说明>#</a></h2><h2 id=52-代码生成器>5.2 代码生成器<a hidden class=anchor aria-hidden=true href=#52-代码生成器>#</a></h2><h2 id=51-需求说明-1>5.1 需求说明<a hidden class=anchor aria-hidden=true href=#51-需求说明-1>#</a></h2><blockquote><p>我们来完成一个商品的列表、添加、修改、删除功能，熟悉如何快速开发自己的业务功能模块。</p></blockquote><ul><li>我们先建一个商品表tb_goods，表结构如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>tb_goods<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>goods_id<span style=color:#f92672>`</span> bigint <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;商品ID&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>     varchar(<span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;商品名&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>intro<span style=color:#f92672>`</span>    varchar(<span style=color:#ae81ff>500</span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;介绍&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>price<span style=color:#f92672>`</span>    decimal(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;价格&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>num<span style=color:#f92672>`</span>      int <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;数量&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>goods_id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8 <span style=color:#66d9ef>COMMENT</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;商品管理&#39;</span>;
</span></span></code></pre></div><h2 id=51-代码生成器>5.1 代码生成器<a hidden class=anchor aria-hidden=true href=#51-代码生成器>#</a></h2><ul><li>使用代码生成器前，我们先来看下代码生成器的配置，看看那些是可配置的，打开renren-generator模块 的配置文件generator.properties，如下所示：</li></ul><pre tabindex=0><code class=language-properties data-lang=properties>#代码生成器，配置信息
mainPath=io.renren
#包名
package=io.renren.modules
moduleName=generator
#作者
author=Mark
#Email
email=sunlightcs@gmail.com
#表前缀(类名不会包含表前缀)
tablePrefix=tb_
#类型转换，配置信息
tinyint=Integer
smallint=Integer
mediumint=Integer
int=Integer
integer=Integer
bigint=Long
float=Float
double=Double
decimal=BigDecimal
bit=Boolean
char=String
varchar=String
tinytext=String
text=String
mediumtext=String
longtext=String
date=Date
datetime=Date
timestamp=Date
NUMBER=Integer
INT=Integer
INTEGER=Integer
BINARY_INTEGER=Integer
LONG=String
FLOAT=Float
BINARY_FLOAT=Float
DOUBLE=Double
BINARY_DOUBLE=Double
DECIMAL=BigDecimal
CHAR=String
VARCHAR=String
VARCHAR2=String
NVARCHAR=String
NVARCHAR2=String
CLOB=String
BLOB=String
DATE=Date
DATETIME=Date
TIMESTAMP=Date
TIMESTAMP(6)=Date
int8=Long
int4=Integer
int2=Integer
numeric=BigDecimal
</code></pre><p>上面的配置文件，可以配置包名、作者信息、表前缀、模块名称、类型转换等信息。其中，类型转换是指， MySQL中的类型与JavaBean中的类型，是怎么一个对应关系。如果有缺少的类型，可自行在generator.properties文件中补充。</p><ul><li>再看看renren-generator模块的application.yml配置文件，我们只要修改数据库名、账号、密码，就可以 了。其中，数据库名是指待生成的表，所在的数据库。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span><span style=color:#75715e># mysql</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>com.alibaba.druid.pool.DruidDataSource</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#MySQL配置</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>driverClassName</span>: <span style=color:#ae81ff>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://localhost:3306/renren_fast?useUnicode=true&amp;characterEncoding=UTF-8&amp;useS</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>SL=false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#oracle配置</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># driverClassName: oracle.jdbc.OracleDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># url: jdbc:oracle:thin:@47.100.206.162:1521:xe</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># username: renren</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># password: 123456</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#SQLServer配置</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># username: sa</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># password: 123456</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#PostgreSQL配置</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># driverClassName: org.postgresql.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># url: jdbc:postgresql://192.168.10.10:5432/renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># username: postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># password: 123456</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jackson</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>time-zone: GMT+8 date-format</span>: <span style=color:#f92672>yyyy-MM-dd HH:mm:ss resources</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>static-locations</span>: <span style=color:#ae81ff>classpath:/static/,classpath:/views/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>mybatis</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mapperLocations</span>: <span style=color:#ae81ff>classpath:mapper/**/*.xml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>pagehelper</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>reasonable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>supportMethodsArguments</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>: <span style=color:#ae81ff>count=countSql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#指定数据库，可选值有【mysql、oracle、sqlserver、postgresql】 </span>
</span></span><span style=display:flex><span><span style=color:#f92672>renren</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>database</span>: <span style=color:#ae81ff>mysql</span>
</span></span></code></pre></div><ul><li><p>在数据库renren_fast中，执行建表语句，创建tb_goods表，再启动renren-generator项目(运行 RenrenApplication.java的main方法即可)，如下所示：</p></li><li><p>在浏览器里输入项目地址(http://localhost)，如下所示：</p></li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/HWqMVn.png alt></p><ul><li>我们只需勾选tb_goods，点击【生成代码】按钮，则可生成相应代码，如下所示：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/Pli3sp.png alt></p><ul><li>我们来看下生成的代码结构，如下所示：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/BhpLFE.png alt></p><ul><li>生成好代码后，我们只需在数据库renren_fast中，执行goods_menu.sql语句，这个SQL是生成菜单的， SQL语句如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>#</span> <span style=color:#75715e>-- 菜单SQL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;商品管理&#39;</span>, <span style=color:#e6db74>&#39;generator/goods&#39;</span>, <span style=color:#66d9ef>NULL</span>, <span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;config&#39;</span>, <span style=color:#e6db74>&#39;6&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>#</span> <span style=color:#75715e>-- 按钮父菜单ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>set</span> <span style=color:#f92672>@</span>parentId <span style=color:#f92672>=</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>identity</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 菜单对应按钮SQL INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;查看&#39;</span>,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;generator:goods:list,generator:goods:info&#39;</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;2&#39;</span>,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;6
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId, <span style=color:#e6db74>&#39;新增&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;generator:goods:save&#39;</span>, <span style=color:#e6db74>&#39;2&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;6&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId, <span style=color:#e6db74>&#39;修改&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;generator:goods:update&#39;</span>, <span style=color:#e6db74>&#39;2&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;6&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> ( <span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>                       , <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId, <span style=color:#e6db74>&#39;删除&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;generator:goods:delete&#39;</span>, <span style=color:#e6db74>&#39;2&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;6&#39;</span>;
</span></span></code></pre></div><ul><li>接下来，再把刚生成的后端代码，添加到项目renren-fast里，前端vue代码，添加到前端项目renren-fast- vue里，在启动renren-fast项目，如下所示：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/hHJj2Z.png alt></p><ul><li>现在，我们就可以新增、修改、删除等操作</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/iAj5t1.png alt></p><h1 id=第-6-章-后端源码分析>第 6 章 后端源码分析<a hidden class=anchor aria-hidden=true href=#第-6-章-后端源码分析>#</a></h1><h2 id=61-前后端分离>6.1 前后端分离<a hidden class=anchor aria-hidden=true href=#61-前后端分离>#</a></h2><h2 id=62-权限设计思路>6.2 权限设计思路<a hidden class=anchor aria-hidden=true href=#62-权限设计思路>#</a></h2><h2 id=63-xss-脚本过滤>6.3 XSS 脚本过滤<a hidden class=anchor aria-hidden=true href=#63-xss-脚本过滤>#</a></h2><h2 id=64-sql-注入>6.4 SQL 注入<a hidden class=anchor aria-hidden=true href=#64-sql-注入>#</a></h2><h2 id=65-redis-缓存>6.5 Redis 缓存<a hidden class=anchor aria-hidden=true href=#65-redis-缓存>#</a></h2><h2 id=66-异常处理机制>6.6 异常处理机制<a hidden class=anchor aria-hidden=true href=#66-异常处理机制>#</a></h2><h2 id=67-后端效验机制>6.7 后端效验机制<a hidden class=anchor aria-hidden=true href=#67-后端效验机制>#</a></h2><h2 id=68-系统日志>6.8 系统日志<a hidden class=anchor aria-hidden=true href=#68-系统日志>#</a></h2><h2 id=69-添加菜单>6.9 添加菜单<a hidden class=anchor aria-hidden=true href=#69-添加菜单>#</a></h2><h2 id=610-添加角色>6.10 添加角色<a hidden class=anchor aria-hidden=true href=#610-添加角色>#</a></h2><h2 id=611-添加管理员>6.11 添加管理员<a hidden class=anchor aria-hidden=true href=#611-添加管理员>#</a></h2><h2 id=612-定时任务模块>6.12 定时任务模块<a hidden class=anchor aria-hidden=true href=#612-定时任务模块>#</a></h2><h2 id=613-云存储模块>6.13 云存储模块<a hidden class=anchor aria-hidden=true href=#613-云存储模块>#</a></h2><h2 id=614-app-模块>6.14 APP 模块<a hidden class=anchor aria-hidden=true href=#614-app-模块>#</a></h2><h2 id=61-前后端分离-1>6.1 前后端分离<a hidden class=anchor aria-hidden=true href=#61-前后端分离-1>#</a></h2><blockquote><p>要实现前后端分离，需要考虑以下 2 个问题：</p><p>1. 项目不再基于session了，如何知道访问者是谁？
1. 如何确认访问者的权限？
3. 前后端分离</p></blockquote><ul><li>一般都是通过token实现，本项目也是一样；用户登录时，生成token及token过期时间，token与用户是一一对应关系，调用接口的时候，把token放到header或请求参数中，服务端就知道是谁在调用接口，登录如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 验证码
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;captcha.jpg&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>captcha</span><span style=color:#f92672>(</span>HttpServletResponse response<span style=color:#f92672>,</span> String uuid<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cache-Control&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-store, no-cache&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    response<span style=color:#f92672>.</span><span style=color:#a6e22e>setContentType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;image/jpeg&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//获取图片验证码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    BufferedImage image <span style=color:#f92672>=</span> sysCaptchaService<span style=color:#f92672>.</span><span style=color:#a6e22e>getCaptcha</span><span style=color:#f92672>(</span>uuid<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    ServletOutputStream out <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ImageIO<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>image<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;jpg&#34;</span><span style=color:#f92672>,</span> out<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>out<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 登录
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/login&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>login</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysLoginForm form<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> captcha <span style=color:#f92672>=</span> sysCaptchaService<span style=color:#f92672>.</span><span style=color:#a6e22e>validate</span><span style=color:#f92672>(</span>form<span style=color:#f92672>.</span><span style=color:#a6e22e>getUuid</span><span style=color:#f92672>(),</span> form<span style=color:#f92672>.</span><span style=color:#a6e22e>getCaptcha</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>captcha<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;验证码不正确&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//用户信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserEntity user <span style=color:#f92672>=</span> sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryByUserName</span><span style=color:#f92672>(</span>form<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsername</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//账号不存在、密码错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>user <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getPassword</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Sha256Hash<span style=color:#f92672>(</span>form<span style=color:#f92672>.</span><span style=color:#a6e22e>getPassword</span><span style=color:#f92672>(),</span> user<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Salt</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>toHex</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;账号或密码不正确&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//账号锁定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;账号已被锁定,请联系管理员&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//生成token，并保存到数据库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    R r <span style=color:#f92672>=</span> sysUserTokenService<span style=color:#f92672>.</span><span style=color:#a6e22e>createToken</span><span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//生产token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>createToken</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//生成一个token，可以是uuid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String token <span style=color:#f92672>=</span> TokenGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>generateValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//当前时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Date now <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//过期时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Date expireTime <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>now<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> EXPIRE <span style=color:#f92672>*</span> 1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//判断是否生成过token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserTokenEntity tokenEntity <span style=color:#f92672>=</span> queryByUserId<span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tokenEntity <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        tokenEntity <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserTokenEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setToken</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setUpdateTime</span><span style=color:#f92672>(</span>now<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setExpireTime</span><span style=color:#f92672>(</span>expireTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//保存token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        save<span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setToken</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setUpdateTime</span><span style=color:#f92672>(</span>now<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setExpireTime</span><span style=color:#f92672>(</span>expireTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//更新token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        update<span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    R r <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>,</span> token<span style=color:#f92672>).</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;expire&#34;</span><span style=color:#f92672>,</span> EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>其中，下面的这行代码，是加盐操作；可能有人不理解为何要加盐，其目的是防止被拖库后，黑客轻易的 （通过密码库对比），就能拿到你的密码</p><pre tabindex=0><code>new Sha256Hash(password, user.getSalt()).toHex())
</code></pre><ul><li>调用接口时，接受传过来的token后，如何保证token有效及用户权限呢？其实，shiro提供了 AuthenticatingFilter抽象类，继承AuthenticatingFilter抽象类即可。</li></ul><p>步骤 1 ，所有请求全部拒绝访问</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isAccessAllowed</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>,</span> Object mappedValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>步骤 2 ，拒绝访问的请求，会调用onAccessDenied方法，onAccessDenied方法先获取token，再调用 executeLogin方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onAccessDenied</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//获取请求token，如果token不存在，直接返回 401
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String token <span style=color:#f92672>=</span> getRequestToken<span style=color:#f92672>((</span>HttpServletRequest<span style=color:#f92672>)</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HttpServletResponse httpResponse <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HttpServletResponse<span style=color:#f92672>)</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String json <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_UNAUTHORIZED</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;invalid token&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        httpResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getWriter</span><span style=color:#f92672>().</span><span style=color:#a6e22e>print</span><span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> executeLogin<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 获取请求的token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getRequestToken</span><span style=color:#f92672>(</span>HttpServletRequest httpRequest<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//从header中获取token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String token <span style=color:#f92672>=</span> httpRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//如果header中不存在token，则从参数中获取token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        token <span style=color:#f92672>=</span> httpRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>步骤 3 ，阅读AuthenticatingFilter抽象类中executeLogin方法，我们发现调用了 subject.login(token) ，这是shiro的登录方法，且需要token参数，我们自定义OAuth2Token类，只要实现AuthenticationToken接口，就可以了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//AuthenticatingFilter类中的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>executeLogin</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span>ServletResponse response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    AuthenticationToken token<span style=color:#f92672>=</span>createToken<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>token<span style=color:#f92672>==</span><span style=color:#66d9ef>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        String msg<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;createToken method implementation returned null. A valid non-null A
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        uthenticationToken&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;must be created in order to execute a login attempt.&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Subject subject<span style=color:#f92672>=</span>getSubject<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        subject<span style=color:#f92672>.</span><span style=color:#a6e22e>login</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> onLoginSuccess<span style=color:#f92672>(</span>token<span style=color:#f92672>,</span>subject<span style=color:#f92672>,</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span><span style=color:#66d9ef>catch</span><span style=color:#f92672>(</span>AuthenticationException e<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> onLoginFailure<span style=color:#f92672>(</span>token<span style=color:#f92672>,</span>e<span style=color:#f92672>,</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//subject.login(token)中的token对象，需要实现AuthenticationToken接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OAuth2Token</span> <span style=color:#66d9ef>implements</span> AuthenticationToken <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>OAuth2Token</span><span style=color:#f92672>(</span>String token<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPrincipal</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getCredentials</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>步骤 4 ，定义OAuth2Realm类，并继承AuthorizingRealm抽象类，调用 subject.login(token) 时，则会调用doGetAuthenticationInfo方法，进行登录</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * authentication身份认证(登录时调用)
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 9. 前面被authc拦截后，需要认证，SecurityBean会调用这里进行认证
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span><span style=color:#f92672>(</span>AuthenticationToken token<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> AuthenticationException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String accessToken <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>String<span style=color:#f92672>)</span> token<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrincipal</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//根据accessToken，查询用户信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserTokenEntity tokenEntity <span style=color:#f92672>=</span> shiroService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryByToken</span><span style=color:#f92672>(</span>accessToken<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//token失效
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>tokenEntity <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>getExpireTime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>&lt;</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IncorrectCredentialsException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token失效，请重新登录&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 9.1. token生效才能登录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//查询用户信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserEntity user <span style=color:#f92672>=</span> shiroService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryUser</span><span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//账号锁定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> LockedAccountException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;账号已被锁定,请联系管理员&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SimpleAuthenticationInfo info <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo<span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> accessToken<span style=color:#f92672>,</span> getName<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> info<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>步骤 5 ，登录失败后，则调用onLoginFailure，进行失败处理，整个流程结束</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onLoginFailure</span><span style=color:#f92672>(</span>AuthenticationToken token<span style=color:#f92672>,</span> AuthenticationException e<span style=color:#f92672>,</span> ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    HttpServletResponse httpResponse <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HttpServletResponse<span style=color:#f92672>)</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    httpResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>setContentType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;application/json;charset=utf-8&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//处理登录失败的异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Throwable throwable <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getCause</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> e <span style=color:#f92672>:</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getCause</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        R r <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_UNAUTHORIZED</span><span style=color:#f92672>,</span> throwable<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        String json <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        httpResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getWriter</span><span style=color:#f92672>().</span><span style=color:#a6e22e>print</span><span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>步骤 6 ，登录成功后，则调用doGetAuthorizationInfo方法，查询用户的权限，再调用具体的接口，整个流程 结束</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * authorization授权(验证权限时调用)
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 10. 前面被roles拦截后，需要授权才能登录，SecurityManager需要调用这里进行权限查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span><span style=color:#f92672>(</span>PrincipalCollection principals<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>SysUserEntity<span style=color:#f92672>)</span>principals<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrimaryPrincipal</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Long userId <span style=color:#f92672>=</span> user<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserId</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//用户权限列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> permsSet <span style=color:#f92672>=</span> shiroService<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserPermissions</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SimpleAuthorizationInfo info <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SimpleAuthorizationInfo<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    info<span style=color:#f92672>.</span><span style=color:#a6e22e>setStringPermissions</span><span style=color:#f92672>(</span>permsSet<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> info<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=62-权限设计思路-1>6.2 权限设计思路<a hidden class=anchor aria-hidden=true href=#62-权限设计思路-1>#</a></h2><p>权限相关的表结构，如下图所示：</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/np520W.png alt></p><ol><li>sys_user[用户]表，保存用户相关数据，通过sys_user_role[用户与角色关联]表，与sys_role[角色]表关联；sys_menu[菜单]表通过sys_role_menu[菜单与角色关联]表，与sys_role[角色]表关联</li><li>sys_menu表，保存菜单相关数据，并在perms字段里，保存了shiro的权限标识，也就是说，拥有此菜单，就拥有perms字段里的所有权限，比如，某用户拥有的菜单权限标识 sys:user:info ，就可以访问下面的方法</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/info/{userId}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:info&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> Long userId<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>在shiro配置代码里，配置为 anon 的，表示不经过shiro处理，配置为 oauth2 的，表示经过 OAuth2Filter 处理，前后端分离的接口，都会交给 OAuth2Filter处理，这样就保证，没有权限的请求，拒绝访问</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Shiro配置
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShiroConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  Shiro自带的过滤器，可以在这里配置拦截页面
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;shiroFilter&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ShiroFilterFactoryBean <span style=color:#a6e22e>shiroFilter</span><span style=color:#f92672>(</span>SecurityManager securityManager<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1. 初始化一个ShiroFilter工程类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ShiroFilterFactoryBean shiroFilter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ShiroFilterFactoryBean<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2. 我们知道Shiro是通过SecurityManager来管理整个认证和授权流程的，这个SecurityManager可以在下面初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setSecurityManager</span><span style=color:#f92672>(</span>securityManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//自定义Oauth2Filter过滤器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Filter<span style=color:#f92672>&gt;</span> filters <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        filters<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;oauth2&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> OAuth2Filter<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilters</span><span style=color:#f92672>(</span>filters<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3. 上面我们讲过，有的页面不需登录任何人可以直接访问，有的需要登录才能访问，有的不仅要登录还需要相关权限才能访问
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> filterMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4. Shiro过滤器常用的有如下几种
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 4.1. anon 任何人都能访问，如登录页面
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 4.2. authc 需要登录才能访问，如系统内的全体通知页面
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 4.3. roles 需要相应的角色才能访问
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/webjars/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/druid/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/login&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/swagger/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/v2/api-docs&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/swagger-ui.html&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/swagger-resources/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/captcha.jpg&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/aaa.txt&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;oauth2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 5. 让ShiroFilter按这个规则拦截
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilterChainDefinitionMap</span><span style=color:#f92672>(</span>filterMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 6. 用户没登录被拦截后，当然需要调转到登录页了，这里配置登录页
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//shiroFilterFactoryBean.setLoginUrl(&#34;/api/user/login&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> shiroFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;securityManager&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SecurityManager <span style=color:#a6e22e>securityManager</span><span style=color:#f92672>(</span>OAuth2Realm oAuth2Realm<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 7. 新建一个SecurityManager供ShiroFilterFactoryBean使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DefaultWebSecurityManager securityManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultWebSecurityManager<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 8. SecurityManager既然管理认证等信息，那他就需要一个类来帮他查数据库吧。这就是Realm类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        securityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>setRealm</span><span style=color:#f92672>(</span>oAuth2Realm<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        securityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>setRememberMeManager</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> securityManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;lifecycleBeanPostProcessor&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> LifecycleBeanPostProcessor <span style=color:#a6e22e>lifecycleBeanPostProcessor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LifecycleBeanPostProcessor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> AuthorizationAttributeSourceAdvisor <span style=color:#a6e22e>authorizationAttributeSourceAdvisor</span><span style=color:#f92672>(</span>SecurityManager securityManager<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        AuthorizationAttributeSourceAdvisor advisor <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AuthorizationAttributeSourceAdvisor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        advisor<span style=color:#f92672>.</span><span style=color:#a6e22e>setSecurityManager</span><span style=color:#f92672>(</span>securityManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> advisor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=63-xss-脚本过滤-1>6.3 XSS 脚本过滤<a hidden class=anchor aria-hidden=true href=#63-xss-脚本过滤-1>#</a></h2><blockquote><p>XSS跨站脚本攻击的基本原理和SQL注入攻击类似，都是利用系统执行了未经过滤的危险代码，不同点 在于XSS是一种基于网页脚本的注入方式，也就是将脚本攻击载荷写入网页执行以达到对网页客户端访问用户攻击的目的，属于客户端攻击。程序员往往不太关心安全这块，这就给有心之人，提供了机会，本系统针对XSS攻击，提供了过滤功能，可以有效防止XSS攻击，代码如下：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XssFilter</span> <span style=color:#66d9ef>implements</span> Filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>(</span>FilterConfig config<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ServletException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>,</span> FilterChain chain<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ServletException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        XssHttpServletRequestWrapper xssRequest <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> XssHttpServletRequestWrapper<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>(</span>HttpServletRequest<span style=color:#f92672>)</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        chain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>xssRequest<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FilterConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> FilterRegistrationBean <span style=color:#a6e22e>xssFilterRegistration</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        FilterRegistrationBean registration <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FilterRegistrationBean<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setDispatcherTypes</span><span style=color:#f92672>(</span>DispatcherType<span style=color:#f92672>.</span><span style=color:#a6e22e>REQUEST</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilter</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> XssFilter<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>addUrlPatterns</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/*&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xssFilter&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setOrder</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_VALUE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> registration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>自定义XssFilter过滤器，用来过滤所有请求，具体过滤还是在XssHttpServletRequestWrapper里实现的， 如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XssHttpServletRequestWrapper</span> <span style=color:#66d9ef>extends</span> HttpServletRequestWrapper <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//没被包装过的HttpServletRequest（特殊场景，需要自己过滤）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    HttpServletRequest orgRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//html过滤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> HTMLFilter htmlFilter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HTMLFilter<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>XssHttpServletRequestWrapper</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        orgRequest <span style=color:#f92672>=</span> request<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ServletInputStream <span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//非json类型，直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_JSON_VALUE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span><span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>CON</span>
</span></span><span style=display:flex><span>                TENT_TYPE<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//为空，直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String json <span style=color:#f92672>=</span> IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(</span><span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;utf-8&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>json<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//xss过滤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        json <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> ByteArrayInputStream bis <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>json<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;utf-8&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ServletInputStream<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isFinished</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isReady</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setReadListener</span><span style=color:#f92672>(</span>ReadListener readListener<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> bis<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span>xssEncode<span style=color:#f92672>(</span>name<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotBlank</span><span style=color:#f92672>(</span>value<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getParameterValues</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String<span style=color:#f92672>[]</span> parameters <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterValues</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parameters <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            parameters<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>parameters<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> parameters<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>[]&gt;</span> <span style=color:#a6e22e>getParameterMap</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>[]&gt;</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>[]&gt;</span> parameters <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String key <span style=color:#f92672>:</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>keySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String<span style=color:#f92672>[]</span> values <span style=color:#f92672>=</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> values<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                values<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>values<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> values<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> map<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>xssEncode<span style=color:#f92672>(</span>name<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotBlank</span><span style=color:#f92672>(</span>value<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>xssEncode</span><span style=color:#f92672>(</span>String input<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> htmlFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>input<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取最原始的request
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HttpServletRequest <span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> orgRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取最原始的request
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> HttpServletRequest <span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>request <span style=color:#66d9ef>instanceof</span> XssHttpServletRequestWrapper<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>((</span>XssHttpServletRequestWrapper<span style=color:#f92672>)</span> request<span style=color:#f92672>).</span><span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> request<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果需要处理富文本数据，可以通过 XssHttpServletRequestWrapper.getOrgRequest(request) ，拿到原始 的 request 对象后，再自行处理富文本数据，如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>data</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        HttpServletRequest orgRequest<span style=color:#f92672>=</span>XssHttpServletRequestWrapper<span style=color:#f92672>.</span><span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        String content<span style=color:#f92672>=</span>orgRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;content&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//富文本数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>content<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=64-sql-注入-1>6.4 SQL 注入<a hidden class=anchor aria-hidden=true href=#64-sql-注入-1>#</a></h2><blockquote><p>本系统使用的是Mybatis，如果使用${}拼接SQL，则存在SQL注入风险，可以对参数进行过滤，避免 SQL注入，如下:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SQLFilter</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * SQL注入过滤
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param str 待验证的字符串
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>sqlInject</span><span style=color:#f92672>(</span>String str<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>str<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//去掉&#39;|&#34;|;|\字符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;\&#34;&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;;&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;\\&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//转换成小写\
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        str <span style=color:#f92672>=</span> str<span style=color:#f92672>.</span><span style=color:#a6e22e>toLowerCase</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//非法字符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String<span style=color:#f92672>[]</span> keywords <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;master&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;truncate&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;insert&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;select&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;delete&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;update&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;declare&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;alter&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;drop&#34;</span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//判断是否包含非法字符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String keyword <span style=color:#f92672>:</span> keywords<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>str<span style=color:#f92672>.</span><span style=color:#a6e22e>indexOf</span><span style=color:#f92672>(</span>keyword<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;包含非法字符&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> str<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>像查询列表，涉及排序问题，排序字段是从前台传过来的，则存在SQL注入风险，需经如下处理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Query</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IPage<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPage</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getPage</span><span style=color:#f92672>(</span>params<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IPage<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPage</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>,</span> String defaultOrderField<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isAsc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//分页参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> curPage <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> limit <span style=color:#f92672>=</span> 10<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>PAGE</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            curPage <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>PAGE</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>LIMIT</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            limit <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>LIMIT</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//分页对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Page<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> page <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Page<span style=color:#f92672>&lt;&gt;(</span>curPage<span style=color:#f92672>,</span> limit<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//分页参数 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        params<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>PAGE</span><span style=color:#f92672>,</span> page<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//排序字段 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//防止SQL注入（因为sidx、order是通过拼接SQL实现排序的，会有SQL注入风险）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String orderField <span style=color:#f92672>=</span> SQLFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>sqlInject</span><span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>ORDER_FIELD</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        String order <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>ORDER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//前端字段排序
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotEmpty</span><span style=color:#f92672>(</span>orderField<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotEmpty</span><span style=color:#f92672>(</span>order<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>ASC</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>order<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> page<span style=color:#f92672>.</span><span style=color:#a6e22e>setAsc</span><span style=color:#f92672>(</span>orderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> page<span style=color:#f92672>.</span><span style=color:#a6e22e>setDesc</span><span style=color:#f92672>(</span>orderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//默认排序
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isAsc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            page<span style=color:#f92672>.</span><span style=color:#a6e22e>setAsc</span><span style=color:#f92672>(</span>defaultOrderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            page<span style=color:#f92672>.</span><span style=color:#a6e22e>setDesc</span><span style=color:#f92672>(</span>defaultOrderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> page<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=65-redis-缓存-1>6.5 Redis 缓存<a hidden class=anchor aria-hidden=true href=#65-redis-缓存-1>#</a></h2><blockquote><p>缓存大家都很熟悉，但能否灵活运用，就不一定了。一般设计缓存架构时，我们需要考虑如下几个问 题：</p></blockquote><ol><li><p>查询数据的时候，尽量减少DB查询，DB主要负责写数据</p></li><li><p>尽量不使用 LEFT JOIN 等关联查询，缓存命中率不高，还浪费内存</p></li><li><p>多使用单表查询，缓存命中率最高</p></li><li><p>数据库 insert 、 update 、 delete 时，同步更新缓存数据</p></li><li><p>合理运用Redis数据结构，也许有质的飞跃</p></li><li><p>对于访问量不大的项目，使用缓存只会增加项目的复杂度</p></li></ol><p>本系统采用Redis作为缓存，并可配置是否开启redis缓存，主要还是通过Spring AOP实现的，配置如下所示：</p><pre tabindex=0><code>redis:
  database: 0
  host: localhost
  port: 6379
  password: # 密码（默认为空）
  timeout: 6000ms # 连接超时时长（毫秒）
  jedis:
    pool:
      max-active: 1000 # 连接池最大连接数（使用负值表示没有限制）
      max-wait: -1ms # 连接池最大阻塞等待时间（使用负值表示没有限制）
      max-idle: 10 # 连接池中的最大空闲连接
      min-idle: 5 # 连接池中的最小空闲连接
renren:
  redis:
  	open: false #是否开启redis缓存 true开启 false关闭
</code></pre><p>本项目中，使用Redis服务的代码，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysConfigServiceImpl</span> <span style=color:#66d9ef>implements</span> SysConfigService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysConfigDao sysConfigDao<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysConfigRedis sysConfigRedis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>saveOrUpdate</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>saveOrUpdate</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateValueByKey</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> String value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateValueByKey</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteBatch</span><span style=color:#f92672>(</span>Long<span style=color:#f92672>[]</span> ids<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>deleteBatch</span><span style=color:#f92672>(</span>ids<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Long id <span style=color:#f92672>:</span> ids<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            SysConfigEntity config <span style=color:#f92672>=</span> queryObject<span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysConfigRedis</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisUtils redisUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveOrUpdate</span><span style=color:#f92672>(</span>SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        String key <span style=color:#f92672>=</span> RedisKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>getSysConfigKey</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        redisUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>String configKey<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String key <span style=color:#f92672>=</span> RedisKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>getSysConfigKey</span><span style=color:#f92672>(</span>configKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        redisUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SysConfigEntity <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String configKey<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String key <span style=color:#f92672>=</span> RedisKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>getSysConfigKey</span><span style=color:#f92672>(</span>configKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redisUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> SysConfigEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisTemplate<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> redisTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ValueOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> valueOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> HashOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> hashOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ListOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> listOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SetOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> setOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ZSetOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> zSetOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 默认过期时长，单位：秒
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>long</span> DEFAULT_EXPIRE <span style=color:#f92672>=</span> 60 <span style=color:#f92672>*</span> 60 <span style=color:#f92672>*</span> 24<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 不设置过期时长
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>long</span> NOT_EXPIRE <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> Gson gson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Object value<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        valueOperations<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> toJson<span style=color:#f92672>(</span>value<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>expire <span style=color:#f92672>!=</span> NOT_EXPIRE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> expire<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Object value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        set<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> DEFAULT_EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> valueOperations<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>expire <span style=color:#f92672>!=</span> NOT_EXPIRE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> expire<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> fromJson<span style=color:#f92672>(</span>value<span style=color:#f92672>,</span> clazz<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> clazz<span style=color:#f92672>,</span> NOT_EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> valueOperations<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>expire <span style=color:#f92672>!=</span> NOT_EXPIRE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> expire<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> NOT_EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Object转成JSON数据
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>Object object<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>object <span style=color:#66d9ef>instanceof</span> Integer <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> Long <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> Float <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                object <span style=color:#66d9ef>instanceof</span> Double <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> Boolean <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> St
</span></span><span style=display:flex><span>                ring<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>object<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>object<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * JSON数据，转成Object
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>String json<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>json<span style=color:#f92672>,</span> clazz<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>大家可能会有疑问，认为这个项目必须要配置Redis缓存，不然会报错，因为有操作Redis的代码，其实不 然，通过Spring AOP，我们可以控制，是否真的使用Redis，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisAspect</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 是否开启redis缓存 true开启 false关闭
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${renren.redis.open: false}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> open<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;execution(* io.renren.common.utils.RedisUtils.*(..))&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>around</span><span style=color:#f92672>(</span>ProceedingJoinPoint point<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Object result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>open<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                result <span style=color:#f92672>=</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;redis error&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Redis服务异常&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=66-异常处理机制-1>6.6 异常处理机制<a hidden class=anchor aria-hidden=true href=#66-异常处理机制-1>#</a></h2><blockquote><p>本项目通过RRException异常类，抛出自定义异常，RRException继承RuntimeException，不能继承 Exception，如果继承Exception，则Spring事务不会回滚。</p></blockquote><p>RRException代码如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RRException</span> <span style=color:#66d9ef>extends</span> RuntimeException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> serialVersionUID <span style=color:#f92672>=</span> 1L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> code <span style=color:#f92672>=</span> 500<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>,</span> Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> code<span style=color:#f92672>,</span> Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getMsg</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMsg</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>如何处理抛出的异常呢，我们定义了RRExceptionHandler类，并加上注解@RestControllerAdvice，就可以处理所有抛出的异常，并返回JSON数据。@RestControllerAdvice是由@ControllerAdvice、@ResponseBody注解组合而来的，可以查找@ControllerAdvice相关的资料，理解@ControllerAdvice注解 的使用。</p></blockquote><p>RRExceptionHandler代码如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestControllerAdvice</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RRExceptionHandler</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 处理自定义异常
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>RRException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleRRException</span><span style=color:#f92672>(</span>RRException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        R r <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> R<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;code&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>DuplicateKeyException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleDuplicateKeyException</span><span style=color:#f92672>(</span>DuplicateKeyException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;数据库中已存在该记录&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>AuthorizationException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleAuthorizationException</span><span style=color:#f92672>(</span>AuthorizationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;没有权限，请联系管理员授权&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>Exception<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleException</span><span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=67-后端效验机制-1>6.7 后端效验机制<a hidden class=anchor aria-hidden=true href=#67-后端效验机制-1>#</a></h2><blockquote><p>本项目，后端效验使用的是Hibernate Validator校验框架，且自定义ValidatorUtils工具类，用来效验数 据。</p></blockquote><p>Hibernate Validator官方文档： <a href=http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/>http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/</a>
ValidatorUtils代码如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ValidatorUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Validator validator<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        validator <span style=color:#f92672>=</span> Validation<span style=color:#f92672>.</span><span style=color:#a6e22e>buildDefaultValidatorFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getValidator</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 校验对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param object 待校验对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param groups 待校验的组
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @throws RRException 校验不通过，则报RRException异常
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>Object object<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;...</span> groups<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RRException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Set<span style=color:#f92672>&lt;</span>ConstraintViolation<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;&gt;</span> constraintViolations <span style=color:#f92672>=</span> validator<span style=color:#f92672>.</span><span style=color:#a6e22e>validate</span><span style=color:#f92672>(</span>object<span style=color:#f92672>,</span> groups<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>constraintViolations<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ConstraintViolation<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> constraint <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ConstraintViolation<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;)</span> constraintV
</span></span><span style=display:flex><span>            iolations<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>().</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span>constraint<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>使用案例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysUserController</span> <span style=color:#66d9ef>extends</span> AbstractController <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 保存用户
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SysLog</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;保存用户&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysUserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//保存用户时，效验SysUserEntity里，带有AddGroup注解的属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateUserId</span><span style=color:#f92672>(</span>getUserId<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 修改用户
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SysLog</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;修改用户&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>update</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysUserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//修改用户时，效验SysUserEntity里，带有UpdateGroup注解的属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateUserId</span><span style=color:#f92672>(</span>getUserId<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysUserEntity</span> <span style=color:#66d9ef>implements</span> Serializable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 用户ID
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long userId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 用户名
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用户名不能为空&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 密码
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;密码不能为空&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 盐
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String salt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 邮箱
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;邮箱不能为空&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Email</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;邮箱格式不正确&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String email<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 手机号
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String mobile<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 状态
</span></span></span><span style=display:flex><span><span style=color:#75715e>     0：禁用
</span></span></span><span style=display:flex><span><span style=color:#75715e>     1：正常
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 角色ID列表
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> roleIdList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 创建者ID
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long createUserId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 创建时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Date createTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过分析上面的代码，我们来理解Hibernate Validator校验框架的使用。 其中，username属性，表示保存或修改用户时，都会效验username属性；而password属性，表示只有保存用户时，才会效验password属性，也就是说，修改用户时，password可以不填写，允许为空。</p><p>如果不指定属性的groups，则默认属于javax.validation.groups.Default.class分组，可以通过ValidatorUtils.validateEntity(user)进行效验。</p><h2 id=68-系统日志-1>6.8 系统日志<a hidden class=anchor aria-hidden=true href=#68-系统日志-1>#</a></h2><p>系统日志是通过Spring AOP实现的，我们自定义了注解 @SysLog ，且只能在方法上使用，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>(</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>METHOD</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> SysLog <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>value</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>default</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>下面是自定义注解 @SysLog 的使用方式，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysUserController</span> <span style=color:#66d9ef>extends</span> AbstractController <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SysLog</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;保存用户&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysUserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateUserId</span><span style=color:#f92672>(</span>getUserId<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们可以发现，只需要在保存日志的请求方法上，加上 @SysLog 注解，就可以把日志保存到数据库里了。 具体是在哪里把数据保存到数据库里的呢，我们定义了 SysLogAspect 处理类，就是来干这事的，如下所 示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 系统日志，切面处理类
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysLogAspect</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysLogService sysLogService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;@annotation(io.renren.common.annotation.SysLog)&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logPointCut</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;logPointCut()&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>around</span><span style=color:#f92672>(</span>ProceedingJoinPoint point<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> beginTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//执行方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object result <span style=color:#f92672>=</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//执行时长(毫秒)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//保存日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        saveSysLog<span style=color:#f92672>(</span>point<span style=color:#f92672>,</span> time<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveSysLog</span><span style=color:#f92672>(</span>ProceedingJoinPoint joinPoint<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> time<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        MethodSignature signature <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>MethodSignature<span style=color:#f92672>)</span> joinPoint<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Method method <span style=color:#f92672>=</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        SysLogEntity sysLog <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysLogEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        SysLog syslog <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>SysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>syslog <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//注解上的描述
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setOperation</span><span style=color:#f92672>(</span>syslog<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//请求的方法名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String className <span style=color:#f92672>=</span> joinPoint<span style=color:#f92672>.</span><span style=color:#a6e22e>getTarget</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        String methodName <span style=color:#f92672>=</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setMethod</span><span style=color:#f92672>(</span>className <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;()&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//请求的参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> joinPoint<span style=color:#f92672>.</span><span style=color:#a6e22e>getArgs</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String params <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>args<span style=color:#f92672>[</span>0<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setParams</span><span style=color:#f92672>(</span>params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//获取request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HttpServletRequest request <span style=color:#f92672>=</span> HttpContextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHttpServletRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//设置IP地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setIp</span><span style=color:#f92672>(</span>IPUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getIpAddr</span><span style=color:#f92672>(</span>request<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//用户名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String username <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>SysUserEntity<span style=color:#f92672>)</span> SecurityUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubject</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getPrincipal</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>getUser</span>
</span></span><span style=display:flex><span>        name<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setUsername</span><span style=color:#f92672>(</span>username<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setTime</span><span style=color:#f92672>(</span>time<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateDate</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//保存系统日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sysLogService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>sysLog<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>SysLogAspect 类定义了一个切入点，请求 @SysLog 注解的方法时，会进入 around方法，把系统日志保存到数据库中。</p><h2 id=69-添加菜单-1>6.9 添加菜单<a hidden class=anchor aria-hidden=true href=#69-添加菜单-1>#</a></h2><blockquote><p>菜单管理，主要是对【目录、菜单、按钮】进行动态的新增、修改、删除等操作，方便开发者管理菜单。</p></blockquote><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/G7kxHE.png alt></p><p>上图是拿现有的菜单进行讲解。其中，授权标识与shiro中的注解@RequiresPermissions，定义的授权标识是 一一对应的，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/config&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysConfigController</span> <span style=color:#66d9ef>extends</span> AbstractController <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>list</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/info/{id}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:info&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>update</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/delete&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:delete&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> Long<span style=color:#f92672>[]</span> ids<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=610-添加角色-1>6.10 添加角色<a hidden class=anchor aria-hidden=true href=#610-添加角色-1>#</a></h2><blockquote><p>管理员权限是通过角色进行管理的，给管理员分配权限时，要先创建好角色。</p></blockquote><p>下面创建了一个【开发角色】，如下图所示：</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/qsBkIQ.png alt></p><h2 id=611-添加管理员-1>6.11 添加管理员<a hidden class=anchor aria-hidden=true href=#611-添加管理员-1>#</a></h2><blockquote><p>本系统默认就创建了admin账号，无需分配任何角色，就拥有最高权限。 一个管理员是可以拥有多个角 色的。</p></blockquote><p>下面创建一个【zhangsan】的管理员账号，并属于【开发角色】，如下所示：</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/xyolW8.png alt></p><h2 id=612-定时任务模块-1>6.12 定时任务模块<a hidden class=anchor aria-hidden=true href=#612-定时任务模块-1>#</a></h2><blockquote><p>本系统使用开源框架Quartz，实现的定时任务，已实现分布式定时任务，可部署多台服务器，不重复执行，以及动态增加、修改、删除、暂停、恢复、立即执行定时任务。 Quartz自带了各数据库的SQL脚本，如果想更改成其他数据库，可参考Quartz相应的SQL脚本。</p></blockquote><h3 id=6121-新增定时任务>6.12.1 新增定时任务<a hidden class=anchor aria-hidden=true href=#6121-新增定时任务>#</a></h3><p>新增一个定时任务，其实很简单，只要定义一个普通的Spring Bean即可，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;testTask&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestTask</span> <span style=color:#66d9ef>implements</span> ITask <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>String params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;TestTask定时任务正在执行，参数为：{}&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如何让Quartz，定时执行testTask里的方法呢？只需要在管理后台，新增一个定时任务即可，如下图所示：</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/j1UF4l.png alt></p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/9d5CTr.png alt></p><p>刚才配置的定时任务，每隔 30 分钟，就会调用TestTask的test方法了，是不是很简单啊。</p><h4 id=6122-源码分析>6.12.2 源码分析<a hidden class=anchor aria-hidden=true href=#6122-源码分析>#</a></h4><p>Quartz提供了相关的API，我们可以调用API，对Quartz进行增加、修改、删除、暂停、恢复、立即执行等。 本系统中， ScheduleUtils 类就是对Quartz API进行的封装，代码如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScheduleUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String JOB_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TASK_&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取触发器key
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> TriggerKey <span style=color:#a6e22e>getTriggerKey</span><span style=color:#f92672>(</span>Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> TriggerKey<span style=color:#f92672>.</span><span style=color:#a6e22e>triggerKey</span><span style=color:#f92672>(</span>JOB_NAME <span style=color:#f92672>+</span> jobId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取jobKey
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> JobKey <span style=color:#a6e22e>getJobKey</span><span style=color:#f92672>(</span>Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> JobKey<span style=color:#f92672>.</span><span style=color:#a6e22e>jobKey</span><span style=color:#f92672>(</span>JOB_NAME <span style=color:#f92672>+</span> jobId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取表达式触发器
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> CronTrigger <span style=color:#a6e22e>getCronTrigger</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>CronTrigger<span style=color:#f92672>)</span> scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>getTrigger</span><span style=color:#f92672>(</span>getTriggerKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getCronTrigger异常，请检查qrtz开头的表，是否有脏数据&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 创建定时任务
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createScheduleJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> ScheduleJobEntity scheduleJob<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//构建job信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            JobDetail jobDetail <span style=color:#f92672>=</span> JobBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newJob</span><span style=color:#f92672>(</span>ScheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getJobKey
</span></span><span style=display:flex><span>                    <span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//表达式调度构建器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            CronScheduleBuilder scheduleBuilder <span style=color:#f92672>=</span> CronScheduleBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>cronSchedule</span><span style=color:#f92672>(</span>scheduleJo
</span></span><span style=display:flex><span>                    b<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronExpression</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>withMisfireHandlingInstructionDoNothing</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//按新的cronExpression表达式构建一个新的trigger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            CronTrigger trigger <span style=color:#f92672>=</span> TriggerBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newTrigger</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getTriggerKey<span style=color:#f92672>(</span>sche
</span></span><span style=display:flex><span>                    duleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span>
</span></span><span style=display:flex><span>                    withSchedule<span style=color:#f92672>(</span>scheduleBuilder<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//放入参数，运行时的方法可以获取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            jobDetail<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobDataMap</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    scheduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleJob</span><span style=color:#f92672>(</span>jobDetail<span style=color:#f92672>,</span> trigger<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//暂停任务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> ScheduleStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>PAUSE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                pauseJob<span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;创建定时任务失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 更新定时任务
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateScheduleJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> ScheduleJobEntity scheduleJob<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            TriggerKey triggerKey <span style=color:#f92672>=</span> getTriggerKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//表达式调度构建器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            CronScheduleBuilder scheduleBuilder <span style=color:#f92672>=</span> CronScheduleBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>cronSchedule</span><span style=color:#f92672>(</span>scheduleJo
</span></span><span style=display:flex><span>                    b<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronExpression</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>withMisfireHandlingInstructionDoNothing</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            CronTrigger trigger <span style=color:#f92672>=</span> getCronTrigger<span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//按新的cronExpression表达式重新构建trigger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            trigger <span style=color:#f92672>=</span> trigger<span style=color:#f92672>.</span><span style=color:#a6e22e>getTriggerBuilder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>triggerKey<span style=color:#f92672>).</span><span style=color:#a6e22e>withSchedule</span><span style=color:#f92672>(</span>sched
</span></span><span style=display:flex><span>                    uleBuilder<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            trigger<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobDataMap</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>sc
</span></span><span style=display:flex><span>                    heduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>rescheduleJob</span><span style=color:#f92672>(</span>triggerKey<span style=color:#f92672>,</span> trigger<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//暂停任务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> ScheduleStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>PAUSE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                pauseJob<span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;更新定时任务失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 立即执行任务
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> ScheduleJobEntity scheduleJob<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            JobDataMap dataMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JobDataMap<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            dataMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>triggerJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>()),</span> dataMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;立即执行定时任务失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 暂停任务
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pauseJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>pauseJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;暂停定时任务失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 恢复任务
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resumeJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;暂停定时任务失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 删除定时任务
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteScheduleJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>deleteJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;删除定时任务失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以下是几个核心的方法：</p><ul><li><p>createScheduleJob【创建定时任务】：在管理后台新增任务时，会调用该方法，把任务添加到Quartz 中，再根据cron表达式，定时执行任务。</p></li><li><p>updateScheduleJob【更新定时任务】：修改任务时，调用该方法，修改Quartz中的任务信息。</p></li><li><p>run【立即执行定时任务】：马上执行一次该任务，只执行一次。</p></li><li><p>pauseJob【暂停定时任务】：这个不是暂停正在执行的任务，而是以后不再执行这个定时任务了。正在 执行的任务，还是照常执行完。</p></li><li><p>resumeJob【恢复定时任务】：这个是针对pauseJob来的，如果任务暂停了，以后都不会再执行，要想再执行，则需要调用resumeJob，使定时任务恢复执行。</p></li><li><p>deleteScheduleJob【删除定时任务】：删除定时任务</p></li></ul><p>其中， <code>createScheduleJob</code> 、 <code>updateScheduleJob</code> 在启动项目的时候，也会调用，把数据库里，新增或修 改的任务，更新到Quartz中，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;scheduleJobService&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScheduleJobServiceImpl</span> <span style=color:#66d9ef>implements</span> ScheduleJobService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 项目启动时，初始化定时器
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>ScheduleJobEntity<span style=color:#f92672>&gt;</span> scheduleJobList <span style=color:#f92672>=</span> schedulerJobDao<span style=color:#f92672>.</span><span style=color:#a6e22e>queryList</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ScheduleJobEntity scheduleJob <span style=color:#f92672>:</span> scheduleJobList<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            CronTrigger cronTrigger <span style=color:#f92672>=</span> ScheduleUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronTrigger</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//如果不存在，则创建
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cronTrigger <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                ScheduleUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>createScheduleJob</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                ScheduleUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>updateScheduleJob</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>大家是不是还有疑问呢，怎么就能定时执行，刚才在管理后台新增的任务testTask呢？ 下面我们再来分析 下 createScheduleJob 方法，创建定时任务的时候，要调用该方法，代码如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//构建一个新的定时任务，JobBuilder.newJob()只能接受Job类型的参数
</span></span></span><span style=display:flex><span><span style=color:#75715e>//把ScheduleJob.class作为参数传进去，ScheduleJob继承QuartzJobBean，而QuartzJobBean实现了Job接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>JobDetail jobDetail<span style=color:#f92672>=</span>JobBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newJob</span><span style=color:#f92672>(</span>ScheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//构建cron，定时任务的周期
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CronScheduleBuilder scheduleBuilder<span style=color:#f92672>=</span>CronScheduleBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>cronSchedule</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronExpression</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>withMisfireHandlingInstructionDoNothing</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//根据cron，构建一个CronTrigger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CronTrigger trigger<span style=color:#f92672>=</span>TriggerBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newTrigger</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getTriggerKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>withSchedule</span><span style=color:#f92672>(</span>scheduleBuilder<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//放入参数，运行时的方法可以获取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        jobDetail<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobDataMap</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span><span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//把任务添加到Quartz中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleJob</span><span style=color:#f92672>(</span>jobDetail<span style=color:#f92672>,</span>trigger<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>把任务添加到 Quartz 后，等cron定义的时间周期到了，就会执行 ScheduleJob 类的 executeInternal 方 法， ScheduleJob 代码如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScheduleJob</span> <span style=color:#66d9ef>extends</span> QuartzJobBean <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>executeInternal</span><span style=color:#f92672>(</span>JobExecutionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> JobExecutionException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ScheduleJobEntity scheduleJob <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>)</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getMergedJobDataMap</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取spring bean
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ScheduleJobLogService scheduleJobLogService <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ScheduleJobLogService<span style=color:#f92672>)</span> SpringContextUt
</span></span><span style=display:flex><span>        ils<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;scheduleJobLogService&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//数据库保存执行记录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ScheduleJobLogEntity log <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ScheduleJobLogEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setJobId</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setBeanName</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setParams</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getParams</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateTime</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//任务开始时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//执行任务 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;任务准备执行，任务ID：&#34;</span> <span style=color:#f92672>+</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Object target <span style=color:#f92672>=</span> SpringContextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            Method method <span style=color:#f92672>=</span> target<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredMethod</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;run&#34;</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            method<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>target<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getParams</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//任务执行总时长 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>long</span> times <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> startTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setTimes</span><span style=color:#f92672>((</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> times<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//任务状态 0 ：成功 1 ：失败
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;任务执行完毕，任务ID：&#34;</span> <span style=color:#f92672>+</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 总共耗时：&#34;</span> <span style=color:#f92672>+</span> tim es <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;毫秒&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;任务执行失败，任务ID：&#34;</span> <span style=color:#f92672>+</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//任务执行总时长
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>long</span> times <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> startTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setTimes</span><span style=color:#f92672>((</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> times<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//任务状态 0 ：成功 1 ：失败 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setError</span><span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(),</span> 0<span style=color:#f92672>,</span> 2000<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduleJobLogService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>log<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=613-云存储模块-1>6.13 云存储模块<a hidden class=anchor aria-hidden=true href=#613-云存储模块-1>#</a></h2><blockquote><p>图片、文件上传，使用的是七牛、阿里云、腾讯云的存储服务，不能上传到本地服务器。上传到本地 服务器，不利于维护，访问速度慢等缺点，所以推荐使用云存储服务。</p></blockquote><h3 id=6131-七牛的配置>6.13.1 七牛的配置<a hidden class=anchor aria-hidden=true href=#6131-七牛的配置>#</a></h3><blockquote><p>如果没有七牛账号，则需要注册七牛账号，才能进行配置，下面演示注册七牛账号并配置，步骤如 下：</p></blockquote><ol><li>[注册七牛账号][34]，并登录后，再创建七牛空间，如下图：</li></ol><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/86h4oq.png alt></p><ol start=2><li>进入管理后端，填写七牛配置信息，如下图：</li></ol><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tkisAZ.png alt></p><p>必填项有域名、AccessKey、SecretKey、空间名。其中，空间名就是才创建的空间名 ios-app ，填进去就可 以了。域名、AccessKey、SecretKey可以通过下图找到：</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/v0K61m.png alt></p><h3 id=6132-阿里云的配置>6.13.2 阿里云的配置<a hidden class=anchor aria-hidden=true href=#6132-阿里云的配置>#</a></h3><ul><li>进入管理后端，填写阿里云配置信息，如下图：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/bHjijJ.png alt></p><ul><li>进去阿里云管理后台，并创建Bucket，如下图：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/zEeaHL.png alt></p><ul><li>通过下面的界面，可以找到域名、BucketName、EndPoint</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tB5WLW.png alt></p><ul><li>通过下面的界面，可以找到AccessKeyId、AccessKeySecret</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/DIzny3.png alt></p><h4 id=6133-腾讯云的配置>6.13.3 腾讯云的配置<a hidden class=anchor aria-hidden=true href=#6133-腾讯云的配置>#</a></h4><ul><li>进入管理后端，填写腾讯云配置信息，如下图：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/lH6UMH.png alt></p><ul><li>进去腾讯云管理后台，并创建Bucket，如下图：</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/UGXMhL.png alt></p><ul><li>通过下面的界面，可以找到域名、BucketName、Bucket所属地区</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/rLnoLL.png alt></p><ul><li>通过下面的界面，可以找到AppId、SecretId、SecretKey</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7XxX9S.png alt></p><h4 id=6134-源码分析>6.13.4 源码分析<a hidden class=anchor aria-hidden=true href=#6134-源码分析>#</a></h4><p>本项目的文件上传，使用的是七牛、阿里云、腾讯云，则需要引入他们的SDK，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.qiniu<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>qiniu-java-sdk<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${qiniu.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;groupId&gt;</span>com.aliyun.oss<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;artifactId&gt;</span>aliyun-sdk-oss<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;version&gt;</span>${aliyun.oss.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;groupId&gt;</span>com.qcloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;artifactId&gt;</span>cos_api<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;version&gt;</span>${qcloud.cos.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>org.slf4j<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>slf4j-log4j12<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>定义抽象类 CloudStorageService ，用来声明上传的公共接口，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CloudStorageService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 云存储配置信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    CloudStorageConfig config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 文件路径
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param prefix 前缀
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param suffix 后缀
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 返回上传路径
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPath</span><span style=color:#f92672>(</span>String prefix<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//生成uuid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String uuid <span style=color:#f92672>=</span> UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>().</span><span style=color:#a6e22e>replaceAll</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//文件路径
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String path <span style=color:#f92672>=</span> DateUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;yyyyMMdd&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> uuid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotBlank</span><span style=color:#f92672>(</span>prefix<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            path <span style=color:#f92672>=</span> prefix <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> path <span style=color:#f92672>+</span> suffix<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 文件上传
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param data 文件字节数组
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param path 文件路径，包含文件名
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 返回http地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 文件上传
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param data   文件字节数组
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param suffix 后缀
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 返回http地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 文件上传
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param inputStream 字节流
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param path        文件路径，包含文件名
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 返回http地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 文件上传
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param inputStream 字节流
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param suffix      后缀
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 返回http地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>七牛上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.common.Zone<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.http.Response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.storage.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.storage.UploadManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.util.Auth<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.io.IOUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 七牛云存储
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QiniuCloudStorageService</span> <span style=color:#66d9ef>extends</span> CloudStorageService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UploadManager uploadManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>QiniuCloudStorageService</span><span style=color:#f92672>(</span>CloudStorageConfig config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        init<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        uploadManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UploadManager<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Configuration<span style=color:#f92672>(</span>Zone<span style=color:#f92672>.</span><span style=color:#a6e22e>autoZone</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        token <span style=color:#f92672>=</span> Auth<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuAccessKey</span><span style=color:#f92672>(),</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuSecretKey</span><span style=color:#f92672>()).</span>
</span></span><span style=display:flex><span>                uploadToken<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuBucketName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Response res <span style=color:#f92672>=</span> uploadManager<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> path<span style=color:#f92672>,</span> token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>res<span style=color:#f92672>.</span><span style=color:#a6e22e>isOK</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;上传七牛出错：&#34;</span> <span style=color:#f92672>+</span> res<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;上传文件失败，请核对七牛配置信息&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuDomain</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data <span style=color:#f92672>=</span> IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;上传文件失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>阿里云上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.aliyun.oss.OSSClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.ByteArrayInputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 阿里云存储
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AliyunCloudStorageService</span> <span style=color:#66d9ef>extends</span> CloudStorageService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OSSClient client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>AliyunCloudStorageService</span><span style=color:#f92672>(</span>CloudStorageConfig config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        init<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OSSClient<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunEndPoint</span><span style=color:#f92672>(),</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunAccessKeyId</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunAccessKeySecret</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>data<span style=color:#f92672>),</span> path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span><span style=color:#a6e22e>putObject</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunBucketName</span><span style=color:#f92672>(),</span> path<span style=color:#f92672>,</span> inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;上传文件失败，请检查配置信息&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunDomain</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>腾讯云上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.COSClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.ClientConfig<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.request.UploadFileRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.sign.Credentials<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.sf.json.JSONObject<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.io.IOUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 腾讯云存储
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QcloudCloudStorageService</span> <span style=color:#66d9ef>extends</span> CloudStorageService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> COSClient client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>QcloudCloudStorageService</span><span style=color:#f92672>(</span>CloudStorageConfig config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        init<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Credentials credentials <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Credentials<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudAppId</span><span style=color:#f92672>(),</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudSe</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>cretId</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudSecretKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//初始化客户端配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ClientConfig clientConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClientConfig<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//设置bucket所在的区域，华南：gz 华北：tj 华东：sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        clientConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>setRegion</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudRegion</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> COSClient<span style=color:#f92672>(</span>clientConfig<span style=color:#f92672>,</span> credentials<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//腾讯云必需要以&#34;/&#34;开头
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>path<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//上传到腾讯云
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        UploadFileRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UploadFileRequest<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudBucketName</span><span style=color:#f92672>(),</span> path<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        String response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>uploadFile</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        JSONObject jsonObject <span style=color:#f92672>=</span> JSONObject<span style=color:#f92672>.</span><span style=color:#a6e22e>fromObject</span><span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>jsonObject<span style=color:#f92672>.</span><span style=color:#a6e22e>getInt</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;code&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;文件上传失败，&#34;</span> <span style=color:#f92672>+</span> jsonObject<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;message&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudDomain</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data <span style=color:#f92672>=</span> IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;上传文件失败&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>对外提供了OSSFactory工厂，可方便业务的调用，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OSSFactory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> SysConfigService sysConfigService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        OSSFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>sysConfigService</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>SysConfigService<span style=color:#f92672>)</span> SpringContextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sysConfi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                gService&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> CloudStorageService <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//获取云存储配置信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CloudStorageConfig config <span style=color:#f92672>=</span> sysConfigService<span style=color:#f92672>.</span><span style=color:#a6e22e>getConfigObject</span><span style=color:#f92672>(</span>ConfigConstant<span style=color:#f92672>.</span><span style=color:#a6e22e>CLOUD_STO</span>
</span></span><span style=display:flex><span>                RAGE_CONFIG_KEY<span style=color:#f92672>,</span> CloudStorageConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>CloudService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>QINIU</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> QiniuCloudStorageService<span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>CloudService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ALIYUN</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AliyunCloudStorageService<span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>CloudService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>QCLOUD</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> QcloudCloudStorageService<span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>文件上传的例子，如下： @RequestMapping("/upload")</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/upload&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;file&#34;</span><span style=color:#f92672>)</span> MultipartFile file<span style=color:#f92672>)</span><span style=color:#66d9ef>throws</span> Exception<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;上传文件不能为空&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//上传文件，并返回文件的http地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String url<span style=color:#f92672>=</span>OSSFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>().</span><span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=614-app-模块-1>6.14 APP 模块<a hidden class=anchor aria-hidden=true href=#614-app-模块-1>#</a></h2><blockquote><p>APP模块，是针对APP使用的，如IOS、Android等，主要是解决用户认证的问题。</p></blockquote><h3 id=6141-app-的使用>6.14.1 APP 的使用<a hidden class=anchor aria-hidden=true href=#6141-app-的使用>#</a></h3><blockquote><p>APP的设计思路：用户通过APP，输入手机号、密码登录后，系统会生成与登录用户一一对应的 token，用户调用需要登录的接口时，只需把token传过来，服务端就知道是谁在访问接口，token如果过期，则拒绝访问，从而保证系统的安全性。</p></blockquote><p>使用很简单，看看下面的例子，就会使用了。仔细观察，我们会发现，有 2 个自定义的注解。其中， @LoginUser注解是获取当前登录用户的信息，有哪些信息，下面会分析的。@Login注解则是需要用户认证，没有登录的用户，不能访问该接口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.annotation.Login<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.annotation.LoginUser<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.GetMapping<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestAttribute<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMapping<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RestController<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiTestController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取用户信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Login</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userInfo&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>userInfo</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@LoginUser</span> UserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>,</span> user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取用户ID
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Login</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>userInfo</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> Integer userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>,</span> userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 忽略Token验证测试
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;notToken&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>notToken</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;无需token也能访问。。。&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=6142-源码分析>6.14.2 源码分析<a hidden class=anchor aria-hidden=true href=#6142-源码分析>#</a></h3><ul><li>我们先来看看，APP用户登录的时候，都干了那些事情，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;APP登录接口&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiLoginController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserService userService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> JwtUtils jwtUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 登录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;login&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;登录&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>login</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> LoginForm form<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//表单校验
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>form<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//用户登录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> userId <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>login</span><span style=color:#f92672>(</span>form<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//生成token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String token <span style=color:#f92672>=</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>generateToken</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>,</span> token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;expire&#34;</span><span style=color:#f92672>,</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getExpire</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>(</span>map<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * jwt工具类
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;renren.jwt&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JwtUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String secret<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String header<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 生成jwt token
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>generateToken</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Date nowDate <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//过期时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Date expireDate <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>nowDate<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> expire <span style=color:#f92672>*</span> 1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Jwts<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeaderParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;typ&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;JWT&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setSubject</span><span style=color:#f92672>(</span>userId <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setIssuedAt</span><span style=color:#f92672>(</span>nowDate<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setExpiration</span><span style=color:#f92672>(</span>expireDate<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>signWith</span><span style=color:#f92672>(</span>SignatureAlgorithm<span style=color:#f92672>.</span><span style=color:#a6e22e>HS512</span><span style=color:#f92672>,</span> secret<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>compact</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Claims <span style=color:#a6e22e>getClaimByToken</span><span style=color:#f92672>(</span>String token<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Jwts<span style=color:#f92672>.</span><span style=color:#a6e22e>parser</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>setSigningKey</span><span style=color:#f92672>(</span>secret<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>parseClaimsJws</span><span style=color:#f92672>(</span>token<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;validate is token error &#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * token是否过期
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return true：过期
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTokenExpired</span><span style=color:#f92672>(</span>Date expiration<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> expiration<span style=color:#f92672>.</span><span style=color:#a6e22e>before</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getSecret</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> secret<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setSecret</span><span style=color:#f92672>(</span>String secret<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>secret</span> <span style=color:#f92672>=</span> secret<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getExpire</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> expire<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setExpire</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span> <span style=color:#f92672>=</span> expire<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> header<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>String header<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>header</span> <span style=color:#f92672>=</span> header<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们从上面的代码，可以看到，用户每次登录的时候，都会生成一个唯一的token，这个token是通过jwt生成 的。</p><ul><li>APP模块的核心配置，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.interceptor.AuthorizationInterceptor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.resolver.LoginUserHandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WebMvcConfig</span> <span style=color:#66d9ef>extends</span> WebMvcConfigurerAdapter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> AuthorizationInterceptor authorizationInterceptor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LoginUserHandlerMethodArgumentResolver loginUserHandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addInterceptors</span><span style=color:#f92672>(</span>InterceptorRegistry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        registry<span style=color:#f92672>.</span><span style=color:#a6e22e>addInterceptor</span><span style=color:#f92672>(</span>authorizationInterceptor<span style=color:#f92672>).</span><span style=color:#a6e22e>addPathPatterns</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app/**&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addArgumentResolvers</span><span style=color:#f92672>(</span>List<span style=color:#f92672>&lt;</span>HandlerMethodArgumentResolver<span style=color:#f92672>&gt;</span> argumentResolvers<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        argumentResolvers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>loginUserHandlerMethodArgumentResolver<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们可以看到，配置了个Interceptor，用来拦截 /app 开头的所有请求，拦截后，会到 AuthorizationInterceptor类preHandle方法处理。只有以 /app开头的请求，API模块认证才会起作用，如果要以/api 开头，则需要修改此处。还配置了argumentResolver，别忽略了啊，下面会讲解。</p><p>温馨提示，别忘了配置shiro，不然会被shiro拦截掉的，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShiroConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;shiroFilter&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ShiroFilterFactoryBean <span style=color:#a6e22e>shirFilter</span><span style=color:#f92672>(</span>SecurityManager securityManager<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//部分代码省略...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> filterMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//让shiro放过，以/app开头的请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//部分代码省略...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilterChainDefinitionMap</span><span style=color:#f92672>(</span>filterMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> shiroFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>分析AuthorizationInterceptor类，我们可以发现，拦截 /app 开头的请求后，都干了些什么，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#f92672>import</span> io.jsonwebtoken.Claims<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.utils.JwtUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.annotation.Login<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.lang.StringUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.HttpStatus<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.HandlerMethod<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.servlet.http.HttpServletRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.servlet.http.HttpServletResponse<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 权限(Token)验证
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthorizationInterceptor</span> <span style=color:#66d9ef>extends</span> HandlerInterceptorAdapter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> JwtUtils jwtUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String USER_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>preHandle</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> Object
</span></span><span style=display:flex><span>            handler<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Login annotation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>handler <span style=color:#66d9ef>instanceof</span> HandlerMethod<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            annotation <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>HandlerMethod<span style=color:#f92672>)</span> handler<span style=color:#f92672>).</span><span style=color:#a6e22e>getMethodAnnotation</span><span style=color:#f92672>(</span>Login<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//获取用户凭证
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String token <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//凭证为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;不能为空&#34;</span><span style=color:#f92672>,</span> HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>UNAUTHORIZED</span><span style=color:#f92672>.</span><span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>alue</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        Claims claims <span style=color:#f92672>=</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getClaimByToken</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>claims <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isTokenExpired</span><span style=color:#f92672>(</span>claims<span style=color:#f92672>.</span><span style=color:#a6e22e>getExpiration</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;失效，请重新登录&#34;</span><span style=color:#f92672>,</span> HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>UNAUTHO</span>
</span></span><span style=display:flex><span>                    RIZED<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//设置userId到request里，后续根据userId，获取用户信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span>USER_KEY<span style=color:#f92672>,</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>(</span>claims<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubject</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们可以发现，进入 /app 请求的接口之前，会判断请求的接口，是否加了@Login注解(需要token认证)，如果没有@Login注解，则不验证token，可以直接访问接口。如果有@Login注解，则需要验证token的正确性，并把userId放到request的USER_KEY里，后续会用到。</p><ul><li>此时，@Login注解的作用，相信大家都明白了。再看看下面的代码，加了@LoginUser注解后，user对象里，就变成当前登录用户的信息，这是什么时候设置进去的呢？</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 获取用户信息
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userInfo&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>userInfo</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@LoginUser</span> UserEntity user<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>  	<span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>,</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>设置user对象进去，其实是在LoginUserHandlerMethodArgumentResolver里干的,LoginUserHandlerMethodArgumentResolver是我们自定义的参数转换器，只要实现HandlerMethodArgumentResolver接口即可，代码如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.annotation.LoginUser<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.entity.UserEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.interceptor.AuthorizationInterceptor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.service.UserService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.MethodParameter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.support.WebDataBinderFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.context.request.NativeWebRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.context.request.RequestAttributes<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.support.ModelAndViewContainer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoginUserHandlerMethodArgumentResolver</span> <span style=color:#66d9ef>implements</span> HandlerMethodArgumentResolver <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserService userService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>supportsParameter</span><span style=color:#f92672>(</span>MethodParameter parameter<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//如果方法的参数是UserEntity，且参数前面有@LoginUser注解，则进入resolveArgument方法，进行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        处理
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> parameter<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterType</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>UserEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> parameter<span style=color:#f92672>.</span><span style=color:#a6e22e>h</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>asParameterAnnotation</span><span style=color:#f92672>(</span>LoginUser<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>resolveArgument</span><span style=color:#f92672>(</span>MethodParameter parameter<span style=color:#f92672>,</span> ModelAndViewContainer container<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                  NativeWebRequest request<span style=color:#f92672>,</span> WebDataBinderFactory factory<span style=color:#f92672>)</span> thr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ows Exception
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//获取用户ID，之前设置进去的，还有印象吧
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object object <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span>AuthorizationInterceptor<span style=color:#f92672>.</span><span style=color:#a6e22e>USER_KEY</span><span style=color:#f92672>,</span> RequestAttrib
</span></span><span style=display:flex><span>                utes<span style=color:#f92672>.</span><span style=color:#a6e22e>SCOPE_REQUEST</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>object <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//通过userId，获取用户信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        UserEntity user <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryObject</span><span style=color:#f92672>((</span>Long<span style=color:#f92672>)</span> object<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//把当前用户信息，设置到UserEntity参数的user对象里
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> user<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=第-7-章-生产环境部署>第 7 章 生产环境部署<a hidden class=anchor aria-hidden=true href=#第-7-章-生产环境部署>#</a></h1><blockquote><p>部署项目前，需要准备JDK8、Maven、MySQL5.5+环境，参考开发环境搭建。</p></blockquote><h2 id=71-jar-包部署>7.1 jar 包部署<a hidden class=anchor aria-hidden=true href=#71-jar-包部署>#</a></h2><h2 id=72-docker-部署>7.2 docker 部署<a hidden class=anchor aria-hidden=true href=#72-docker-部署>#</a></h2><h2 id=73-集群部署>7.3 集群部署<a hidden class=anchor aria-hidden=true href=#73-集群部署>#</a></h2><h3 id=71-jar-包部署-1>7.1 jar 包部署<a hidden class=anchor aria-hidden=true href=#71-jar-包部署-1>#</a></h3><blockquote><p>Spring Boot项目，推荐打成jar包的方式，部署到服务器上。</p></blockquote><ul><li>Spring Boot内置了Tomcat，可配置Tomcat的端口号、初始化线程数、最大线程数、连接超时时长、https 等等，如下所示：</li></ul><pre tabindex=0><code class=language-YML data-lang=YML>server:
  tomcat:
    uri-encoding: UTF-8
    max-threads: 1000
    min-spare-threads: 30
  port: 8080
  connection-timeout: 5000ms
  servlet:
    context-path: /renren-fast
    session:
    cookie:
    http-only: true
  ssl:
    key-store: classpath:.keystore
    key-store-type: JKS
    key-password: 123456
    key-alias: tomcat
</code></pre><ul><li>当然，还可以指定jvm的内存大小，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>java -Xms4g -Xmx4g -Xmn1g -server -jar renren-fast.jar
</span></span></code></pre></div><ul><li>在windows下部署，只需打开cmd窗口，输入如下命令：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>java -jar renren-fast.jar --spring.profiles.active<span style=color:#f92672>=</span>prod
</span></span></code></pre></div><ul><li>在Linux下部署，只需输入如下命令，即可在Linux后台运行：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>nohup java -jar renren-fast.jar --spring.profiles.active<span style=color:#f92672>=</span>prod &gt; renren.log &amp;
</span></span></code></pre></div><ul><li>在Linux环境下，我们一般可以创建shell脚本，用于重启项目，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#创建启动的shell脚本</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># vim start.sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>process<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>ps -fe|grep <span style=color:#e6db74>&#34;renren-fast.jar&#34;</span> |grep -ivE <span style=color:#e6db74>&#34;grep|cron&#34;</span> |awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> !$process <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		echo <span style=color:#e6db74>&#34;stop erp process </span>$process<span style=color:#e6db74> .....&#34;</span>
</span></span><span style=display:flex><span>		kill -9 $process
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;start erp process.....&#34;</span>
</span></span><span style=display:flex><span>nohup java -Dspring.profiles.active<span style=color:#f92672>=</span>prod -jar renren-fast.jar --server.port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span> --server.servlet.context-path<span style=color:#f92672>=</span>/renren-fast 2&gt;&amp;<span style=color:#ae81ff>1</span> | cronolog log.%Y-%m-%d.out &gt;&gt; /dev/null &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;start erp success!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#通过shell脚本启动项目</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># yum install -y cronolog</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># chomd +x start.sh</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># ./start.sh</span>
</span></span></code></pre></div><h2 id=72-docker-部署-1>7.2 docker 部署<a hidden class=anchor aria-hidden=true href=#72-docker-部署-1>#</a></h2><p>安装docker环境</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#安装docker</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -sSL https://get.docker.com/ | sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#启动docker</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark ~<span style=color:#f92672>]</span><span style=color:#75715e># service docker start</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看docker版本信息</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark ~<span style=color:#f92672>]</span><span style=color:#75715e># docker version</span>
</span></span><span style=display:flex><span>Client:
</span></span><span style=display:flex><span>    Version: 17.07.0-ce
</span></span><span style=display:flex><span>    API version: 1.31
</span></span><span style=display:flex><span>    Go version: go1.8.3
</span></span><span style=display:flex><span>    Git commit: <span style=color:#ae81ff>8784753</span>
</span></span><span style=display:flex><span>    Built: Tue Aug <span style=color:#ae81ff>29</span> 17:42:01 <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>    OS/Arch: linux/amd64
</span></span><span style=display:flex><span>Server:
</span></span><span style=display:flex><span>    Version: 17.07.0-ce
</span></span><span style=display:flex><span>    API version: 1.31 <span style=color:#f92672>(</span>minimum version 1.12<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Go version: go1.8.3
</span></span><span style=display:flex><span>    Git commit: <span style=color:#ae81ff>8784753</span>
</span></span><span style=display:flex><span>    Built: Tue Aug <span style=color:#ae81ff>29</span> 17:43:23 <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>    OS/Arch: linux/amd64
</span></span><span style=display:flex><span>    Experimental: false
</span></span></code></pre></div><ul><li>还需要准备java、maven环境，请自行安装</li><li>通过maven插件，构建docker镜像</li></ul><h2 id=打包并构建项目镜像>打包并构建项目镜像<a hidden class=anchor aria-hidden=true href=#打包并构建项目镜像>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># mvn clean package docker:build</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#省略打包log...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> Building image renren/fast
</span></span><span style=display:flex><span>Step 1/6 : FROM java:8
</span></span><span style=display:flex><span>	---&gt; d23bdf5b1b1b
</span></span><span style=display:flex><span>Step 2/6 : EXPOSE <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>    ---&gt; Using cache
</span></span><span style=display:flex><span>    ---&gt; 8e33aadb2c18
</span></span><span style=display:flex><span>Step 3/6 : VOLUME /tmp
</span></span><span style=display:flex><span>  ---&gt; Using cache
</span></span><span style=display:flex><span>  ---&gt; c5dc0c509062
</span></span><span style=display:flex><span>Step 4/6 : ADD renren-fast-1.2.0.jar /app.jar
</span></span><span style=display:flex><span>  ---&gt; 831bc3ca84bc
</span></span><span style=display:flex><span>Step 5/6 : RUN bash -c <span style=color:#e6db74>&#39;touch /app.jar&#39;</span>
</span></span><span style=display:flex><span>  ---&gt; Running in fe3ef9343e4c
</span></span><span style=display:flex><span>  ---&gt; b3d6dd6fc297
</span></span><span style=display:flex><span>Removing intermediate container fe3ef9343e4c
</span></span><span style=display:flex><span>Step 6/6 : ENTRYPOINT java -jar /app.jar
</span></span><span style=display:flex><span>  ---&gt; Running in 89adce4ae167
</span></span><span style=display:flex><span>  ---&gt; a4ae60970a77
</span></span><span style=display:flex><span>Removing intermediate container 89adce4ae167
</span></span><span style=display:flex><span>ProgressMessage<span style=color:#f92672>{</span>id<span style=color:#f92672>=</span>null, status<span style=color:#f92672>=</span>null, stream<span style=color:#f92672>=</span>null, error<span style=color:#f92672>=</span>null, progress<span style=color:#f92672>=</span>null, progressDetail<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>null<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Successfully built a4ae60970a77
</span></span><span style=display:flex><span>Successfully tagged renren/fast:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看镜像</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker images</span>
</span></span><span style=display:flex><span>REPOSITORY 		TAG 		IMAGE ID 				 CREATED 					SIZE
</span></span><span style=display:flex><span>renren/fast 	latest 	a4ae60970a77 		 <span style=color:#ae81ff>14</span> seconds ago 	714MB
</span></span><span style=display:flex><span>java 					<span style=color:#ae81ff>8</span> 			d23bdf5b1b1b 		 <span style=color:#ae81ff>7</span> months ago 		643MB
</span></span></code></pre></div><ul><li>安装docker-compose，用来管理容器</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#下载地址：https://github.com/docker/compose/releases</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#下载docker-compose</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#增加可执行权限</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># chmod +x /usr/local/bin/docker-compose</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看版本信息</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose version</span>
</span></span><span style=display:flex><span>docker-compose version 1.16.1, build 6d1ac21
</span></span><span style=display:flex><span>docker-py version: 2.5.1
</span></span><span style=display:flex><span>CPython version: 2.7.13
</span></span><span style=display:flex><span>OpenSSL version: OpenSSL 1.0.1t <span style=color:#ae81ff>3</span> May <span style=color:#ae81ff>2016</span>
</span></span></code></pre></div><p>如果下载不了，可以用迅雷将https://github.com/docker/compose/releases/download/1.16.1/docker-compose-
Linux-x86_64下载到本地，再上传到服务器</p><ul><li>通过docker-compose，启动项目，如下所示：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#启动项目</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose up -d</span>
</span></span><span style=display:flex><span>Creating network <span style=color:#e6db74>&#34;renrenfast_default&#34;</span> with the default driver
</span></span><span style=display:flex><span>Creating renrenfast_campus_1 ...
</span></span><span style=display:flex><span>Creating renrenfast_campus_1 ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看启动的容器</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker ps</span>
</span></span><span style=display:flex><span>CONTAINER ID 	IMAGE 			COMMAND 							CREATED 						STATUS 				PORTS 				
</span></span><span style=display:flex><span>NAMES
</span></span><span style=display:flex><span>f4e3fcdd8dd4 	renren/fast <span style=color:#e6db74>&#34;java -jar /app.jar&#34;</span> 	<span style=color:#ae81ff>55</span> seconds ago 			Up <span style=color:#ae81ff>3</span> seconds 	0.0.0.0:8080-&gt;8080/tcp renrenfast_renren-fast_1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#停掉并删除，docker-compose管理的容器</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose down</span>
</span></span><span style=display:flex><span>Stopping renrenfast_renren-fast_1 ... <span style=color:#66d9ef>done</span> 
</span></span><span style=display:flex><span>Removing renrenfast_renren-fast_1 ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Removing network renrenfast_default
</span></span></code></pre></div><h2 id=73-集群部署-1>7.3 集群部署<a hidden class=anchor aria-hidden=true href=#73-集群部署-1>#</a></h2><blockquote><p>本系统支持集群部署，集群部署，只需启动多个节点，并配置Nginx即可。</p></blockquote><ul><li>配置Nginx</li></ul><pre tabindex=0><code class=language-conf data-lang=conf>http {
    upstream renren {
        server localhost:8080;
        server localhost:8081;
    }
    
    server {
        listen 80;
        server_name localhost;
        location /renren-fast {
            proxy_pass http://renren;
            client_max_body_size 1024m;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;
            proxy_redirect off;
        }
    }
}
</code></pre><ul><li>通过http://localhost/renren-fast，就可以访问了</li></ul><div class=post-meta></hr>注：本作品采用<a rel=license target=view_window href=http://creativecommons.org/licenses/by-nc-sa/4.0/> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议 </a>进行许可。</div></div><footer class=post-footer><ul class=post-tags><li><a href=https://swimminghao1.github.io/tags/springboot/>🏷 SpringBoot</a></li><li><a href=https://swimminghao1.github.io/tags/%E8%84%9A%E6%89%8B%E6%9E%B6/>🏷 脚手架</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share renren-fast开发文档3.0最新版 on twitter" href="https://twitter.com/intent/tweet/?text=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f&hashtags=SpringBoot%2c%e8%84%9a%e6%89%8b%e6%9e%b6"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fast开发文档3.0最新版 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f&title=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&summary=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&source=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fast开发文档3.0最新版 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f&title=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fast开发文档3.0最新版 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fast开发文档3.0最新版 on whatsapp" href="https://api.whatsapp.com/send?text=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88%20-%20https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fast开发文档3.0最新版 on telegram" href="https://telegram.me/share/url?text=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><nav class=paginav><a class=prev href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/08_01_nas/nas%E6%95%99%E7%A8%8B/%E5%BD%B1%E9%9F%B3/emby-server%E5%AA%92%E4%BD%93%E5%BA%93%E7%A1%AC%E9%93%BE%E6%8E%A5/><span class=title>« 上一页</span><br><span>emby-server媒体库硬链接</span></a>
<a class=next href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/spring-boot-2.0-%E9%9B%86%E6%88%90-redis/><span class=title>下一页 »</span><br><span>Spring Boot 2.0 集成 redis</span></a></nav></footer></article></main><footer class=footer><span>Copyright &copy; 2023 • <a href=https://swimminghao1.github.io/>swimminghao</a></span><div><span><a href=/about/>关于</a>
• <a href=/disclaimer/>免责声明</a>
• <a href=/sitemap.xml target=view_window>站点地图</a>
• <a href=https://www.foreverblog.cn/go.html target=view_window>虫洞</a>
• PV <span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin"></i></span></span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><meta name=”apple-mobile-web-app-capable” content="”yes”"><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js")})</script></body></html>