<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ | swimminghao</title><meta name=keywords content="SpringBoot,è„šæ‰‹æ¶"><meta name=description content="renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ ç‰ˆæƒè¯´æ˜ æœ¬æ–‡æ¡£ä¸ºä»˜è´¹æ–‡æ¡£ï¼Œç‰ˆæƒå½’äººäººå¼€æºï¼ˆrenren.ioï¼‰æ‰€æœ‰ï¼Œå¹¶ä¿ç•™ä¸€åˆ‡æƒåˆ©ï¼Œæœ¬æ–‡æ¡£åŠå…¶æè¿°"><meta name=author content="swimminghao"><link rel=canonical href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/><meta name=yandex-verification content="73b1a797f62c0e98"><meta name=baidu-site-verification content="code-gnOrbP1RyC"><meta name=baidu_union_verify content="4c552c344295cb984c46ebe74962b067"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/satouriko/LxgwWenKai_Webfonts@v1.101/dist/LXGWWenKai-Light.css><link crossorigin=anonymous href=/assets/css/stylesheet.min.0a5d9aa21e56d0b7d41b1d4b56af0b911caf526faf5060a8d3717579bf27cb93.css integrity="sha256-Cl2aoh5W0LfUGx1LVq8LkRyvUm+vUGCo03F1eb8ny5M=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://swimminghao1.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://swimminghao1.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://swimminghao1.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://swimminghao1.github.io/apple-touch-icon.png><link rel=mask-icon href=https://swimminghao1.github.io/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.97.0"><link rel=manifest href=/manifest.json><script type=text/javascript>function downloadJSAtOnload(){var e=document.createElement("script");e.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7296634171837358",document.body.appendChild(e)}window.addEventListener?window.addEventListener("load",downloadJSAtOnload,!1):window.attachEvent?window.attachEvent("onload",downloadJSAtOnload):window.onload=downloadJSAtOnload</script><script async defer data-website-id=3d947a98-2774-46b0-805f-fe2e4877a1d7 src=https://umami.frytea.com/umami.js></script>
<script async src=https://swimminghao1.github.io/js/busuanzi.pure.mini.js></script>
<link rel=stylesheet href=/libs/font-awesome-4.7.0/css/font-awesome.min.css><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=https://swimminghao1.github.io/js/mermaid.min.js crossorigin=anonymous></script>
<script>const config={startOnLoad:!0,theme:"forest",themeVariables:{lineColor:"#fafafa"},flowchart:{useMaxWidth:!1,htmlLabels:!0}};mermaid.initialize(config),window.onload=()=>{window.mermaid.init(void 0,document.querySelectorAll(".language-mermaid"))}</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?c49e2f5be5e009382be07455c33b1394",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-136094326-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ"><meta property="og:description" content="renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ ç‰ˆæƒè¯´æ˜ æœ¬æ–‡æ¡£ä¸ºä»˜è´¹æ–‡æ¡£ï¼Œç‰ˆæƒå½’äººäººå¼€æºï¼ˆrenren.ioï¼‰æ‰€æœ‰ï¼Œå¹¶ä¿ç•™ä¸€åˆ‡æƒåˆ©ï¼Œæœ¬æ–‡æ¡£åŠå…¶æè¿°"><meta property="og:type" content="article"><meta property="og:url" content="https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/"><meta property="og:image" content="https://swimminghao1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-03-16T10:05:00+00:00"><meta property="article:modified_time" content="2022-03-16T10:05:00+00:00"><meta property="og:site_name" content="swimminghao"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://swimminghao1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ"><meta name=twitter:description content="renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ ç‰ˆæƒè¯´æ˜ æœ¬æ–‡æ¡£ä¸ºä»˜è´¹æ–‡æ¡£ï¼Œç‰ˆæƒå½’äººäººå¼€æºï¼ˆrenren.ioï¼‰æ‰€æœ‰ï¼Œå¹¶ä¿ç•™ä¸€åˆ‡æƒåˆ©ï¼Œæœ¬æ–‡æ¡£åŠå…¶æè¿°"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"https://swimminghao1.github.io/post/"},{"@type":"ListItem","position":2,"name":"renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ","item":"https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ","name":"renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ","description":"renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ ç‰ˆæƒè¯´æ˜ æœ¬æ–‡æ¡£ä¸ºä»˜è´¹æ–‡æ¡£ï¼Œç‰ˆæƒå½’äººäººå¼€æºï¼ˆrenren.ioï¼‰æ‰€æœ‰ï¼Œå¹¶ä¿ç•™ä¸€åˆ‡æƒåˆ©ï¼Œæœ¬æ–‡æ¡£åŠå…¶æè¿°","keywords":["SpringBoot","è„šæ‰‹æ¶"],"articleBody":"renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ ç‰ˆæƒè¯´æ˜  æœ¬æ–‡æ¡£ä¸ºä»˜è´¹æ–‡æ¡£ï¼Œç‰ˆæƒå½’äººäººå¼€æºï¼ˆrenren.ioï¼‰æ‰€æœ‰ï¼Œå¹¶ä¿ç•™ä¸€åˆ‡æƒåˆ©ï¼Œæœ¬æ–‡æ¡£åŠå…¶æè¿°çš„å†…å®¹å—æœ‰å…³æ³•å¾‹çš„ç‰ˆæƒä¿æŠ¤ï¼Œå¯¹æœ¬æ–‡æ¡£ä»¥ä»»ä½•å½¢å¼çš„éæ³•å¤åˆ¶ã€æ³„éœ²æˆ–æ•£å¸ƒåˆ°ç½‘ç»œæä¾›ä¸‹è½½ï¼Œéƒ½å°†å¯¼è‡´ç›¸åº”çš„æ³•å¾‹è´£ä»»ã€‚\n å…è´£å£°æ˜  æœ¬æ–‡æ¡£ä»…æä¾›é˜¶æ®µæ€§ä¿¡æ¯ï¼Œæ‰€å«å†…å®¹å¯æ ¹æ®é¡¹ç›®çš„å®é™…æƒ…å†µéšæ—¶æ›´æ–°ï¼Œä»¥äººäººå¼€æºç¤¾åŒºå…¬å‘Šä¸ºå‡†ã€‚å¦‚å› æ–‡æ¡£ä½¿ç”¨ä¸å½“é€ æˆçš„ç›´æ¥æˆ–é—´æ¥æŸå¤±ï¼Œäººäººå¼€æºä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚\n æ–‡æ¡£æ›´æ–°  æœ¬æ–‡æ¡£ç”±äººäººå¼€æºäº 2019 å¹´ 03 æœˆ 01 æ—¥æœ€åä¿®è®¢ã€‚\n ç¬¬ 1 ç«  é¡¹ç›®ä»‹ç»  äººäººæƒé™ç³»ç»Ÿæ˜¯ä¸€å¥—è½»é‡çº§çš„æƒé™ç³»ç»Ÿï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€éƒ¨é—¨ç®¡ç†ã€èœå•ç®¡ç†ã€å®šæ—¶ä»»åŠ¡ã€ å‚æ•°ç®¡ç†ã€å­—å…¸ç®¡ç†ã€æ–‡ä»¶ä¸Šä¼ ã€ç™»å½•æ—¥å¿—ã€æ“ä½œæ—¥å¿—ã€å¼‚å¸¸æ—¥å¿—ã€æ–‡ç« ç®¡ç†ã€APPæ¨¡å—ç­‰åŠŸèƒ½ã€‚å…¶ä¸­ï¼Œè¿˜æ‹¥æœ‰å¤šæ•°æ®æºã€æ•°æ®æƒé™ã€å›½é™…åŒ–æ”¯æŒã€Redisç¼“å­˜åŠ¨æ€å¼€å¯ä¸å…³é—­ã€ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç­‰æŠ€æœ¯ç‰¹ç‚¹ã€‚\n 1.1 é¡¹ç›®æè¿° 1.2 é¡¹ç›®ç‰¹ç‚¹ 1.3 æ•°æ®äº¤äº’ 1.4 å¼€å‘ç¯å¢ƒæ­å»º 1.5 è·å–å¸®åŠ© 1.1 é¡¹ç›®æè¿° renren-fastæ˜¯ä¸€å¥—è½»é‡çº§çš„æƒé™ç³»ç»Ÿï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€èœå•ç®¡ç†ã€å®šæ—¶ä»»åŠ¡ã€æ–‡ä»¶ä¸Šä¼ ã€ç³» ç»Ÿæ—¥å¿—ã€APPæ¨¡å—ç­‰åŠŸèƒ½ã€‚å…¶ä¸­ï¼Œè¿˜æ‹¥æœ‰å¤šæ•°æ®æºã€Redisç¼“å­˜åŠ¨æ€å¼€å¯ä¸å…³é—­ã€ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç­‰æŠ€æœ¯ç‰¹ ç‚¹ã€‚\n1.2 é¡¹ç›®ç‰¹ç‚¹  renren-fasté‡‡ç”¨SpringBoot 2.1ã€MyBatisã€Shiroæ¡†æ¶ï¼Œå¼€å‘çš„ä¸€å¥—æƒé™ç³»ç»Ÿï¼Œæä½é—¨æ§›ï¼Œæ‹¿æ¥å³ç”¨ã€‚è®¾ è®¡ä¹‹åˆï¼Œå°±éå¸¸æ³¨é‡å®‰å…¨æ€§ï¼Œä¸ºä¼ä¸šç³»ç»Ÿä¿é©¾æŠ¤èˆªï¼Œè®©ä¸€åˆ‡éƒ½å˜å¾—å¦‚æ­¤ç®€å•ã€‚ çµæ´»çš„æƒé™æ§åˆ¶ï¼Œå¯æ§åˆ¶åˆ°é¡µé¢æˆ–æŒ‰é’®ï¼Œæ»¡è¶³ç»å¤§éƒ¨åˆ†çš„æƒé™éœ€æ±‚ å®Œå–„çš„ XSS é˜²èŒƒåŠè„šæœ¬è¿‡æ»¤ï¼Œå½»åº•æœç» XSS æ”»å‡» æ”¯æŒMySQLã€Oracleã€SQL Serverã€PostgreSQLç­‰ä¸»æµæ•°æ®åº“   æ¨èä½¿ç”¨é˜¿é‡Œäº‘æœåŠ¡å™¨éƒ¨ç½²é¡¹ç›®ï¼Œå…è´¹é¢†å–é˜¿é‡Œäº‘ä¼˜æƒ åˆ¸ï¼Œè¯·ç‚¹å‡»ã€å…è´¹é¢†å–ã€‘\n1.3 æ•°æ®äº¤äº’  ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œwebé¡¹ç›®éƒ½æ˜¯é€šè¿‡sessionè¿›è¡Œè®¤è¯ï¼Œæ¯æ¬¡è¯·æ±‚æ•°æ®æ—¶ï¼Œéƒ½ä¼šæŠŠjsessionidæ”¾åœ¨cookieä¸­ï¼Œä»¥ä¾¿ä¸æœåŠ¡ç«¯ä¿æŒä¼šè¯ æœ¬é¡¹ç›®æ˜¯å‰åç«¯åˆ†ç¦»çš„ï¼Œé€šè¿‡tokenè¿›è¡Œè®¤è¯ï¼ˆç™»å½•æ—¶ï¼Œç”Ÿæˆå”¯ä¸€çš„tokenå‡­è¯ï¼‰ï¼Œæ¯æ¬¡è¯·æ±‚æ•°æ®æ—¶ï¼Œéƒ½ä¼šæŠŠtokenæ”¾åœ¨headerä¸­ï¼ŒæœåŠ¡ç«¯è§£ætokenï¼Œå¹¶ç¡®å®šç”¨æˆ·èº«ä»½åŠç”¨æˆ·æƒé™ï¼Œæ•°æ®é€šè¿‡jsonäº¤äº’ æ•°æ®äº¤äº’æµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  1.4 å¼€å‘ç¯å¢ƒæ­å»º 1.4.1 è½¯ä»¶éœ€æ±‚  JDK 1.8+ Maven 3.0+ MySQL 5.5+ Oracle 11g+ SQL Server 2012+ PostgreSQL 9.4+  1.4.2 ä¸‹è½½æºç   é€šè¿‡ git ï¼Œä¸‹è½½renren-fastæºç ï¼Œå¦‚ä¸‹ï¼š  git clone https://gitee.com/renrenio/renren-fast.git 1.4.3 IDEA å¼€å‘å·¥å…·  IDEAæ‰“å¼€é¡¹ç›®ï¼Œ File - Open å¦‚ä¸‹å›¾ï¼š  1.4.4 Eclipse å¼€å‘å·¥å…·  Eclipseå¯¼å…¥é¡¹ç›®ï¼Œå¦‚ä¸‹å›¾ï¼š  1.4.5 åˆ›å»ºæ•°æ®åº“  åˆ›å»ºæ•°æ®åº“ renren_fast ï¼Œæ•°æ®åº“ç¼–ç ä¸ºUTF-8  CREATE DATABASE renren_fast CHARACTER SET utf8 COLLATE utf8_general_ci;  æ‰§è¡Œ db/mysql.sql æ–‡ä»¶ï¼Œåˆå§‹åŒ–æ•°æ®ï¼ˆé»˜è®¤æ”¯æŒMySQLï¼‰  1.4.6 ä¿®æ”¹é…ç½®æ–‡ä»¶  ä¿®æ”¹ application-dev.yml ï¼Œæ›´æ–°MySQLè´¦å·å’Œå¯†ç  è¿è¡Œ io.renren.RenrenApplication.java çš„ main æ–¹æ³•ï¼Œåˆ™å¯å¯åŠ¨é¡¹ç›® Swaggerè·¯å¾„ï¼šhttp://localhost:8080/renren-fast/swagger/index.html Swaggeræ³¨è§£è·¯å¾„ï¼šhttp://localhost:8080/renren-fast/swagger-ui.html  1.4.7 å‰ç«¯éƒ¨ç½²  renren-fast-vueåŸºäºvueã€element-uiæ„å»ºå¼€å‘ï¼Œå®ç°renren-faståå°ç®¡ç†å‰ç«¯åŠŸèƒ½ï¼Œæä¾›ä¸€å¥—æ›´ä¼˜çš„å‰ç«¯è§£å†³æ–¹æ¡ˆã€‚ æ¬¢è¿staræˆ–forkå‰ç«¯Gitåº“ï¼Œæ–¹ä¾¿æ—¥åå¯»æ‰¾ï¼ŒåŠäºŒæ¬¡å¼€å‘\n  å¼€å‘ç¯å¢ƒï¼Œéœ€è¦å®‰è£…node8.xæœ€æ–°ç‰ˆ  # å…‹éš†é¡¹ç›® git clone https://gitee.com/renrenio/renren-fast-vue.git # å®‰è£…ä¾èµ– npm install --registry=https://registry.npm.taobao.org # å¯åŠ¨æœåŠ¡ npm run dev  ç”Ÿäº§ç¯å¢ƒï¼Œæ‰“åŒ…å¹¶æŠŠdistç›®å½•æ–‡ä»¶ï¼Œéƒ¨ç½²åˆ°Nginxé‡Œ  #æ„å»ºç”Ÿäº§ç¯å¢ƒ(é»˜è®¤) npm run build # æ„å»ºæµ‹è¯•ç¯å¢ƒ npm run build --qa # æ„å»ºéªŒæ”¶ç¯å¢ƒ npm run build --uat # æ„å»ºç”Ÿäº§ç¯å¢ƒ npm run build --prod # å®‰è£…Nginxï¼Œå¹¶é…ç½®Nginx server { \tlisten 80; \tserver_name localhost; \tlocation / { \troot E:\\\\renren-fast-vue; \tindex index.html index.htm; \t} } # å¯åŠ¨Nginxåï¼Œè®¿é—®å¦‚ä¸‹è·¯å¾„å³å¯ http://localhost  ç™»å½•çš„è´¦å·å¯†ç ï¼šadmin/admin  1.5 è·å–å¸®åŠ©   åç«¯åœ°å€ï¼šhttps://gitee.com/renrenio/renren-fast\n  å‰ç«¯åœ°å€ï¼šhttps://github.com/renrenio/renren-fast-vue\n  ä»£ç ç”Ÿæˆå™¨ï¼šhttps://gitee.com/renrenio/renren-generator\n  å®˜æ–¹ç¤¾åŒºï¼šhttps://www.renren.io/community\n  å¦‚éœ€å¯»æ±‚å¸®åŠ©ã€é¡¹ç›®å»ºè®®ã€æŠ€æœ¯è®¨è®ºç­‰ï¼Œè¯·ç§»æ­¥åˆ°å®˜æ–¹ç¤¾åŒºï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´è¿›è¡Œè§£ç­”æˆ–å›å¤ å¦‚éœ€å…³æ³¨é¡¹ç›®æœ€æ–°åŠ¨æ€ï¼Œè¯·Watchã€Staré¡¹ç›®ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹é¡¹ç›®æœ€å¥½çš„æ”¯æŒ\n  ç¬¬ 2 ç«  æ•°æ®åº“æ”¯æŒ 2.1 MySQL æ•°æ®åº“æ”¯æŒ 2.2 Oracle æ•°æ®åº“æ”¯æŒ 2.3 SQL Server æ•°æ®åº“æ”¯æŒ 2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ 2.1 MySQL æ•°æ®åº“æ”¯æŒ  ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  spring:  datasource:  druid:  driver-class-name: com.mysql.jdbc.Driver  url: jdbc:mysql://localhost:3306/renren_fast?allowMultiQueries=true\u0026useUnicode=true\u0026characterEncoding=UTF-8\u0026useSSL=false  username: root  password: 123456 æ‰§è¡Œdb/mysql.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯  2.2 Oracle æ•°æ®åº“æ”¯æŒ  ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  spring:  datasource:  druid:  driver-class-name: oracle.jdbc.OracleDriver  url: jdbc:oracle:thin:@192.168.10.10:1521:renren  username: renren_fast  password: 123456 æ‰§è¡Œdb/oracle.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯  2.3 SQL Server æ•°æ®åº“æ”¯æŒ  ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  spring:  datasource:  druid:  driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver  url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast  username: sa  password: 123456 æ‰§è¡Œdb/sqlserver.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯  2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ  ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  spring:  datasource:  druid:  driver-class-name: org.postgresql.Driver  url: jdbc:postgresql://192.168.10.10:5432/renren_fast  username: renren  password: 123456 ä¿®æ”¹quartzé…ç½®ä¿¡æ¯ï¼Œquartzé…ç½®æ–‡ä»¶ ScheduleConfig.java ï¼Œæ‰“å¼€æ³¨é‡Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  //PostgreSQLæ•°æ®åº“ï¼Œéœ€è¦æ‰“å¼€æ­¤æ³¨é‡Š prop.put(\"org.quartz.jobStore.driverDelegateClass\", \"org.quartz.impl.jdbcjobstore.PostgreSQLD elegate\"); æ‰§è¡Œdb/postgresql.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯  ç¬¬ 3 ç«  å¤šæ•°æ®æºæ”¯æŒ 3.1 å¤šæ•°æ®æºé…ç½® 3.2 å¤šæ•°æ®æºä½¿ç”¨ 3.3 æºç è®²è§£ 3.1 å¤šæ•°æ®æºé…ç½®  å¤šæ•°æ®æºçš„åº”ç”¨åœºæ™¯ï¼Œä¸»è¦é’ˆå¯¹è·¨å¤šä¸ªæ•°æ®åº“å®ä¾‹çš„æƒ…å†µï¼Œå¦‚æœæ˜¯åŒå®ä¾‹ä¸­çš„å¤šä¸ªæ•°æ®åº“ï¼Œåˆ™æ²¡å¿…è¦ä½¿ç”¨å¤šæ•°æ®æºã€‚\n #ä¸‹é¢æ¼”ç¤ºå•å®ä¾‹ï¼Œå¤šæ•°æ®åº“çš„ä½¿ç”¨æƒ…å†µ select * from db.table; #å…¶ä¸­ï¼Œdbä¸ºæ•°æ®åº“åï¼Œtableä¸ºæ•°æ®åº“è¡¨å  é…ç½®å¤šæ•°æ®æºï¼Œå¦‚æœæ˜¯å¼€å‘ç¯å¢ƒï¼Œåˆ™ä¿®æ”¹ application-dev.xml ï¼Œå¦‚ä¸‹æ‰€ç¤º  å¤šæ•°æ®æºçš„é…ç½® dynamic:  datasource:  slave1:  driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver  url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast  username: sa  password: 123456  slave2:  driver-class-name: org.postgresql.Driver  url: jdbc:postgresql://192.168.10.10:5432/renren_fast  username: postgres  password: 123456 3.2 å¤šæ•°æ®æºä½¿ç”¨  å¤šæ•°æ®æºçš„ä½¿ç”¨ï¼Œåªéœ€åœ¨Serviceç±»ã€æ–¹æ³•ä¸Šæ·»åŠ @DataSource(\"\")æ³¨è§£å³å¯ï¼Œæ¯”å¦‚åœ¨ç±»ä¸Šæ·»åŠ äº† @DataSource(â€œuserDBâ€)æ³¨è§£ï¼Œåˆ™è¡¨ç¤ºè¯¥Serviceæ–¹æ³•é‡Œçš„æ‰€æœ‰CURDï¼Œéƒ½ä¼šåœ¨ userDB æ•°æ®æºé‡Œæ‰§è¡Œã€‚\n  å¤šæ•°æ®æºæ³¨è§£ä½¿ç”¨è§„åˆ™  æ”¯æŒåœ¨Serviceç±»æˆ–æ–¹æ³•ä¸Šï¼Œæ·»åŠ å¤šæ•°æ®æºçš„æ³¨è§£@DataSource åœ¨Serviceç±»ä¸Šæ·»åŠ äº†@DataSourceæ³¨è§£ï¼Œåˆ™è¯¥ç±»ä¸‹çš„æ‰€æœ‰æ–¹æ³•ï¼Œéƒ½ä¼šä½¿ç”¨@DataSourceæ ‡æ³¨çš„æ•°æ®æº åœ¨Serviceç±»ã€æ–¹æ³•ä¸Šéƒ½æ·»åŠ äº†@DataSourceæ³¨è§£ï¼Œåˆ™æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼šè¦†ç›–Serviceç±»ä¸Šçš„æ³¨è§£   ç¼–å†™DynamicDataSourceTestService.javaï¼Œæµ‹è¯•å¤šæ•°æ®æºåŠäº‹ç‰©  package io.renren.service;  import io.renren.commons.dynamic.datasource.annotation.DataSource; import io.renren.dao.SysUserDao; import io.renren.entity.SysUserEntity; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Service; import org.springframework.transaction.annotation.Transactional;  /** * æµ‹è¯•å¤šæ•°æ®æº * * @author Mark sunlightcs@gmail.com */ @Service //@DataSource(\"slave1\") å¤šæ•°æ®æºå…¨å±€é…ç½® public class DynamicDataSourceTestService {  @Autowired  private SysUserDao sysUserDao;   @Transactional  public void updateUser(Long id) {  SysUserEntity user = new SysUserEntity();  user.setUserId(id);  user.setMobile(\"13500000000\");  sysUserDao.updateById(user);  }   @Transactional  @DataSource(\"slave1\")  public void updateUserBySlave1(Long id) {  SysUserEntity user = new SysUserEntity();  user.setUserId(id);  user.setMobile(\"13500000001\");  sysUserDao.updateById(user);  }   @DataSource(\"slave2\")  @Transactional  public void updateUserBySlave2(Long id) {  SysUserEntity user = new SysUserEntity();  user.setUserId(id);  user.setMobile(\"13500000002\");  sysUserDao.updateById(user);  //æµ‹è¯•äº‹ç‰©  int i = 1 / 0;  } } è¿è¡Œæµ‹è¯•ç±»DynamicDataSourceTest.javaï¼Œå³å¯æµ‹è¯•å¤šæ•°æ®æºåŠäº‹ç‰©æ˜¯ç”Ÿæ•ˆçš„  package io.renren.service;  import org.junit.Test; import org.junit.runner.RunWith; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.test.context.junit4.SpringRunner;  /** * å¤šæ•°æ®æºæµ‹è¯• * * @author Mark sunlightcs@gmail.com */ @RunWith(SpringRunner.class) @SpringBootTest public class DynamicDataSourceTest {  @Autowired  private DynamicDataSourceTestService dynamicDataSourceTestService;   @Test  public void test() {  Long id = 1L;  dynamicDataSourceTestService.updateUser(id);  dynamicDataSourceTestService.updateUserBySlave1(id);  dynamicDataSourceTestService.updateUserBySlave2(id);  } } å…¶ä¸­ï¼Œ @DataSource(â€œslave1â€) ã€ @DataSource(â€œslave2â€) é‡Œçš„ slave1 ã€ slave2 å€¼ï¼Œæ˜¯åœ¨application- dev.xmlé‡Œé…ç½®çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  dynamic:  datasource:  slave1:  driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver  url: jdbc:sqlserver://localhost:1433;DatabaseName=renren_security  username: sa  password: 123456  slave2:  driver-class-name: org.postgresql.Driver  url: jdbc:postgresql://localhost:5432/renren_security  username: renren  password: 123456 3.3 æºç è®²è§£  å®šä¹‰å¤šæ•°æ®æºæ³¨è§£ç±»@DataSourceï¼Œä½¿ç”¨å¤šæ•°æ®æºæ—¶ï¼Œåªéœ€åœ¨Serviceæ–¹æ³•ä¸Šæ·»åŠ @DataSourceæ³¨è§£å³å¯  import java.lang.annotation.*;  /** * å¤šæ•°æ®æºæ³¨è§£ * * @author Mark sunlightcs@gmail.com */ @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited public @interface DataSource {  String value() default \"\"; } å®šä¹‰è¯»å–å¤šæ•°æ®æºé…ç½®æ–‡ä»¶çš„ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  /** * å¤šæ•°æ®æºå±æ€§ * * @author Mark sunlightcs@gmail.com */ public class DataSourceProperties {  private String driverClassName;  private String url;  private String username;  private String password;  /** * Druidé»˜è®¤å‚æ•° */  private int initialSize = 2;  private int maxActive = 10;  private int minIdle = -1;  private long maxWait = 60 * 1000L;  private long timeBetweenEvictionRunsMillis = 60 * 1000L;  private long minEvictableIdleTimeMillis = 1000L * 60L * 30L;  private long maxEvictableIdleTimeMillis = 1000L * 60L * 60L * 7;  private String validationQuery = \"select 1\";  private int validationQueryTimeout = -1;  private boolean testOnBorrow = false;  private boolean testOnReturn = false;  private boolean testWhileIdle = true;  private boolean poolPreparedStatements = false;  private int maxOpenPreparedStatements = -1;  private boolean sharePreparedStatements = false;  private String filters = \"stat,wall\";   public String getDriverClassName() {  return driverClassName;  }   public void setDriverClassName(String driverClassName) {  this.driverClassName = driverClassName;  }   public String getUrl() {  return url;  }   public void setUrl(String url) {  this.url = url;  }   public String getUsername() {  return username;  }   public void setUsername(String username) {  this.username = username;  }   public String getPassword() {  return password;  }   public void setPassword(String password) {  this.password = password;  }   public int getInitialSize() {  return initialSize;  }   public void setInitialSize(int initialSize) {  this.initialSize = initialSize;  }   public int getMaxActive() {  return maxActive;  }   public void setMaxActive(int maxActive) {  this.maxActive = maxActive;  }   public int getMinIdle() {  return minIdle;  }   public void setMinIdle(int minIdle) {  this.minIdle = minIdle;  }   public long getMaxWait() {  return maxWait;  }   public void setMaxWait(long maxWait) {  this.maxWait = maxWait;  }   public long getTimeBetweenEvictionRunsMillis() {  return timeBetweenEvictionRunsMillis;  }   public void setTimeBetweenEvictionRunsMillis(long timeBetweenEvictionRunsMillis) {  this.timeBetweenEvictionRunsMillis =  timeBetweenEvictionRunsMillis;  }   public long getMinEvictableIdleTimeMillis() {  return minEvictableIdleTimeMillis;  }   public void setMinEvictableIdleTimeMillis(long minEvictableIdleTimeMillis) {  this.minEvictableIdleTimeMillis =  minEvictableIdleTimeMillis;  }   public long getMaxEvictableIdleTimeMillis() {  return maxEvictableIdleTimeMillis;  }   public void setMaxEvictableIdleTimeMillis(long maxEvictableIdleTimeMillis) {  this.maxEvictableIdleTimeMillis =  maxEvictableIdleTimeMillis;  }   public String getValidationQuery() {  return validationQuery;  }   public void setValidationQuery(String validationQuery) {  this.validationQuery = validationQuery;  }   public int getValidationQueryTimeout() {  return validationQueryTimeout;  }   public void setValidationQueryTimeout(int validationQueryTimeout) {  this.validationQueryTimeout =  validationQueryTimeout;  }   public boolean isTestOnBorrow() {  return testOnBorrow;  }   public void setTestOnBorrow(boolean testOnBorrow) {  this.testOnBorrow = testOnBorrow;  }   public boolean isTestOnReturn() {  return testOnReturn;  }   public void setTestOnReturn(boolean testOnReturn) {  this.testOnReturn = testOnReturn;  }   public boolean isTestWhileIdle() {  return testWhileIdle;  }   public void setTestWhileIdle(boolean testWhileIdle) {  this.testWhileIdle = testWhileIdle;  }   public boolean isPoolPreparedStatements() {  return poolPreparedStatements;  }   public void setPoolPreparedStatements(boolean poolPreparedStatements) {  this.poolPreparedStatements =  poolPreparedStatements;  }   public int getMaxOpenPreparedStatements() {  return maxOpenPreparedStatements;  }   public void setMaxOpenPreparedStatements(int maxOpenPreparedStatements) {  this.maxOpenPreparedStatements =  maxOpenPreparedStatements;  }   public boolean isSharePreparedStatements() {  return sharePreparedStatements;  }   public void setSharePreparedStatements(boolean sharePreparedStatements) {  this.sharePreparedStatements =  sharePreparedStatements;  }   public String getFilters() {  return filters;  }   public void setFilters(String filters) {  this.filters = filters;  } } import org.springframework.boot.context.properties.ConfigurationProperties;  import java.util.LinkedHashMap; import java.util.Map;  /** * å¤šæ•°æ®æºå±æ€§ * * @author Mark sunlightcs@gmail.com */ @ConfigurationProperties(prefix = \"dynamic\") public class DynamicDataSourceProperties {  private MapString, DataSourceProperties datasource = new LinkedHashMap();   public MapString, DataSourceProperties getDatasource() {  return datasource;  }   public void setDatasource(MapString, DataSourceProperties datasource) {  this.datasource = datasource;  } } æ‰©å±•Springçš„AbstractRoutingDataSourceæŠ½è±¡ç±»ï¼Œ AbstractRoutingDataSourceä¸­çš„æŠ½è±¡æ–¹æ³•determineCurrentLookupKeyæ˜¯å®ç°å¤šæ•°æ®æºçš„æ ¸å¿ƒï¼Œå¹¶å¯¹è¯¥æ–¹æ³•è¿›è¡ŒOverrideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;  /** * å¤šæ•°æ®æº * * @author Mark sunlightcs@gmail.com */ public class DynamicDataSource extends AbstractRoutingDataSource {  @Override  protected Object determineCurrentLookupKey() {  return DynamicContextHolder.peek();  } } æ•°æ®æºä¸Šä¸‹  /** * å¤šæ•°æ®æºä¸Šä¸‹æ–‡ * * @author Mark sunlightcs@gmail.com */ public class DynamicContextHolder {  @SuppressWarnings(\"unchecked\")  private static final ThreadLocalDequeString CONTEXT_HOLDER = new ThreadLocal() {  @Override  protected Object initialValue() {  return new ArrayDeque();  }  };   /** * è·å¾—å½“å‰çº¿ç¨‹æ•°æ®æº * * @return æ•°æ®æºåç§° */  public static String peek() {  return CONTEXT_HOLDER.get().peek();  }   /** * è®¾ç½®å½“å‰çº¿ç¨‹æ•°æ®æº * * @param dataSource æ•°æ®æºåç§° */  public static void push(String dataSource) {  CONTEXT_HOLDER.get().push(dataSource);  }   /** * æ¸…ç©ºå½“å‰çº¿ç¨‹æ•°æ®æº */  public static void poll() {  DequeString deque = CONTEXT_HOLDER.get();  deque.poll();  if (deque.isEmpty()) {  CONTEXT_HOLDER.remove();  }  } } é…ç½®å¤šæ•°æ®æºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  return druidDataSource; } } @DataSourceæ³¨è§£çš„åˆ‡é¢å¤„ç†ç±»ï¼ŒåŠ¨æ€åˆ‡æ¢çš„æ ¸å¿ƒä»£ç   import com.alibaba.druid.pool.DruidDataSource; import io.renren.commons.dynamic.datasource.properties.DataSourceProperties; import io.renren.commons.dynamic.datasource.properties.DynamicDataSourceProperties; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.boot.context.properties.EnableConfigurationProperties; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration;  import java.util.HashMap; import java.util.Map;  /** * é…ç½®å¤šæ•°æ®æº * * @author Mark sunlightcs@gmail.com */ @Configuration @EnableConfigurationProperties(DynamicDataSourceProperties.class) public class DynamicDataSourceConfig {  @Autowired  private DynamicDataSourceProperties properties;   @Bean  @ConfigurationProperties(prefix = \"spring.datasource.druid\")  public DataSourceProperties dataSourceProperties() {  return new DataSourceProperties();  } //å› ä¸ºDynamicDataSourceæ˜¯ç»§æ‰¿ä¸AbstractRoutingDataSourceï¼Œè€ŒAbstractRoutingDataSourceåˆæ˜¯ç»§  æ‰¿äºAbstractDataSourceï¼ŒAbstractDataSourceå®ç°äº†ç»Ÿä¸€çš„DataSourceæ¥å£ï¼Œ  æ‰€ä»¥DynamicDataSourceä¹Ÿå¯  ä»¥å½“åšDataSourceä½¿ç”¨   @Bean  public DynamicDataSource dynamicDataSource(DataSourceProperties dataSourceProperties) {  DynamicDataSource dynamicDataSource = new DynamicDataSource();  dynamicDataSource.setTargetDataSources(getDynamicDataSource());  //é»˜è®¤æ•°æ®æº  DruidDataSource defaultDataSource = DynamicDataSourceFactory.buildDruidDataSource(dat  aSourceProperties);  dynamicDataSource.setDefaultTargetDataSource(defaultDataSource);  return dynamicDataSource;  }   private MapObject, Object getDynamicDataSource() {  MapObject, Object targetDataSources = new HashMap();  properties.getDatasource().forEach((k, v) - {  DruidDataSource druidDataSource = DynamicDataSourceFactory.buildDruidDataSource(v  );  targetDataSources.put(k, druidDataSource);  });  return targetDataSources;  } } import com.alibaba.druid.pool.DruidDataSource; import io.renren.commons.dynamic.datasource.properties.DataSourceProperties;  import java.sql.SQLException;  /** * DruidDataSource * * @author Mark sunlightcs@gmail.com */ public class DynamicDataSourceFactory {  public static DruidDataSource buildDruidDataSource(DataSourceProperties properties) {  DruidDataSource druidDataSource = new DruidDataSource();  druidDataSource.setDriverClassName(properties.getDriverClassName());  druidDataSource.setUrl(properties.getUrl());  druidDataSource.setUsername(properties.getUsername());  druidDataSource.setPassword(properties.getPassword());  druidDataSource.setInitialSize(properties.getInitialSize());  druidDataSource.setMaxActive(properties.getMaxActive());  druidDataSource.setMinIdle(properties.getMinIdle());  druidDataSource.setMaxWait(properties.getMaxWait());  druidDataSource.setTimeBetweenEvictionRunsMillis(properties.getTimeBetweenEvictionRun  sMillis());  druidDataSource.setMinEvictableIdleTimeMillis(properties.getMinEvictableIdleTimeMilli  s());  druidDataSource.setMaxEvictableIdleTimeMillis(properties.getMaxEvictableIdleTimeMilli  s());  druidDataSource.setValidationQuery(properties.getValidationQuery());  druidDataSource.setValidationQueryTimeout(properties.getValidationQueryTimeout());  druidDataSource.setTestOnBorrow(properties.isTestOnBorrow());  druidDataSource.setTestOnReturn(properties.isTestOnReturn());  druidDataSource.setPoolPreparedStatements(properties.isPoolPreparedStatements());  druidDataSource.setMaxOpenPreparedStatements(properties.getMaxOpenPreparedStatements(  ));  druidDataSource.setSharePreparedStatements(properties.isSharePreparedStatements());  try {  druidDataSource.setFilters(properties.getFilters());  druidDataSource.init();  } catch (SQLException e) {  e.printStackTrace();  }  return druidDataSource;  } } @DataSourceæ³¨è§£çš„åˆ‡é¢å¤„ç†ç±»ï¼ŒåŠ¨æ€åˆ‡æ¢çš„æ ¸å¿ƒä»£ç   import io.renren.commons.dynamic.datasource.annotation.DataSource; import io.renren.commons.dynamic.datasource.config.DynamicContextHolder; import org.aspectj.lang.ProceedingJoinPoint; import org.aspectj.lang.annotation.Around; import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Pointcut; import org.aspectj.lang.reflect.MethodSignature; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.core.Ordered; import org.springframework.core.annotation.Order; import org.springframework.stereotype.Component;  import java.lang.reflect.Method;  /** * å¤šæ•°æ®æºï¼Œåˆ‡é¢å¤„ç†ç±» * * @author Mark sunlightcs@gmail.com */ @Aspect @Component @Order(Ordered.HIGHEST_PRECEDENCE) public class DataSourceAspect {  protected Logger logger = LoggerFactory.getLogger(getClass());   @Pointcut(\"@annotation(io.renren.commons.dynamic.datasource.annotation.DataSource) \" +  \"|| @within(io.renren.commons.dynamic.datasource.annotation.DataSource)\")  public void dataSourcePointCut() {  }   @Around(\"dataSourcePointCut()\")  public Object around(ProceedingJoinPoint point) throws Throwable {  MethodSignature signature = (MethodSignature) point.getSignature();  Class targetClass = point.getTarget().getClass();  Method method = signature.getMethod();  DataSource targetDataSource = (DataSource) targetClass.getAnnotation(DataSource.class);  DataSource methodDataSource = method.getAnnotation(DataSource.class);  if (targetDataSource != null || methodDataSource != null) {  String value;  if (methodDataSource != null) {  value = methodDataSource.value();  } else {  value = targetDataSource.value();  }  DynamicContextHolder.push(value);  logger.debug(\"set datasource is {}\", value);  }  try {  return point.proceed();  } finally {  DynamicContextHolder.poll();  logger.debug(\"clean datasource\");  }  } } ç¬¬ 4 ç«  åŸºç¡€çŸ¥è¯†è®²è§£ 4.1 Spring MVC ä½¿ç”¨ 4.2 Swagger ä½¿ç”¨ 4.3 Mybatis-plus ä½¿ç”¨ 4.1 Spring MVC ä½¿ç”¨  å¯¹Spring MVCä¸å¤ªç†Ÿæ‚‰çš„ï¼Œéœ€è¦ç†è§£Spring MVCå¸¸ç”¨çš„æ³¨è§£ï¼Œä¹Ÿæ–¹ä¾¿æ—¥åæ’æŸ¥é—®é¢˜ï¼Œå¸¸ç”¨çš„æ³¨è§£å¦‚ä¸‹æ‰€ç¤ºï¼š\n 4.1.1 @Controller æ³¨è§£ @Controlleræ³¨è§£è¡¨æ˜äº†ä¸€ä¸ªç±»æ˜¯ä½œä¸ºæ§åˆ¶å™¨çš„è§’è‰²è€Œå­˜åœ¨çš„ã€‚Springä¸è¦æ±‚ä½ å»ç»§æ‰¿ä»»ä½•æ§åˆ¶å™¨åŸºç±»ï¼Œä¹Ÿä¸è¦æ±‚ä½ å»å®ç°Servletçš„é‚£å¥—APIã€‚å½“ç„¶ï¼Œå¦‚æœä½ éœ€è¦çš„è¯ä¹Ÿå¯ä»¥å»ä½¿ç”¨ä»»ä½•ä¸Servletç›¸å…³çš„ç‰¹æ€§ã€‚\n @Controller public class UserController { // ... } 4.1.2 @RequestMapping æ³¨è§£ ä½ å¯ä»¥ä½¿ç”¨@RequestMappingæ³¨è§£æ¥å°†è¯·æ±‚URLï¼Œå¦‚/userç­‰ï¼Œæ˜ å°„åˆ°æ•´ä¸ªç±»ä¸Šæˆ–æŸä¸ªç‰¹å®šçš„å¤„ç†å™¨æ–¹æ³•ä¸Šã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œç±»çº§åˆ«çš„æ³¨è§£è´Ÿè´£å°†ä¸€ä¸ªç‰¹å®šï¼ˆæˆ–ç¬¦åˆæŸç§æ¨¡å¼ï¼‰çš„è¯·æ±‚è·¯å¾„æ˜ å°„åˆ°ä¸€ä¸ªæ§åˆ¶å™¨ä¸Šï¼ŒåŒæ—¶é€šè¿‡æ–¹æ³•çº§åˆ«çš„æ³¨è§£æ¥ç»†åŒ–æ˜ å°„ï¼Œå³æ ¹æ®ç‰¹å®šçš„HTTPè¯·æ±‚æ–¹æ³•ï¼ˆGETã€POSTæ–¹æ³•ç­‰ï¼‰ã€HTTPè¯·æ±‚ä¸­æ˜¯å¦æºå¸¦ç‰¹ å®šå‚æ•°ç­‰æ¡ä»¶ï¼Œå°†è¯·æ±‚æ˜ å°„åˆ°åŒ¹é…çš„æ–¹æ³•ä¸Šã€‚\n @Controller public class UserController {   @RequestMapping(\"/user\")  public String user() {  return \"user\";  } } ä»¥ä¸Šä»£ç æ²¡æœ‰æŒ‡å®šè¯·æ±‚å¿…é¡»æ˜¯GETæ–¹æ³•è¿˜æ˜¯PUT/POSTæˆ–å…¶ä»–æ–¹æ³•ï¼Œ@RequestMappingæ³¨è§£é»˜è®¤ä¼šæ˜ å°„æ‰€æœ‰ çš„HTTPè¯·æ±‚æ–¹æ³•ã€‚å¦‚æœä»…æƒ³æ¥æ”¶æŸç§è¯·æ±‚æ–¹æ³•ï¼Œè¯·åœ¨æ³¨è§£ä¸­æŒ‡å®šä¹‹@RequestMapping(path = â€œ/userâ€, method = RequestMethod.GET)ä»¥ç¼©å°èŒƒå›´ã€‚\n4.1.3 @PathVariable æ³¨è§£ åœ¨Spring MVCä¸­ä½ å¯ä»¥åœ¨æ–¹æ³•å‚æ•°ä¸Šä½¿ç”¨@PathVariableæ³¨è§£ï¼Œå°†å…¶ä¸URIæ¨¡æ¿ä¸­çš„å‚æ•°ç»‘å®šèµ·æ¥ï¼Œå¦‚ä¸‹æ‰€ ç¤ºï¼š\n@RequestMapping(path = \"/user/{userId}\", method = RequestMethod.GET) public String userCenter(@PathVariable(\"userId\") String userId,Model model){  UserDTO user=userService.get(userId);  model.addAttribute(\"user\",user);  return\"userCenter\";  } URIæ¨¡æ¿\"/user/{userId}â€œæŒ‡å®šäº†ä¸€ä¸ªå˜é‡åä¸ºuserIdã€‚å½“æ§åˆ¶å™¨å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒuserIdçš„å€¼å°±ä¼šè¢«URIæ¨¡ æ¿ä¸­å¯¹åº”éƒ¨åˆ†çš„å€¼æ‰€å¡«å……ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœè¯·æ±‚çš„URIæ˜¯/userId/1ï¼Œæ­¤æ—¶å˜é‡userIdçš„å€¼å°±æ˜¯ 1 ã€‚\n4.1.4 @GetMapping æ³¨è§£ @GetMappingæ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œæ˜¯@RequestMapping(method = RequestMethod.GET)çš„ç¼©å†™ã€‚è¯¥æ³¨è§£å°†HTTP GETæ˜ å°„åˆ°ç‰¹å®šçš„å¤„ç†æ–¹æ³•ä¸Šã€‚å¯ä»¥ä½¿ç”¨@GetMapping(\"/userâ€)æ¥ä»£æ›¿@RequestMapping(path=\"/user\",method=RequestMethod.GET)ã€‚è¿˜æœ‰@PostMappingã€@PutMappingã€ @DeleteMappingç­‰åŒç†ã€‚\n4.1.5 @RequestBody æ³¨è§£ è¯¥æ³¨è§£ç”¨äºè¯»å–Requestè¯·æ±‚çš„bodyéƒ¨åˆ†æ•°æ®ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½®çš„HttpMessageConverterè¿›è¡Œè§£æï¼Œç„¶åæŠŠç›¸åº”çš„æ•°æ®ç»‘å®šåˆ°è¦è¿”å›çš„å¯¹è±¡ä¸Šï¼Œå†æŠŠHttpMessageConverterè¿”å›çš„å¯¹è±¡æ•°æ®ç»‘å®šåˆ°Controllerä¸­æ–¹æ³•çš„å‚æ•°ä¸Šã€‚\n @Controller public class UserController {  @GetMapping(\"/user\")  public String user(@RequestBody User user) {  //...  return \"user\";  } } 4.1.6 @ResponseBody æ³¨è§£ è¯¥æ³¨è§£ç”¨äºå°†Controllerçš„æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œé€šè¿‡é€‚å½“çš„HttpMessageConverterè½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼åï¼Œå†™å…¥åˆ°Responseå¯¹è±¡çš„bodyæ•°æ®åŒºã€‚æ¯”å¦‚è·å–JSONæ•°æ®ï¼ŒåŠ ä¸Š@ResponseBodyåï¼Œä¼šç›´æ¥è¿”å›JSONæ•°æ®ï¼Œè€Œä¸ä¼šè¢«è§£æä¸ºè§†å›¾ã€‚\n @Controller public class UserController {  @ResponseBody  @GetMapping(\"/user/{userId}\")  public User info(@PathVariable(\"userId\") String userId) {  UserDTO user = userService.get(userId);  return user;  } } 4.1.7 @RestController æ³¨è§£ @RestControlleræ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œå³@Controller + @ResponseBodyçš„ç»„åˆæ³¨è§£ï¼Œè¯·æ±‚å®Œåï¼Œä¼šè¿”å›JSONæ•°æ®ã€‚\n4.2 Swagger ä½¿ç”¨  Swaggeræ˜¯ä¸€ä¸ªæ ¹æ®Swaggeræ³¨è§£ï¼Œå³å¯ç”Ÿæˆæ¥å£æ–‡æ¡£çš„æœåŠ¡ã€‚\n 4.2.1 æ­å»º Swagger ç¯å¢ƒ  åœ¨pom.xmlæ–‡ä»¶ä¸­æ·»åŠ swaggerç›¸å…³ä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š     io.springfox  springfox-swagger2  ${springfox-version}   io.springfox springfox-swagger-ui ${springfox-version}   ç¼–å†™Swaggerçš„Configurationé…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  import io.swagger.annotations.ApiOperation; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurer; import springfox.documentation.builders.ApiInfoBuilder; import springfox.documentation.builders.PathSelectors; import springfox.documentation.builders.RequestHandlerSelectors; import springfox.documentation.service.ApiInfo; import springfox.documentation.service.ApiKey; import springfox.documentation.spi.DocumentationType; import springfox.documentation.spring.web.plugins.Docket; import springfox.documentation.swagger2.annotations.EnableSwagger2;  import java.util.List;  import static com.google.common.collect.Lists.newArrayList;  @Configuration @EnableSwagger2 public class SwaggerConfig implements WebMvcConfigurer {  @Bean  public Docket createRestApi() {  return new Docket(DocumentationType.SWAGGER_2)  .apiInfo(apiInfo())  .select()  //åŠ äº†ApiOperationæ³¨è§£çš„ç±»ï¼Œæ‰ç”Ÿæˆæ¥å£æ–‡æ¡£  .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))  //io.renren.controlleråŒ…ä¸‹çš„ç±»ï¼Œæ‰ç”Ÿæˆæ¥å£æ–‡æ¡£  //.apis(RequestHandlerSelectors.basePackage(\"io.renren.controller\"))  .paths(PathSelectors.any())  .build()  .directModelSubstitute(java.util.Date.class, String.class);  }   private ApiInfo apiInfo() {  return new ApiInfoBuilder()  .title(\"äººäººå¼€æº\")  .description(\"äººäººå¼€æºæ¥å£æ–‡æ¡£\")  .termsOfServiceUrl(\"https://www.renren.io/community\")  .version(\"1.0.0\")  .build();  } } 4.2.2 Swagger å¸¸ç”¨æ³¨è§£  @Apiæ³¨è§£ç”¨åœ¨ç±»ä¸Šï¼Œè¯´æ˜è¯¥ç±»çš„ä½œç”¨ã€‚å¯ä»¥æ ‡è®°ä¸€ä¸ªControllerç±»åšä¸ºswaggeræ–‡æ¡£èµ„æºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š   @Api(tags = \"ç”¨æˆ·ç®¡ç†\") @RestController public class UserController {  }  @ApiOperationæ³¨è§£ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œè¯´æ˜è¯¥æ–¹æ³•çš„ä½œç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š   @Api(tags = \"ç”¨æˆ·ç®¡ç†\") @RestController public class UserController {  @GetMapping(\"/user/list\")  @ApiOperation(\"åˆ—è¡¨\")  public ListUserDTO list() {  ListUserDTO list = userService.list();  return list;  } }  @ApiParamæ³¨è§£ç”¨åœ¨æ–¹æ³•å‚æ•°ä¸Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š   @Api(tags = \"ç”¨æˆ·ç®¡ç†\") @RestController public class UserController {  @GetMapping(\"/user/list\")  @ApiOperation(\"åˆ—è¡¨\")  public List list(@ApiParam(value = \"ç”¨æˆ·å\", required = true) String username) {  List list = userService.list();  return list;  } }   @ApiImplicitParamsæ³¨è§£ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œä¸»è¦ç”¨äºä¸€ç»„å‚æ•°è¯´æ˜\n  @ApiImplicitParamæ³¨è§£ç”¨åœ¨@ApiImplicitParamsæ³¨è§£ä¸­ï¼ŒæŒ‡å®šä¸€ä¸ªè¯·æ±‚å‚æ•°çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n  @GetMapping(\"page\") @ApiOperation(\"åˆ†é¡µ\") @ApiImplicitParams({  @ApiImplicitParam(name = \"page\", value = \"å½“å‰é¡µç ï¼Œä» 1 å¼€å§‹\", paramType = \"query\", requ ired=true, dataType = \"int\"),  @ApiImplicitParam(name = \"limit\", value = \"æ¯é¡µæ˜¾ç¤ºè®°å½•æ•°\", paramType = \"query\", requir ed=true, dataType = \"int\"),  @ApiImplicitParam(name = \"order_field\", value = \"æ’åºå­—æ®µ\", paramType = \"query\", dataT ype=\"String\"),  @ApiImplicitParam(name = \"order\", value = \"æ’åºæ–¹å¼ï¼Œå¯é€‰å€¼(ascã€desc)\", paramType = \"q uery\", dataType = \"String\"),  @ApiImplicitParam(name = \"username\", value = \"ç”¨æˆ·å\", paramType = \"query\", dataType = \"String\") }) public ResultPageData page(@ApiIgnore @RequestParam MapString, Object par ams){  PageData page=sysUserService.page(params);  return new ResultPageData().ok(page);  }  @ApiIgnoreæ³¨è§£ï¼Œå¯ç”¨äºç±»ã€æ–¹æ³•æˆ–å‚æ•°ä¸Šï¼Œè¡¨ç¤ºç”ŸæˆSwaggeræ¥å£æ–‡æ¡£æ—¶ï¼Œå¿½ç•¥ç±»ã€æ–¹æ³•æˆ–å‚æ•°ã€‚  4.3 Mybatis-plus ä½¿ç”¨ åœ¨é¡¹ç›®çš„pom.xmlé‡Œå¼•å…¥ä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n   com.baomidou  mybatis-plus-boot-starter  ${mybatisplus.version}  åœ¨ymlé…ç½®æ–‡ä»¶é‡Œï¼Œé…ç½®mybatis-plusï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nmybatis-plus:  mapper-locations: classpath*:/mapper/**/*.xml  #å®ä½“æ‰«æï¼Œå¤šä¸ªpackageç”¨é€—å·æˆ–è€…åˆ†å·åˆ†éš”  typeAliasesPackage: io.renren.modules.*.entity  global-config:  #æ•°æ®åº“ç›¸å…³é…ç½®  db-config:  #ä¸»é”®ç±»å‹ AUTO:\"æ•°æ®åº“IDè‡ªå¢\", INPUT:\"ç”¨æˆ·è¾“å…¥ID\", ID_WORKER:\"å…¨å±€å”¯ä¸€ID (æ•°å­—ç±»å‹å”¯ä¸€ID)\"  , UUID:\"å…¨å±€å”¯ä¸€ID UUID\";  id-type: AUTO  #å­—æ®µç­–ç•¥ IGNORED:\"å¿½ç•¥åˆ¤æ–­\",NOT_NULL:\"é NULL åˆ¤æ–­\"),NOT_EMPTY:\"éç©ºåˆ¤æ–­\"  field-strategy: NOT_NULL  #é©¼å³°ä¸‹åˆ’çº¿è½¬æ¢  column-underline: true  logic-delete-value: -1  logic-not-delete-value: 0  banner: false  #åŸç”Ÿé…ç½®  configuration:  map-underscore-to-camel-case: true  cache-enabled: false  call-setters-on-nulls: true  jdbc-type-for-null: 'null' ç¬¬ 5 ç«  é¡¹ç›®å®æˆ˜ 5.1 éœ€æ±‚è¯´æ˜ 5.2 ä»£ç ç”Ÿæˆå™¨ 5.1 éœ€æ±‚è¯´æ˜  æˆ‘ä»¬æ¥å®Œæˆä¸€ä¸ªå•†å“çš„åˆ—è¡¨ã€æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤åŠŸèƒ½ï¼Œç†Ÿæ‚‰å¦‚ä½•å¿«é€Ÿå¼€å‘è‡ªå·±çš„ä¸šåŠ¡åŠŸèƒ½æ¨¡å—ã€‚\n  æˆ‘ä»¬å…ˆå»ºä¸€ä¸ªå•†å“è¡¨tb_goodsï¼Œè¡¨ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š  CREATE TABLE `tb_goods` (  `goods_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'å•†å“ID',  `name` varchar(50) COMMENT 'å•†å“å',  `intro` varchar(500) COMMENT 'ä»‹ç»',  `price` decimal(10, 2) COMMENT 'ä»·æ ¼',  `num` int COMMENT 'æ•°é‡',  PRIMARY KEY (`goods_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='å•†å“ç®¡ç†'; 5.1 ä»£ç ç”Ÿæˆå™¨  ä½¿ç”¨ä»£ç ç”Ÿæˆå™¨å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä»£ç ç”Ÿæˆå™¨çš„é…ç½®ï¼Œçœ‹çœ‹é‚£äº›æ˜¯å¯é…ç½®çš„ï¼Œæ‰“å¼€renren-generatoræ¨¡å— çš„é…ç½®æ–‡ä»¶generator.propertiesï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  #ä»£ç ç”Ÿæˆå™¨ï¼Œé…ç½®ä¿¡æ¯ mainPath=io.renren #åŒ…å package=io.renren.modules moduleName=generator #ä½œè€… author=Mark #Email email=sunlightcs@gmail.com #è¡¨å‰ç¼€(ç±»åä¸ä¼šåŒ…å«è¡¨å‰ç¼€) tablePrefix=tb_ #ç±»å‹è½¬æ¢ï¼Œé…ç½®ä¿¡æ¯ tinyint=Integer smallint=Integer mediumint=Integer int=Integer integer=Integer bigint=Long float=Float double=Double decimal=BigDecimal bit=Boolean char=String varchar=String tinytext=String text=String mediumtext=String longtext=String date=Date datetime=Date timestamp=Date NUMBER=Integer INT=Integer INTEGER=Integer BINARY_INTEGER=Integer LONG=String FLOAT=Float BINARY_FLOAT=Float DOUBLE=Double BINARY_DOUBLE=Double DECIMAL=BigDecimal CHAR=String VARCHAR=String VARCHAR2=String NVARCHAR=String NVARCHAR2=String CLOB=String BLOB=String DATE=Date DATETIME=Date TIMESTAMP=Date TIMESTAMP(6)=Date int8=Long int4=Integer int2=Integer numeric=BigDecimal ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é…ç½®åŒ…åã€ä½œè€…ä¿¡æ¯ã€è¡¨å‰ç¼€ã€æ¨¡å—åç§°ã€ç±»å‹è½¬æ¢ç­‰ä¿¡æ¯ã€‚å…¶ä¸­ï¼Œç±»å‹è½¬æ¢æ˜¯æŒ‡ï¼Œ MySQLä¸­çš„ç±»å‹ä¸JavaBeanä¸­çš„ç±»å‹ï¼Œæ˜¯æ€ä¹ˆä¸€ä¸ªå¯¹åº”å…³ç³»ã€‚å¦‚æœæœ‰ç¼ºå°‘çš„ç±»å‹ï¼Œå¯è‡ªè¡Œåœ¨generator.propertiesæ–‡ä»¶ä¸­è¡¥å……ã€‚\n å†çœ‹çœ‹renren-generatoræ¨¡å—çš„application.ymlé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬åªè¦ä¿®æ”¹æ•°æ®åº“åã€è´¦å·ã€å¯†ç ï¼Œå°±å¯ä»¥ äº†ã€‚å…¶ä¸­ï¼Œæ•°æ®åº“åæ˜¯æŒ‡å¾…ç”Ÿæˆçš„è¡¨ï¼Œæ‰€åœ¨çš„æ•°æ®åº“ã€‚  server:  port: 80 # mysql spring:  datasource:  type: com.alibaba.druid.pool.DruidDataSource  #MySQLé…ç½®  driverClassName: com.mysql.jdbc.Driver  url: jdbc:mysql://localhost:3306/renren_fast?useUnicode=true\u0026characterEncoding=UTF-8\u0026useS  SL=false  username: renren  password: 123456  #oracleé…ç½®  # driverClassName: oracle.jdbc.OracleDriver  # url: jdbc:oracle:thin:@47.100.206.162:1521:xe  # username: renren  # password: 123456  #SQLServeré…ç½®  # driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver  # url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast  # username: sa  # password: 123456  #PostgreSQLé…ç½®  # driverClassName: org.postgresql.Driver  # url: jdbc:postgresql://192.168.10.10:5432/renren_fast  # username: postgres  # password: 123456  jackson:  time-zone: GMT+8 date-format: yyyy-MM-dd HH:mm:ss resources:  static-locations: classpath:/static/,classpath:/views/  mybatis:  mapperLocations: classpath:mapper/**/*.xml  pagehelper:  reasonable: true  supportMethodsArguments: true  params: count=countSql  #æŒ‡å®šæ•°æ®åº“ï¼Œå¯é€‰å€¼æœ‰ã€mysqlã€oracleã€sqlserverã€postgresqlã€‘  renren:  database: mysql   åœ¨æ•°æ®åº“renren_fastä¸­ï¼Œæ‰§è¡Œå»ºè¡¨è¯­å¥ï¼Œåˆ›å»ºtb_goodsè¡¨ï¼Œå†å¯åŠ¨renren-generatoré¡¹ç›®(è¿è¡Œ RenrenApplication.javaçš„mainæ–¹æ³•å³å¯)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n  åœ¨æµè§ˆå™¨é‡Œè¾“å…¥é¡¹ç›®åœ°å€(http://localhost)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n   æˆ‘ä»¬åªéœ€å‹¾é€‰tb_goodsï¼Œç‚¹å‡»ã€ç”Ÿæˆä»£ç ã€‘æŒ‰é’®ï¼Œåˆ™å¯ç”Ÿæˆç›¸åº”ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š   æˆ‘ä»¬æ¥çœ‹ä¸‹ç”Ÿæˆçš„ä»£ç ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š   ç”Ÿæˆå¥½ä»£ç åï¼Œæˆ‘ä»¬åªéœ€åœ¨æ•°æ®åº“renren_fastä¸­ï¼Œæ‰§è¡Œgoods_menu.sqlè¯­å¥ï¼Œè¿™ä¸ªSQLæ˜¯ç”Ÿæˆèœå•çš„ï¼Œ SQLè¯­å¥å¦‚ä¸‹æ‰€ç¤ºï¼š  # -- èœå•SQL  INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) VALUES ('1', 'å•†å“ç®¡ç†', 'generator/goods', NULL, '1', 'config', '6');  # -- æŒ‰é’®çˆ¶èœå•ID  set @parentId = @@identity;  -- èœå•å¯¹åº”æŒ‰é’®SQL INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId,  'æŸ¥çœ‹',  null,  'generator:goods:list,generator:goods:info',  '2',  null,  '6 '; INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId, 'æ–°å¢', null, 'generator:goods:save', '2', null, '6';  INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId, 'ä¿®æ”¹', null, 'generator:goods:update', '2', null, '6'; INSERT INTO `sys_menu` ( `parent_id`, `name`  , `url`, `perms`, `type`, `icon`, `order_num`) SELECT @parentId, 'åˆ é™¤', null, 'generator:goods:delete', '2', null, '6';  æ¥ä¸‹æ¥ï¼Œå†æŠŠåˆšç”Ÿæˆçš„åç«¯ä»£ç ï¼Œæ·»åŠ åˆ°é¡¹ç›®renren-fasté‡Œï¼Œå‰ç«¯vueä»£ç ï¼Œæ·»åŠ åˆ°å‰ç«¯é¡¹ç›®renren-fast- vueé‡Œï¼Œåœ¨å¯åŠ¨renren-fasté¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š   ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œ  ç¬¬ 6 ç«  åç«¯æºç åˆ†æ 6.1 å‰åç«¯åˆ†ç¦» 6.2 æƒé™è®¾è®¡æ€è·¯ 6.3 XSS è„šæœ¬è¿‡æ»¤ 6.4 SQL æ³¨å…¥ 6.5 Redis ç¼“å­˜ 6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶ 6.7 åç«¯æ•ˆéªŒæœºåˆ¶ 6.8 ç³»ç»Ÿæ—¥å¿— 6.9 æ·»åŠ èœå• 6.10 æ·»åŠ è§’è‰² 6.11 æ·»åŠ ç®¡ç†å‘˜ 6.12 å®šæ—¶ä»»åŠ¡æ¨¡å— 6.13 äº‘å­˜å‚¨æ¨¡å— 6.14 APP æ¨¡å— 6.1 å‰åç«¯åˆ†ç¦»  è¦å®ç°å‰åç«¯åˆ†ç¦»ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹ 2 ä¸ªé—®é¢˜ï¼š\n1. é¡¹ç›®ä¸å†åŸºäºsessionäº†ï¼Œå¦‚ä½•çŸ¥é“è®¿é—®è€…æ˜¯è°ï¼Ÿ 1. å¦‚ä½•ç¡®è®¤è®¿é—®è€…çš„æƒé™ï¼Ÿ 3. å‰åç«¯åˆ†ç¦»\n  ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡tokenå®ç°ï¼Œæœ¬é¡¹ç›®ä¹Ÿæ˜¯ä¸€æ ·ï¼›ç”¨æˆ·ç™»å½•æ—¶ï¼Œç”ŸæˆtokenåŠtokenè¿‡æœŸæ—¶é—´ï¼Œtokenä¸ç”¨æˆ·æ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œè°ƒç”¨æ¥å£çš„æ—¶å€™ï¼ŒæŠŠtokenæ”¾åˆ°headeræˆ–è¯·æ±‚å‚æ•°ä¸­ï¼ŒæœåŠ¡ç«¯å°±çŸ¥é“æ˜¯è°åœ¨è°ƒç”¨æ¥å£ï¼Œç™»å½•å¦‚ä¸‹æ‰€ç¤ºï¼š  /** * éªŒè¯ç  */ @GetMapping(\"captcha.jpg\") public void captcha(HttpServletResponse response, String uuid) throws ServletException, IOException {  response.setHeader(\"Cache-Control\", \"no-store, no-cache\");  response.setContentType(\"image/jpeg\");  //è·å–å›¾ç‰‡éªŒè¯ç   BufferedImage image = sysCaptchaService.getCaptcha(uuid);  ServletOutputStream out = response.getOutputStream();  ImageIO.write(image, \"jpg\", out);  IOUtils.closeQuietly(out); }  /** * ç™»å½• */ @PostMapping(\"/sys/login\") public MapString, Object login(@RequestBody SysLoginForm form) throws IOException {  boolean captcha = sysCaptchaService.validate(form.getUuid(), form.getCaptcha());  if (!captcha) {  return R.error(\"éªŒè¯ç ä¸æ­£ç¡®\");  }   //ç”¨æˆ·ä¿¡æ¯  SysUserEntity user = sysUserService.queryByUserName(form.getUsername());   //è´¦å·ä¸å­˜åœ¨ã€å¯†ç é”™è¯¯  if (user == null || !user.getPassword().equals(new Sha256Hash(form.getPassword(), user.get  Salt()).toHex())) {  return R.error(\"è´¦å·æˆ–å¯†ç ä¸æ­£ç¡®\");  }  //è´¦å·é”å®š  if (user.getStatus() == 0) {  return R.error(\"è´¦å·å·²è¢«é”å®š,è¯·è”ç³»ç®¡ç†å‘˜\");  }  //ç”Ÿæˆtokenï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“  R r = sysUserTokenService.createToken(user.getUserId());  return r; }   //ç”Ÿäº§token public R createToken(long userId) {  //ç”Ÿæˆä¸€ä¸ªtokenï¼Œå¯ä»¥æ˜¯uuid  String token = TokenGenerator.generateValue();  //å½“å‰æ—¶é—´  Date now = new Date();  //è¿‡æœŸæ—¶é—´  Date expireTime = new Date(now.getTime() + EXPIRE * 1000);  //åˆ¤æ–­æ˜¯å¦ç”Ÿæˆè¿‡token  SysUserTokenEntity tokenEntity = queryByUserId(userId);  if (tokenEntity == null) {  tokenEntity = new SysUserTokenEntity();  tokenEntity.setUserId(userId);  tokenEntity.setToken(token);  tokenEntity.setUpdateTime(now);  tokenEntity.setExpireTime(expireTime);  //ä¿å­˜token  save(tokenEntity);  } else {  tokenEntity.setToken(token);  tokenEntity.setUpdateTime(now);  tokenEntity.setExpireTime(expireTime);  //æ›´æ–°token  update(tokenEntity);  }  R r = R.ok().put(\"token\", token).put(\"expire\", EXPIRE);  return r; } å…¶ä¸­ï¼Œä¸‹é¢çš„è¿™è¡Œä»£ç ï¼Œæ˜¯åŠ ç›æ“ä½œï¼›å¯èƒ½æœ‰äººä¸ç†è§£ä¸ºä½•è¦åŠ ç›ï¼Œå…¶ç›®çš„æ˜¯é˜²æ­¢è¢«æ‹–åº“åï¼Œé»‘å®¢è½»æ˜“çš„ ï¼ˆé€šè¿‡å¯†ç åº“å¯¹æ¯”ï¼‰ï¼Œå°±èƒ½æ‹¿åˆ°ä½ çš„å¯†ç \nnew Sha256Hash(password, user.getSalt()).toHex())  è°ƒç”¨æ¥å£æ—¶ï¼Œæ¥å—ä¼ è¿‡æ¥çš„tokenåï¼Œå¦‚ä½•ä¿è¯tokenæœ‰æ•ˆåŠç”¨æˆ·æƒé™å‘¢ï¼Ÿå…¶å®ï¼Œshiroæä¾›äº† AuthenticatingFilteræŠ½è±¡ç±»ï¼Œç»§æ‰¿AuthenticatingFilteræŠ½è±¡ç±»å³å¯ã€‚  æ­¥éª¤ 1 ï¼Œæ‰€æœ‰è¯·æ±‚å…¨éƒ¨æ‹’ç»è®¿é—®\n@Override protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) {  return false; } æ­¥éª¤ 2 ï¼Œæ‹’ç»è®¿é—®çš„è¯·æ±‚ï¼Œä¼šè°ƒç”¨onAccessDeniedæ–¹æ³•ï¼ŒonAccessDeniedæ–¹æ³•å…ˆè·å–tokenï¼Œå†è°ƒç”¨ executeLoginæ–¹æ³•\n@Override protected boolean onAccessDenied(ServletRequest request, ServletResponse response) throws Exception {  //è·å–è¯·æ±‚tokenï¼Œå¦‚æœtokenä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› 401  String token = getRequestToken((HttpServletRequest) request);  if (StringUtils.isBlank(token)) {  HttpServletResponse httpResponse = (HttpServletResponse) response;  String json = new Gson().toJson(R.error(HttpStatus.SC_UNAUTHORIZED, \"invalid token\"));  httpResponse.getWriter().print(json);  return false;  }  return executeLogin(request, response); }  /** * è·å–è¯·æ±‚çš„token */ private String getRequestToken(HttpServletRequest httpRequest) {  //ä»headerä¸­è·å–token  String token = httpRequest.getHeader(\"token\");  //å¦‚æœheaderä¸­ä¸å­˜åœ¨tokenï¼Œåˆ™ä»å‚æ•°ä¸­è·å–token  if (StringUtils.isBlank(token)) {  token = httpRequest.getParameter(\"token\");  }  return token; } æ­¥éª¤ 3 ï¼Œé˜…è¯»AuthenticatingFilteræŠ½è±¡ç±»ä¸­executeLoginæ–¹æ³•ï¼Œæˆ‘ä»¬å‘ç°è°ƒç”¨äº† subject.login(token) ï¼Œè¿™æ˜¯shiroçš„ç™»å½•æ–¹æ³•ï¼Œä¸”éœ€è¦tokenå‚æ•°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰OAuth2Tokenç±»ï¼Œåªè¦å®ç°AuthenticationTokenæ¥å£ï¼Œå°±å¯ä»¥äº†\n//AuthenticatingFilterç±»ä¸­çš„æ–¹æ³• protected boolean executeLogin(ServletRequest request,ServletResponse response) throws Exception{  AuthenticationToken token=createToken(request,response);  if(token==null){  String msg=\"createToken method implementation returned null. A valid non-null A uthenticationToken\" +  \"must be created in order to execute a login attempt.\";  throw new IllegalStateException(msg);  }  try{  Subject subject=getSubject(request,response);  subject.login(token);  return onLoginSuccess(token,subject,request,response);  }catch(AuthenticationException e){  return onLoginFailure(token,e,request,response);  } }   //subject.login(token)ä¸­çš„tokenå¯¹è±¡ï¼Œéœ€è¦å®ç°AuthenticationTokenæ¥å£ public class OAuth2Token implements AuthenticationToken {  private String token;   public OAuth2Token(String token) {  this.token = token;  }   @Override  public String getPrincipal() {  return token;  }   @Override  public Object getCredentials() {  return token;  } } æ­¥éª¤ 4 ï¼Œå®šä¹‰OAuth2Realmç±»ï¼Œå¹¶ç»§æ‰¿AuthorizingRealmæŠ½è±¡ç±»ï¼Œè°ƒç”¨ subject.login(token) æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨doGetAuthenticationInfoæ–¹æ³•ï¼Œè¿›è¡Œç™»å½•\n/** * authenticationèº«ä»½è®¤è¯(ç™»å½•æ—¶è°ƒç”¨) */ // 9. å‰é¢è¢«authcæ‹¦æˆªåï¼Œéœ€è¦è®¤è¯ï¼ŒSecurityBeanä¼šè°ƒç”¨è¿™é‡Œè¿›è¡Œè®¤è¯ @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {  String accessToken = (String) token.getPrincipal();   //æ ¹æ®accessTokenï¼ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯  SysUserTokenEntity tokenEntity = shiroService.queryByToken(accessToken);  //tokenå¤±æ•ˆ   if(tokenEntity == null || tokenEntity.getExpireTime().getTime()  System.currentTimeMillis()){  throw new IncorrectCredentialsException(\"tokenå¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•\");  }  // 9.1. tokenç”Ÿæ•ˆæ‰èƒ½ç™»å½•  //æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯  SysUserEntity user = shiroService.queryUser(tokenEntity.getUserId());  //è´¦å·é”å®š  if(user.getStatus() == 0){  throw new LockedAccountException(\"è´¦å·å·²è¢«é”å®š,è¯·è”ç³»ç®¡ç†å‘˜\");  }   SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(user, accessToken, getName());  return info; } æ­¥éª¤ 5 ï¼Œç™»å½•å¤±è´¥åï¼Œåˆ™è°ƒç”¨onLoginFailureï¼Œè¿›è¡Œå¤±è´¥å¤„ç†ï¼Œæ•´ä¸ªæµç¨‹ç»“æŸ\n@Override protected boolean onLoginFailure(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response) {  HttpServletResponse httpResponse = (HttpServletResponse) response;  httpResponse.setContentType(\"application/json;charset=utf-8\");  try {  //å¤„ç†ç™»å½•å¤±è´¥çš„å¼‚å¸¸  Throwable throwable = e.getCause() == null ? e : e.getCause();  R r = R.error(HttpStatus.SC_UNAUTHORIZED, throwable.getMessage());  String json = new Gson().toJson(r);  httpResponse.getWriter().print(json);  } catch (IOException e1) {  }  return false; } æ­¥éª¤ 6 ï¼Œç™»å½•æˆåŠŸåï¼Œåˆ™è°ƒç”¨doGetAuthorizationInfoæ–¹æ³•ï¼ŒæŸ¥è¯¢ç”¨æˆ·çš„æƒé™ï¼Œå†è°ƒç”¨å…·ä½“çš„æ¥å£ï¼Œæ•´ä¸ªæµç¨‹ ç»“æŸ\n/** * authorizationæˆæƒ(éªŒè¯æƒé™æ—¶è°ƒç”¨) */ // 10. å‰é¢è¢«rolesæ‹¦æˆªåï¼Œéœ€è¦æˆæƒæ‰èƒ½ç™»å½•ï¼ŒSecurityManageréœ€è¦è°ƒç”¨è¿™é‡Œè¿›è¡Œæƒé™æŸ¥è¯¢ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {  SysUserEntity user = (SysUserEntity)principals.getPrimaryPrincipal();  Long userId = user.getUserId();   //ç”¨æˆ·æƒé™åˆ—è¡¨  SetString permsSet = shiroService.getUserPermissions(userId);   SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();  info.setStringPermissions(permsSet);  return info; } 6.2 æƒé™è®¾è®¡æ€è·¯ æƒé™ç›¸å…³çš„è¡¨ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n sys_user[ç”¨æˆ·]è¡¨ï¼Œä¿å­˜ç”¨æˆ·ç›¸å…³æ•°æ®ï¼Œé€šè¿‡sys_user_role[ç”¨æˆ·ä¸è§’è‰²å…³è”]è¡¨ï¼Œä¸sys_role[è§’è‰²]è¡¨å…³è”ï¼›sys_menu[èœå•]è¡¨é€šè¿‡sys_role_menu[èœå•ä¸è§’è‰²å…³è”]è¡¨ï¼Œä¸sys_role[è§’è‰²]è¡¨å…³è” sys_menuè¡¨ï¼Œä¿å­˜èœå•ç›¸å…³æ•°æ®ï¼Œå¹¶åœ¨permså­—æ®µé‡Œï¼Œä¿å­˜äº†shiroçš„æƒé™æ ‡è¯†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‹¥æœ‰æ­¤èœå•ï¼Œå°±æ‹¥æœ‰permså­—æ®µé‡Œçš„æ‰€æœ‰æƒé™ï¼Œæ¯”å¦‚ï¼ŒæŸç”¨æˆ·æ‹¥æœ‰çš„èœå•æƒé™æ ‡è¯† sys:user:info ï¼Œå°±å¯ä»¥è®¿é—®ä¸‹é¢çš„æ–¹æ³•  @RequestMapping(\"/info/{userId}\") @RequiresPermissions(\"sys:user:info\") public R info(@PathVariable(\"userId\") Long userId){ } åœ¨shiroé…ç½®ä»£ç é‡Œï¼Œé…ç½®ä¸º anon çš„ï¼Œè¡¨ç¤ºä¸ç»è¿‡shiroå¤„ç†ï¼Œé…ç½®ä¸º oauth2 çš„ï¼Œè¡¨ç¤ºç»è¿‡ OAuth2Filter å¤„ç†ï¼Œå‰åç«¯åˆ†ç¦»çš„æ¥å£ï¼Œéƒ½ä¼šäº¤ç»™ OAuth2Filterå¤„ç†ï¼Œè¿™æ ·å°±ä¿è¯ï¼Œæ²¡æœ‰æƒé™çš„è¯·æ±‚ï¼Œæ‹’ç»è®¿é—®  /** * Shiroé…ç½® * * @author Mark sunlightcs@gmail.com */ @Configuration public class ShiroConfig {   /** * Shiroè‡ªå¸¦çš„è¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®æ‹¦æˆªé¡µé¢ */  @Bean(\"shiroFilter\")  public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) {   // 1. åˆå§‹åŒ–ä¸€ä¸ªShiroFilterå·¥ç¨‹ç±»  ShiroFilterFactoryBean shiroFilter = new ShiroFilterFactoryBean();  // 2. æˆ‘ä»¬çŸ¥é“Shiroæ˜¯é€šè¿‡SecurityManageræ¥ç®¡ç†æ•´ä¸ªè®¤è¯å’Œæˆæƒæµç¨‹çš„ï¼Œè¿™ä¸ªSecurityManagerå¯ä»¥åœ¨ä¸‹é¢åˆå§‹åŒ–  shiroFilter.setSecurityManager(securityManager);   //è‡ªå®šä¹‰Oauth2Filterè¿‡æ»¤å™¨  MapString, Filter filters = new HashMap();  filters.put(\"oauth2\", new OAuth2Filter());  shiroFilter.setFilters(filters);   // 3. ä¸Šé¢æˆ‘ä»¬è®²è¿‡ï¼Œæœ‰çš„é¡µé¢ä¸éœ€ç™»å½•ä»»ä½•äººå¯ä»¥ç›´æ¥è®¿é—®ï¼Œæœ‰çš„éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼Œæœ‰çš„ä¸ä»…è¦ç™»å½•è¿˜éœ€è¦ç›¸å…³æƒé™æ‰èƒ½è®¿é—®  MapString, String filterMap = new LinkedHashMap();   // 4. Shiroè¿‡æ»¤å™¨å¸¸ç”¨çš„æœ‰å¦‚ä¸‹å‡ ç§  // 4.1. anon ä»»ä½•äººéƒ½èƒ½è®¿é—®ï¼Œå¦‚ç™»å½•é¡µé¢  // 4.2. authc éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼Œå¦‚ç³»ç»Ÿå†…çš„å…¨ä½“é€šçŸ¥é¡µé¢  // 4.3. roles éœ€è¦ç›¸åº”çš„è§’è‰²æ‰èƒ½è®¿é—®  filterMap.put(\"/webjars/**\", \"anon\");  filterMap.put(\"/druid/**\", \"anon\");  filterMap.put(\"/app/**\", \"anon\");  filterMap.put(\"/sys/login\", \"anon\");  filterMap.put(\"/swagger/**\", \"anon\");  filterMap.put(\"/v2/api-docs\", \"anon\");  filterMap.put(\"/swagger-ui.html\", \"anon\");  filterMap.put(\"/swagger-resources/**\", \"anon\");  filterMap.put(\"/captcha.jpg\", \"anon\");  filterMap.put(\"/aaa.txt\", \"anon\");  filterMap.put(\"/**\", \"oauth2\");  // 5. è®©ShiroFilteræŒ‰è¿™ä¸ªè§„åˆ™æ‹¦æˆª  shiroFilter.setFilterChainDefinitionMap(filterMap);   // 6. ç”¨æˆ·æ²¡ç™»å½•è¢«æ‹¦æˆªåï¼Œå½“ç„¶éœ€è¦è°ƒè½¬åˆ°ç™»å½•é¡µäº†ï¼Œè¿™é‡Œé…ç½®ç™»å½•é¡µ  //shiroFilterFactoryBean.setLoginUrl(\"/api/user/login\");  return shiroFilter;  }    @Bean(\"securityManager\")  public SecurityManager securityManager(OAuth2Realm oAuth2Realm) {  // 7. æ–°å»ºä¸€ä¸ªSecurityManagerä¾›ShiroFilterFactoryBeanä½¿ç”¨  DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();  // 8. SecurityManageræ—¢ç„¶ç®¡ç†è®¤è¯ç­‰ä¿¡æ¯ï¼Œé‚£ä»–å°±éœ€è¦ä¸€ä¸ªç±»æ¥å¸®ä»–æŸ¥æ•°æ®åº“å§ã€‚è¿™å°±æ˜¯Realmç±»  securityManager.setRealm(oAuth2Realm);  securityManager.setRememberMeManager(null);  return securityManager;  }    @Bean(\"lifecycleBeanPostProcessor\")  public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() {  return new LifecycleBeanPostProcessor();  }   @Bean  public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager) {  AuthorizationAttributeSourceAdvisor advisor = new AuthorizationAttributeSourceAdvisor();  advisor.setSecurityManager(securityManager);  return advisor;  } } 6.3 XSS è„šæœ¬è¿‡æ»¤  XSSè·¨ç«™è„šæœ¬æ”»å‡»çš„åŸºæœ¬åŸç†å’ŒSQLæ³¨å…¥æ”»å‡»ç±»ä¼¼ï¼Œéƒ½æ˜¯åˆ©ç”¨ç³»ç»Ÿæ‰§è¡Œäº†æœªç»è¿‡æ»¤çš„å±é™©ä»£ç ï¼Œä¸åŒç‚¹ åœ¨äºXSSæ˜¯ä¸€ç§åŸºäºç½‘é¡µè„šæœ¬çš„æ³¨å…¥æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å°†è„šæœ¬æ”»å‡»è½½è·å†™å…¥ç½‘é¡µæ‰§è¡Œä»¥è¾¾åˆ°å¯¹ç½‘é¡µå®¢æˆ·ç«¯è®¿é—®ç”¨æˆ·æ”»å‡»çš„ç›®çš„ï¼Œå±äºå®¢æˆ·ç«¯æ”»å‡»ã€‚ç¨‹åºå‘˜å¾€å¾€ä¸å¤ªå…³å¿ƒå®‰å…¨è¿™å—ï¼Œè¿™å°±ç»™æœ‰å¿ƒä¹‹äººï¼Œæä¾›äº†æœºä¼šï¼Œæœ¬ç³»ç»Ÿé’ˆå¯¹XSSæ”»å‡»ï¼Œæä¾›äº†è¿‡æ»¤åŠŸèƒ½ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢XSSæ”»å‡»ï¼Œä»£ç å¦‚ä¸‹ï¼š\n public class XssFilter implements Filter {  @Override  public void init(FilterConfig config) throws ServletException {  }   public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)  throws IOException, ServletException {  XssHttpServletRequestWrapper xssRequest = new XssHttpServletRequestWrapper(  (HttpServletRequest) request);  chain.doFilter(xssRequest, response);  }   @Override  public void destroy() {  } }  @Configuration public class FilterConfig {  @Bean  public FilterRegistrationBean xssFilterRegistration() {  FilterRegistrationBean registration = new FilterRegistrationBean();  registration.setDispatcherTypes(DispatcherType.REQUEST);  registration.setFilter(new XssFilter());  registration.addUrlPatterns(\"/*\");  registration.setName(\"xssFilter\");  registration.setOrder(Integer.MAX_VALUE);  return registration;  } }  è‡ªå®šä¹‰XssFilterè¿‡æ»¤å™¨ï¼Œç”¨æ¥è¿‡æ»¤æ‰€æœ‰è¯·æ±‚ï¼Œå…·ä½“è¿‡æ»¤è¿˜æ˜¯åœ¨XssHttpServletRequestWrapperé‡Œå®ç°çš„ï¼Œ å¦‚ä¸‹æ‰€ç¤ºï¼š  public class XssHttpServletRequestWrapper extends HttpServletRequestWrapper {  //æ²¡è¢«åŒ…è£…è¿‡çš„HttpServletRequestï¼ˆç‰¹æ®Šåœºæ™¯ï¼Œéœ€è¦è‡ªå·±è¿‡æ»¤ï¼‰  HttpServletRequest orgRequest;  //htmlè¿‡æ»¤  private final static HTMLFilter htmlFilter = new HTMLFilter();   public XssHttpServletRequestWrapper(HttpServletRequest request) {  super(request);  orgRequest = request;  }   @Override  public ServletInputStream getInputStream() throws IOException { //éjsonç±»å‹ï¼Œç›´æ¥è¿”å›  if (!MediaType.APPLICATION_JSON_VALUE.equalsIgnoreCase(super.getHeader(HttpHeaders.CON  TENT_TYPE))) {  return super.getInputStream();  } //ä¸ºç©ºï¼Œç›´æ¥è¿”å›  String json = IOUtils.toString(super.getInputStream(), \"utf-8\");  if (StringUtils.isBlank(json)) {  return super.getInputStream();  } //xssè¿‡æ»¤  json = xssEncode(json);  final ByteArrayInputStream bis = new ByteArrayInputStream(json.getBytes(\"utf-8\"));  return new ServletInputStream() {  @Override  public boolean isFinished() {  return true;  }   @Override  public boolean isReady() {  return true;  }   @Override  public void setReadListener(ReadListener readListener) {  }   @Override  public int read() throws IOException {  return bis.read();  }  };  }   @Override  public String getParameter(String name) {  String value = super.getParameter(xssEncode(name));  if (StringUtils.isNotBlank(value)) {  value = xssEncode(value);  }  return value;  }   @Override  public String[] getParameterValues(String name) {  String[] parameters = super.getParameterValues(name);  if (parameters == null || parameters.length == 0) {  return null;  }  for (int i = 0; i  parameters.length; i++) {  parameters[i] = xssEncode(parameters[i]);  }  return parameters;  }   @Override  public MapString, String[] getParameterMap() {  MapString, String[] map = new LinkedHashMap();  MapString, String[] parameters = super.getParameterMap();  for (String key : parameters.keySet()) {  String[] values = parameters.get(key);  for (int i = 0; i  values.length; i++) {  values[i] = xssEncode(values[i]);  }  map.put(key, values);  }  return map;  }   @Override  public String getHeader(String name) {  String value = super.getHeader(xssEncode(name));  if (StringUtils.isNotBlank(value)) {  value = xssEncode(value);  }  return value;  }   private String xssEncode(String input) {  return htmlFilter.filter(input);  }   /** * è·å–æœ€åŸå§‹çš„request */  public HttpServletRequest getOrgRequest() {  return orgRequest;  }   /** * è·å–æœ€åŸå§‹çš„request */  public static HttpServletRequest getOrgRequest(HttpServletRequest request) {  if (request instanceof XssHttpServletRequestWrapper) {  return ((XssHttpServletRequestWrapper) request).getOrgRequest();  }  return request;  } } å¦‚æœéœ€è¦å¤„ç†å¯Œæ–‡æœ¬æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ XssHttpServletRequestWrapper.getOrgRequest(request) ï¼Œæ‹¿åˆ°åŸå§‹ çš„ request å¯¹è±¡åï¼Œå†è‡ªè¡Œå¤„ç†å¯Œæ–‡æœ¬æ•°æ®ï¼Œå¦‚ï¼š\npublic R data(HttpServletRequest request){  HttpServletRequest orgRequest=XssHttpServletRequestWrapper.getOrgRequest(request);  String content=orgRequest.getParameter(\"content\");  //å¯Œæ–‡æœ¬æ•°æ®  System.out.println(content);  return R.ok();  } 6.4 SQL æ³¨å…¥  æœ¬ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Mybatisï¼Œå¦‚æœä½¿ç”¨${}æ‹¼æ¥SQLï¼Œåˆ™å­˜åœ¨SQLæ³¨å…¥é£é™©ï¼Œå¯ä»¥å¯¹å‚æ•°è¿›è¡Œè¿‡æ»¤ï¼Œé¿å… SQLæ³¨å…¥ï¼Œå¦‚ä¸‹:\n public class SQLFilter {  /** * SQLæ³¨å…¥è¿‡æ»¤ * @param str å¾…éªŒè¯çš„å­—ç¬¦ä¸² */  public static String sqlInject(String str) {  if (StringUtils.isBlank(str)) {  return null;  }  //å»æ‰'|\"|;|\\å­—ç¬¦  str = StringUtils.replace(str, \"'\", \"\");  str = StringUtils.replace(str, \"\\\"\", \"\");  str = StringUtils.replace(str, \";\", \"\");  str = StringUtils.replace(str, \"\\\\\", \"\");  //è½¬æ¢æˆå°å†™\\  str = str.toLowerCase();  //éæ³•å­—ç¬¦  String[] keywords = {\"master\", \"truncate\", \"insert\", \"select\", \"delete\", \"update\", \"declare\", \"alter\", \"drop\"};  //åˆ¤æ–­æ˜¯å¦åŒ…å«éæ³•å­—ç¬¦  for (String keyword : keywords) {  if (str.indexOf(keyword) != -1) {  throw new RRException(\"åŒ…å«éæ³•å­—ç¬¦\");  }  }  return str;  } } åƒæŸ¥è¯¢åˆ—è¡¨ï¼Œæ¶‰åŠæ’åºé—®é¢˜ï¼Œæ’åºå­—æ®µæ˜¯ä»å‰å°ä¼ è¿‡æ¥çš„ï¼Œåˆ™å­˜åœ¨SQLæ³¨å…¥é£é™©ï¼Œéœ€ç»å¦‚ä¸‹å¤„ç†ï¼š\npublic class QueryT {  public IPageT getPage(MapString, Object params) {  return this.getPage(params, null, false);  }   public IPageT getPage(MapString, Object params, String defaultOrderField, boolean isAsc) {  //åˆ†é¡µå‚æ•°  long curPage = 1;  long limit = 10;  if (params.get(Constant.PAGE) != null) {  curPage = Long.parseLong((String) params.get(Constant.PAGE));  }  if (params.get(Constant.LIMIT) != null) {  limit = Long.parseLong((String) params.get(Constant.LIMIT));  }   //åˆ†é¡µå¯¹è±¡  PageT page = new Page(curPage, limit);  //åˆ†é¡µå‚æ•°  params.put(Constant.PAGE, page);   //æ’åºå­—æ®µ  //é˜²æ­¢SQLæ³¨å…¥ï¼ˆå› ä¸ºsidxã€orderæ˜¯é€šè¿‡æ‹¼æ¥SQLå®ç°æ’åºçš„ï¼Œä¼šæœ‰SQLæ³¨å…¥é£é™©ï¼‰  String orderField = SQLFilter.sqlInject((String) params.get(Constant.ORDER_FIELD));  String order = (String) params.get(Constant.ORDER);   //å‰ç«¯å­—æ®µæ’åº  if (StringUtils.isNotEmpty(orderField) \u0026\u0026 StringUtils.isNotEmpty(order)) {  if (Constant.ASC.equalsIgnoreCase(order)) {  return page.setAsc(orderField);  } else {  return page.setDesc(orderField);  }  }  //é»˜è®¤æ’åº  if (isAsc) {  page.setAsc(defaultOrderField);  } else {  page.setDesc(defaultOrderField);  }  return page;  } } 6.5 Redis ç¼“å­˜  ç¼“å­˜å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œä½†èƒ½å¦çµæ´»è¿ç”¨ï¼Œå°±ä¸ä¸€å®šäº†ã€‚ä¸€èˆ¬è®¾è®¡ç¼“å­˜æ¶æ„æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä¸‹å‡ ä¸ªé—® é¢˜ï¼š\n   æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå°½é‡å‡å°‘DBæŸ¥è¯¢ï¼ŒDBä¸»è¦è´Ÿè´£å†™æ•°æ®\n  å°½é‡ä¸ä½¿ç”¨ LEFT JOIN ç­‰å…³è”æŸ¥è¯¢ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¸é«˜ï¼Œè¿˜æµªè´¹å†…å­˜\n  å¤šä½¿ç”¨å•è¡¨æŸ¥è¯¢ï¼Œç¼“å­˜å‘½ä¸­ç‡æœ€é«˜\n  æ•°æ®åº“ insert ã€ update ã€ delete æ—¶ï¼ŒåŒæ­¥æ›´æ–°ç¼“å­˜æ•°æ®\n  åˆç†è¿ç”¨Redisæ•°æ®ç»“æ„ï¼Œä¹Ÿè®¸æœ‰è´¨çš„é£è·ƒ\n  å¯¹äºè®¿é—®é‡ä¸å¤§çš„é¡¹ç›®ï¼Œä½¿ç”¨ç¼“å­˜åªä¼šå¢åŠ é¡¹ç›®çš„å¤æ‚åº¦\n  æœ¬ç³»ç»Ÿé‡‡ç”¨Redisä½œä¸ºç¼“å­˜ï¼Œå¹¶å¯é…ç½®æ˜¯å¦å¼€å¯redisç¼“å­˜ï¼Œä¸»è¦è¿˜æ˜¯é€šè¿‡Spring AOPå®ç°çš„ï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š\nredis: database: 0 host: localhost port: 6379 password: # å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰ timeout: 6000ms # è¿æ¥è¶…æ—¶æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ jedis: pool: max-active: 1000 # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ max-wait: -1ms # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ max-idle: 10 # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥ min-idle: 5 # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥ renren: redis: open: false #æ˜¯å¦å¼€å¯redisç¼“å­˜ trueå¼€å¯ falseå…³é—­ æœ¬é¡¹ç›®ä¸­ï¼Œä½¿ç”¨RedisæœåŠ¡çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\npublic class SysConfigServiceImpl implements SysConfigService {  @Autowired  private SysConfigDao sysConfigDao;  @Autowired  private SysConfigRedis sysConfigRedis;   @Override  @Transactional  public void save(SysConfigEntity config) {  sysConfigDao.save(config);  sysConfigRedis.saveOrUpdate(config);  }   @Override  @Transactional  public void update(SysConfigEntity config) {  sysConfigDao.update(config);  sysConfigRedis.saveOrUpdate(config);  }   @Override  @Transactional  public void updateValueByKey(String key, String value) {  sysConfigDao.updateValueByKey(key, value);  sysConfigRedis.delete(key);  }   @Override  @Transactional  public void deleteBatch(Long[] ids) {  sysConfigDao.deleteBatch(ids);  for (Long id : ids) {  SysConfigEntity config = queryObject(id);  sysConfigRedis.delete(config.getKey());  }  } }  @Component public class SysConfigRedis {  @Autowired  private RedisUtils redisUtils;   public void saveOrUpdate(SysConfigEntity config) {  if (config == null) {  return;  }  String key = RedisKeys.getSysConfigKey(config.getKey());  redisUtils.set(key, config);  }   public void delete(String configKey) {  String key = RedisKeys.getSysConfigKey(configKey);  redisUtils.delete(key);  }   public SysConfigEntity get(String configKey) {  String key = RedisKeys.getSysConfigKey(configKey);  return redisUtils.get(key, SysConfigEntity.class);  } }  @Component public class RedisUtils {  @Autowired  private RedisTemplateString, Object redisTemplate;  @Autowired  private ValueOperationsString, String valueOperations;  @Autowired  private HashOperationsString, String, Object hashOperations;  @Autowired  private ListOperationsString, Object listOperations;  @Autowired  private SetOperationsString, Object setOperations;  @Autowired  private ZSetOperationsString, Object zSetOperations;  /** * é»˜è®¤è¿‡æœŸæ—¶é•¿ï¼Œå•ä½ï¼šç§’ */  public final static long DEFAULT_EXPIRE = 60 * 60 * 24;  /** * ä¸è®¾ç½®è¿‡æœŸæ—¶é•¿ */  public final static long NOT_EXPIRE = -1;  private final static Gson gson = new Gson();   public void set(String key, Object value, long expire) {  valueOperations.set(key, toJson(value));  if (expire != NOT_EXPIRE) {  redisTemplate.expire(key, expire, TimeUnit.SECONDS);  }  }   public void set(String key, Object value) {  set(key, value, DEFAULT_EXPIRE);  }   public T T get(String key, ClassT clazz, long expire) {  String value = valueOperations.get(key);  if (expire != NOT_EXPIRE) {  redisTemplate.expire(key, expire, TimeUnit.SECONDS);  }  return value == null ? null : fromJson(value, clazz);  }   public T T get(String key, ClassT clazz) {  return get(key, clazz, NOT_EXPIRE);  }   public String get(String key, long expire) {  String value = valueOperations.get(key);  if (expire != NOT_EXPIRE) {  redisTemplate.expire(key, expire, TimeUnit.SECONDS);  }  return value;  }   public String get(String key) {  return get(key, NOT_EXPIRE);  }   public void delete(String key) {  redisTemplate.delete(key);  }   /** * Objectè½¬æˆJSONæ•°æ® */  private String toJson(Object object) {  if (object instanceof Integer || object instanceof Long || object instanceof Float ||  object instanceof Double || object instanceof Boolean || object instanceof St  ring) {  return String.valueOf(object);  }  return gson.toJson(object);  }   /** * JSONæ•°æ®ï¼Œè½¬æˆObject */  private T T fromJson(String json, ClassT clazz) {  return gson.fromJson(json, clazz);  } } å¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œè®¤ä¸ºè¿™ä¸ªé¡¹ç›®å¿…é¡»è¦é…ç½®Redisç¼“å­˜ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼Œå› ä¸ºæœ‰æ“ä½œRedisçš„ä»£ç ï¼Œå…¶å®ä¸ ç„¶ï¼Œé€šè¿‡Spring AOPï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ï¼Œæ˜¯å¦çœŸçš„ä½¿ç”¨Redisï¼Œä»£ç å¦‚ä¸‹ï¼š\n @Aspect @Component public class RedisAspect {  private Logger logger = LoggerFactory.getLogger(getClass());  /** * æ˜¯å¦å¼€å¯redisç¼“å­˜ trueå¼€å¯ falseå…³é—­ */  @Value(\"${renren.redis.open: false}\")  private boolean open;   @Around(\"execution(* io.renren.common.utils.RedisUtils.*(..))\")  public Object around(ProceedingJoinPoint point) throws Throwable {  Object result = null;  if (open) {  try {  result = point.proceed();  } catch (Exception e) {  logger.error(\"redis error\", e);  throw new RRException(\"RedisæœåŠ¡å¼‚å¸¸\");  }  }  return result;  } } 6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶  æœ¬é¡¹ç›®é€šè¿‡RRExceptionå¼‚å¸¸ç±»ï¼ŒæŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼ŒRRExceptionç»§æ‰¿RuntimeExceptionï¼Œä¸èƒ½ç»§æ‰¿ Exceptionï¼Œå¦‚æœç»§æ‰¿Exceptionï¼Œåˆ™Springäº‹åŠ¡ä¸ä¼šå›æ»šã€‚\n RRExceptionä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\npublic class RRException extends RuntimeException {  private static final long serialVersionUID = 1L;  private String msg;  private int code = 500;   public RRException(String msg) {  super(msg);  this.msg = msg;  }   public RRException(String msg, Throwable e) {  super(msg, e);  this.msg = msg;  }   public RRException(String msg, int code) {  super(msg);  this.msg = msg;  this.code = code;  }   public RRException(String msg, int code, Throwable e) {  super(msg, e);  this.msg = msg;  this.code = code;  }   public String getMsg() {  return msg;  }   public void setMsg(String msg) {  this.msg = msg;  }   public int getCode() {  return code;  }   public void setCode(int code) {  this.code = code;  } }  å¦‚ä½•å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸å‘¢ï¼Œæˆ‘ä»¬å®šä¹‰äº†RRExceptionHandlerç±»ï¼Œå¹¶åŠ ä¸Šæ³¨è§£@RestControllerAdviceï¼Œå°±å¯ä»¥å¤„ç†æ‰€æœ‰æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¹¶è¿”å›JSONæ•°æ®ã€‚@RestControllerAdviceæ˜¯ç”±@ControllerAdviceã€@ResponseBodyæ³¨è§£ç»„åˆè€Œæ¥çš„ï¼Œå¯ä»¥æŸ¥æ‰¾@ControllerAdviceç›¸å…³çš„èµ„æ–™ï¼Œç†è§£@ControllerAdviceæ³¨è§£ çš„ä½¿ç”¨ã€‚\n RRExceptionHandlerä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\n @RestControllerAdvice public class RRExceptionHandler {  private Logger logger = LoggerFactory.getLogger(getClass());   /** * å¤„ç†è‡ªå®šä¹‰å¼‚å¸¸ */  @ExceptionHandler(RRException.class)  public R handleRRException(RRException e) {  R r = new R();  r.put(\"code\", e.getCode());  r.put(\"msg\", e.getMessage());  return r;  }   @ExceptionHandler(DuplicateKeyException.class)  public R handleDuplicateKeyException(DuplicateKeyException e) {  logger.error(e.getMessage(), e);  return R.error(\"æ•°æ®åº“ä¸­å·²å­˜åœ¨è¯¥è®°å½•\");  }   @ExceptionHandler(AuthorizationException.class)  public R handleAuthorizationException(AuthorizationException e) {  logger.error(e.getMessage(), e);  return R.error(\"æ²¡æœ‰æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æˆæƒ\");  }   @ExceptionHandler(Exception.class)  public R handleException(Exception e) {  logger.error(e.getMessage(), e);  return R.error();  } } 6.7 åç«¯æ•ˆéªŒæœºåˆ¶  æœ¬é¡¹ç›®ï¼Œåç«¯æ•ˆéªŒä½¿ç”¨çš„æ˜¯Hibernate Validatoræ ¡éªŒæ¡†æ¶ï¼Œä¸”è‡ªå®šä¹‰ValidatorUtilså·¥å…·ç±»ï¼Œç”¨æ¥æ•ˆéªŒæ•° æ®ã€‚\n Hibernate Validatorå®˜æ–¹æ–‡æ¡£ï¼š http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/ ValidatorUtilsä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\npublic class ValidatorUtils {  private static Validator validator;   static {  validator = Validation.buildDefaultValidatorFactory().getValidator();  }   /** * æ ¡éªŒå¯¹è±¡ * @param object å¾…æ ¡éªŒå¯¹è±¡ * @param groups å¾…æ ¡éªŒçš„ç»„ * @throws RRException æ ¡éªŒä¸é€šè¿‡ï¼Œåˆ™æŠ¥RRExceptionå¼‚å¸¸ */  public static void validateEntity(Object object, Class... groups) throws RRException {  SetConstraintViolationObject constraintViolations = validator.validate(object, groups);  if (!constraintViolations.isEmpty()) {  ConstraintViolationObject constraint = (ConstraintViolationObject) constraintV  iolations.iterator().next();  throw new RRException(constraint.getMessage());  }  } } ä½¿ç”¨æ¡ˆä¾‹ï¼š\n @RestController @RequestMapping(\"/sys/user\") public class SysUserController extends AbstractController {  /** * ä¿å­˜ç”¨æˆ· */  @SysLog(\"ä¿å­˜ç”¨æˆ·\")  @RequestMapping(\"/save\")  @RequiresPermissions(\"sys:user:save\")  public R save(@RequestBody SysUserEntity user) { //ä¿å­˜ç”¨æˆ·æ—¶ï¼Œæ•ˆéªŒSysUserEntityé‡Œï¼Œå¸¦æœ‰AddGroupæ³¨è§£çš„å±æ€§  ValidatorUtils.validateEntity(user, AddGroup.class);  user.setCreateUserId(getUserId());  sysUserService.save(user);  return R.ok();  }   /** * ä¿®æ”¹ç”¨æˆ· */  @SysLog(\"ä¿®æ”¹ç”¨æˆ·\")  @RequestMapping(\"/update\")  @RequiresPermissions(\"sys:user:update\")  public R update(@RequestBody SysUserEntity user) { //ä¿®æ”¹ç”¨æˆ·æ—¶ï¼Œæ•ˆéªŒSysUserEntityé‡Œï¼Œå¸¦æœ‰UpdateGroupæ³¨è§£çš„å±æ€§  ValidatorUtils.validateEntity(user, UpdateGroup.class);  user.setCreateUserId(getUserId());  sysUserService.update(user);  return R.ok();  } } public class SysUserEntity implements Serializable {  /** * ç”¨æˆ·ID */  private Long userId;  /** * ç”¨æˆ·å */  @NotBlank(message = \"ç”¨æˆ·åä¸èƒ½ä¸ºç©º\", groups = {AddGroup.class, UpdateGroup.class})  private String username;  /** * å¯†ç  */  @NotBlank(message = \"å¯†ç ä¸èƒ½ä¸ºç©º\", groups = AddGroup.class)  private String password;  /** * ç› */  private String salt;  /** * é‚®ç®± */  @NotBlank(message = \"é‚®ç®±ä¸èƒ½ä¸ºç©º\", groups = {AddGroup.class, UpdateGroup.class})  @Email(message = \"é‚®ç®±æ ¼å¼ä¸æ­£ç¡®\", groups = {AddGroup.class, UpdateGroup.class})  private String email;  /** * æ‰‹æœºå· */  private String mobile;  /** * çŠ¶æ€ 0ï¼šç¦ç”¨ 1ï¼šæ­£å¸¸ */  private Integer status;  /** * è§’è‰²IDåˆ—è¡¨ */  private ListLong roleIdList;  /** * åˆ›å»ºè€…ID */  private Long createUserId;  /** * åˆ›å»ºæ—¶é—´ */  private Date createTime; } é€šè¿‡åˆ†æä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬æ¥ç†è§£Hibernate Validatoræ ¡éªŒæ¡†æ¶çš„ä½¿ç”¨ã€‚ å…¶ä¸­ï¼Œusernameå±æ€§ï¼Œè¡¨ç¤ºä¿å­˜æˆ–ä¿®æ”¹ç”¨æˆ·æ—¶ï¼Œéƒ½ä¼šæ•ˆéªŒusernameå±æ€§ï¼›è€Œpasswordå±æ€§ï¼Œè¡¨ç¤ºåªæœ‰ä¿å­˜ç”¨æˆ·æ—¶ï¼Œæ‰ä¼šæ•ˆéªŒpasswordå±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¿®æ”¹ç”¨æˆ·æ—¶ï¼Œpasswordå¯ä»¥ä¸å¡«å†™ï¼Œå…è®¸ä¸ºç©ºã€‚\nå¦‚æœä¸æŒ‡å®šå±æ€§çš„groupsï¼Œåˆ™é»˜è®¤å±äºjavax.validation.groups.Default.classåˆ†ç»„ï¼Œå¯ä»¥é€šè¿‡ValidatorUtils.validateEntity(user)è¿›è¡Œæ•ˆéªŒã€‚\n6.8 ç³»ç»Ÿæ—¥å¿— ç³»ç»Ÿæ—¥å¿—æ˜¯é€šè¿‡Spring AOPå®ç°çš„ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†æ³¨è§£ @SysLog ï¼Œä¸”åªèƒ½åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface SysLog {  String value() default \"\"; } ä¸‹é¢æ˜¯è‡ªå®šä¹‰æ³¨è§£ @SysLog çš„ä½¿ç”¨æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n @RestController @RequestMapping(\"/sys/user\") public class SysUserController extends AbstractController {  @SysLog(\"ä¿å­˜ç”¨æˆ·\")  @RequestMapping(\"/save\")  @RequiresPermissions(\"sys:user:save\")  public R save(@RequestBody SysUserEntity user) {  ValidatorUtils.validateEntity(user, AddGroup.class);  user.setCreateUserId(getUserId());  sysUserService.save(user);  return R.ok();  } } æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåªéœ€è¦åœ¨ä¿å­˜æ—¥å¿—çš„è¯·æ±‚æ–¹æ³•ä¸Šï¼ŒåŠ ä¸Š @SysLog æ³¨è§£ï¼Œå°±å¯ä»¥æŠŠæ—¥å¿—ä¿å­˜åˆ°æ•°æ®åº“é‡Œäº†ã€‚ å…·ä½“æ˜¯åœ¨å“ªé‡ŒæŠŠæ•°æ®ä¿å­˜åˆ°æ•°æ®åº“é‡Œçš„å‘¢ï¼Œæˆ‘ä»¬å®šä¹‰äº† SysLogAspect å¤„ç†ç±»ï¼Œå°±æ˜¯æ¥å¹²è¿™äº‹çš„ï¼Œå¦‚ä¸‹æ‰€ ç¤ºï¼š\n/** * ç³»ç»Ÿæ—¥å¿—ï¼Œåˆ‡é¢å¤„ç†ç±» */ @Aspect @Component public class SysLogAspect {  @Autowired  private SysLogService sysLogService;   @Pointcut(\"@annotation(io.renren.common.annotation.SysLog)\")  public void logPointCut() {  }   @Around(\"logPointCut()\")  public Object around(ProceedingJoinPoint point) throws Throwable {  long beginTime = System.currentTimeMillis(); //æ‰§è¡Œæ–¹æ³•  Object result = point.proceed(); //æ‰§è¡Œæ—¶é•¿(æ¯«ç§’)  long time = System.currentTimeMillis() - beginTime; //ä¿å­˜æ—¥å¿—  saveSysLog(point, time);  return result;  }   private void saveSysLog(ProceedingJoinPoint joinPoint, long time) {  MethodSignature signature = (MethodSignature) joinPoint.getSignature();  Method method = signature.getMethod();  SysLogEntity sysLog = new SysLogEntity();  SysLog syslog = method.getAnnotation(SysLog.class);  if (syslog != null) { //æ³¨è§£ä¸Šçš„æè¿°  sysLog.setOperation(syslog.value());  } //è¯·æ±‚çš„æ–¹æ³•å  String className = joinPoint.getTarget().getClass().getName();  String methodName = signature.getName();  sysLog.setMethod(className + \".\" + methodName + \"()\"); //è¯·æ±‚çš„å‚æ•°  Object[] args = joinPoint.getArgs();  try {  String params = new Gson().toJson(args[0]);  sysLog.setParams(params);  } catch (Exception e) {  } //è·å–request  HttpServletRequest request = HttpContextUtils.getHttpServletRequest(); //è®¾ç½®IPåœ°å€  sysLog.setIp(IPUtils.getIpAddr(request)); //ç”¨æˆ·å  String username = ((SysUserEntity) SecurityUtils.getSubject().getPrincipal()).getUser  name();  sysLog.setUsername(username);  sysLog.setTime(time);  sysLog.setCreateDate(new Date()); //ä¿å­˜ç³»ç»Ÿæ—¥å¿—  sysLogService.save(sysLog);  } } SysLogAspect ç±»å®šä¹‰äº†ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œè¯·æ±‚ @SysLog æ³¨è§£çš„æ–¹æ³•æ—¶ï¼Œä¼šè¿›å…¥ aroundæ–¹æ³•ï¼ŒæŠŠç³»ç»Ÿæ—¥å¿—ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚\n6.9 æ·»åŠ èœå•  èœå•ç®¡ç†ï¼Œä¸»è¦æ˜¯å¯¹ã€ç›®å½•ã€èœå•ã€æŒ‰é’®ã€‘è¿›è¡ŒåŠ¨æ€çš„æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œï¼Œæ–¹ä¾¿å¼€å‘è€…ç®¡ç†èœå•ã€‚\n ä¸Šå›¾æ˜¯æ‹¿ç°æœ‰çš„èœå•è¿›è¡Œè®²è§£ã€‚å…¶ä¸­ï¼Œæˆæƒæ ‡è¯†ä¸shiroä¸­çš„æ³¨è§£@RequiresPermissionsï¼Œå®šä¹‰çš„æˆæƒæ ‡è¯†æ˜¯ ä¸€ä¸€å¯¹åº”çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n @RestController @RequestMapping(\"/sys/config\") public class SysConfigController extends AbstractController {  @RequestMapping(\"/list\")  @RequiresPermissions(\"sys:config:list\")  public R list(@RequestParam MapString, Object params) {  }   @RequestMapping(\"/info/{id}\")  @RequiresPermissions(\"sys:config:info\")  public R info(@PathVariable(\"id\") Long id) {  }   @RequestMapping(\"/save\")  @RequiresPermissions(\"sys:config:save\")  public R save(@RequestBody SysConfigEntity config) {  }   @RequestMapping(\"/update\")  @RequiresPermissions(\"sys:config:update\")  public R update(@RequestBody SysConfigEntity config) {   }   @RequestMapping(\"/delete\")  @RequiresPermissions(\"sys:config:delete\")  public R delete(@RequestBody Long[] ids) {   }  } 6.10 æ·»åŠ è§’è‰²  ç®¡ç†å‘˜æƒé™æ˜¯é€šè¿‡è§’è‰²è¿›è¡Œç®¡ç†çš„ï¼Œç»™ç®¡ç†å‘˜åˆ†é…æƒé™æ—¶ï¼Œè¦å…ˆåˆ›å»ºå¥½è§’è‰²ã€‚\n ä¸‹é¢åˆ›å»ºäº†ä¸€ä¸ªã€å¼€å‘è§’è‰²ã€‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n6.11 æ·»åŠ ç®¡ç†å‘˜  æœ¬ç³»ç»Ÿé»˜è®¤å°±åˆ›å»ºäº†adminè´¦å·ï¼Œæ— éœ€åˆ†é…ä»»ä½•è§’è‰²ï¼Œå°±æ‹¥æœ‰æœ€é«˜æƒé™ã€‚ ä¸€ä¸ªç®¡ç†å‘˜æ˜¯å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’ è‰²çš„ã€‚\n ä¸‹é¢åˆ›å»ºä¸€ä¸ªã€zhangsanã€‘çš„ç®¡ç†å‘˜è´¦å·ï¼Œå¹¶å±äºã€å¼€å‘è§’è‰²ã€‘ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n6.12 å®šæ—¶ä»»åŠ¡æ¨¡å—  æœ¬ç³»ç»Ÿä½¿ç”¨å¼€æºæ¡†æ¶Quartzï¼Œå®ç°çš„å®šæ—¶ä»»åŠ¡ï¼Œå·²å®ç°åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ï¼Œå¯éƒ¨ç½²å¤šå°æœåŠ¡å™¨ï¼Œä¸é‡å¤æ‰§è¡Œï¼Œä»¥åŠåŠ¨æ€å¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€æš‚åœã€æ¢å¤ã€ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚ Quartzè‡ªå¸¦äº†å„æ•°æ®åº“çš„SQLè„šæœ¬ï¼Œå¦‚æœæƒ³æ›´æ”¹æˆå…¶ä»–æ•°æ®åº“ï¼Œå¯å‚è€ƒQuartzç›¸åº”çš„SQLè„šæœ¬ã€‚\n 6.12.1 æ–°å¢å®šæ—¶ä»»åŠ¡ æ–°å¢ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå…¶å®å¾ˆç®€å•ï¼Œåªè¦å®šä¹‰ä¸€ä¸ªæ™®é€šçš„Spring Beanå³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n@Component(\"testTask\") public class TestTask implements ITask {  private Logger logger = LoggerFactory.getLogger(getClass());   @Override  public void run(String params) {  logger.debug(\"TestTaskå®šæ—¶ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œå‚æ•°ä¸ºï¼š{}\", params);  } } å¦‚ä½•è®©Quartzï¼Œå®šæ—¶æ‰§è¡ŒtestTaské‡Œçš„æ–¹æ³•å‘¢ï¼Ÿåªéœ€è¦åœ¨ç®¡ç†åå°ï¼Œæ–°å¢ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nåˆšæ‰é…ç½®çš„å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš” 30 åˆ†é’Ÿï¼Œå°±ä¼šè°ƒç”¨TestTaskçš„testæ–¹æ³•äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å•Šã€‚\n6.12.2 æºç åˆ†æ Quartzæä¾›äº†ç›¸å…³çš„APIï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨APIï¼Œå¯¹Quartzè¿›è¡Œå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€æš‚åœã€æ¢å¤ã€ç«‹å³æ‰§è¡Œç­‰ã€‚ æœ¬ç³»ç»Ÿä¸­ï¼Œ ScheduleUtils ç±»å°±æ˜¯å¯¹Quartz APIè¿›è¡Œçš„å°è£…ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\npublic class ScheduleUtils {  private final static String JOB_NAME = \"TASK_\";   /** * è·å–è§¦å‘å™¨key */  private static TriggerKey getTriggerKey(Long jobId) {  return TriggerKey.triggerKey(JOB_NAME + jobId);  }   /** * è·å–jobKey */  private static JobKey getJobKey(Long jobId) {  return JobKey.jobKey(JOB_NAME + jobId);  }   /** * è·å–è¡¨è¾¾å¼è§¦å‘å™¨ */  public static CronTrigger getCronTrigger(Scheduler scheduler, Long jobId) {  try {  return (CronTrigger) scheduler.getTrigger(getTriggerKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"getCronTriggerå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥qrtzå¼€å¤´çš„è¡¨ï¼Œæ˜¯å¦æœ‰è„æ•°æ®\", e);  }  }   /** * åˆ›å»ºå®šæ—¶ä»»åŠ¡ */  public static void createScheduleJob(Scheduler scheduler, ScheduleJobEntity scheduleJob) {  try { //æ„å»ºjobä¿¡æ¯  JobDetail jobDetail = JobBuilder.newJob(ScheduleJob.class).withIdentity(getJobKey  (scheduleJob.getJobId())).build(); //è¡¨è¾¾å¼è°ƒåº¦æ„å»ºå™¨  CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(scheduleJo  b.getCronExpression())  .withMisfireHandlingInstructionDoNothing(); //æŒ‰æ–°çš„cronExpressionè¡¨è¾¾å¼æ„å»ºä¸€ä¸ªæ–°çš„trigger  CronTrigger trigger = TriggerBuilder.newTrigger().withIdentity(getTriggerKey(sche  duleJob.getJobId())).  withSchedule(scheduleBuilder).build(); //æ”¾å…¥å‚æ•°ï¼Œè¿è¡Œæ—¶çš„æ–¹æ³•å¯ä»¥è·å–  jobDetail.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY, new Gson().toJson(  scheduleJob));  scheduler.scheduleJob(jobDetail, trigger); //æš‚åœä»»åŠ¡  if (scheduleJob.getStatus() == ScheduleStatus.PAUSE.getValue()) {  pauseJob(scheduler, scheduleJob.getJobId());  }  } catch (SchedulerException e) {  throw new RRException(\"åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥\", e);  }  }   /** * æ›´æ–°å®šæ—¶ä»»åŠ¡ */  public static void updateScheduleJob(Scheduler scheduler, ScheduleJobEntity scheduleJob) {  try {  TriggerKey triggerKey = getTriggerKey(scheduleJob.getJobId()); //è¡¨è¾¾å¼è°ƒåº¦æ„å»ºå™¨  CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(scheduleJo  b.getCronExpression())  .withMisfireHandlingInstructionDoNothing();  CronTrigger trigger = getCronTrigger(scheduler, scheduleJob.getJobId()); //æŒ‰æ–°çš„cronExpressionè¡¨è¾¾å¼é‡æ–°æ„å»ºtrigger  trigger = trigger.getTriggerBuilder().withIdentity(triggerKey).withSchedule(sched  uleBuilder).build(); //å‚æ•°  trigger.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY, new Gson().toJson(sc  heduleJob));  scheduler.rescheduleJob(triggerKey, trigger); //æš‚åœä»»åŠ¡  if (scheduleJob.getStatus() == ScheduleStatus.PAUSE.getValue()) {  pauseJob(scheduler, scheduleJob.getJobId());  }  } catch (SchedulerException e) {  throw new RRException(\"æ›´æ–°å®šæ—¶ä»»åŠ¡å¤±è´¥\", e);  }  }   /** * ç«‹å³æ‰§è¡Œä»»åŠ¡ */  public static void run(Scheduler scheduler, ScheduleJobEntity scheduleJob) {  try { //å‚æ•°  JobDataMap dataMap = new JobDataMap();  dataMap.put(ScheduleJobEntity.JOB_PARAM_KEY, new Gson().toJson(scheduleJob));  scheduler.triggerJob(getJobKey(scheduleJob.getJobId()), dataMap);  } catch (SchedulerException e) {  throw new RRException(\"ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡å¤±è´¥\", e);  }  }   /** * æš‚åœä»»åŠ¡ */  public static void pauseJob(Scheduler scheduler, Long jobId) {  try {  scheduler.pauseJob(getJobKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"æš‚åœå®šæ—¶ä»»åŠ¡å¤±è´¥\", e);  }  }   /** * æ¢å¤ä»»åŠ¡ */  public static void resumeJob(Scheduler scheduler, Long jobId) {  try {  scheduler.resumeJob(getJobKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"æš‚åœå®šæ—¶ä»»åŠ¡å¤±è´¥\", e);  }  }   /** * åˆ é™¤å®šæ—¶ä»»åŠ¡ */  public static void deleteScheduleJob(Scheduler scheduler, Long jobId) {  try {  scheduler.deleteJob(getJobKey(jobId));  } catch (SchedulerException e) {  throw new RRException(\"åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥\", e);  }  } } ä»¥ä¸‹æ˜¯å‡ ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ï¼š\n  createScheduleJobã€åˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‘ï¼šåœ¨ç®¡ç†åå°æ–°å¢ä»»åŠ¡æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼ŒæŠŠä»»åŠ¡æ·»åŠ åˆ°Quartz ä¸­ï¼Œå†æ ¹æ®cronè¡¨è¾¾å¼ï¼Œå®šæ—¶æ‰§è¡Œä»»åŠ¡ã€‚\n  updateScheduleJobã€æ›´æ–°å®šæ—¶ä»»åŠ¡ã€‘ï¼šä¿®æ”¹ä»»åŠ¡æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¿®æ”¹Quartzä¸­çš„ä»»åŠ¡ä¿¡æ¯ã€‚\n  runã€ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‘ï¼šé©¬ä¸Šæ‰§è¡Œä¸€æ¬¡è¯¥ä»»åŠ¡ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚\n  pauseJobã€æš‚åœå®šæ—¶ä»»åŠ¡ã€‘ï¼šè¿™ä¸ªä¸æ˜¯æš‚åœæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œæ˜¯ä»¥åä¸å†æ‰§è¡Œè¿™ä¸ªå®šæ—¶ä»»åŠ¡äº†ã€‚æ­£åœ¨ æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿˜æ˜¯ç…§å¸¸æ‰§è¡Œå®Œã€‚\n  resumeJobã€æ¢å¤å®šæ—¶ä»»åŠ¡ã€‘ï¼šè¿™ä¸ªæ˜¯é’ˆå¯¹pauseJobæ¥çš„ï¼Œå¦‚æœä»»åŠ¡æš‚åœäº†ï¼Œä»¥åéƒ½ä¸ä¼šå†æ‰§è¡Œï¼Œè¦æƒ³å†æ‰§è¡Œï¼Œåˆ™éœ€è¦è°ƒç”¨resumeJobï¼Œä½¿å®šæ—¶ä»»åŠ¡æ¢å¤æ‰§è¡Œã€‚\n  deleteScheduleJobã€åˆ é™¤å®šæ—¶ä»»åŠ¡ã€‘ï¼šåˆ é™¤å®šæ—¶ä»»åŠ¡\n  å…¶ä¸­ï¼Œ createScheduleJob ã€ updateScheduleJob åœ¨å¯åŠ¨é¡¹ç›®çš„æ—¶å€™ï¼Œä¹Ÿä¼šè°ƒç”¨ï¼ŒæŠŠæ•°æ®åº“é‡Œï¼Œæ–°å¢æˆ–ä¿® æ”¹çš„ä»»åŠ¡ï¼Œæ›´æ–°åˆ°Quartzä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n @Service(\"scheduleJobService\") public class ScheduleJobServiceImpl implements ScheduleJobService {  /** * é¡¹ç›®å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–å®šæ—¶å™¨ */  @PostConstruct  public void init() {  ListScheduleJobEntity scheduleJobList = schedulerJobDao.queryList(new HashMap());  for (ScheduleJobEntity scheduleJob : scheduleJobList) {  CronTrigger cronTrigger = ScheduleUtils.getCronTrigger(scheduler, scheduleJob.getJobId());  //å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º  if (cronTrigger == null) {  ScheduleUtils.createScheduleJob(scheduler, scheduleJob);  } else {  ScheduleUtils.updateScheduleJob(scheduler, scheduleJob);  }  }  } } å¤§å®¶æ˜¯ä¸æ˜¯è¿˜æœ‰ç–‘é—®å‘¢ï¼Œæ€ä¹ˆå°±èƒ½å®šæ—¶æ‰§è¡Œï¼Œåˆšæ‰åœ¨ç®¡ç†åå°æ–°å¢çš„ä»»åŠ¡testTaskå‘¢ï¼Ÿ ä¸‹é¢æˆ‘ä»¬å†æ¥åˆ†æ ä¸‹ createScheduleJob æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡çš„æ—¶å€™ï¼Œè¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\n//æ„å»ºä¸€ä¸ªæ–°çš„å®šæ—¶ä»»åŠ¡ï¼ŒJobBuilder.newJob()åªèƒ½æ¥å—Jobç±»å‹çš„å‚æ•° //æŠŠScheduleJob.classä½œä¸ºå‚æ•°ä¼ è¿›å»ï¼ŒScheduleJobç»§æ‰¿QuartzJobBeanï¼Œè€ŒQuartzJobBeanå®ç°äº†Jobæ¥å£ JobDetail jobDetail=JobBuilder.newJob(ScheduleJob.class).withIdentity(getJobKey(scheduleJob.getJobId())).build(); //æ„å»ºcronï¼Œå®šæ—¶ä»»åŠ¡çš„å‘¨æœŸ  CronScheduleBuilder scheduleBuilder=CronScheduleBuilder.cronSchedule(scheduleJob.getCronExpression()).withMisfireHandlingInstructionDoNothing(); //æ ¹æ®cronï¼Œæ„å»ºä¸€ä¸ªCronTrigger  CronTrigger trigger=TriggerBuilder.newTrigger().withIdentity(getTriggerKey(scheduleJob.getJobId())).withSchedule(scheduleBuilder).build(); //æ”¾å…¥å‚æ•°ï¼Œè¿è¡Œæ—¶çš„æ–¹æ³•å¯ä»¥è·å–  jobDetail.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY,new Gson().toJson(scheduleJob)); //æŠŠä»»åŠ¡æ·»åŠ åˆ°Quartzä¸­  scheduler.scheduleJob(jobDetail,trigger); æŠŠä»»åŠ¡æ·»åŠ åˆ° Quartz åï¼Œç­‰cronå®šä¹‰çš„æ—¶é—´å‘¨æœŸåˆ°äº†ï¼Œå°±ä¼šæ‰§è¡Œ ScheduleJob ç±»çš„ executeInternal æ–¹ æ³•ï¼Œ ScheduleJob ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\npublic class ScheduleJob extends QuartzJobBean {  private Logger logger = LoggerFactory.getLogger(getClass());   @Override  protected void executeInternal(JobExecutionContext context) throws JobExecutionException {  ScheduleJobEntity scheduleJob = (ScheduleJobEntity) context.getMergedJobDataMap()  .get(ScheduleJobEntity.JOB_PARAM_KEY);  //è·å–spring bean  ScheduleJobLogService scheduleJobLogService = (ScheduleJobLogService) SpringContextUt  ils.getBean(\"scheduleJobLogService\");  //æ•°æ®åº“ä¿å­˜æ‰§è¡Œè®°å½•  ScheduleJobLogEntity log = new ScheduleJobLogEntity();  log.setJobId(scheduleJob.getJobId());  log.setBeanName(scheduleJob.getBeanName());  log.setParams(scheduleJob.getParams());  log.setCreateTime(new Date());  //ä»»åŠ¡å¼€å§‹æ—¶é—´  long startTime = System.currentTimeMillis();  try {  //æ‰§è¡Œä»»åŠ¡  logger.info(\"ä»»åŠ¡å‡†å¤‡æ‰§è¡Œï¼Œä»»åŠ¡IDï¼š\" + scheduleJob.getJobId());   Object target = SpringContextUtils.getBean(scheduleJob.getBeanName());  Method method = target.getClass().getDeclaredMethod(\"run\", String.class);  method.invoke(target, scheduleJob.getParams());  //ä»»åŠ¡æ‰§è¡Œæ€»æ—¶é•¿  long times = System.currentTimeMillis() - startTime;  log.setTimes((int) times);  //ä»»åŠ¡çŠ¶æ€ 0 ï¼šæˆåŠŸ 1 ï¼šå¤±è´¥   log.setStatus(0);  logger.info(\"ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä»»åŠ¡IDï¼š\" + scheduleJob.getJobId() + \" æ€»å…±è€—æ—¶ï¼š\" + tim es + \"æ¯«ç§’\");  } catch (Exception e) {  logger.error(\"ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œä»»åŠ¡IDï¼š\" + scheduleJob.getJobId(), e);  //ä»»åŠ¡æ‰§è¡Œæ€»æ—¶é•¿  long times = System.currentTimeMillis() - startTime;  log.setTimes((int) times);  //ä»»åŠ¡çŠ¶æ€ 0 ï¼šæˆåŠŸ 1 ï¼šå¤±è´¥  log.setStatus(1);  log.setError(StringUtils.substring(e.toString(), 0, 2000));  } finally {  scheduleJobLogService.save(log);  }  } } 6.13 äº‘å­˜å‚¨æ¨¡å—  å›¾ç‰‡ã€æ–‡ä»¶ä¸Šä¼ ï¼Œä½¿ç”¨çš„æ˜¯ä¸ƒç‰›ã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘çš„å­˜å‚¨æœåŠ¡ï¼Œä¸èƒ½ä¸Šä¼ åˆ°æœ¬åœ°æœåŠ¡å™¨ã€‚ä¸Šä¼ åˆ°æœ¬åœ° æœåŠ¡å™¨ï¼Œä¸åˆ©äºç»´æŠ¤ï¼Œè®¿é—®é€Ÿåº¦æ…¢ç­‰ç¼ºç‚¹ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨äº‘å­˜å‚¨æœåŠ¡ã€‚\n 6.13.1 ä¸ƒç‰›çš„é…ç½®  å¦‚æœæ²¡æœ‰ä¸ƒç‰›è´¦å·ï¼Œåˆ™éœ€è¦æ³¨å†Œä¸ƒç‰›è´¦å·ï¼Œæ‰èƒ½è¿›è¡Œé…ç½®ï¼Œä¸‹é¢æ¼”ç¤ºæ³¨å†Œä¸ƒç‰›è´¦å·å¹¶é…ç½®ï¼Œæ­¥éª¤å¦‚ ä¸‹ï¼š\n  [æ³¨å†Œä¸ƒç‰›è´¦å·][34]ï¼Œå¹¶ç™»å½•åï¼Œå†åˆ›å»ºä¸ƒç‰›ç©ºé—´ï¼Œå¦‚ä¸‹å›¾ï¼š  è¿›å…¥ç®¡ç†åç«¯ï¼Œå¡«å†™ä¸ƒç‰›é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ï¼š  å¿…å¡«é¡¹æœ‰åŸŸåã€AccessKeyã€SecretKeyã€ç©ºé—´åã€‚å…¶ä¸­ï¼Œç©ºé—´åå°±æ˜¯æ‰åˆ›å»ºçš„ç©ºé—´å ios-app ï¼Œå¡«è¿›å»å°±å¯ ä»¥äº†ã€‚åŸŸåã€AccessKeyã€SecretKeyå¯ä»¥é€šè¿‡ä¸‹å›¾æ‰¾åˆ°ï¼š\n6.13.2 é˜¿é‡Œäº‘çš„é…ç½®  è¿›å…¥ç®¡ç†åç«¯ï¼Œå¡«å†™é˜¿é‡Œäº‘é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ï¼š   è¿›å»é˜¿é‡Œäº‘ç®¡ç†åå°ï¼Œå¹¶åˆ›å»ºBucketï¼Œå¦‚ä¸‹å›¾ï¼š   é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°åŸŸåã€BucketNameã€EndPoint   é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°AccessKeyIdã€AccessKeySecret  6.13.3 è…¾è®¯äº‘çš„é…ç½®  è¿›å…¥ç®¡ç†åç«¯ï¼Œå¡«å†™è…¾è®¯äº‘é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ï¼š   è¿›å»è…¾è®¯äº‘ç®¡ç†åå°ï¼Œå¹¶åˆ›å»ºBucketï¼Œå¦‚ä¸‹å›¾ï¼š   é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°åŸŸåã€BucketNameã€Bucketæ‰€å±åœ°åŒº   é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°AppIdã€SecretIdã€SecretKey  6.13.4 æºç åˆ†æ æœ¬é¡¹ç›®çš„æ–‡ä»¶ä¸Šä¼ ï¼Œä½¿ç”¨çš„æ˜¯ä¸ƒç‰›ã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼Œåˆ™éœ€è¦å¼•å…¥ä»–ä»¬çš„SDKï¼Œå¦‚ä¸‹ï¼š\n   com.qiniu  qiniu-java-sdk  ${qiniu.version}   com.aliyun.oss aliyun-sdk-oss ${aliyun.oss.version}   com.qcloud cos_api ${qcloud.cos.version}     org.slf4j  slf4j-log4j12     å®šä¹‰æŠ½è±¡ç±» CloudStorageService ï¼Œç”¨æ¥å£°æ˜ä¸Šä¼ çš„å…¬å…±æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\npublic abstract class CloudStorageService {  /** * äº‘å­˜å‚¨é…ç½®ä¿¡æ¯ */  CloudStorageConfig config;   /** * æ–‡ä»¶è·¯å¾„ * * @param prefix å‰ç¼€ * @param suffix åç¼€ * @return è¿”å›ä¸Šä¼ è·¯å¾„ */  public String getPath(String prefix, String suffix) {  //ç”Ÿæˆuuid  String uuid = UUID.randomUUID().toString().replaceAll(\"-\", \"\");  //æ–‡ä»¶è·¯å¾„  String path = DateUtils.format(new Date(), \"yyyyMMdd\") + \"/\" + uuid;  if (StringUtils.isNotBlank(prefix)) {  path = prefix + \"/\" + path;  }  return path + suffix;  }   /** * æ–‡ä»¶ä¸Šä¼  * * @param data æ–‡ä»¶å­—èŠ‚æ•°ç»„ * @param path æ–‡ä»¶è·¯å¾„ï¼ŒåŒ…å«æ–‡ä»¶å * @return è¿”å›httpåœ°å€ */  public abstract String upload(byte[] data, String path);   /** * æ–‡ä»¶ä¸Šä¼  * * @param data æ–‡ä»¶å­—èŠ‚æ•°ç»„ * @param suffix åç¼€ * @return è¿”å›httpåœ°å€ */  public abstract String uploadSuffix(byte[] data, String suffix);   /** * æ–‡ä»¶ä¸Šä¼  * * @param inputStream å­—èŠ‚æµ * @param path æ–‡ä»¶è·¯å¾„ï¼ŒåŒ…å«æ–‡ä»¶å * @return è¿”å›httpåœ°å€ */  public abstract String upload(InputStream inputStream, String path);   /** * æ–‡ä»¶ä¸Šä¼  * * @param inputStream å­—èŠ‚æµ * @param suffix åç¼€ * @return è¿”å›httpåœ°å€ */  public abstract String uploadSuffix(InputStream inputStream, String suffix); }  ä¸ƒç‰›ä¸Šä¼ çš„å®ç°ï¼Œåªéœ€ç»§æ‰¿ CloudStorageService ï¼Œå¹¶å®ç°ç›¸åº”çš„ä¸Šä¼ æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  import com.qiniu.common.Zone; import com.qiniu.http.Response; import com.qiniu.storage.Configuration; import com.qiniu.storage.UploadManager; import com.qiniu.util.Auth; import io.renren.common.exception.RRException; import org.apache.commons.io.IOUtils;  import java.io.IOException; import java.io.InputStream;  /** * ä¸ƒç‰›äº‘å­˜å‚¨ * * @author Mark sunlightcs@gmail.com */ public class QiniuCloudStorageService extends CloudStorageService {  private UploadManager uploadManager;  private String token;   public QiniuCloudStorageService(CloudStorageConfig config) {  this.config = config; //åˆå§‹åŒ–  init();  }   private void init() {  uploadManager = new UploadManager(new Configuration(Zone.autoZone()));  token = Auth.create(config.getQiniuAccessKey(), config.getQiniuSecretKey()).  uploadToken(config.getQiniuBucketName());  }   @Override  public String upload(byte[] data, String path) {  try {  Response res = uploadManager.put(data, path, token);  if (!res.isOK()) {  throw new RuntimeException(\"ä¸Šä¼ ä¸ƒç‰›å‡ºé”™ï¼š\" + res.toString());  }  } catch (Exception e) {  throw new RRException(\"ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ ¸å¯¹ä¸ƒç‰›é…ç½®ä¿¡æ¯\", e);  }  return config.getQiniuDomain() + \"/\" + path;  }   @Override  public String upload(InputStream inputStream, String path) {  try {  byte[] data = IOUtils.toByteArray(inputStream);  return this.upload(data, path);  } catch (IOException e) {  throw new RRException(\"ä¸Šä¼ æ–‡ä»¶å¤±è´¥\", e);  }  }   @Override  public String uploadSuffix(byte[] data, String suffix) {  return upload(data, getPath(config.getQiniuPrefix(), suffix));  }   @Override  public String uploadSuffix(InputStream inputStream, String suffix) {  return upload(inputStream, getPath(config.getQiniuPrefix(), suffix));  } }  é˜¿é‡Œäº‘ä¸Šä¼ çš„å®ç°ï¼Œåªéœ€ç»§æ‰¿ CloudStorageService ï¼Œå¹¶å®ç°ç›¸åº”çš„ä¸Šä¼ æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤º  import com.aliyun.oss.OSSClient; import io.renren.common.exception.RRException;  import java.io.ByteArrayInputStream; import java.io.InputStream;  /** * é˜¿é‡Œäº‘å­˜å‚¨ * * @author Mark sunlightcs@gmail.com */ public class AliyunCloudStorageService extends CloudStorageService {  private OSSClient client;   public AliyunCloudStorageService(CloudStorageConfig config) {  this.config = config; //åˆå§‹åŒ–  init();  }   private void init() {  client = new OSSClient(config.getAliyunEndPoint(), config.getAliyunAccessKeyId(),  config.getAliyunAccessKeySecret());  }   @Override  public String upload(byte[] data, String path) {  return upload(new ByteArrayInputStream(data), path);  }   @Override  public String upload(InputStream inputStream, String path) {  try {  client.putObject(config.getAliyunBucketName(), path, inputStream);  } catch (Exception e) {  throw new RRException(\"ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ä¿¡æ¯\", e);  }  return config.getAliyunDomain() + \"/\" + path;  }   @Override  public String uploadSuffix(byte[] data, String suffix) {  return upload(data, getPath(config.getAliyunPrefix(), suffix));  }   @Override  public String uploadSuffix(InputStream inputStream, String suffix) {  return upload(inputStream, getPath(config.getAliyunPrefix(), suffix));  } }  è…¾è®¯äº‘ä¸Šä¼ çš„å®ç°ï¼Œåªéœ€ç»§æ‰¿ CloudStorageService ï¼Œå¹¶å®ç°ç›¸åº”çš„ä¸Šä¼ æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  import com.qcloud.cos.COSClient; import com.qcloud.cos.ClientConfig; import com.qcloud.cos.request.UploadFileRequest; import com.qcloud.cos.sign.Credentials; import io.renren.common.exception.RRException; import net.sf.json.JSONObject; import org.apache.commons.io.IOUtils;  import java.io.IOException; import java.io.InputStream;  /** * è…¾è®¯äº‘å­˜å‚¨ * * @author Mark sunlightcs@gmail.com */ public class QcloudCloudStorageService extends CloudStorageService {  private COSClient client;   public QcloudCloudStorageService(CloudStorageConfig config) {  this.config = config; //åˆå§‹åŒ–  init();  }   private void init() {  Credentials credentials = new Credentials(config.getQcloudAppId(), config.getQcloudSe  cretId(),  config.getQcloudSecretKey()); //åˆå§‹åŒ–å®¢æˆ·ç«¯é…ç½®  ClientConfig clientConfig = new ClientConfig(); //è®¾ç½®bucketæ‰€åœ¨çš„åŒºåŸŸï¼Œåå—ï¼šgz ååŒ—ï¼štj åä¸œï¼šsh  clientConfig.setRegion(config.getQcloudRegion());  client = new COSClient(clientConfig, credentials);  }   @Override  public String upload(byte[] data, String path) { //è…¾è®¯äº‘å¿…éœ€è¦ä»¥\"/\"å¼€å¤´  if (!path.startsWith(\"/\")) {  path = \"/\" + path;  } //ä¸Šä¼ åˆ°è…¾è®¯äº‘  UploadFileRequest request = new UploadFileRequest(config.getQcloudBucketName(), path,  data);  String response = client.uploadFile(request);  JSONObject jsonObject = JSONObject.fromObject(response);  if (jsonObject.getInt(\"code\") != 0) {  throw new RRException(\"æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œ\" + jsonObject.getString(\"message\"));  }  return config.getQcloudDomain() + path;  }   @Override  public String upload(InputStream inputStream, String path) {  try {  byte[] data = IOUtils.toByteArray(inputStream);  return this.upload(data, path);  } catch (IOException e) {  throw new RRException(\"ä¸Šä¼ æ–‡ä»¶å¤±è´¥\", e);  }  }   @Override  public String uploadSuffix(byte[] data, String suffix) {  return upload(data, getPath(config.getQcloudPrefix(), suffix));  }   @Override  public String uploadSuffix(InputStream inputStream, String suffix) {  return upload(inputStream, getPath(config.getQcloudPrefix(), suffix));  } }  å¯¹å¤–æä¾›äº†OSSFactoryå·¥å‚ï¼Œå¯æ–¹ä¾¿ä¸šåŠ¡çš„è°ƒç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  public final class OSSFactory {  private static SysConfigService sysConfigService;   static {  OSSFactory.sysConfigService = (SysConfigService) SpringContextUtils.getBean(\"sysConfi gService\");  }   public static CloudStorageService build() { //è·å–äº‘å­˜å‚¨é…ç½®ä¿¡æ¯  CloudStorageConfig config = sysConfigService.getConfigObject(ConfigConstant.CLOUD_STO  RAGE_CONFIG_KEY, CloudStorageConfig.class);  if (config.getType() == Constant.CloudService.QINIU.getValue()) {  return new QiniuCloudStorageService(config);  } else if (config.getType() == Constant.CloudService.ALIYUN.getValue()) {  return new AliyunCloudStorageService(config);  } else if (config.getType() == Constant.CloudService.QCLOUD.getValue()) {  return new QcloudCloudStorageService(config);  }  return null;  } }  æ–‡ä»¶ä¸Šä¼ çš„ä¾‹å­ï¼Œå¦‚ä¸‹ï¼š @RequestMapping(\"/upload\")  @RequestMapping(\"/upload\") public R upload(@RequestParam(\"file\") MultipartFile file)throws Exception{  if(file.isEmpty()){  throw new RRException(\"ä¸Šä¼ æ–‡ä»¶ä¸èƒ½ä¸ºç©º\");  }  //ä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶è¿”å›æ–‡ä»¶çš„httpåœ°å€  String url=OSSFactory.build().upload(file.getBytes());  }  } 6.14 APP æ¨¡å—  APPæ¨¡å—ï¼Œæ˜¯é’ˆå¯¹APPä½¿ç”¨çš„ï¼Œå¦‚IOSã€Androidç­‰ï¼Œä¸»è¦æ˜¯è§£å†³ç”¨æˆ·è®¤è¯çš„é—®é¢˜ã€‚\n 6.14.1 APP çš„ä½¿ç”¨  APPçš„è®¾è®¡æ€è·¯ï¼šç”¨æˆ·é€šè¿‡APPï¼Œè¾“å…¥æ‰‹æœºå·ã€å¯†ç ç™»å½•åï¼Œç³»ç»Ÿä¼šç”Ÿæˆä¸ç™»å½•ç”¨æˆ·ä¸€ä¸€å¯¹åº”çš„ tokenï¼Œç”¨æˆ·è°ƒç”¨éœ€è¦ç™»å½•çš„æ¥å£æ—¶ï¼Œåªéœ€æŠŠtokenä¼ è¿‡æ¥ï¼ŒæœåŠ¡ç«¯å°±çŸ¥é“æ˜¯è°åœ¨è®¿é—®æ¥å£ï¼Œtokenå¦‚æœè¿‡æœŸï¼Œåˆ™æ‹’ç»è®¿é—®ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚\n ä½¿ç”¨å¾ˆç®€å•ï¼Œçœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå°±ä¼šä½¿ç”¨äº†ã€‚ä»”ç»†è§‚å¯Ÿï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œæœ‰ 2 ä¸ªè‡ªå®šä¹‰çš„æ³¨è§£ã€‚å…¶ä¸­ï¼Œ @LoginUseræ³¨è§£æ˜¯è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæœ‰å“ªäº›ä¿¡æ¯ï¼Œä¸‹é¢ä¼šåˆ†æçš„ã€‚@Loginæ³¨è§£åˆ™æ˜¯éœ€è¦ç”¨æˆ·è®¤è¯ï¼Œæ²¡æœ‰ç™»å½•çš„ç”¨æˆ·ï¼Œä¸èƒ½è®¿é—®è¯¥æ¥å£ã€‚\nimport io.renren.modules.app.annotation.Login; import io.renren.modules.app.annotation.LoginUser; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestAttribute; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController;  @RestController @RequestMapping(\"/app\") public class ApiTestController {  /** * è·å–ç”¨æˆ·ä¿¡æ¯ */  @Login  @GetMapping(\"userInfo\")  public R userInfo(@LoginUser UserEntity user) {  return R.ok().put(\"user\", user);  }   /** * è·å–ç”¨æˆ·ID */  @Login  @GetMapping(\"userId\")  public R userInfo(@RequestAttribute(\"userId\") Integer userId) {  return R.ok().put(\"userId\", userId);  }   /** * å¿½ç•¥TokenéªŒè¯æµ‹è¯• */  @GetMapping(\"notToken\")  public R notToken() {  return R.ok().put(\"msg\", \"æ— éœ€tokenä¹Ÿèƒ½è®¿é—®ã€‚ã€‚ã€‚\");  } } 6.14.2 æºç åˆ†æ  æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼ŒAPPç”¨æˆ·ç™»å½•çš„æ—¶å€™ï¼Œéƒ½å¹²äº†é‚£äº›äº‹æƒ…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š   @RestController @RequestMapping(\"/app\") @Api(\"APPç™»å½•æ¥å£\") public class ApiLoginController {  @Autowired  private UserService userService;  @Autowired  private JwtUtils jwtUtils;   /** * ç™»å½• */  @PostMapping(\"login\")  @ApiOperation(\"ç™»å½•\")  public R login(@RequestBody LoginForm form) { \t//è¡¨å•æ ¡éªŒ  ValidatorUtils.validateEntity(form); \t//ç”¨æˆ·ç™»å½•  long userId = userService.login(form); \t//ç”Ÿæˆtoken  String token = jwtUtils.generateToken(userId);  MapString, Object map = new HashMap();  map.put(\"token\", token);  map.put(\"expire\", jwtUtils.getExpire());  return R.ok(map);  } } /** * jwtå·¥å…·ç±» */ @ConfigurationProperties(prefix = \"renren.jwt\") @Component public class JwtUtils {  private Logger logger = LoggerFactory.getLogger(getClass());  private String secret;  private long expire;  private String header;   /** * ç”Ÿæˆjwt token */  public String generateToken(long userId) {  Date nowDate = new Date(); \t//è¿‡æœŸæ—¶é—´  Date expireDate = new Date(nowDate.getTime() + expire * 1000);  return Jwts.builder()  .setHeaderParam(\"typ\", \"JWT\")  .setSubject(userId + \"\")  .setIssuedAt(nowDate)  .setExpiration(expireDate)  .signWith(SignatureAlgorithm.HS512, secret)  .compact();  }   public Claims getClaimByToken(String token) {  try {  return Jwts.parser()  .setSigningKey(secret)  .parseClaimsJws(token)  .getBody();  } catch (Exception e) {  logger.debug(\"validate is token error \", e);  return null;  }  }   /** * tokenæ˜¯å¦è¿‡æœŸ * * @return trueï¼šè¿‡æœŸ */  public boolean isTokenExpired(Date expiration) {  return expiration.before(new Date());  }   public String getSecret() {  return secret;  }   public void setSecret(String secret) {  this.secret = secret;  }   public long getExpire() {  return expire;  }   public void setExpire(long expire) {  this.expire = expire;  }   public String getHeader() {  return header;  }   public void setHeader(String header) {  this.header = header;  } } æˆ‘ä»¬ä»ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·æ¯æ¬¡ç™»å½•çš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„tokenï¼Œè¿™ä¸ªtokenæ˜¯é€šè¿‡jwtç”Ÿæˆ çš„ã€‚\n APPæ¨¡å—çš„æ ¸å¿ƒé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  import io.renren.modules.api.interceptor.AuthorizationInterceptor; import io.renren.modules.api.resolver.LoginUserHandlerMethodArgumentResolver; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.context.annotation.Configuration; import org.springframework.web.method.support.HandlerMethodArgumentResolver; import org.springframework.web.servlet.config.annotation.InterceptorRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;  @Configuration public class WebMvcConfig extends WebMvcConfigurerAdapter {  @Autowired  private AuthorizationInterceptor authorizationInterceptor;  @Autowired  private LoginUserHandlerMethodArgumentResolver loginUserHandlerMethodArgumentResolver;   @Override  public void addInterceptors(InterceptorRegistry registry) {  registry.addInterceptor(authorizationInterceptor).addPathPatterns(\"/app/**\");  }   @Override  public void addArgumentResolvers(ListHandlerMethodArgumentResolver argumentResolvers) {  argumentResolvers.add(loginUserHandlerMethodArgumentResolver);  } } æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé…ç½®äº†ä¸ªInterceptorï¼Œç”¨æ¥æ‹¦æˆª /app å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ï¼Œæ‹¦æˆªåï¼Œä¼šåˆ° AuthorizationInterceptorç±»preHandleæ–¹æ³•å¤„ç†ã€‚åªæœ‰ä»¥ /appå¼€å¤´çš„è¯·æ±‚ï¼ŒAPIæ¨¡å—è®¤è¯æ‰ä¼šèµ·ä½œç”¨ï¼Œå¦‚æœè¦ä»¥/api å¼€å¤´ï¼Œåˆ™éœ€è¦ä¿®æ”¹æ­¤å¤„ã€‚è¿˜é…ç½®äº†argumentResolverï¼Œåˆ«å¿½ç•¥äº†å•Šï¼Œä¸‹é¢ä¼šè®²è§£ã€‚\næ¸©é¦¨æç¤ºï¼Œåˆ«å¿˜äº†é…ç½®shiroï¼Œä¸ç„¶ä¼šè¢«shiroæ‹¦æˆªæ‰çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n @Configuration public class ShiroConfig {  @Bean(\"shiroFilter\")  public ShiroFilterFactoryBean shirFilter(SecurityManager securityManager) { //éƒ¨åˆ†ä»£ç çœç•¥...  MapString, String filterMap = new LinkedHashMap(); //è®©shiroæ”¾è¿‡ï¼Œä»¥/appå¼€å¤´çš„è¯·æ±‚  filterMap.put(\"/app/**\", \"anon\"); //éƒ¨åˆ†ä»£ç çœç•¥...  shiroFilter.setFilterChainDefinitionMap(filterMap);  return shiroFilter;  } }  åˆ†æAuthorizationInterceptorç±»ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ‹¦æˆª /app å¼€å¤´çš„è¯·æ±‚åï¼Œéƒ½å¹²äº†äº›ä»€ä¹ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  import io.jsonwebtoken.Claims; import io.renren.common.exception.RRException; import io.renren.modules.app.utils.JwtUtils; import io.renren.modules.app.annotation.Login; import org.apache.commons.lang.StringUtils; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.HttpStatus; import org.springframework.stereotype.Component; import org.springframework.web.method.HandlerMethod; import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;  import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse;  /** * æƒé™(Token)éªŒè¯ */ @Component public class AuthorizationInterceptor extends HandlerInterceptorAdapter {  @Autowired  private JwtUtils jwtUtils;  public static final String USER_KEY = \"userId\";   @Override  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object  handler) throws Exception {  Login annotation;  if (handler instanceof HandlerMethod) {  annotation = ((HandlerMethod) handler).getMethodAnnotation(Login.class);  } else {  return true;  }  if (annotation == null) {  return true;  } \t//è·å–ç”¨æˆ·å‡­è¯  String token = request.getHeader(jwtUtils.getHeader());  if (StringUtils.isBlank(token)) {  token = request.getParameter(jwtUtils.getHeader());  } \t//å‡­è¯ä¸ºç©º  if (StringUtils.isBlank(token)) {  throw new RRException(jwtUtils.getHeader() + \"ä¸èƒ½ä¸ºç©º\", HttpStatus.UNAUTHORIZED.v  alue());  }  Claims claims = jwtUtils.getClaimByToken(token);  if (claims == null || jwtUtils.isTokenExpired(claims.getExpiration())) {  throw new RRException(jwtUtils.getHeader() + \"å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•\", HttpStatus.UNAUTHO  RIZED.value());  } \t//è®¾ç½®userIdåˆ°requesté‡Œï¼Œåç»­æ ¹æ®userIdï¼Œè·å–ç”¨æˆ·ä¿¡æ¯  request.setAttribute(USER_KEY, Long.parseLong(claims.getSubject()));  return true;  } } æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿›å…¥ /app è¯·æ±‚çš„æ¥å£ä¹‹å‰ï¼Œä¼šåˆ¤æ–­è¯·æ±‚çš„æ¥å£ï¼Œæ˜¯å¦åŠ äº†@Loginæ³¨è§£(éœ€è¦tokenè®¤è¯)ï¼Œå¦‚æœæ²¡æœ‰@Loginæ³¨è§£ï¼Œåˆ™ä¸éªŒè¯tokenï¼Œå¯ä»¥ç›´æ¥è®¿é—®æ¥å£ã€‚å¦‚æœæœ‰@Loginæ³¨è§£ï¼Œåˆ™éœ€è¦éªŒè¯tokençš„æ­£ç¡®æ€§ï¼Œå¹¶æŠŠuserIdæ”¾åˆ°requestçš„USER_KEYé‡Œï¼Œåç»­ä¼šç”¨åˆ°ã€‚\n æ­¤æ—¶ï¼Œ@Loginæ³¨è§£çš„ä½œç”¨ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æ˜ç™½äº†ã€‚å†çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼ŒåŠ äº†@LoginUseræ³¨è§£åï¼Œuserå¯¹è±¡é‡Œï¼Œå°±å˜æˆå½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿™æ˜¯ä»€ä¹ˆæ—¶å€™è®¾ç½®è¿›å»çš„å‘¢ï¼Ÿ  /** * è·å–ç”¨æˆ·ä¿¡æ¯ */ @GetMapping(\"userInfo\") public R userInfo(@LoginUser UserEntity user){  return R.ok().put(\"user\",user); }  è®¾ç½®userå¯¹è±¡è¿›å»ï¼Œå…¶å®æ˜¯åœ¨LoginUserHandlerMethodArgumentResolveré‡Œå¹²çš„,LoginUserHandlerMethodArgumentResolveræ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å‚æ•°è½¬æ¢å™¨ï¼Œåªè¦å®ç°HandlerMethodArgumentResolveræ¥å£å³å¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  import io.renren.modules.api.annotation.LoginUser; import io.renren.modules.api.entity.UserEntity; import io.renren.modules.api.interceptor.AuthorizationInterceptor; import io.renren.modules.api.service.UserService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.core.MethodParameter; import org.springframework.stereotype.Component; import org.springframework.web.bind.support.WebDataBinderFactory; import org.springframework.web.context.request.NativeWebRequest; import org.springframework.web.context.request.RequestAttributes; import org.springframework.web.method.support.HandlerMethodArgumentResolver; import org.springframework.web.method.support.ModelAndViewContainer;  @Component public class LoginUserHandlerMethodArgumentResolver implements HandlerMethodArgumentResolver {  @Autowired  private UserService userService;   @Override  public boolean supportsParameter(MethodParameter parameter) { //å¦‚æœæ–¹æ³•çš„å‚æ•°æ˜¯UserEntityï¼Œä¸”å‚æ•°å‰é¢æœ‰@LoginUseræ³¨è§£ï¼Œåˆ™è¿›å…¥resolveArgumentæ–¹æ³•ï¼Œè¿›è¡Œ  å¤„ç†  return parameter.getParameterType().isAssignableFrom(UserEntity.class) \u0026\u0026 parameter.h  asParameterAnnotation(LoginUser.class);  }   @Override  public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer container,  NativeWebRequest request, WebDataBinderFactory factory) thr   ows Exception   { //è·å–ç”¨æˆ·IDï¼Œä¹‹å‰è®¾ç½®è¿›å»çš„ï¼Œè¿˜æœ‰å°è±¡å§  Object object = request.getAttribute(AuthorizationInterceptor.USER_KEY, RequestAttrib  utes.SCOPE_REQUEST);  if (object == null) {  return null;  } //é€šè¿‡userIdï¼Œè·å–ç”¨æˆ·ä¿¡æ¯  UserEntity user = userService.queryObject((Long) object); //æŠŠå½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œè®¾ç½®åˆ°UserEntityå‚æ•°çš„userå¯¹è±¡é‡Œ  return user;  } } ç¬¬ 7 ç«  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²  éƒ¨ç½²é¡¹ç›®å‰ï¼Œéœ€è¦å‡†å¤‡JDK8ã€Mavenã€MySQL5.5+ç¯å¢ƒï¼Œå‚è€ƒå¼€å‘ç¯å¢ƒæ­å»ºã€‚\n 7.1 jar åŒ…éƒ¨ç½² 7.2 docker éƒ¨ç½² 7.3 é›†ç¾¤éƒ¨ç½² 7.1 jar åŒ…éƒ¨ç½²  Spring Booté¡¹ç›®ï¼Œæ¨èæ‰“æˆjaråŒ…çš„æ–¹å¼ï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚\n  Spring Bootå†…ç½®äº†Tomcatï¼Œå¯é…ç½®Tomcatçš„ç«¯å£å·ã€åˆå§‹åŒ–çº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€è¿æ¥è¶…æ—¶æ—¶é•¿ã€https ç­‰ç­‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  server: tomcat: uri-encoding: UTF-8 max-threads: 1000 min-spare-threads: 30 port: 8080 connection-timeout: 5000ms servlet: context-path: /renren-fast session: cookie: http-only: true ssl: key-store: classpath:.keystore key-store-type: JKS key-password: 123456 key-alias: tomcat  å½“ç„¶ï¼Œè¿˜å¯ä»¥æŒ‡å®šjvmçš„å†…å­˜å¤§å°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  java -Xms4g -Xmx4g -Xmn1g -server -jar renren-fast.jar  åœ¨windowsä¸‹éƒ¨ç½²ï¼Œåªéœ€æ‰“å¼€cmdçª—å£ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š  java -jar renren-fast.jar --spring.profiles.active=prod  åœ¨Linuxä¸‹éƒ¨ç½²ï¼Œåªéœ€è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯åœ¨Linuxåå°è¿è¡Œï¼š  nohup java -jar renren-fast.jar --spring.profiles.active=prod  renren.log \u0026  åœ¨Linuxç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥åˆ›å»ºshellè„šæœ¬ï¼Œç”¨äºé‡å¯é¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  #åˆ›å»ºå¯åŠ¨çš„shellè„šæœ¬ [root@renren renren-fast]# vim start.sh #!/bin/sh  process=`ps -fe|grep \"renren-fast.jar\" |grep -ivE \"grep|cron\" |awk '{print $2}'` if [ !$process ]; then \techo \"stop erp process $process.....\" \tkill -9 $process  sleep 1 fi  echo \"start erp process.....\" nohup java -Dspring.profiles.active=prod -jar renren-fast.jar --server.port=8080 --server.servlet.context-path=/renren-fast 2\u00261 | cronolog log.%Y-%m-%d.out  /dev/null \u0026  echo \"start erp success!\"  #é€šè¿‡shellè„šæœ¬å¯åŠ¨é¡¹ç›® [root@renren renren-fast]# yum install -y cronolog [root@renren renren-fast]# chomd +x start.sh [root@renren renren-fast]# ./start.sh 7.2 docker éƒ¨ç½² å®‰è£…dockerç¯å¢ƒ\n#å®‰è£…docker [root@mark ~]# curl -sSL https://get.docker.com/ | sh  #å¯åŠ¨docker [root@mark ~]# service docker start  #æŸ¥çœ‹dockerç‰ˆæœ¬ä¿¡æ¯ [root@mark ~]# docker version Client:  Version: 17.07.0-ce  API version: 1.31  Go version: go1.8.3  Git commit: 8784753  Built: Tue Aug 29 17:42:01 2017  OS/Arch: linux/amd64 Server:  Version: 17.07.0-ce  API version: 1.31 (minimum version 1.12)  Go version: go1.8.3  Git commit: 8784753  Built: Tue Aug 29 17:43:23 2017  OS/Arch: linux/amd64  Experimental: false  è¿˜éœ€è¦å‡†å¤‡javaã€mavenç¯å¢ƒï¼Œè¯·è‡ªè¡Œå®‰è£… é€šè¿‡mavenæ’ä»¶ï¼Œæ„å»ºdockeré•œåƒ  æ‰“åŒ…å¹¶æ„å»ºé¡¹ç›®é•œåƒ [root@mark renren-fast]# mvn clean package docker:build #çœç•¥æ‰“åŒ…log... [INFO] Building image renren/fast Step 1/6 : FROM java:8 \t--- d23bdf5b1b1b Step 2/6 : EXPOSE 8080  --- Using cache  --- 8e33aadb2c18 Step 3/6 : VOLUME /tmp  --- Using cache  --- c5dc0c509062 Step 4/6 : ADD renren-fast-1.2.0.jar /app.jar  --- 831bc3ca84bc Step 5/6 : RUN bash -c 'touch /app.jar'  --- Running in fe3ef9343e4c  --- b3d6dd6fc297 Removing intermediate container fe3ef9343e4c Step 6/6 : ENTRYPOINT java -jar /app.jar  --- Running in 89adce4ae167  --- a4ae60970a77 Removing intermediate container 89adce4ae167 ProgressMessage{id=null, status=null, stream=null, error=null, progress=null, progressDetail= null} Successfully built a4ae60970a77 Successfully tagged renren/fast:latest   # æŸ¥çœ‹é•œåƒ [root@mark renren-fast]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE renren/fast latest a4ae60970a77 14 seconds ago 714MB java 8 d23bdf5b1b1b 7 months ago 643MB  å®‰è£…docker-composeï¼Œç”¨æ¥ç®¡ç†å®¹å™¨  #ä¸‹è½½åœ°å€ï¼šhttps://github.com/docker/compose/releases #ä¸‹è½½docker-compose [root@mark renren-fast]# curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m`  /usr/local/bin/docker-compose #å¢åŠ å¯æ‰§è¡Œæƒé™ [root@mark renren-fast]# chmod +x /usr/local/bin/docker-compose #æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯ [root@mark renren-fast]# docker-compose version docker-compose version 1.16.1, build 6d1ac21 docker-py version: 2.5.1 CPython version: 2.7.13 OpenSSL version: OpenSSL 1.0.1t 3 May 2016 å¦‚æœä¸‹è½½ä¸äº†ï¼Œå¯ä»¥ç”¨è¿…é›·å°†https://github.com/docker/compose/releases/download/1.16.1/docker-compose- Linux-x86_64ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå†ä¸Šä¼ åˆ°æœåŠ¡å™¨\n é€šè¿‡docker-composeï¼Œå¯åŠ¨é¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  #å¯åŠ¨é¡¹ç›® [root@mark renren-fast]# docker-compose up -d Creating network \"renrenfast_default\" with the default driver Creating renrenfast_campus_1 ... Creating renrenfast_campus_1 ... done  #æŸ¥çœ‹å¯åŠ¨çš„å®¹å™¨ [root@mark renren-fast]# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES f4e3fcdd8dd4 renren/fast \"java -jar /app.jar\" 55 seconds ago Up 3 seconds 0.0.0.0:8080-8080/tcp renrenfast_renren-fast_1    #åœæ‰å¹¶åˆ é™¤ï¼Œdocker-composeç®¡ç†çš„å®¹å™¨ [root@mark renren-fast]# docker-compose down Stopping renrenfast_renren-fast_1 ... done Removing renrenfast_renren-fast_1 ... done Removing network renrenfast_default 7.3 é›†ç¾¤éƒ¨ç½²  æœ¬ç³»ç»Ÿæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé›†ç¾¤éƒ¨ç½²ï¼Œåªéœ€å¯åŠ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå¹¶é…ç½®Nginxå³å¯ã€‚\n  é…ç½®Nginx  http { upstream renren { server localhost:8080; server localhost:8081; } server { listen 80; server_name localhost; location /renren-fast { proxy_pass http://renren; client_max_body_size 1024m; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $host; proxy_redirect off; } } }  é€šè¿‡http://localhost/renren-fastï¼Œå°±å¯ä»¥è®¿é—®äº†  ","wordCount":"23128","inLanguage":"zh","datePublished":"2022-03-16T10:05:00Z","dateModified":"2022-03-16T10:05:00Z","author":{"@type":"Person","name":"swimminghao"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/"},"publisher":{"@type":"Organization","name":"swimminghao","logo":{"@type":"ImageObject","url":"https://swimminghao1.github.io/favicon.ico"}}}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://swimminghao1.github.io/ accesskey=h title="ğŸ€ swimminghao (Alt + H)">ğŸ€ swimminghao</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://swimminghao1.github.io/categories/ title="ğŸ—‚ å½’ç±»"><span>ğŸ—‚ å½’ç±»</span></a></li><li><a href=https://swimminghao1.github.io/tags/ title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li><li><a href=https://swimminghao1.github.io/archives/ title="â±ï¸ æ—¶é—´è½´"><span>â±ï¸ æ—¶é—´è½´</span></a></li><li><a href=https://swimminghao1.github.io/search/ title="ğŸ” ç´¢å¼• (Alt + /)" accesskey=/><span>ğŸ” ç´¢å¼•</span></a></li><li><a href=https://swimminghao1.github.io/friends title="ğŸ§‘â€ğŸ¤â€ğŸ§‘ å‹é“¾"><span>ğŸ§‘â€ğŸ¤â€ğŸ§‘ å‹é“¾</span></a></li><li><a href=https://www.travellings.cn/go.html title=ğŸš‡><span>ğŸš‡</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://swimminghao1.github.io/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://swimminghao1.github.io/post/>ğŸ“šæ–‡ç« </a></div><h1 class=post-title><a href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/>renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ</a></h1><div class=post-meta>March 16, 2022&nbsp;Â·&nbsp;47 åˆ†é’Ÿ&nbsp;Â·&nbsp;23128 å­—&nbsp;Â·&nbsp;swimminghao&nbsp;|&nbsp;<a href=https://github.com/songtianlun/songtianlun.github.io/edit/main/content/post/02%e4%b8%aa%e4%ba%ba%e5%ad%a6%e4%b9%a0/06_04_spring/%e8%84%9a%e6%89%8b%e6%9e%b6/renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88.md rel="noopener noreferrer" target=_blank>PR</a>
<span>| <span class=waline-pageview-count data-path=/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/><i class="fa fa-spinner fa-spin"></i></span> Hits</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a330%e6%9c%80%e6%96%b0%e7%89%88 aria-label=renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ>renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ</a></li><li><a href=#%e7%89%88%e6%9d%83%e8%af%b4%e6%98%8e aria-label=ç‰ˆæƒè¯´æ˜>ç‰ˆæƒè¯´æ˜</a></li><li><a href=#%e5%85%8d%e8%b4%a3%e5%a3%b0%e6%98%8e aria-label=å…è´£å£°æ˜>å…è´£å£°æ˜</a></li><li><a href=#%e6%96%87%e6%a1%a3%e6%9b%b4%e6%96%b0 aria-label=æ–‡æ¡£æ›´æ–°>æ–‡æ¡£æ›´æ–°</a></li><li><a href=#%e7%ac%ac-1-%e7%ab%a0-%e9%a1%b9%e7%9b%ae%e4%bb%8b%e7%bb%8d aria-label="ç¬¬ 1 ç«  é¡¹ç›®ä»‹ç»">ç¬¬ 1 ç«  é¡¹ç›®ä»‹ç»</a><ul><li><a href=#11-%e9%a1%b9%e7%9b%ae%e6%8f%8f%e8%bf%b0 aria-label="1.1 é¡¹ç›®æè¿°">1.1 é¡¹ç›®æè¿°</a></li><li><a href=#12-%e9%a1%b9%e7%9b%ae%e7%89%b9%e7%82%b9 aria-label="1.2 é¡¹ç›®ç‰¹ç‚¹">1.2 é¡¹ç›®ç‰¹ç‚¹</a></li><li><a href=#13-%e6%95%b0%e6%8d%ae%e4%ba%a4%e4%ba%92 aria-label="1.3 æ•°æ®äº¤äº’">1.3 æ•°æ®äº¤äº’</a></li><li><a href=#14-%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba aria-label="1.4 å¼€å‘ç¯å¢ƒæ­å»º">1.4 å¼€å‘ç¯å¢ƒæ­å»º</a></li><li><a href=#15-%e8%8e%b7%e5%8f%96%e5%b8%ae%e5%8a%a9 aria-label="1.5 è·å–å¸®åŠ©">1.5 è·å–å¸®åŠ©</a></li><li><a href=#11-%e9%a1%b9%e7%9b%ae%e6%8f%8f%e8%bf%b0-1 aria-label="1.1 é¡¹ç›®æè¿°">1.1 é¡¹ç›®æè¿°</a></li><li><a href=#12-%e9%a1%b9%e7%9b%ae%e7%89%b9%e7%82%b9-1 aria-label="1.2 é¡¹ç›®ç‰¹ç‚¹">1.2 é¡¹ç›®ç‰¹ç‚¹</a></li><li><a href=#13-%e6%95%b0%e6%8d%ae%e4%ba%a4%e4%ba%92-1 aria-label="1.3 æ•°æ®äº¤äº’">1.3 æ•°æ®äº¤äº’</a></li><li><a href=#14-%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba-1 aria-label="1.4 å¼€å‘ç¯å¢ƒæ­å»º">1.4 å¼€å‘ç¯å¢ƒæ­å»º</a><ul><li><a href=#141-%e8%bd%af%e4%bb%b6%e9%9c%80%e6%b1%82 aria-label="1.4.1 è½¯ä»¶éœ€æ±‚">1.4.1 è½¯ä»¶éœ€æ±‚</a></li><li><a href=#142-%e4%b8%8b%e8%bd%bd%e6%ba%90%e7%a0%81 aria-label="1.4.2 ä¸‹è½½æºç ">1.4.2 ä¸‹è½½æºç </a></li><li><a href=#143-idea-%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7 aria-label="1.4.3 IDEA å¼€å‘å·¥å…·">1.4.3 IDEA å¼€å‘å·¥å…·</a></li><li><a href=#144-eclipse-%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7 aria-label="1.4.4 Eclipse å¼€å‘å·¥å…·">1.4.4 Eclipse å¼€å‘å·¥å…·</a></li><li><a href=#145-%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93 aria-label="1.4.5 åˆ›å»ºæ•°æ®åº“">1.4.5 åˆ›å»ºæ•°æ®åº“</a></li><li><a href=#146-%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="1.4.6 ä¿®æ”¹é…ç½®æ–‡ä»¶">1.4.6 ä¿®æ”¹é…ç½®æ–‡ä»¶</a></li><li><a href=#147-%e5%89%8d%e7%ab%af%e9%83%a8%e7%bd%b2 aria-label="1.4.7 å‰ç«¯éƒ¨ç½²">1.4.7 å‰ç«¯éƒ¨ç½²</a></li></ul></li><li><a href=#15-%e8%8e%b7%e5%8f%96%e5%b8%ae%e5%8a%a9-1 aria-label="1.5 è·å–å¸®åŠ©">1.5 è·å–å¸®åŠ©</a></li></ul></li><li><a href=#%e7%ac%ac-2-%e7%ab%a0-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="ç¬¬ 2 ç«  æ•°æ®åº“æ”¯æŒ">ç¬¬ 2 ç«  æ•°æ®åº“æ”¯æŒ</a><ul><li><a href=#21-mysql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.1 MySQL æ•°æ®åº“æ”¯æŒ">2.1 MySQL æ•°æ®åº“æ”¯æŒ</a></li><li><a href=#22-oracle-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.2 Oracle æ•°æ®åº“æ”¯æŒ">2.2 Oracle æ•°æ®åº“æ”¯æŒ</a></li><li><a href=#23-sql-server-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.3 SQL Server æ•°æ®åº“æ”¯æŒ">2.3 SQL Server æ•°æ®åº“æ”¯æŒ</a></li><li><a href=#24-postgresql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81 aria-label="2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ">2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ</a></li><li><a href=#21-mysql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.1 MySQL æ•°æ®åº“æ”¯æŒ">2.1 MySQL æ•°æ®åº“æ”¯æŒ</a></li><li><a href=#22-oracle-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.2 Oracle æ•°æ®åº“æ”¯æŒ">2.2 Oracle æ•°æ®åº“æ”¯æŒ</a></li><li><a href=#23-sql-server-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.3 SQL Server æ•°æ®åº“æ”¯æŒ">2.3 SQL Server æ•°æ®åº“æ”¯æŒ</a></li><li><a href=#24-postgresql-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%94%af%e6%8c%81-1 aria-label="2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ">2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ</a></li></ul></li><li><a href=#%e7%ac%ac-3-%e7%ab%a0-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e6%94%af%e6%8c%81 aria-label="ç¬¬ 3 ç«  å¤šæ•°æ®æºæ”¯æŒ">ç¬¬ 3 ç«  å¤šæ•°æ®æºæ”¯æŒ</a><ul><li><a href=#31-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e9%85%8d%e7%bd%ae aria-label="3.1 å¤šæ•°æ®æºé…ç½®">3.1 å¤šæ•°æ®æºé…ç½®</a></li><li><a href=#32-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e4%bd%bf%e7%94%a8 aria-label="3.2 å¤šæ•°æ®æºä½¿ç”¨">3.2 å¤šæ•°æ®æºä½¿ç”¨</a></li><li><a href=#33-%e6%ba%90%e7%a0%81%e8%ae%b2%e8%a7%a3 aria-label="3.3 æºç è®²è§£">3.3 æºç è®²è§£</a></li><li><a href=#31-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e9%85%8d%e7%bd%ae-1 aria-label="3.1 å¤šæ•°æ®æºé…ç½®">3.1 å¤šæ•°æ®æºé…ç½®</a></li><li><a href=#%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e9%85%8d%e7%bd%ae aria-label=å¤šæ•°æ®æºçš„é…ç½®>å¤šæ•°æ®æºçš„é…ç½®</a></li><li><a href=#32-%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90%e4%bd%bf%e7%94%a8-1 aria-label="3.2 å¤šæ•°æ®æºä½¿ç”¨">3.2 å¤šæ•°æ®æºä½¿ç”¨</a></li><li><a href=#33-%e6%ba%90%e7%a0%81%e8%ae%b2%e8%a7%a3-1 aria-label="3.3 æºç è®²è§£">3.3 æºç è®²è§£</a></li></ul></li><li><a href=#%e7%ac%ac-4-%e7%ab%a0-%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86%e8%ae%b2%e8%a7%a3 aria-label="ç¬¬ 4 ç«  åŸºç¡€çŸ¥è¯†è®²è§£">ç¬¬ 4 ç«  åŸºç¡€çŸ¥è¯†è®²è§£</a><ul><li><a href=#41-spring-mvc-%e4%bd%bf%e7%94%a8 aria-label="4.1 Spring MVC ä½¿ç”¨">4.1 Spring MVC ä½¿ç”¨</a></li><li><a href=#42-swagger-%e4%bd%bf%e7%94%a8 aria-label="4.2 Swagger ä½¿ç”¨">4.2 Swagger ä½¿ç”¨</a></li><li><a href=#43-mybatis-plus-%e4%bd%bf%e7%94%a8 aria-label="4.3 Mybatis-plus ä½¿ç”¨">4.3 Mybatis-plus ä½¿ç”¨</a></li><li><a href=#41-spring-mvc-%e4%bd%bf%e7%94%a8-1 aria-label="4.1 Spring MVC ä½¿ç”¨">4.1 Spring MVC ä½¿ç”¨</a><ul><li><a href=#411-controller-%e6%b3%a8%e8%a7%a3 aria-label="4.1.1 @Controller æ³¨è§£">4.1.1 @Controller æ³¨è§£</a></li><li><a href=#412-requestmapping-%e6%b3%a8%e8%a7%a3 aria-label="4.1.2 @RequestMapping æ³¨è§£">4.1.2 @RequestMapping æ³¨è§£</a></li><li><a href=#413-pathvariable-%e6%b3%a8%e8%a7%a3 aria-label="4.1.3 @PathVariable æ³¨è§£">4.1.3 @PathVariable æ³¨è§£</a></li><li><a href=#414-getmapping-%e6%b3%a8%e8%a7%a3 aria-label="4.1.4 @GetMapping æ³¨è§£">4.1.4 @GetMapping æ³¨è§£</a></li><li><a href=#415-requestbody-%e6%b3%a8%e8%a7%a3 aria-label="4.1.5 @RequestBody æ³¨è§£">4.1.5 @RequestBody æ³¨è§£</a></li><li><a href=#416-responsebody-%e6%b3%a8%e8%a7%a3 aria-label="4.1.6 @ResponseBody æ³¨è§£">4.1.6 @ResponseBody æ³¨è§£</a></li><li><a href=#417-restcontroller-%e6%b3%a8%e8%a7%a3 aria-label="4.1.7 @RestController æ³¨è§£">4.1.7 @RestController æ³¨è§£</a></li></ul></li><li><a href=#42-swagger-%e4%bd%bf%e7%94%a8-1 aria-label="4.2 Swagger ä½¿ç”¨">4.2 Swagger ä½¿ç”¨</a><ul><li><a href=#421-%e6%90%ad%e5%bb%ba-swagger-%e7%8e%af%e5%a2%83 aria-label="4.2.1 æ­å»º Swagger ç¯å¢ƒ">4.2.1 æ­å»º Swagger ç¯å¢ƒ</a></li><li><a href=#422-swagger-%e5%b8%b8%e7%94%a8%e6%b3%a8%e8%a7%a3 aria-label="4.2.2 Swagger å¸¸ç”¨æ³¨è§£">4.2.2 Swagger å¸¸ç”¨æ³¨è§£</a></li></ul></li><li><a href=#43-mybatis-plus-%e4%bd%bf%e7%94%a8-1 aria-label="4.3 Mybatis-plus ä½¿ç”¨">4.3 Mybatis-plus ä½¿ç”¨</a></li></ul></li><li><a href=#%e7%ac%ac-5-%e7%ab%a0-%e9%a1%b9%e7%9b%ae%e5%ae%9e%e6%88%98 aria-label="ç¬¬ 5 ç«  é¡¹ç›®å®æˆ˜">ç¬¬ 5 ç«  é¡¹ç›®å®æˆ˜</a><ul><li><a href=#51-%e9%9c%80%e6%b1%82%e8%af%b4%e6%98%8e aria-label="5.1 éœ€æ±‚è¯´æ˜">5.1 éœ€æ±‚è¯´æ˜</a></li><li><a href=#52-%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e5%99%a8 aria-label="5.2 ä»£ç ç”Ÿæˆå™¨">5.2 ä»£ç ç”Ÿæˆå™¨</a></li><li><a href=#51-%e9%9c%80%e6%b1%82%e8%af%b4%e6%98%8e-1 aria-label="5.1 éœ€æ±‚è¯´æ˜">5.1 éœ€æ±‚è¯´æ˜</a></li><li><a href=#51-%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e5%99%a8 aria-label="5.1 ä»£ç ç”Ÿæˆå™¨">5.1 ä»£ç ç”Ÿæˆå™¨</a></li></ul></li><li><a href=#%e7%ac%ac-6-%e7%ab%a0-%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="ç¬¬ 6 ç«  åç«¯æºç åˆ†æ">ç¬¬ 6 ç«  åç«¯æºç åˆ†æ</a><ul><li><a href=#61-%e5%89%8d%e5%90%8e%e7%ab%af%e5%88%86%e7%a6%bb aria-label="6.1 å‰åç«¯åˆ†ç¦»">6.1 å‰åç«¯åˆ†ç¦»</a></li><li><a href=#62-%e6%9d%83%e9%99%90%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af aria-label="6.2 æƒé™è®¾è®¡æ€è·¯">6.2 æƒé™è®¾è®¡æ€è·¯</a></li><li><a href=#63-xss-%e8%84%9a%e6%9c%ac%e8%bf%87%e6%bb%a4 aria-label="6.3 XSS è„šæœ¬è¿‡æ»¤">6.3 XSS è„šæœ¬è¿‡æ»¤</a></li><li><a href=#64-sql-%e6%b3%a8%e5%85%a5 aria-label="6.4 SQL æ³¨å…¥">6.4 SQL æ³¨å…¥</a></li><li><a href=#65-redis-%e7%bc%93%e5%ad%98 aria-label="6.5 Redis ç¼“å­˜">6.5 Redis ç¼“å­˜</a></li><li><a href=#66-%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86%e6%9c%ba%e5%88%b6 aria-label="6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶">6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶</a></li><li><a href=#67-%e5%90%8e%e7%ab%af%e6%95%88%e9%aa%8c%e6%9c%ba%e5%88%b6 aria-label="6.7 åç«¯æ•ˆéªŒæœºåˆ¶">6.7 åç«¯æ•ˆéªŒæœºåˆ¶</a></li><li><a href=#68-%e7%b3%bb%e7%bb%9f%e6%97%a5%e5%bf%97 aria-label="6.8 ç³»ç»Ÿæ—¥å¿—">6.8 ç³»ç»Ÿæ—¥å¿—</a></li><li><a href=#69-%e6%b7%bb%e5%8a%a0%e8%8f%9c%e5%8d%95 aria-label="6.9 æ·»åŠ èœå•">6.9 æ·»åŠ èœå•</a></li><li><a href=#610-%e6%b7%bb%e5%8a%a0%e8%a7%92%e8%89%b2 aria-label="6.10 æ·»åŠ è§’è‰²">6.10 æ·»åŠ è§’è‰²</a></li><li><a href=#611-%e6%b7%bb%e5%8a%a0%e7%ae%a1%e7%90%86%e5%91%98 aria-label="6.11 æ·»åŠ ç®¡ç†å‘˜">6.11 æ·»åŠ ç®¡ç†å‘˜</a></li><li><a href=#612-%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e6%a8%a1%e5%9d%97 aria-label="6.12 å®šæ—¶ä»»åŠ¡æ¨¡å—">6.12 å®šæ—¶ä»»åŠ¡æ¨¡å—</a></li><li><a href=#613-%e4%ba%91%e5%ad%98%e5%82%a8%e6%a8%a1%e5%9d%97 aria-label="6.13 äº‘å­˜å‚¨æ¨¡å—">6.13 äº‘å­˜å‚¨æ¨¡å—</a></li><li><a href=#614-app-%e6%a8%a1%e5%9d%97 aria-label="6.14 APP æ¨¡å—">6.14 APP æ¨¡å—</a></li><li><a href=#61-%e5%89%8d%e5%90%8e%e7%ab%af%e5%88%86%e7%a6%bb-1 aria-label="6.1 å‰åç«¯åˆ†ç¦»">6.1 å‰åç«¯åˆ†ç¦»</a></li><li><a href=#62-%e6%9d%83%e9%99%90%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af-1 aria-label="6.2 æƒé™è®¾è®¡æ€è·¯">6.2 æƒé™è®¾è®¡æ€è·¯</a></li><li><a href=#63-xss-%e8%84%9a%e6%9c%ac%e8%bf%87%e6%bb%a4-1 aria-label="6.3 XSS è„šæœ¬è¿‡æ»¤">6.3 XSS è„šæœ¬è¿‡æ»¤</a></li><li><a href=#64-sql-%e6%b3%a8%e5%85%a5-1 aria-label="6.4 SQL æ³¨å…¥">6.4 SQL æ³¨å…¥</a></li><li><a href=#65-redis-%e7%bc%93%e5%ad%98-1 aria-label="6.5 Redis ç¼“å­˜">6.5 Redis ç¼“å­˜</a></li><li><a href=#66-%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86%e6%9c%ba%e5%88%b6-1 aria-label="6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶">6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶</a></li><li><a href=#67-%e5%90%8e%e7%ab%af%e6%95%88%e9%aa%8c%e6%9c%ba%e5%88%b6-1 aria-label="6.7 åç«¯æ•ˆéªŒæœºåˆ¶">6.7 åç«¯æ•ˆéªŒæœºåˆ¶</a></li><li><a href=#68-%e7%b3%bb%e7%bb%9f%e6%97%a5%e5%bf%97-1 aria-label="6.8 ç³»ç»Ÿæ—¥å¿—">6.8 ç³»ç»Ÿæ—¥å¿—</a></li><li><a href=#69-%e6%b7%bb%e5%8a%a0%e8%8f%9c%e5%8d%95-1 aria-label="6.9 æ·»åŠ èœå•">6.9 æ·»åŠ èœå•</a></li><li><a href=#610-%e6%b7%bb%e5%8a%a0%e8%a7%92%e8%89%b2-1 aria-label="6.10 æ·»åŠ è§’è‰²">6.10 æ·»åŠ è§’è‰²</a></li><li><a href=#611-%e6%b7%bb%e5%8a%a0%e7%ae%a1%e7%90%86%e5%91%98-1 aria-label="6.11 æ·»åŠ ç®¡ç†å‘˜">6.11 æ·»åŠ ç®¡ç†å‘˜</a></li><li><a href=#612-%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e6%a8%a1%e5%9d%97-1 aria-label="6.12 å®šæ—¶ä»»åŠ¡æ¨¡å—">6.12 å®šæ—¶ä»»åŠ¡æ¨¡å—</a><ul><li><a href=#6121-%e6%96%b0%e5%a2%9e%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1 aria-label="6.12.1 æ–°å¢å®šæ—¶ä»»åŠ¡">6.12.1 æ–°å¢å®šæ—¶ä»»åŠ¡</a><ul><li><a href=#6122-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="6.12.2 æºç åˆ†æ">6.12.2 æºç åˆ†æ</a></li></ul></li></ul></li><li><a href=#613-%e4%ba%91%e5%ad%98%e5%82%a8%e6%a8%a1%e5%9d%97-1 aria-label="6.13 äº‘å­˜å‚¨æ¨¡å—">6.13 äº‘å­˜å‚¨æ¨¡å—</a><ul><li><a href=#6131-%e4%b8%83%e7%89%9b%e7%9a%84%e9%85%8d%e7%bd%ae aria-label="6.13.1 ä¸ƒç‰›çš„é…ç½®">6.13.1 ä¸ƒç‰›çš„é…ç½®</a></li><li><a href=#6132-%e9%98%bf%e9%87%8c%e4%ba%91%e7%9a%84%e9%85%8d%e7%bd%ae aria-label="6.13.2 é˜¿é‡Œäº‘çš„é…ç½®">6.13.2 é˜¿é‡Œäº‘çš„é…ç½®</a><ul><li><a href=#6133-%e8%85%be%e8%ae%af%e4%ba%91%e7%9a%84%e9%85%8d%e7%bd%ae aria-label="6.13.3 è…¾è®¯äº‘çš„é…ç½®">6.13.3 è…¾è®¯äº‘çš„é…ç½®</a></li><li><a href=#6134-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="6.13.4 æºç åˆ†æ">6.13.4 æºç åˆ†æ</a></li></ul></li></ul></li><li><a href=#614-app-%e6%a8%a1%e5%9d%97-1 aria-label="6.14 APP æ¨¡å—">6.14 APP æ¨¡å—</a><ul><li><a href=#6141-app-%e7%9a%84%e4%bd%bf%e7%94%a8 aria-label="6.14.1 APP çš„ä½¿ç”¨">6.14.1 APP çš„ä½¿ç”¨</a></li><li><a href=#6142-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="6.14.2 æºç åˆ†æ">6.14.2 æºç åˆ†æ</a></li></ul></li></ul></li><li><a href=#%e7%ac%ac-7-%e7%ab%a0-%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83%e9%83%a8%e7%bd%b2 aria-label="ç¬¬ 7 ç«  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²">ç¬¬ 7 ç«  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²</a><ul><li><a href=#71-jar-%e5%8c%85%e9%83%a8%e7%bd%b2 aria-label="7.1 jar åŒ…éƒ¨ç½²">7.1 jar åŒ…éƒ¨ç½²</a></li><li><a href=#72-docker-%e9%83%a8%e7%bd%b2 aria-label="7.2 docker éƒ¨ç½²">7.2 docker éƒ¨ç½²</a></li><li><a href=#73-%e9%9b%86%e7%be%a4%e9%83%a8%e7%bd%b2 aria-label="7.3 é›†ç¾¤éƒ¨ç½²">7.3 é›†ç¾¤éƒ¨ç½²</a><ul><li><a href=#71-jar-%e5%8c%85%e9%83%a8%e7%bd%b2-1 aria-label="7.1 jar åŒ…éƒ¨ç½²">7.1 jar åŒ…éƒ¨ç½²</a></li></ul></li><li><a href=#72-docker-%e9%83%a8%e7%bd%b2-1 aria-label="7.2 docker éƒ¨ç½²">7.2 docker éƒ¨ç½²</a></li><li><a href=#%e6%89%93%e5%8c%85%e5%b9%b6%e6%9e%84%e5%bb%ba%e9%a1%b9%e7%9b%ae%e9%95%9c%e5%83%8f aria-label=æ‰“åŒ…å¹¶æ„å»ºé¡¹ç›®é•œåƒ>æ‰“åŒ…å¹¶æ„å»ºé¡¹ç›®é•œåƒ</a></li><li><a href=#73-%e9%9b%86%e7%be%a4%e9%83%a8%e7%bd%b2-1 aria-label="7.3 é›†ç¾¤éƒ¨ç½²">7.3 é›†ç¾¤éƒ¨ç½²</a></li></ul></li></ul></div><div><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7296634171837358 data-ad-slot=9161921641 data-ad-format=auto data-full-width-responsive=true></ins></div><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></details></div><div class=post-content><blockquote style=margin-top:8px><p style=text-align:center;text-indent:0><a href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/>æœ¬æ–‡</a>
é¦–å‘äº
<a href=https://swimminghao1.github.io/>ğŸ€ æ°¸æµ©</a>ï¼Œ
<a href=/disclaimer/>è½¬è½½</a> è¯·æ³¨æ˜
<a href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/%E8%84%9A%E6%89%8B%E6%9E%B6/renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33.0%E6%9C%80%E6%96%B0%E7%89%88/>æ¥æº</a>ã€‚</p></blockquote><h1 id=renren-fastå¼€å‘æ–‡æ¡£30æœ€æ–°ç‰ˆ>renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ<a hidden class=anchor aria-hidden=true href=#renren-fastå¼€å‘æ–‡æ¡£30æœ€æ–°ç‰ˆ>#</a></h1><h1 id=ç‰ˆæƒè¯´æ˜>ç‰ˆæƒè¯´æ˜<a hidden class=anchor aria-hidden=true href=#ç‰ˆæƒè¯´æ˜>#</a></h1><blockquote><p>æœ¬æ–‡æ¡£ä¸ºä»˜è´¹æ–‡æ¡£ï¼Œç‰ˆæƒå½’äººäººå¼€æºï¼ˆrenren.ioï¼‰æ‰€æœ‰ï¼Œå¹¶ä¿ç•™ä¸€åˆ‡æƒåˆ©ï¼Œæœ¬æ–‡æ¡£åŠå…¶æè¿°çš„å†…å®¹å—æœ‰å…³æ³•å¾‹çš„ç‰ˆæƒä¿æŠ¤ï¼Œå¯¹æœ¬æ–‡æ¡£ä»¥ä»»ä½•å½¢å¼çš„éæ³•å¤åˆ¶ã€æ³„éœ²æˆ–æ•£å¸ƒåˆ°ç½‘ç»œæä¾›ä¸‹è½½ï¼Œéƒ½å°†å¯¼è‡´ç›¸åº”çš„æ³•å¾‹è´£ä»»ã€‚</p></blockquote><h1 id=å…è´£å£°æ˜>å…è´£å£°æ˜<a hidden class=anchor aria-hidden=true href=#å…è´£å£°æ˜>#</a></h1><blockquote><p>æœ¬æ–‡æ¡£ä»…æä¾›é˜¶æ®µæ€§ä¿¡æ¯ï¼Œæ‰€å«å†…å®¹å¯æ ¹æ®é¡¹ç›®çš„å®é™…æƒ…å†µéšæ—¶æ›´æ–°ï¼Œä»¥äººäººå¼€æºç¤¾åŒºå…¬å‘Šä¸ºå‡†ã€‚å¦‚å› æ–‡æ¡£ä½¿ç”¨ä¸å½“é€ æˆçš„ç›´æ¥æˆ–é—´æ¥æŸå¤±ï¼Œäººäººå¼€æºä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚</p></blockquote><h1 id=æ–‡æ¡£æ›´æ–°>æ–‡æ¡£æ›´æ–°<a hidden class=anchor aria-hidden=true href=#æ–‡æ¡£æ›´æ–°>#</a></h1><blockquote><p>æœ¬æ–‡æ¡£ç”±äººäººå¼€æºäº 2019 å¹´ 03 æœˆ 01 æ—¥æœ€åä¿®è®¢ã€‚</p></blockquote><h1 id=ç¬¬-1-ç« -é¡¹ç›®ä»‹ç»>ç¬¬ 1 ç«  é¡¹ç›®ä»‹ç»<a hidden class=anchor aria-hidden=true href=#ç¬¬-1-ç« -é¡¹ç›®ä»‹ç»>#</a></h1><blockquote><p>äººäººæƒé™ç³»ç»Ÿæ˜¯ä¸€å¥—è½»é‡çº§çš„æƒé™ç³»ç»Ÿï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€éƒ¨é—¨ç®¡ç†ã€èœå•ç®¡ç†ã€å®šæ—¶ä»»åŠ¡ã€ å‚æ•°ç®¡ç†ã€å­—å…¸ç®¡ç†ã€æ–‡ä»¶ä¸Šä¼ ã€ç™»å½•æ—¥å¿—ã€æ“ä½œæ—¥å¿—ã€å¼‚å¸¸æ—¥å¿—ã€æ–‡ç« ç®¡ç†ã€APPæ¨¡å—ç­‰åŠŸèƒ½ã€‚å…¶ä¸­ï¼Œè¿˜æ‹¥æœ‰å¤šæ•°æ®æºã€æ•°æ®æƒé™ã€å›½é™…åŒ–æ”¯æŒã€Redisç¼“å­˜åŠ¨æ€å¼€å¯ä¸å…³é—­ã€ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç­‰æŠ€æœ¯ç‰¹ç‚¹ã€‚</p></blockquote><h2 id=11-é¡¹ç›®æè¿°>1.1 é¡¹ç›®æè¿°<a hidden class=anchor aria-hidden=true href=#11-é¡¹ç›®æè¿°>#</a></h2><h2 id=12-é¡¹ç›®ç‰¹ç‚¹>1.2 é¡¹ç›®ç‰¹ç‚¹<a hidden class=anchor aria-hidden=true href=#12-é¡¹ç›®ç‰¹ç‚¹>#</a></h2><h2 id=13-æ•°æ®äº¤äº’>1.3 æ•°æ®äº¤äº’<a hidden class=anchor aria-hidden=true href=#13-æ•°æ®äº¤äº’>#</a></h2><h2 id=14-å¼€å‘ç¯å¢ƒæ­å»º>1.4 å¼€å‘ç¯å¢ƒæ­å»º<a hidden class=anchor aria-hidden=true href=#14-å¼€å‘ç¯å¢ƒæ­å»º>#</a></h2><h2 id=15-è·å–å¸®åŠ©>1.5 è·å–å¸®åŠ©<a hidden class=anchor aria-hidden=true href=#15-è·å–å¸®åŠ©>#</a></h2><h2 id=11-é¡¹ç›®æè¿°-1>1.1 é¡¹ç›®æè¿°<a hidden class=anchor aria-hidden=true href=#11-é¡¹ç›®æè¿°-1>#</a></h2><p>renren-fastæ˜¯ä¸€å¥—è½»é‡çº§çš„æƒé™ç³»ç»Ÿï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€èœå•ç®¡ç†ã€å®šæ—¶ä»»åŠ¡ã€æ–‡ä»¶ä¸Šä¼ ã€ç³» ç»Ÿæ—¥å¿—ã€APPæ¨¡å—ç­‰åŠŸèƒ½ã€‚å…¶ä¸­ï¼Œè¿˜æ‹¥æœ‰å¤šæ•°æ®æºã€Redisç¼“å­˜åŠ¨æ€å¼€å¯ä¸å…³é—­ã€ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç­‰æŠ€æœ¯ç‰¹ ç‚¹ã€‚</p><h2 id=12-é¡¹ç›®ç‰¹ç‚¹-1>1.2 é¡¹ç›®ç‰¹ç‚¹<a hidden class=anchor aria-hidden=true href=#12-é¡¹ç›®ç‰¹ç‚¹-1>#</a></h2><ul><li><a href=https://gitee.com/renrenio/renren-fast>renren-fast</a>é‡‡ç”¨SpringBoot 2.1ã€MyBatisã€Shiroæ¡†æ¶ï¼Œå¼€å‘çš„ä¸€å¥—æƒé™ç³»ç»Ÿï¼Œæä½é—¨æ§›ï¼Œæ‹¿æ¥å³ç”¨ã€‚è®¾
è®¡ä¹‹åˆï¼Œå°±éå¸¸æ³¨é‡å®‰å…¨æ€§ï¼Œä¸ºä¼ä¸šç³»ç»Ÿä¿é©¾æŠ¤èˆªï¼Œè®©ä¸€åˆ‡éƒ½å˜å¾—å¦‚æ­¤ç®€å•ã€‚</li><li>çµæ´»çš„æƒé™æ§åˆ¶ï¼Œå¯æ§åˆ¶åˆ°é¡µé¢æˆ–æŒ‰é’®ï¼Œæ»¡è¶³ç»å¤§éƒ¨åˆ†çš„æƒé™éœ€æ±‚</li><li>å®Œå–„çš„ XSS é˜²èŒƒåŠè„šæœ¬è¿‡æ»¤ï¼Œå½»åº•æœç» XSS æ”»å‡»</li><li>æ”¯æŒMySQLã€Oracleã€SQL Serverã€PostgreSQLç­‰ä¸»æµæ•°æ®åº“</li><li></li></ul><p>æ¨èä½¿ç”¨é˜¿é‡Œäº‘æœåŠ¡å™¨éƒ¨ç½²é¡¹ç›®ï¼Œå…è´¹é¢†å–é˜¿é‡Œäº‘ä¼˜æƒ åˆ¸ï¼Œè¯·ç‚¹å‡»<a href="https://www.aliyun.com/minisite/goods?userCode=y93lfwbg&productCode=dmspre&utm_source=y93lfwbg">ã€å…è´¹é¢†å–ã€‘</a></p><h2 id=13-æ•°æ®äº¤äº’-1>1.3 æ•°æ®äº¤äº’<a hidden class=anchor aria-hidden=true href=#13-æ•°æ®äº¤äº’-1>#</a></h2><ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œwebé¡¹ç›®éƒ½æ˜¯é€šè¿‡sessionè¿›è¡Œè®¤è¯ï¼Œæ¯æ¬¡è¯·æ±‚æ•°æ®æ—¶ï¼Œéƒ½ä¼šæŠŠjsessionidæ”¾åœ¨cookieä¸­ï¼Œä»¥ä¾¿ä¸æœåŠ¡ç«¯ä¿æŒä¼šè¯</li><li>æœ¬é¡¹ç›®æ˜¯å‰åç«¯åˆ†ç¦»çš„ï¼Œé€šè¿‡tokenè¿›è¡Œè®¤è¯ï¼ˆç™»å½•æ—¶ï¼Œç”Ÿæˆå”¯ä¸€çš„tokenå‡­è¯ï¼‰ï¼Œæ¯æ¬¡è¯·æ±‚æ•°æ®æ—¶ï¼Œéƒ½ä¼šæŠŠtokenæ”¾åœ¨headerä¸­ï¼ŒæœåŠ¡ç«¯è§£ætokenï¼Œå¹¶ç¡®å®šç”¨æˆ·èº«ä»½åŠç”¨æˆ·æƒé™ï¼Œæ•°æ®é€šè¿‡jsonäº¤äº’</li><li>æ•°æ®äº¤äº’æµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7nZ7nU.png alt></p><h2 id=14-å¼€å‘ç¯å¢ƒæ­å»º-1>1.4 å¼€å‘ç¯å¢ƒæ­å»º<a hidden class=anchor aria-hidden=true href=#14-å¼€å‘ç¯å¢ƒæ­å»º-1>#</a></h2><h3 id=141-è½¯ä»¶éœ€æ±‚>1.4.1 è½¯ä»¶éœ€æ±‚<a hidden class=anchor aria-hidden=true href=#141-è½¯ä»¶éœ€æ±‚>#</a></h3><ul><li>JDK 1.8+</li><li>Maven 3.0+</li><li>MySQL 5.5+</li><li>Oracle 11g+</li><li>SQL Server 2012+</li><li>PostgreSQL 9.4+</li></ul><h3 id=142-ä¸‹è½½æºç >1.4.2 ä¸‹è½½æºç <a hidden class=anchor aria-hidden=true href=#142-ä¸‹è½½æºç >#</a></h3><ul><li>é€šè¿‡ git ï¼Œä¸‹è½½renren-fastæºç ï¼Œå¦‚ä¸‹ï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://gitee.com/renrenio/renren-fast.git
</span></span></code></pre></div><h3 id=143-idea-å¼€å‘å·¥å…·>1.4.3 IDEA å¼€å‘å·¥å…·<a hidden class=anchor aria-hidden=true href=#143-idea-å¼€å‘å·¥å…·>#</a></h3><ul><li>IDEAæ‰“å¼€é¡¹ç›®ï¼Œ File -> Open å¦‚ä¸‹å›¾ï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/EVCSoB.png alt></p><h3 id=144-eclipse-å¼€å‘å·¥å…·>1.4.4 Eclipse å¼€å‘å·¥å…·<a hidden class=anchor aria-hidden=true href=#144-eclipse-å¼€å‘å·¥å…·>#</a></h3><ul><li>Eclipseå¯¼å…¥é¡¹ç›®ï¼Œå¦‚ä¸‹å›¾ï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/C4IoHO.png alt></p><h3 id=145-åˆ›å»ºæ•°æ®åº“>1.4.5 åˆ›å»ºæ•°æ®åº“<a hidden class=anchor aria-hidden=true href=#145-åˆ›å»ºæ•°æ®åº“>#</a></h3><ul><li>åˆ›å»ºæ•°æ®åº“ renren_fast ï¼Œæ•°æ®åº“ç¼–ç ä¸º<code>UTF-8</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DATABASE</span> renren_fast CHARACTER <span style=color:#66d9ef>SET</span> utf8 <span style=color:#66d9ef>COLLATE</span> utf8_general_ci;
</span></span></code></pre></div><ul><li>æ‰§è¡Œ db/mysql.sql æ–‡ä»¶ï¼Œåˆå§‹åŒ–æ•°æ®ï¼ˆé»˜è®¤æ”¯æŒMySQLï¼‰</li></ul><h3 id=146-ä¿®æ”¹é…ç½®æ–‡ä»¶>1.4.6 ä¿®æ”¹é…ç½®æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#146-ä¿®æ”¹é…ç½®æ–‡ä»¶>#</a></h3><ul><li>ä¿®æ”¹ <code>application-dev.yml</code> ï¼Œæ›´æ–°MySQLè´¦å·å’Œå¯†ç </li><li>è¿è¡Œ io.renren.RenrenApplication.java çš„ main æ–¹æ³•ï¼Œåˆ™å¯å¯åŠ¨é¡¹ç›®</li><li>Swaggerè·¯å¾„ï¼šhttp://localhost:8080/renren-fast/swagger/index.html</li><li>Swaggeræ³¨è§£è·¯å¾„ï¼šhttp://localhost:8080/renren-fast/swagger-ui.html</li></ul><h3 id=147-å‰ç«¯éƒ¨ç½²>1.4.7 å‰ç«¯éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#147-å‰ç«¯éƒ¨ç½²>#</a></h3><blockquote><p>renren-fast-vueåŸºäºvueã€element-uiæ„å»ºå¼€å‘ï¼Œå®ç°renren-faståå°ç®¡ç†å‰ç«¯åŠŸèƒ½ï¼Œæä¾›ä¸€å¥—æ›´ä¼˜çš„å‰ç«¯è§£å†³æ–¹æ¡ˆã€‚ æ¬¢è¿staræˆ–forkå‰ç«¯Gitåº“ï¼Œæ–¹ä¾¿æ—¥åå¯»æ‰¾ï¼ŒåŠäºŒæ¬¡å¼€å‘</p></blockquote><ul><li>å¼€å‘ç¯å¢ƒï¼Œéœ€è¦å®‰è£…node8.xæœ€æ–°ç‰ˆ</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å…‹éš†é¡¹ç›®</span>
</span></span><span style=display:flex><span>git clone https://gitee.com/renrenio/renren-fast-vue.git
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£…ä¾èµ–</span>
</span></span><span style=display:flex><span>npm install --registry<span style=color:#f92672>=</span>https://registry.npm.taobao.org
</span></span><span style=display:flex><span><span style=color:#75715e># å¯åŠ¨æœåŠ¡</span>
</span></span><span style=display:flex><span>npm run dev
</span></span></code></pre></div><ul><li>ç”Ÿäº§ç¯å¢ƒï¼Œæ‰“åŒ…å¹¶æŠŠdistç›®å½•æ–‡ä»¶ï¼Œéƒ¨ç½²åˆ°Nginxé‡Œ</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#æ„å»ºç”Ÿäº§ç¯å¢ƒ(é»˜è®¤)</span>
</span></span><span style=display:flex><span>npm run build
</span></span><span style=display:flex><span><span style=color:#75715e># æ„å»ºæµ‹è¯•ç¯å¢ƒ</span>
</span></span><span style=display:flex><span>npm run build --qa
</span></span><span style=display:flex><span><span style=color:#75715e># æ„å»ºéªŒæ”¶ç¯å¢ƒ</span>
</span></span><span style=display:flex><span>npm run build --uat
</span></span><span style=display:flex><span><span style=color:#75715e># æ„å»ºç”Ÿäº§ç¯å¢ƒ</span>
</span></span><span style=display:flex><span>npm run build --prod
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£…Nginxï¼Œå¹¶é…ç½®Nginx</span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		listen 80;
</span></span><span style=display:flex><span>		server_name localhost;
</span></span><span style=display:flex><span>		location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				root E:<span style=color:#ae81ff>\\</span>renren-fast-vue;
</span></span><span style=display:flex><span>				index index.html index.htm;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¯åŠ¨Nginxåï¼Œè®¿é—®å¦‚ä¸‹è·¯å¾„å³å¯</span>
</span></span><span style=display:flex><span>http://localhost
</span></span></code></pre></div><ul><li>ç™»å½•çš„è´¦å·å¯†ç ï¼šadmin/admin</li></ul><h2 id=15-è·å–å¸®åŠ©-1>1.5 è·å–å¸®åŠ©<a hidden class=anchor aria-hidden=true href=#15-è·å–å¸®åŠ©-1>#</a></h2><ul><li><p>åç«¯åœ°å€ï¼šhttps://gitee.com/renrenio/renren-fast</p></li><li><p>å‰ç«¯åœ°å€ï¼šhttps://github.com/renrenio/renren-fast-vue</p></li><li><p>ä»£ç ç”Ÿæˆå™¨ï¼šhttps://gitee.com/renrenio/renren-generator</p></li><li><p>å®˜æ–¹ç¤¾åŒºï¼šhttps://www.renren.io/community</p></li><li><p>å¦‚éœ€å¯»æ±‚å¸®åŠ©ã€é¡¹ç›®å»ºè®®ã€æŠ€æœ¯è®¨è®ºç­‰ï¼Œè¯·ç§»æ­¥åˆ°å®˜æ–¹ç¤¾åŒºï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´è¿›è¡Œè§£ç­”æˆ–å›å¤ å¦‚éœ€å…³æ³¨é¡¹ç›®æœ€æ–°åŠ¨æ€ï¼Œè¯·Watchã€Staré¡¹ç›®ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹é¡¹ç›®æœ€å¥½çš„æ”¯æŒ</p></li></ul><h1 id=ç¬¬-2-ç« -æ•°æ®åº“æ”¯æŒ>ç¬¬ 2 ç«  æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#ç¬¬-2-ç« -æ•°æ®åº“æ”¯æŒ>#</a></h1><h2 id=21-mysql-æ•°æ®åº“æ”¯æŒ>2.1 MySQL æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#21-mysql-æ•°æ®åº“æ”¯æŒ>#</a></h2><h2 id=22-oracle-æ•°æ®åº“æ”¯æŒ>2.2 Oracle æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#22-oracle-æ•°æ®åº“æ”¯æŒ>#</a></h2><h2 id=23-sql-server-æ•°æ®åº“æ”¯æŒ>2.3 SQL Server æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#23-sql-server-æ•°æ®åº“æ”¯æŒ>#</a></h2><h2 id=24-postgresql-æ•°æ®åº“æ”¯æŒ>2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#24-postgresql-æ•°æ®åº“æ”¯æŒ>#</a></h2><h2 id=21-mysql-æ•°æ®åº“æ”¯æŒ-1>2.1 MySQL æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#21-mysql-æ•°æ®åº“æ”¯æŒ-1>#</a></h2><ol><li>ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://localhost:3306/renren_fast?allowMultiQueries=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>æ‰§è¡Œdb/mysql.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯</li></ol><h2 id=22-oracle-æ•°æ®åº“æ”¯æŒ-1>2.2 Oracle æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#22-oracle-æ•°æ®åº“æ”¯æŒ-1>#</a></h2><ol><li>ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>oracle.jdbc.OracleDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:oracle:thin:@192.168.10.10:1521:renren</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>æ‰§è¡Œdb/oracle.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯</li></ol><h2 id=23-sql-server-æ•°æ®åº“æ”¯æŒ-1>2.3 SQL Server æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#23-sql-server-æ•°æ®åº“æ”¯æŒ-1>#</a></h2><ol><li>ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>sa</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>æ‰§è¡Œdb/sqlserver.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯</li></ol><h2 id=24-postgresql-æ•°æ®åº“æ”¯æŒ-1>2.4 PostgreSQL æ•°æ®åº“æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#24-postgresql-æ•°æ®åº“æ”¯æŒ-1>#</a></h2><ol><li>ä¿®æ”¹æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åœ¨application-dev.ymlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>druid</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>org.postgresql.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://192.168.10.10:5432/renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><ol start=2><li>ä¿®æ”¹quartzé…ç½®ä¿¡æ¯ï¼Œquartzé…ç½®æ–‡ä»¶ ScheduleConfig.java ï¼Œæ‰“å¼€æ³¨é‡Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ae81ff>//PostgreSQLæ•°æ®åº“ï¼Œéœ€è¦æ‰“å¼€æ­¤æ³¨é‡Š</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>prop.put(&#34;org.quartz.jobStore.driverDelegateClass&#34;, &#34;org.quartz.impl.jdbcjobstore.PostgreSQLD</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>elegate&#34;);</span>
</span></span></code></pre></div><ol start=3><li>æ‰§è¡Œdb/postgresql.sqlï¼Œåˆ›å»ºè¡¨åŠåˆå§‹åŒ–æ•°æ®ï¼Œå†å¯åŠ¨é¡¹ç›®å³å¯</li></ol><h1 id=ç¬¬-3-ç« -å¤šæ•°æ®æºæ”¯æŒ>ç¬¬ 3 ç«  å¤šæ•°æ®æºæ”¯æŒ<a hidden class=anchor aria-hidden=true href=#ç¬¬-3-ç« -å¤šæ•°æ®æºæ”¯æŒ>#</a></h1><h2 id=31-å¤šæ•°æ®æºé…ç½®>3.1 å¤šæ•°æ®æºé…ç½®<a hidden class=anchor aria-hidden=true href=#31-å¤šæ•°æ®æºé…ç½®>#</a></h2><h2 id=32-å¤šæ•°æ®æºä½¿ç”¨>3.2 å¤šæ•°æ®æºä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#32-å¤šæ•°æ®æºä½¿ç”¨>#</a></h2><h2 id=33-æºç è®²è§£>3.3 æºç è®²è§£<a hidden class=anchor aria-hidden=true href=#33-æºç è®²è§£>#</a></h2><h2 id=31-å¤šæ•°æ®æºé…ç½®-1>3.1 å¤šæ•°æ®æºé…ç½®<a hidden class=anchor aria-hidden=true href=#31-å¤šæ•°æ®æºé…ç½®-1>#</a></h2><blockquote><p>å¤šæ•°æ®æºçš„åº”ç”¨åœºæ™¯ï¼Œä¸»è¦é’ˆå¯¹è·¨å¤šä¸ªæ•°æ®åº“å®ä¾‹çš„æƒ…å†µï¼Œå¦‚æœæ˜¯åŒå®ä¾‹ä¸­çš„å¤šä¸ªæ•°æ®åº“ï¼Œåˆ™æ²¡å¿…è¦ä½¿ç”¨å¤šæ•°æ®æºã€‚</p></blockquote><pre tabindex=0><code>#ä¸‹é¢æ¼”ç¤ºå•å®ä¾‹ï¼Œå¤šæ•°æ®åº“çš„ä½¿ç”¨æƒ…å†µ
select * from db.table;
#å…¶ä¸­ï¼Œdbä¸ºæ•°æ®åº“åï¼Œtableä¸ºæ•°æ®åº“è¡¨å
</code></pre><ul><li>é…ç½®å¤šæ•°æ®æºï¼Œå¦‚æœæ˜¯å¼€å‘ç¯å¢ƒï¼Œåˆ™ä¿®æ”¹ application-dev.xml ï¼Œå¦‚ä¸‹æ‰€ç¤º</li></ul><h2 id=å¤šæ•°æ®æºçš„é…ç½®>å¤šæ•°æ®æºçš„é…ç½®<a hidden class=anchor aria-hidden=true href=#å¤šæ•°æ®æºçš„é…ç½®>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>dynamic</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>slave1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>sa</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>slave2</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>org.postgresql.Driver</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://192.168.10.10:5432/renren_fast</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>username</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><h2 id=32-å¤šæ•°æ®æºä½¿ç”¨-1>3.2 å¤šæ•°æ®æºä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#32-å¤šæ•°æ®æºä½¿ç”¨-1>#</a></h2><blockquote><p>å¤šæ•°æ®æºçš„ä½¿ç”¨ï¼Œåªéœ€åœ¨Serviceç±»ã€æ–¹æ³•ä¸Šæ·»åŠ @DataSource("")æ³¨è§£å³å¯ï¼Œæ¯”å¦‚åœ¨ç±»ä¸Šæ·»åŠ äº† @DataSource(&ldquo;userDB&rdquo;)æ³¨è§£ï¼Œåˆ™è¡¨ç¤ºè¯¥Serviceæ–¹æ³•é‡Œçš„æ‰€æœ‰CURDï¼Œéƒ½ä¼šåœ¨ userDB æ•°æ®æºé‡Œæ‰§è¡Œã€‚</p></blockquote><ol><li>å¤šæ•°æ®æºæ³¨è§£ä½¿ç”¨è§„åˆ™<ul><li>æ”¯æŒåœ¨Serviceç±»æˆ–æ–¹æ³•ä¸Šï¼Œæ·»åŠ å¤šæ•°æ®æºçš„æ³¨è§£@DataSource</li><li>åœ¨Serviceç±»ä¸Šæ·»åŠ äº†@DataSourceæ³¨è§£ï¼Œåˆ™è¯¥ç±»ä¸‹çš„æ‰€æœ‰æ–¹æ³•ï¼Œéƒ½ä¼šä½¿ç”¨@DataSourceæ ‡æ³¨çš„æ•°æ®æº</li><li>åœ¨Serviceç±»ã€æ–¹æ³•ä¸Šéƒ½æ·»åŠ äº†@DataSourceæ³¨è§£ï¼Œåˆ™æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼šè¦†ç›–Serviceç±»ä¸Šçš„æ³¨è§£</li></ul></li><li>ç¼–å†™DynamicDataSourceTestService.javaï¼Œæµ‹è¯•å¤šæ•°æ®æºåŠäº‹ç‰©</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> io.renren.service<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.annotation.DataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.dao.SysUserDao<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.entity.SysUserEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Service<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.transaction.annotation.Transactional<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * æµ‹è¯•å¤šæ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//@DataSource(&#34;slave1&#34;) å¤šæ•°æ®æºå…¨å±€é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceTestService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysUserDao sysUserDao<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateUser</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setMobile</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;13500000000&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysUserDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateById</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DataSource</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;slave1&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateUserBySlave1</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setMobile</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;13500000001&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysUserDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateById</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DataSource</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;slave2&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateUserBySlave2</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setMobile</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;13500000002&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysUserDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateById</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æµ‹è¯•äº‹ç‰©
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 1 <span style=color:#f92672>/</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>è¿è¡Œæµ‹è¯•ç±»DynamicDataSourceTest.javaï¼Œå³å¯æµ‹è¯•å¤šæ•°æ®æºåŠäº‹ç‰©æ˜¯ç”Ÿæ•ˆçš„</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> io.renren.service<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.Test<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.runner.RunWith<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit4.SpringRunner<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * å¤šæ•°æ®æºæµ‹è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span><span style=color:#f92672>(</span>SpringRunner<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> DynamicDataSourceTestService dynamicDataSourceTestService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Long id <span style=color:#f92672>=</span> 1L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        dynamicDataSourceTestService<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        dynamicDataSourceTestService<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUserBySlave1</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        dynamicDataSourceTestService<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUserBySlave2</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>å…¶ä¸­ï¼Œ @DataSource(&ldquo;slave1&rdquo;) ã€ @DataSource(&ldquo;slave2&rdquo;) é‡Œçš„ slave1 ã€ slave2 å€¼ï¼Œæ˜¯åœ¨application- dev.xmlé‡Œé…ç½®çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>dynamic</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>slave1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:sqlserver://localhost:1433;DatabaseName=renren_security</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>sa</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>slave2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>org.postgresql.Driver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://localhost:5432/renren_security</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><h2 id=33-æºç è®²è§£-1>3.3 æºç è®²è§£<a hidden class=anchor aria-hidden=true href=#33-æºç è®²è§£-1>#</a></h2><ol><li>å®šä¹‰å¤šæ•°æ®æºæ³¨è§£ç±»@DataSourceï¼Œä½¿ç”¨å¤šæ•°æ®æºæ—¶ï¼Œåªéœ€åœ¨Serviceæ–¹æ³•ä¸Šæ·»åŠ @DataSourceæ³¨è§£å³å¯</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.annotation.*<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * å¤šæ•°æ®æºæ³¨è§£
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>({</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>METHOD</span><span style=color:#f92672>,</span> ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Inherited</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> DataSource <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>value</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>default</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=2><li>å®šä¹‰è¯»å–å¤šæ•°æ®æºé…ç½®æ–‡ä»¶çš„ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * å¤šæ•°æ®æºå±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DataSourceProperties</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String driverClassName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Druidé»˜è®¤å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> initialSize <span style=color:#f92672>=</span> 2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> maxActive <span style=color:#f92672>=</span> 10<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> minIdle <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> maxWait <span style=color:#f92672>=</span> 60 <span style=color:#f92672>*</span> 1000L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> timeBetweenEvictionRunsMillis <span style=color:#f92672>=</span> 60 <span style=color:#f92672>*</span> 1000L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> minEvictableIdleTimeMillis <span style=color:#f92672>=</span> 1000L <span style=color:#f92672>*</span> 60L <span style=color:#f92672>*</span> 30L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> maxEvictableIdleTimeMillis <span style=color:#f92672>=</span> 1000L <span style=color:#f92672>*</span> 60L <span style=color:#f92672>*</span> 60L <span style=color:#f92672>*</span> 7<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String validationQuery <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;select 1&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> validationQueryTimeout <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> testOnBorrow <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> testOnReturn <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> testWhileIdle <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> poolPreparedStatements <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> maxOpenPreparedStatements <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> sharePreparedStatements <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String filters <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;stat,wall&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getDriverClassName</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> driverClassName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDriverClassName</span><span style=color:#f92672>(</span>String driverClassName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>driverClassName</span> <span style=color:#f92672>=</span> driverClassName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getUrl</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUrl</span><span style=color:#f92672>(</span>String url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getUsername</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setUsername</span><span style=color:#f92672>(</span>String username<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPassword</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span>String password<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getInitialSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> initialSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setInitialSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> initialSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>initialSize</span> <span style=color:#f92672>=</span> initialSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMaxActive</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxActive<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxActive</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> maxActive<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxActive</span> <span style=color:#f92672>=</span> maxActive<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMinIdle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> minIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMinIdle</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> minIdle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>minIdle</span> <span style=color:#f92672>=</span> minIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getMaxWait</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxWait<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxWait</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> maxWait<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxWait</span> <span style=color:#f92672>=</span> maxWait<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getTimeBetweenEvictionRunsMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> timeBetweenEvictionRunsMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTimeBetweenEvictionRunsMillis</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> timeBetweenEvictionRunsMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeBetweenEvictionRunsMillis</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                timeBetweenEvictionRunsMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getMinEvictableIdleTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> minEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMinEvictableIdleTimeMillis</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> minEvictableIdleTimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>minEvictableIdleTimeMillis</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                minEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getMaxEvictableIdleTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxEvictableIdleTimeMillis</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> maxEvictableIdleTimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxEvictableIdleTimeMillis</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                maxEvictableIdleTimeMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getValidationQuery</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> validationQuery<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setValidationQuery</span><span style=color:#f92672>(</span>String validationQuery<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>validationQuery</span> <span style=color:#f92672>=</span> validationQuery<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getValidationQueryTimeout</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> validationQueryTimeout<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setValidationQueryTimeout</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> validationQueryTimeout<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>validationQueryTimeout</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                validationQueryTimeout<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTestOnBorrow</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> testOnBorrow<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTestOnBorrow</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> testOnBorrow<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>testOnBorrow</span> <span style=color:#f92672>=</span> testOnBorrow<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTestOnReturn</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> testOnReturn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTestOnReturn</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> testOnReturn<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>testOnReturn</span> <span style=color:#f92672>=</span> testOnReturn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTestWhileIdle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> testWhileIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setTestWhileIdle</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> testWhileIdle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>testWhileIdle</span> <span style=color:#f92672>=</span> testWhileIdle<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isPoolPreparedStatements</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> poolPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPoolPreparedStatements</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> poolPreparedStatements<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>poolPreparedStatements</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                poolPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMaxOpenPreparedStatements</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> maxOpenPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMaxOpenPreparedStatements</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> maxOpenPreparedStatements<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxOpenPreparedStatements</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                maxOpenPreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isSharePreparedStatements</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sharePreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setSharePreparedStatements</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> sharePreparedStatements<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sharePreparedStatements</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                sharePreparedStatements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getFilters</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> filters<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setFilters</span><span style=color:#f92672>(</span>String filters<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>filters</span> <span style=color:#f92672>=</span> filters<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.ConfigurationProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.LinkedHashMap<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Map<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * å¤šæ•°æ®æºå±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dynamic&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceProperties</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> DataSourceProperties<span style=color:#f92672>&gt;</span> datasource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> DataSourceProperties<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getDatasource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> datasource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDatasource</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> DataSourceProperties<span style=color:#f92672>&gt;</span> datasource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>datasource</span> <span style=color:#f92672>=</span> datasource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>æ‰©å±•Springçš„AbstractRoutingDataSourceæŠ½è±¡ç±»ï¼Œ
AbstractRoutingDataSourceä¸­çš„æŠ½è±¡æ–¹æ³•determineCurrentLookupKeyæ˜¯å®ç°å¤šæ•°æ®æºçš„æ ¸å¿ƒï¼Œå¹¶å¯¹è¯¥æ–¹æ³•è¿›è¡ŒOverrideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * å¤šæ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSource</span> <span style=color:#66d9ef>extends</span> AbstractRoutingDataSource <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>determineCurrentLookupKey</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DynamicContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=4><li>æ•°æ®æºä¸Šä¸‹</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * å¤šæ•°æ®æºä¸Šä¸‹æ–‡
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicContextHolder</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ThreadLocal<span style=color:#f92672>&lt;</span>Deque<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;&gt;</span> CONTEXT_HOLDER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocal<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>initialValue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ArrayDeque<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å¾—å½“å‰çº¿ç¨‹æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return æ•°æ®æºåç§°
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>peek</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>peek</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è®¾ç½®å½“å‰çº¿ç¨‹æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param dataSource æ•°æ®æºåç§°
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>String dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>dataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ¸…ç©ºå½“å‰çº¿ç¨‹æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>poll</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Deque<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> deque <span style=color:#f92672>=</span> CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        deque<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>deque<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            CONTEXT_HOLDER<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=5><li>é…ç½®å¤šæ•°æ®æºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ol><pre tabindex=0><code>return druidDataSource;
}
}
</code></pre><ol start=5><li>@DataSourceæ³¨è§£çš„åˆ‡é¢å¤„ç†ç±»ï¼ŒåŠ¨æ€åˆ‡æ¢çš„æ ¸å¿ƒä»£ç </li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.druid.pool.DruidDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.properties.DataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.properties.DynamicDataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.ConfigurationProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.EnableConfigurationProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.HashMap<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Map<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * é…ç½®å¤šæ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span><span style=color:#f92672>(</span>DynamicDataSourceProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> DynamicDataSourceProperties properties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.druid&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSourceProperties <span style=color:#a6e22e>dataSourceProperties</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataSourceProperties<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//å› ä¸ºDynamicDataSourceæ˜¯ç»§æ‰¿ä¸AbstractRoutingDataSourceï¼Œè€ŒAbstractRoutingDataSourceåˆæ˜¯ç»§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    æ‰¿äºAbstractDataSource<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>AbstractDataSourceå®ç°äº†ç»Ÿä¸€çš„DataSourceæ¥å£<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>
</span></span><span style=display:flex><span>    æ‰€ä»¥DynamicDataSourceä¹Ÿå¯
</span></span><span style=display:flex><span>            ä»¥å½“åšDataSourceä½¿ç”¨
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DynamicDataSource <span style=color:#a6e22e>dynamicDataSource</span><span style=color:#f92672>(</span>DataSourceProperties dataSourceProperties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        DynamicDataSource dynamicDataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DynamicDataSource<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        dynamicDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTargetDataSources</span><span style=color:#f92672>(</span>getDynamicDataSource<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//é»˜è®¤æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DruidDataSource defaultDataSource <span style=color:#f92672>=</span> DynamicDataSourceFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>buildDruidDataSource</span><span style=color:#f92672>(</span>dat
</span></span><span style=display:flex><span>                aSourceProperties<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        dynamicDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultTargetDataSource</span><span style=color:#f92672>(</span>defaultDataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dynamicDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getDynamicDataSource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> targetDataSources <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getDatasource</span><span style=color:#f92672>().</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>((</span>k<span style=color:#f92672>,</span> v<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            DruidDataSource druidDataSource <span style=color:#f92672>=</span> DynamicDataSourceFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>buildDruidDataSource</span><span style=color:#f92672>(</span>v
</span></span><span style=display:flex><span>            <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            targetDataSources<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>k<span style=color:#f92672>,</span> druidDataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> targetDataSources<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.druid.pool.DruidDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.properties.DataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.sql.SQLException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * DruidDataSource
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceFactory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> DruidDataSource <span style=color:#a6e22e>buildDruidDataSource</span><span style=color:#f92672>(</span>DataSourceProperties properties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        DruidDataSource druidDataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DruidDataSource<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setDriverClassName</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getDriverClassName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setUrl</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getUrl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setUsername</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsername</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getPassword</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setInitialSize</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getInitialSize</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxActive</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxActive</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMinIdle</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinIdle</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxWait</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxWait</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTimeBetweenEvictionRunsMillis</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getTimeBetweenEvictionRun</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>sMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMinEvictableIdleTimeMillis</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMinEvictableIdleTimeMilli</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>s</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxEvictableIdleTimeMillis</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxEvictableIdleTimeMilli</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>s</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setValidationQuery</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getValidationQuery</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setValidationQueryTimeout</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getValidationQueryTimeout</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTestOnBorrow</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isTestOnBorrow</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setTestOnReturn</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isTestOnReturn</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setPoolPreparedStatements</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isPoolPreparedStatements</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxOpenPreparedStatements</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxOpenPreparedStatements</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setSharePreparedStatements</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>isSharePreparedStatements</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilters</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getFilters</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            druidDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>init</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SQLException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> druidDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=5><li>@DataSourceæ³¨è§£çš„åˆ‡é¢å¤„ç†ç±»ï¼ŒåŠ¨æ€åˆ‡æ¢çš„æ ¸å¿ƒä»£ç </li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.annotation.DataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.commons.dynamic.datasource.config.DynamicContextHolder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.ProceedingJoinPoint<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Around<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Aspect<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Pointcut<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.reflect.MethodSignature<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.Ordered<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.annotation.Order<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.reflect.Method<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * å¤šæ•°æ®æºï¼Œåˆ‡é¢å¤„ç†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span>Ordered<span style=color:#f92672>.</span><span style=color:#a6e22e>HIGHEST_PRECEDENCE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DataSourceAspect</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;@annotation(io.renren.commons.dynamic.datasource.annotation.DataSource) &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;|| @within(io.renren.commons.dynamic.datasource.annotation.DataSource)&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dataSourcePointCut</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dataSourcePointCut()&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>around</span><span style=color:#f92672>(</span>ProceedingJoinPoint point<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        MethodSignature signature <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>MethodSignature<span style=color:#f92672>)</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Class targetClass <span style=color:#f92672>=</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>getTarget</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Method method <span style=color:#f92672>=</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        DataSource targetDataSource <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>DataSource<span style=color:#f92672>)</span> targetClass<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        DataSource methodDataSource <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>targetDataSource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> methodDataSource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>methodDataSource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                value <span style=color:#f92672>=</span> methodDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                value <span style=color:#f92672>=</span> targetDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            DynamicContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>push</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;set datasource is {}&#34;</span><span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            DynamicContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;clean datasource&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=ç¬¬-4-ç« -åŸºç¡€çŸ¥è¯†è®²è§£>ç¬¬ 4 ç«  åŸºç¡€çŸ¥è¯†è®²è§£<a hidden class=anchor aria-hidden=true href=#ç¬¬-4-ç« -åŸºç¡€çŸ¥è¯†è®²è§£>#</a></h1><h2 id=41-spring-mvc-ä½¿ç”¨>4.1 Spring MVC ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#41-spring-mvc-ä½¿ç”¨>#</a></h2><h2 id=42-swagger-ä½¿ç”¨>4.2 Swagger ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#42-swagger-ä½¿ç”¨>#</a></h2><h2 id=43-mybatis-plus-ä½¿ç”¨>4.3 Mybatis-plus ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#43-mybatis-plus-ä½¿ç”¨>#</a></h2><h2 id=41-spring-mvc-ä½¿ç”¨-1>4.1 Spring MVC ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#41-spring-mvc-ä½¿ç”¨-1>#</a></h2><blockquote><p>å¯¹Spring MVCä¸å¤ªç†Ÿæ‚‰çš„ï¼Œéœ€è¦ç†è§£Spring MVCå¸¸ç”¨çš„æ³¨è§£ï¼Œä¹Ÿæ–¹ä¾¿æ—¥åæ’æŸ¥é—®é¢˜ï¼Œå¸¸ç”¨çš„æ³¨è§£å¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><h3 id=411-controller-æ³¨è§£>4.1.1 @Controller æ³¨è§£<a hidden class=anchor aria-hidden=true href=#411-controller-æ³¨è§£>#</a></h3><p>@Controlleræ³¨è§£è¡¨æ˜äº†ä¸€ä¸ªç±»æ˜¯ä½œä¸ºæ§åˆ¶å™¨çš„è§’è‰²è€Œå­˜åœ¨çš„ã€‚Springä¸è¦æ±‚ä½ å»ç»§æ‰¿ä»»ä½•æ§åˆ¶å™¨åŸºç±»ï¼Œä¹Ÿä¸è¦æ±‚ä½ å»å®ç°Servletçš„é‚£å¥—APIã€‚å½“ç„¶ï¼Œå¦‚æœä½ éœ€è¦çš„è¯ä¹Ÿå¯ä»¥å»ä½¿ç”¨ä»»ä½•ä¸Servletç›¸å…³çš„ç‰¹æ€§ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=412-requestmapping-æ³¨è§£>4.1.2 @RequestMapping æ³¨è§£<a hidden class=anchor aria-hidden=true href=#412-requestmapping-æ³¨è§£>#</a></h3><p>ä½ å¯ä»¥ä½¿ç”¨@RequestMappingæ³¨è§£æ¥å°†è¯·æ±‚URLï¼Œå¦‚/userç­‰ï¼Œæ˜ å°„åˆ°æ•´ä¸ªç±»ä¸Šæˆ–æŸä¸ªç‰¹å®šçš„å¤„ç†å™¨æ–¹æ³•ä¸Šã€‚
ä¸€èˆ¬æ¥è¯´ï¼Œç±»çº§åˆ«çš„æ³¨è§£è´Ÿè´£å°†ä¸€ä¸ªç‰¹å®šï¼ˆæˆ–ç¬¦åˆæŸç§æ¨¡å¼ï¼‰çš„è¯·æ±‚è·¯å¾„æ˜ å°„åˆ°ä¸€ä¸ªæ§åˆ¶å™¨ä¸Šï¼ŒåŒæ—¶é€šè¿‡æ–¹æ³•çº§åˆ«çš„æ³¨è§£æ¥ç»†åŒ–æ˜ å°„ï¼Œå³æ ¹æ®ç‰¹å®šçš„HTTPè¯·æ±‚æ–¹æ³•ï¼ˆGETã€POSTæ–¹æ³•ç­‰ï¼‰ã€HTTPè¯·æ±‚ä¸­æ˜¯å¦æºå¸¦ç‰¹ å®šå‚æ•°ç­‰æ¡ä»¶ï¼Œå°†è¯·æ±‚æ˜ å°„åˆ°åŒ¹é…çš„æ–¹æ³•ä¸Šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>user</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ä»¥ä¸Šä»£ç æ²¡æœ‰æŒ‡å®šè¯·æ±‚å¿…é¡»æ˜¯GETæ–¹æ³•è¿˜æ˜¯PUT/POSTæˆ–å…¶ä»–æ–¹æ³•ï¼Œ@RequestMappingæ³¨è§£é»˜è®¤ä¼šæ˜ å°„æ‰€æœ‰ çš„HTTPè¯·æ±‚æ–¹æ³•ã€‚å¦‚æœä»…æƒ³æ¥æ”¶æŸç§è¯·æ±‚æ–¹æ³•ï¼Œè¯·åœ¨æ³¨è§£ä¸­æŒ‡å®šä¹‹@RequestMapping(path = &ldquo;/user&rdquo;, method = RequestMethod.GET)ä»¥ç¼©å°èŒƒå›´ã€‚</p><h3 id=413-pathvariable-æ³¨è§£>4.1.3 @PathVariable æ³¨è§£<a hidden class=anchor aria-hidden=true href=#413-pathvariable-æ³¨è§£>#</a></h3><p>åœ¨Spring MVCä¸­ä½ å¯ä»¥åœ¨æ–¹æ³•å‚æ•°ä¸Šä½¿ç”¨@PathVariableæ³¨è§£ï¼Œå°†å…¶ä¸URIæ¨¡æ¿ä¸­çš„å‚æ•°ç»‘å®šèµ·æ¥ï¼Œå¦‚ä¸‹æ‰€ ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/user/{userId}&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>userCenter</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> String userId<span style=color:#f92672>,</span>Model model<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        UserDTO user<span style=color:#f92672>=</span>userService<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        model<span style=color:#f92672>.</span><span style=color:#a6e22e>addAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>,</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#e6db74>&#34;userCenter&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>URIæ¨¡æ¿"/user/{userId}&ldquo;æŒ‡å®šäº†ä¸€ä¸ªå˜é‡åä¸ºuserIdã€‚å½“æ§åˆ¶å™¨å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒuserIdçš„å€¼å°±ä¼šè¢«URIæ¨¡ æ¿ä¸­å¯¹åº”éƒ¨åˆ†çš„å€¼æ‰€å¡«å……ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœè¯·æ±‚çš„URIæ˜¯/userId/1ï¼Œæ­¤æ—¶å˜é‡userIdçš„å€¼å°±æ˜¯ 1 ã€‚</p><h3 id=414-getmapping-æ³¨è§£>4.1.4 @GetMapping æ³¨è§£<a hidden class=anchor aria-hidden=true href=#414-getmapping-æ³¨è§£>#</a></h3><p>@GetMappingæ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œæ˜¯@RequestMapping(method = RequestMethod.GET)çš„ç¼©å†™ã€‚è¯¥æ³¨è§£å°†HTTP GETæ˜ å°„åˆ°ç‰¹å®šçš„å¤„ç†æ–¹æ³•ä¸Šã€‚å¯ä»¥ä½¿ç”¨@GetMapping("/user&rdquo;)æ¥ä»£æ›¿@RequestMapping(path="/user",method=RequestMethod.GET)ã€‚è¿˜æœ‰@PostMappingã€@PutMappingã€ @DeleteMappingç­‰åŒç†ã€‚</p><h3 id=415-requestbody-æ³¨è§£>4.1.5 @RequestBody æ³¨è§£<a hidden class=anchor aria-hidden=true href=#415-requestbody-æ³¨è§£>#</a></h3><p>è¯¥æ³¨è§£ç”¨äºè¯»å–Requestè¯·æ±‚çš„bodyéƒ¨åˆ†æ•°æ®ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½®çš„HttpMessageConverterè¿›è¡Œè§£æï¼Œç„¶åæŠŠç›¸åº”çš„æ•°æ®ç»‘å®šåˆ°è¦è¿”å›çš„å¯¹è±¡ä¸Šï¼Œå†æŠŠHttpMessageConverterè¿”å›çš„å¯¹è±¡æ•°æ®ç»‘å®šåˆ°Controllerä¸­æ–¹æ³•çš„å‚æ•°ä¸Šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>user</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> User user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=416-responsebody-æ³¨è§£>4.1.6 @ResponseBody æ³¨è§£<a hidden class=anchor aria-hidden=true href=#416-responsebody-æ³¨è§£>#</a></h3><p>è¯¥æ³¨è§£ç”¨äºå°†Controllerçš„æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œé€šè¿‡é€‚å½“çš„HttpMessageConverterè½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼åï¼Œå†™å…¥åˆ°Responseå¯¹è±¡çš„bodyæ•°æ®åŒºã€‚æ¯”å¦‚è·å–JSONæ•°æ®ï¼ŒåŠ ä¸Š@ResponseBodyåï¼Œä¼šç›´æ¥è¿”å›JSONæ•°æ®ï¼Œè€Œä¸ä¼šè¢«è§£æä¸ºè§†å›¾ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ResponseBody</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{userId}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> String userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        UserDTO user <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> user<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=417-restcontroller-æ³¨è§£>4.1.7 @RestController æ³¨è§£<a hidden class=anchor aria-hidden=true href=#417-restcontroller-æ³¨è§£>#</a></h3><p>@RestControlleræ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œå³@Controller + @ResponseBodyçš„ç»„åˆæ³¨è§£ï¼Œè¯·æ±‚å®Œåï¼Œä¼šè¿”å›JSONæ•°æ®ã€‚</p><h2 id=42-swagger-ä½¿ç”¨-1>4.2 Swagger ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#42-swagger-ä½¿ç”¨-1>#</a></h2><blockquote><p>Swaggeræ˜¯ä¸€ä¸ªæ ¹æ®Swaggeræ³¨è§£ï¼Œå³å¯ç”Ÿæˆæ¥å£æ–‡æ¡£çš„æœåŠ¡ã€‚</p></blockquote><h3 id=421-æ­å»º-swagger-ç¯å¢ƒ>4.2.1 æ­å»º Swagger ç¯å¢ƒ<a hidden class=anchor aria-hidden=true href=#421-æ­å»º-swagger-ç¯å¢ƒ>#</a></h3><ul><li>åœ¨pom.xmlæ–‡ä»¶ä¸­æ·»åŠ swaggerç›¸å…³ä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>io.springfox<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>springfox-swagger2<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${springfox-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;groupId&gt;</span>io.springfox<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;artifactId&gt;</span>springfox-swagger-ui<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;version&gt;</span>${springfox-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ul><li>ç¼–å†™Swaggerçš„Configurationé…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.annotations.ApiOperation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.builders.ApiInfoBuilder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.builders.PathSelectors<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.builders.RequestHandlerSelectors<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.service.ApiInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.service.ApiKey<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.spi.DocumentationType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.spring.web.plugins.Docket<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> springfox.documentation.swagger2.annotations.EnableSwagger2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> com.google.common.collect.Lists.newArrayList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableSwagger2</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SwaggerConfig</span> <span style=color:#66d9ef>implements</span> WebMvcConfigurer <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Docket <span style=color:#a6e22e>createRestApi</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Docket<span style=color:#f92672>(</span>DocumentationType<span style=color:#f92672>.</span><span style=color:#a6e22e>SWAGGER_2</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>apiInfo</span><span style=color:#f92672>(</span>apiInfo<span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//åŠ äº†ApiOperationæ³¨è§£çš„ç±»ï¼Œæ‰ç”Ÿæˆæ¥å£æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>apis</span><span style=color:#f92672>(</span>RequestHandlerSelectors<span style=color:#f92672>.</span><span style=color:#a6e22e>withMethodAnnotation</span><span style=color:#f92672>(</span>ApiOperation<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//io.renren.controlleråŒ…ä¸‹çš„ç±»ï¼Œæ‰ç”Ÿæˆæ¥å£æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//.apis(RequestHandlerSelectors.basePackage(&#34;io.renren.controller&#34;))
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>paths</span><span style=color:#f92672>(</span>PathSelectors<span style=color:#f92672>.</span><span style=color:#a6e22e>any</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>directModelSubstitute</span><span style=color:#f92672>(</span>java<span style=color:#f92672>.</span><span style=color:#a6e22e>util</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Date</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ApiInfo <span style=color:#a6e22e>apiInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ApiInfoBuilder<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>title</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;äººäººå¼€æº&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>description</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;äººäººå¼€æºæ¥å£æ–‡æ¡£&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>termsOfServiceUrl</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;https://www.renren.io/community&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>version</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;1.0.0&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=422-swagger-å¸¸ç”¨æ³¨è§£>4.2.2 Swagger å¸¸ç”¨æ³¨è§£<a hidden class=anchor aria-hidden=true href=#422-swagger-å¸¸ç”¨æ³¨è§£>#</a></h3><ul><li>@Apiæ³¨è§£ç”¨åœ¨ç±»ä¸Šï¼Œè¯´æ˜è¯¥ç±»çš„ä½œç”¨ã€‚å¯ä»¥æ ‡è®°ä¸€ä¸ªControllerç±»åšä¸ºswaggeræ–‡æ¡£èµ„æºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span>tags <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ç”¨æˆ·ç®¡ç†&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>@ApiOperationæ³¨è§£ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œè¯´æ˜è¯¥æ–¹æ³•çš„ä½œç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span>tags <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ç”¨æˆ·ç®¡ç†&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;åˆ—è¡¨&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>UserDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>UserDTO<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>@ApiParamæ³¨è§£ç”¨åœ¨æ–¹æ³•å‚æ•°ä¸Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span>tags <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ç”¨æˆ·ç®¡ç†&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;åˆ—è¡¨&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List <span style=color:#a6e22e>list</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@ApiParam</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ç”¨æˆ·å&#34;</span><span style=color:#f92672>,</span> required <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> String username<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List list <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><p>@ApiImplicitParamsæ³¨è§£ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œä¸»è¦ç”¨äºä¸€ç»„å‚æ•°è¯´æ˜</p></li><li><p>@ApiImplicitParamæ³¨è§£ç”¨åœ¨@ApiImplicitParamsæ³¨è§£ä¸­ï¼ŒæŒ‡å®šä¸€ä¸ªè¯·æ±‚å‚æ•°çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;page&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;åˆ†é¡µ&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ApiImplicitParams</span><span style=color:#f92672>({</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;page&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;å½“å‰é¡µç ï¼Œä» 1 å¼€å§‹&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> requ ired<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;int&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;limit&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;æ¯é¡µæ˜¾ç¤ºè®°å½•æ•°&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> requir ed<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;int&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;order_field&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;æ’åºå­—æ®µ&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> dataT ype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;String&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;order&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;æ’åºæ–¹å¼ï¼Œå¯é€‰å€¼(ascã€desc)&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;q uery&#34;</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;String&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiImplicitParam</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>,</span> value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ç”¨æˆ·å&#34;</span><span style=color:#f92672>,</span> paramType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#f92672>,</span> dataType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;String&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result<span style=color:#f92672>&lt;</span>PageData<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@ApiIgnore</span> <span style=color:#a6e22e>@RequestParam</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> par ams<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        PageData page<span style=color:#f92672>=</span>sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>page</span><span style=color:#f92672>(</span>params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result<span style=color:#f92672>&lt;</span>PageData<span style=color:#f92672>&gt;().</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>(</span>page<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>@ApiIgnoreæ³¨è§£ï¼Œå¯ç”¨äºç±»ã€æ–¹æ³•æˆ–å‚æ•°ä¸Šï¼Œè¡¨ç¤ºç”ŸæˆSwaggeræ¥å£æ–‡æ¡£æ—¶ï¼Œå¿½ç•¥ç±»ã€æ–¹æ³•æˆ–å‚æ•°ã€‚</li></ul><h2 id=43-mybatis-plus-ä½¿ç”¨-1>4.3 Mybatis-plus ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#43-mybatis-plus-ä½¿ç”¨-1>#</a></h2><p>åœ¨é¡¹ç›®çš„pom.xmlé‡Œå¼•å…¥ä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.baomidou<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${mybatisplus.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>åœ¨ymlé…ç½®æ–‡ä»¶é‡Œï¼Œé…ç½®mybatis-plusï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>mybatis-plus</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mapper-locations</span>: <span style=color:#ae81ff>classpath*:/mapper/**/*.xml</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#å®ä½“æ‰«æï¼Œå¤šä¸ªpackageç”¨é€—å·æˆ–è€…åˆ†å·åˆ†éš”</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>typeAliasesPackage</span>: <span style=color:#ae81ff>io.renren.modules.*.entity</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>global-config</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>#æ•°æ®åº“ç›¸å…³é…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>db-config</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>#ä¸»é”®ç±»å‹ AUTO:&#34;æ•°æ®åº“IDè‡ªå¢&#34;, INPUT:&#34;ç”¨æˆ·è¾“å…¥ID&#34;, ID_WORKER:&#34;å…¨å±€å”¯ä¸€ID (æ•°å­—ç±»å‹å”¯ä¸€ID)&#34;</span>
</span></span><span style=display:flex><span>    , <span style=color:#ae81ff>UUID:&#34;å…¨å±€å”¯ä¸€ID UUID&#34;;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>id-type</span>: <span style=color:#ae81ff>AUTO</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#å­—æ®µç­–ç•¥ IGNORED:&#34;å¿½ç•¥åˆ¤æ–­&#34;,NOT_NULL:&#34;é NULL åˆ¤æ–­&#34;),NOT_EMPTY:&#34;éç©ºåˆ¤æ–­&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>field-strategy</span>: <span style=color:#ae81ff>NOT_NULL</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#é©¼å³°ä¸‹åˆ’çº¿è½¬æ¢</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>column-underline</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>logic-delete-value</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>logic-not-delete-value</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>banner</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#åŸç”Ÿé…ç½®</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>configuration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>map-underscore-to-camel-case</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cache-enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>call-setters-on-nulls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jdbc-type-for-null</span>: <span style=color:#e6db74>&#39;null&#39;</span>
</span></span></code></pre></div><h1 id=ç¬¬-5-ç« -é¡¹ç›®å®æˆ˜>ç¬¬ 5 ç«  é¡¹ç›®å®æˆ˜<a hidden class=anchor aria-hidden=true href=#ç¬¬-5-ç« -é¡¹ç›®å®æˆ˜>#</a></h1><h2 id=51-éœ€æ±‚è¯´æ˜>5.1 éœ€æ±‚è¯´æ˜<a hidden class=anchor aria-hidden=true href=#51-éœ€æ±‚è¯´æ˜>#</a></h2><h2 id=52-ä»£ç ç”Ÿæˆå™¨>5.2 ä»£ç ç”Ÿæˆå™¨<a hidden class=anchor aria-hidden=true href=#52-ä»£ç ç”Ÿæˆå™¨>#</a></h2><h2 id=51-éœ€æ±‚è¯´æ˜-1>5.1 éœ€æ±‚è¯´æ˜<a hidden class=anchor aria-hidden=true href=#51-éœ€æ±‚è¯´æ˜-1>#</a></h2><blockquote><p>æˆ‘ä»¬æ¥å®Œæˆä¸€ä¸ªå•†å“çš„åˆ—è¡¨ã€æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤åŠŸèƒ½ï¼Œç†Ÿæ‚‰å¦‚ä½•å¿«é€Ÿå¼€å‘è‡ªå·±çš„ä¸šåŠ¡åŠŸèƒ½æ¨¡å—ã€‚</p></blockquote><ul><li>æˆ‘ä»¬å…ˆå»ºä¸€ä¸ªå•†å“è¡¨tb_goodsï¼Œè¡¨ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>tb_goods<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>goods_id<span style=color:#f92672>`</span> bigint <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;å•†å“ID&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>     varchar(<span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;å•†å“å&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>intro<span style=color:#f92672>`</span>    varchar(<span style=color:#ae81ff>500</span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;ä»‹ç»&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>price<span style=color:#f92672>`</span>    decimal(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;ä»·æ ¼&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>num<span style=color:#f92672>`</span>      int <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;æ•°é‡&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>goods_id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8 <span style=color:#66d9ef>COMMENT</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;å•†å“ç®¡ç†&#39;</span>;
</span></span></code></pre></div><h2 id=51-ä»£ç ç”Ÿæˆå™¨>5.1 ä»£ç ç”Ÿæˆå™¨<a hidden class=anchor aria-hidden=true href=#51-ä»£ç ç”Ÿæˆå™¨>#</a></h2><ul><li>ä½¿ç”¨ä»£ç ç”Ÿæˆå™¨å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä»£ç ç”Ÿæˆå™¨çš„é…ç½®ï¼Œçœ‹çœ‹é‚£äº›æ˜¯å¯é…ç½®çš„ï¼Œæ‰“å¼€renren-generatoræ¨¡å— çš„é…ç½®æ–‡ä»¶generator.propertiesï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><pre tabindex=0><code class=language-properties data-lang=properties>#ä»£ç ç”Ÿæˆå™¨ï¼Œé…ç½®ä¿¡æ¯
mainPath=io.renren
#åŒ…å
package=io.renren.modules
moduleName=generator
#ä½œè€…
author=Mark
#Email
email=sunlightcs@gmail.com
#è¡¨å‰ç¼€(ç±»åä¸ä¼šåŒ…å«è¡¨å‰ç¼€)
tablePrefix=tb_
#ç±»å‹è½¬æ¢ï¼Œé…ç½®ä¿¡æ¯
tinyint=Integer
smallint=Integer
mediumint=Integer
int=Integer
integer=Integer
bigint=Long
float=Float
double=Double
decimal=BigDecimal
bit=Boolean
char=String
varchar=String
tinytext=String
text=String
mediumtext=String
longtext=String
date=Date
datetime=Date
timestamp=Date
NUMBER=Integer
INT=Integer
INTEGER=Integer
BINARY_INTEGER=Integer
LONG=String
FLOAT=Float
BINARY_FLOAT=Float
DOUBLE=Double
BINARY_DOUBLE=Double
DECIMAL=BigDecimal
CHAR=String
VARCHAR=String
VARCHAR2=String
NVARCHAR=String
NVARCHAR2=String
CLOB=String
BLOB=String
DATE=Date
DATETIME=Date
TIMESTAMP=Date
TIMESTAMP(6)=Date
int8=Long
int4=Integer
int2=Integer
numeric=BigDecimal
</code></pre><p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é…ç½®åŒ…åã€ä½œè€…ä¿¡æ¯ã€è¡¨å‰ç¼€ã€æ¨¡å—åç§°ã€ç±»å‹è½¬æ¢ç­‰ä¿¡æ¯ã€‚å…¶ä¸­ï¼Œç±»å‹è½¬æ¢æ˜¯æŒ‡ï¼Œ MySQLä¸­çš„ç±»å‹ä¸JavaBeanä¸­çš„ç±»å‹ï¼Œæ˜¯æ€ä¹ˆä¸€ä¸ªå¯¹åº”å…³ç³»ã€‚å¦‚æœæœ‰ç¼ºå°‘çš„ç±»å‹ï¼Œå¯è‡ªè¡Œåœ¨generator.propertiesæ–‡ä»¶ä¸­è¡¥å……ã€‚</p><ul><li>å†çœ‹çœ‹renren-generatoræ¨¡å—çš„application.ymlé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬åªè¦ä¿®æ”¹æ•°æ®åº“åã€è´¦å·ã€å¯†ç ï¼Œå°±å¯ä»¥ äº†ã€‚å…¶ä¸­ï¼Œæ•°æ®åº“åæ˜¯æŒ‡å¾…ç”Ÿæˆçš„è¡¨ï¼Œæ‰€åœ¨çš„æ•°æ®åº“ã€‚</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span><span style=color:#75715e># mysql</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>com.alibaba.druid.pool.DruidDataSource</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#MySQLé…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>driverClassName</span>: <span style=color:#ae81ff>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://localhost:3306/renren_fast?useUnicode=true&amp;characterEncoding=UTF-8&amp;useS</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>SL=false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>renren</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#oracleé…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># driverClassName: oracle.jdbc.OracleDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># url: jdbc:oracle:thin:@47.100.206.162:1521:xe</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># username: renren</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># password: 123456</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#SQLServeré…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># username: sa</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># password: 123456</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#PostgreSQLé…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># driverClassName: org.postgresql.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># url: jdbc:postgresql://192.168.10.10:5432/renren_fast</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># username: postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># password: 123456</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jackson</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>time-zone: GMT+8 date-format</span>: <span style=color:#f92672>yyyy-MM-dd HH:mm:ss resources</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>static-locations</span>: <span style=color:#ae81ff>classpath:/static/,classpath:/views/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>mybatis</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mapperLocations</span>: <span style=color:#ae81ff>classpath:mapper/**/*.xml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>pagehelper</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>reasonable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>supportMethodsArguments</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>: <span style=color:#ae81ff>count=countSql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#æŒ‡å®šæ•°æ®åº“ï¼Œå¯é€‰å€¼æœ‰ã€mysqlã€oracleã€sqlserverã€postgresqlã€‘ </span>
</span></span><span style=display:flex><span><span style=color:#f92672>renren</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>database</span>: <span style=color:#ae81ff>mysql</span>
</span></span></code></pre></div><ul><li><p>åœ¨æ•°æ®åº“renren_fastä¸­ï¼Œæ‰§è¡Œå»ºè¡¨è¯­å¥ï¼Œåˆ›å»ºtb_goodsè¡¨ï¼Œå†å¯åŠ¨renren-generatoré¡¹ç›®(è¿è¡Œ RenrenApplication.javaçš„mainæ–¹æ³•å³å¯)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p></li><li><p>åœ¨æµè§ˆå™¨é‡Œè¾“å…¥é¡¹ç›®åœ°å€(http://localhost)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p></li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/HWqMVn.png alt></p><ul><li>æˆ‘ä»¬åªéœ€å‹¾é€‰tb_goodsï¼Œç‚¹å‡»ã€ç”Ÿæˆä»£ç ã€‘æŒ‰é’®ï¼Œåˆ™å¯ç”Ÿæˆç›¸åº”ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/Pli3sp.png alt></p><ul><li>æˆ‘ä»¬æ¥çœ‹ä¸‹ç”Ÿæˆçš„ä»£ç ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/BhpLFE.png alt></p><ul><li>ç”Ÿæˆå¥½ä»£ç åï¼Œæˆ‘ä»¬åªéœ€åœ¨æ•°æ®åº“renren_fastä¸­ï¼Œæ‰§è¡Œgoods_menu.sqlè¯­å¥ï¼Œè¿™ä¸ªSQLæ˜¯ç”Ÿæˆèœå•çš„ï¼Œ SQLè¯­å¥å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>#</span> <span style=color:#75715e>-- èœå•SQL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;å•†å“ç®¡ç†&#39;</span>, <span style=color:#e6db74>&#39;generator/goods&#39;</span>, <span style=color:#66d9ef>NULL</span>, <span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;config&#39;</span>, <span style=color:#e6db74>&#39;6&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>#</span> <span style=color:#75715e>-- æŒ‰é’®çˆ¶èœå•ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>set</span> <span style=color:#f92672>@</span>parentId <span style=color:#f92672>=</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>identity</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- èœå•å¯¹åº”æŒ‰é’®SQL INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;æŸ¥çœ‹&#39;</span>,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;generator:goods:list,generator:goods:info&#39;</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;2&#39;</span>,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;6
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId, <span style=color:#e6db74>&#39;æ–°å¢&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;generator:goods:save&#39;</span>, <span style=color:#e6db74>&#39;2&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;6&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId, <span style=color:#e6db74>&#39;ä¿®æ”¹&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;generator:goods:update&#39;</span>, <span style=color:#e6db74>&#39;2&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;6&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>sys_menu<span style=color:#f92672>`</span> ( <span style=color:#f92672>`</span>parent_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>                       , <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>perms<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span><span style=color:#66d9ef>type</span><span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>icon<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>order_num<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@</span>parentId, <span style=color:#e6db74>&#39;åˆ é™¤&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;generator:goods:delete&#39;</span>, <span style=color:#e6db74>&#39;2&#39;</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;6&#39;</span>;
</span></span></code></pre></div><ul><li>æ¥ä¸‹æ¥ï¼Œå†æŠŠåˆšç”Ÿæˆçš„åç«¯ä»£ç ï¼Œæ·»åŠ åˆ°é¡¹ç›®renren-fasté‡Œï¼Œå‰ç«¯vueä»£ç ï¼Œæ·»åŠ åˆ°å‰ç«¯é¡¹ç›®renren-fast- vueé‡Œï¼Œåœ¨å¯åŠ¨renren-fasté¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/hHJj2Z.png alt></p><ul><li>ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œ</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/iAj5t1.png alt></p><h1 id=ç¬¬-6-ç« -åç«¯æºç åˆ†æ>ç¬¬ 6 ç«  åç«¯æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#ç¬¬-6-ç« -åç«¯æºç åˆ†æ>#</a></h1><h2 id=61-å‰åç«¯åˆ†ç¦»>6.1 å‰åç«¯åˆ†ç¦»<a hidden class=anchor aria-hidden=true href=#61-å‰åç«¯åˆ†ç¦»>#</a></h2><h2 id=62-æƒé™è®¾è®¡æ€è·¯>6.2 æƒé™è®¾è®¡æ€è·¯<a hidden class=anchor aria-hidden=true href=#62-æƒé™è®¾è®¡æ€è·¯>#</a></h2><h2 id=63-xss-è„šæœ¬è¿‡æ»¤>6.3 XSS è„šæœ¬è¿‡æ»¤<a hidden class=anchor aria-hidden=true href=#63-xss-è„šæœ¬è¿‡æ»¤>#</a></h2><h2 id=64-sql-æ³¨å…¥>6.4 SQL æ³¨å…¥<a hidden class=anchor aria-hidden=true href=#64-sql-æ³¨å…¥>#</a></h2><h2 id=65-redis-ç¼“å­˜>6.5 Redis ç¼“å­˜<a hidden class=anchor aria-hidden=true href=#65-redis-ç¼“å­˜>#</a></h2><h2 id=66-å¼‚å¸¸å¤„ç†æœºåˆ¶>6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#66-å¼‚å¸¸å¤„ç†æœºåˆ¶>#</a></h2><h2 id=67-åç«¯æ•ˆéªŒæœºåˆ¶>6.7 åç«¯æ•ˆéªŒæœºåˆ¶<a hidden class=anchor aria-hidden=true href=#67-åç«¯æ•ˆéªŒæœºåˆ¶>#</a></h2><h2 id=68-ç³»ç»Ÿæ—¥å¿—>6.8 ç³»ç»Ÿæ—¥å¿—<a hidden class=anchor aria-hidden=true href=#68-ç³»ç»Ÿæ—¥å¿—>#</a></h2><h2 id=69-æ·»åŠ èœå•>6.9 æ·»åŠ èœå•<a hidden class=anchor aria-hidden=true href=#69-æ·»åŠ èœå•>#</a></h2><h2 id=610-æ·»åŠ è§’è‰²>6.10 æ·»åŠ è§’è‰²<a hidden class=anchor aria-hidden=true href=#610-æ·»åŠ è§’è‰²>#</a></h2><h2 id=611-æ·»åŠ ç®¡ç†å‘˜>6.11 æ·»åŠ ç®¡ç†å‘˜<a hidden class=anchor aria-hidden=true href=#611-æ·»åŠ ç®¡ç†å‘˜>#</a></h2><h2 id=612-å®šæ—¶ä»»åŠ¡æ¨¡å—>6.12 å®šæ—¶ä»»åŠ¡æ¨¡å—<a hidden class=anchor aria-hidden=true href=#612-å®šæ—¶ä»»åŠ¡æ¨¡å—>#</a></h2><h2 id=613-äº‘å­˜å‚¨æ¨¡å—>6.13 äº‘å­˜å‚¨æ¨¡å—<a hidden class=anchor aria-hidden=true href=#613-äº‘å­˜å‚¨æ¨¡å—>#</a></h2><h2 id=614-app-æ¨¡å—>6.14 APP æ¨¡å—<a hidden class=anchor aria-hidden=true href=#614-app-æ¨¡å—>#</a></h2><h2 id=61-å‰åç«¯åˆ†ç¦»-1>6.1 å‰åç«¯åˆ†ç¦»<a hidden class=anchor aria-hidden=true href=#61-å‰åç«¯åˆ†ç¦»-1>#</a></h2><blockquote><p>è¦å®ç°å‰åç«¯åˆ†ç¦»ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹ 2 ä¸ªé—®é¢˜ï¼š</p><p>1. é¡¹ç›®ä¸å†åŸºäºsessionäº†ï¼Œå¦‚ä½•çŸ¥é“è®¿é—®è€…æ˜¯è°ï¼Ÿ
1. å¦‚ä½•ç¡®è®¤è®¿é—®è€…çš„æƒé™ï¼Ÿ
3. å‰åç«¯åˆ†ç¦»</p></blockquote><ul><li>ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡tokenå®ç°ï¼Œæœ¬é¡¹ç›®ä¹Ÿæ˜¯ä¸€æ ·ï¼›ç”¨æˆ·ç™»å½•æ—¶ï¼Œç”ŸæˆtokenåŠtokenè¿‡æœŸæ—¶é—´ï¼Œtokenä¸ç”¨æˆ·æ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œè°ƒç”¨æ¥å£çš„æ—¶å€™ï¼ŒæŠŠtokenæ”¾åˆ°headeræˆ–è¯·æ±‚å‚æ•°ä¸­ï¼ŒæœåŠ¡ç«¯å°±çŸ¥é“æ˜¯è°åœ¨è°ƒç”¨æ¥å£ï¼Œç™»å½•å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * éªŒè¯ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;captcha.jpg&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>captcha</span><span style=color:#f92672>(</span>HttpServletResponse response<span style=color:#f92672>,</span> String uuid<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    response<span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cache-Control&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;no-store, no-cache&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    response<span style=color:#f92672>.</span><span style=color:#a6e22e>setContentType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;image/jpeg&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è·å–å›¾ç‰‡éªŒè¯ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    BufferedImage image <span style=color:#f92672>=</span> sysCaptchaService<span style=color:#f92672>.</span><span style=color:#a6e22e>getCaptcha</span><span style=color:#f92672>(</span>uuid<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    ServletOutputStream out <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ImageIO<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>image<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;jpg&#34;</span><span style=color:#f92672>,</span> out<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>out<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ç™»å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/login&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>login</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysLoginForm form<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> captcha <span style=color:#f92672>=</span> sysCaptchaService<span style=color:#f92672>.</span><span style=color:#a6e22e>validate</span><span style=color:#f92672>(</span>form<span style=color:#f92672>.</span><span style=color:#a6e22e>getUuid</span><span style=color:#f92672>(),</span> form<span style=color:#f92672>.</span><span style=color:#a6e22e>getCaptcha</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>captcha<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;éªŒè¯ç ä¸æ­£ç¡®&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserEntity user <span style=color:#f92672>=</span> sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryByUserName</span><span style=color:#f92672>(</span>form<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsername</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è´¦å·ä¸å­˜åœ¨ã€å¯†ç é”™è¯¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>user <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getPassword</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Sha256Hash<span style=color:#f92672>(</span>form<span style=color:#f92672>.</span><span style=color:#a6e22e>getPassword</span><span style=color:#f92672>(),</span> user<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Salt</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>toHex</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è´¦å·æˆ–å¯†ç ä¸æ­£ç¡®&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è´¦å·é”å®š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è´¦å·å·²è¢«é”å®š,è¯·è”ç³»ç®¡ç†å‘˜&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//ç”Ÿæˆtokenï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    R r <span style=color:#f92672>=</span> sysUserTokenService<span style=color:#f92672>.</span><span style=color:#a6e22e>createToken</span><span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ç”Ÿäº§token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>createToken</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//ç”Ÿæˆä¸€ä¸ªtokenï¼Œå¯ä»¥æ˜¯uuid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String token <span style=color:#f92672>=</span> TokenGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>generateValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//å½“å‰æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Date now <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è¿‡æœŸæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Date expireTime <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>now<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> EXPIRE <span style=color:#f92672>*</span> 1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//åˆ¤æ–­æ˜¯å¦ç”Ÿæˆè¿‡token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserTokenEntity tokenEntity <span style=color:#f92672>=</span> queryByUserId<span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tokenEntity <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        tokenEntity <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysUserTokenEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserId</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setToken</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setUpdateTime</span><span style=color:#f92672>(</span>now<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setExpireTime</span><span style=color:#f92672>(</span>expireTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//ä¿å­˜token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        save<span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setToken</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setUpdateTime</span><span style=color:#f92672>(</span>now<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setExpireTime</span><span style=color:#f92672>(</span>expireTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ›´æ–°token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        update<span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    R r <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>,</span> token<span style=color:#f92672>).</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;expire&#34;</span><span style=color:#f92672>,</span> EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œä¸‹é¢çš„è¿™è¡Œä»£ç ï¼Œæ˜¯åŠ ç›æ“ä½œï¼›å¯èƒ½æœ‰äººä¸ç†è§£ä¸ºä½•è¦åŠ ç›ï¼Œå…¶ç›®çš„æ˜¯é˜²æ­¢è¢«æ‹–åº“åï¼Œé»‘å®¢è½»æ˜“çš„ ï¼ˆé€šè¿‡å¯†ç åº“å¯¹æ¯”ï¼‰ï¼Œå°±èƒ½æ‹¿åˆ°ä½ çš„å¯†ç </p><pre tabindex=0><code>new Sha256Hash(password, user.getSalt()).toHex())
</code></pre><ul><li>è°ƒç”¨æ¥å£æ—¶ï¼Œæ¥å—ä¼ è¿‡æ¥çš„tokenåï¼Œå¦‚ä½•ä¿è¯tokenæœ‰æ•ˆåŠç”¨æˆ·æƒé™å‘¢ï¼Ÿå…¶å®ï¼Œshiroæä¾›äº† AuthenticatingFilteræŠ½è±¡ç±»ï¼Œç»§æ‰¿AuthenticatingFilteræŠ½è±¡ç±»å³å¯ã€‚</li></ul><p>æ­¥éª¤ 1 ï¼Œæ‰€æœ‰è¯·æ±‚å…¨éƒ¨æ‹’ç»è®¿é—®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isAccessAllowed</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>,</span> Object mappedValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æ­¥éª¤ 2 ï¼Œæ‹’ç»è®¿é—®çš„è¯·æ±‚ï¼Œä¼šè°ƒç”¨onAccessDeniedæ–¹æ³•ï¼ŒonAccessDeniedæ–¹æ³•å…ˆè·å–tokenï¼Œå†è°ƒç”¨ executeLoginæ–¹æ³•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onAccessDenied</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è·å–è¯·æ±‚tokenï¼Œå¦‚æœtokenä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› 401
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String token <span style=color:#f92672>=</span> getRequestToken<span style=color:#f92672>((</span>HttpServletRequest<span style=color:#f92672>)</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HttpServletResponse httpResponse <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HttpServletResponse<span style=color:#f92672>)</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String json <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_UNAUTHORIZED</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;invalid token&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        httpResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getWriter</span><span style=color:#f92672>().</span><span style=color:#a6e22e>print</span><span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> executeLogin<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * è·å–è¯·æ±‚çš„token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getRequestToken</span><span style=color:#f92672>(</span>HttpServletRequest httpRequest<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//ä»headerä¸­è·å–token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String token <span style=color:#f92672>=</span> httpRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//å¦‚æœheaderä¸­ä¸å­˜åœ¨tokenï¼Œåˆ™ä»å‚æ•°ä¸­è·å–token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        token <span style=color:#f92672>=</span> httpRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æ­¥éª¤ 3 ï¼Œé˜…è¯»AuthenticatingFilteræŠ½è±¡ç±»ä¸­executeLoginæ–¹æ³•ï¼Œæˆ‘ä»¬å‘ç°è°ƒç”¨äº† subject.login(token) ï¼Œè¿™æ˜¯shiroçš„ç™»å½•æ–¹æ³•ï¼Œä¸”éœ€è¦tokenå‚æ•°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰OAuth2Tokenç±»ï¼Œåªè¦å®ç°AuthenticationTokenæ¥å£ï¼Œå°±å¯ä»¥äº†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//AuthenticatingFilterç±»ä¸­çš„æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>executeLogin</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span>ServletResponse response<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    AuthenticationToken token<span style=color:#f92672>=</span>createToken<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>token<span style=color:#f92672>==</span><span style=color:#66d9ef>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        String msg<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;createToken method implementation returned null. A valid non-null A
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        uthenticationToken&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;must be created in order to execute a login attempt.&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Subject subject<span style=color:#f92672>=</span>getSubject<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        subject<span style=color:#f92672>.</span><span style=color:#a6e22e>login</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> onLoginSuccess<span style=color:#f92672>(</span>token<span style=color:#f92672>,</span>subject<span style=color:#f92672>,</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span><span style=color:#66d9ef>catch</span><span style=color:#f92672>(</span>AuthenticationException e<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> onLoginFailure<span style=color:#f92672>(</span>token<span style=color:#f92672>,</span>e<span style=color:#f92672>,</span>request<span style=color:#f92672>,</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//subject.login(token)ä¸­çš„tokenå¯¹è±¡ï¼Œéœ€è¦å®ç°AuthenticationTokenæ¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OAuth2Token</span> <span style=color:#66d9ef>implements</span> AuthenticationToken <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>OAuth2Token</span><span style=color:#f92672>(</span>String token<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPrincipal</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getCredentials</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æ­¥éª¤ 4 ï¼Œå®šä¹‰OAuth2Realmç±»ï¼Œå¹¶ç»§æ‰¿AuthorizingRealmæŠ½è±¡ç±»ï¼Œè°ƒç”¨ subject.login(token) æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨doGetAuthenticationInfoæ–¹æ³•ï¼Œè¿›è¡Œç™»å½•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * authenticationèº«ä»½è®¤è¯(ç™»å½•æ—¶è°ƒç”¨)
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 9. å‰é¢è¢«authcæ‹¦æˆªåï¼Œéœ€è¦è®¤è¯ï¼ŒSecurityBeanä¼šè°ƒç”¨è¿™é‡Œè¿›è¡Œè®¤è¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span><span style=color:#f92672>(</span>AuthenticationToken token<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> AuthenticationException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String accessToken <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>String<span style=color:#f92672>)</span> token<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrincipal</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//æ ¹æ®accessTokenï¼ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserTokenEntity tokenEntity <span style=color:#f92672>=</span> shiroService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryByToken</span><span style=color:#f92672>(</span>accessToken<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//tokenå¤±æ•ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>tokenEntity <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>getExpireTime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>&lt;</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IncorrectCredentialsException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tokenå¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 9.1. tokenç”Ÿæ•ˆæ‰èƒ½ç™»å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SysUserEntity user <span style=color:#f92672>=</span> shiroService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryUser</span><span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//è´¦å·é”å®š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> LockedAccountException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è´¦å·å·²è¢«é”å®š,è¯·è”ç³»ç®¡ç†å‘˜&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SimpleAuthenticationInfo info <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo<span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> accessToken<span style=color:#f92672>,</span> getName<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> info<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æ­¥éª¤ 5 ï¼Œç™»å½•å¤±è´¥åï¼Œåˆ™è°ƒç”¨onLoginFailureï¼Œè¿›è¡Œå¤±è´¥å¤„ç†ï¼Œæ•´ä¸ªæµç¨‹ç»“æŸ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onLoginFailure</span><span style=color:#f92672>(</span>AuthenticationToken token<span style=color:#f92672>,</span> AuthenticationException e<span style=color:#f92672>,</span> ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    HttpServletResponse httpResponse <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HttpServletResponse<span style=color:#f92672>)</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    httpResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>setContentType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;application/json;charset=utf-8&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å¤„ç†ç™»å½•å¤±è´¥çš„å¼‚å¸¸
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Throwable throwable <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getCause</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> e <span style=color:#f92672>:</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getCause</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        R r <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>SC_UNAUTHORIZED</span><span style=color:#f92672>,</span> throwable<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        String json <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        httpResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getWriter</span><span style=color:#f92672>().</span><span style=color:#a6e22e>print</span><span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æ­¥éª¤ 6 ï¼Œç™»å½•æˆåŠŸåï¼Œåˆ™è°ƒç”¨doGetAuthorizationInfoæ–¹æ³•ï¼ŒæŸ¥è¯¢ç”¨æˆ·çš„æƒé™ï¼Œå†è°ƒç”¨å…·ä½“çš„æ¥å£ï¼Œæ•´ä¸ªæµç¨‹ ç»“æŸ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * authorizationæˆæƒ(éªŒè¯æƒé™æ—¶è°ƒç”¨)
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 10. å‰é¢è¢«rolesæ‹¦æˆªåï¼Œéœ€è¦æˆæƒæ‰èƒ½ç™»å½•ï¼ŒSecurityManageréœ€è¦è°ƒç”¨è¿™é‡Œè¿›è¡Œæƒé™æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span><span style=color:#f92672>(</span>PrincipalCollection principals<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    SysUserEntity user <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>SysUserEntity<span style=color:#f92672>)</span>principals<span style=color:#f92672>.</span><span style=color:#a6e22e>getPrimaryPrincipal</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Long userId <span style=color:#f92672>=</span> user<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserId</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//ç”¨æˆ·æƒé™åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> permsSet <span style=color:#f92672>=</span> shiroService<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserPermissions</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SimpleAuthorizationInfo info <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SimpleAuthorizationInfo<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    info<span style=color:#f92672>.</span><span style=color:#a6e22e>setStringPermissions</span><span style=color:#f92672>(</span>permsSet<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> info<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=62-æƒé™è®¾è®¡æ€è·¯-1>6.2 æƒé™è®¾è®¡æ€è·¯<a hidden class=anchor aria-hidden=true href=#62-æƒé™è®¾è®¡æ€è·¯-1>#</a></h2><p>æƒé™ç›¸å…³çš„è¡¨ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/np520W.png alt></p><ol><li>sys_user[ç”¨æˆ·]è¡¨ï¼Œä¿å­˜ç”¨æˆ·ç›¸å…³æ•°æ®ï¼Œé€šè¿‡sys_user_role[ç”¨æˆ·ä¸è§’è‰²å…³è”]è¡¨ï¼Œä¸sys_role[è§’è‰²]è¡¨å…³è”ï¼›sys_menu[èœå•]è¡¨é€šè¿‡sys_role_menu[èœå•ä¸è§’è‰²å…³è”]è¡¨ï¼Œä¸sys_role[è§’è‰²]è¡¨å…³è”</li><li>sys_menuè¡¨ï¼Œä¿å­˜èœå•ç›¸å…³æ•°æ®ï¼Œå¹¶åœ¨permså­—æ®µé‡Œï¼Œä¿å­˜äº†shiroçš„æƒé™æ ‡è¯†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‹¥æœ‰æ­¤èœå•ï¼Œå°±æ‹¥æœ‰permså­—æ®µé‡Œçš„æ‰€æœ‰æƒé™ï¼Œæ¯”å¦‚ï¼ŒæŸç”¨æˆ·æ‹¥æœ‰çš„èœå•æƒé™æ ‡è¯† sys:user:info ï¼Œå°±å¯ä»¥è®¿é—®ä¸‹é¢çš„æ–¹æ³•</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/info/{userId}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:info&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> Long userId<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>åœ¨shiroé…ç½®ä»£ç é‡Œï¼Œé…ç½®ä¸º anon çš„ï¼Œè¡¨ç¤ºä¸ç»è¿‡shiroå¤„ç†ï¼Œé…ç½®ä¸º oauth2 çš„ï¼Œè¡¨ç¤ºç»è¿‡ OAuth2Filter å¤„ç†ï¼Œå‰åç«¯åˆ†ç¦»çš„æ¥å£ï¼Œéƒ½ä¼šäº¤ç»™ OAuth2Filterå¤„ç†ï¼Œè¿™æ ·å°±ä¿è¯ï¼Œæ²¡æœ‰æƒé™çš„è¯·æ±‚ï¼Œæ‹’ç»è®¿é—®</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Shiroé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShiroConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  Shiroè‡ªå¸¦çš„è¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®æ‹¦æˆªé¡µé¢
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;shiroFilter&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ShiroFilterFactoryBean <span style=color:#a6e22e>shiroFilter</span><span style=color:#f92672>(</span>SecurityManager securityManager<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1. åˆå§‹åŒ–ä¸€ä¸ªShiroFilterå·¥ç¨‹ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ShiroFilterFactoryBean shiroFilter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ShiroFilterFactoryBean<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2. æˆ‘ä»¬çŸ¥é“Shiroæ˜¯é€šè¿‡SecurityManageræ¥ç®¡ç†æ•´ä¸ªè®¤è¯å’Œæˆæƒæµç¨‹çš„ï¼Œè¿™ä¸ªSecurityManagerå¯ä»¥åœ¨ä¸‹é¢åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setSecurityManager</span><span style=color:#f92672>(</span>securityManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//è‡ªå®šä¹‰Oauth2Filterè¿‡æ»¤å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Filter<span style=color:#f92672>&gt;</span> filters <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        filters<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;oauth2&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> OAuth2Filter<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilters</span><span style=color:#f92672>(</span>filters<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3. ä¸Šé¢æˆ‘ä»¬è®²è¿‡ï¼Œæœ‰çš„é¡µé¢ä¸éœ€ç™»å½•ä»»ä½•äººå¯ä»¥ç›´æ¥è®¿é—®ï¼Œæœ‰çš„éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼Œæœ‰çš„ä¸ä»…è¦ç™»å½•è¿˜éœ€è¦ç›¸å…³æƒé™æ‰èƒ½è®¿é—®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> filterMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4. Shiroè¿‡æ»¤å™¨å¸¸ç”¨çš„æœ‰å¦‚ä¸‹å‡ ç§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 4.1. anon ä»»ä½•äººéƒ½èƒ½è®¿é—®ï¼Œå¦‚ç™»å½•é¡µé¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 4.2. authc éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼Œå¦‚ç³»ç»Ÿå†…çš„å…¨ä½“é€šçŸ¥é¡µé¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 4.3. roles éœ€è¦ç›¸åº”çš„è§’è‰²æ‰èƒ½è®¿é—®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/webjars/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/druid/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/login&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/swagger/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/v2/api-docs&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/swagger-ui.html&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/swagger-resources/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/captcha.jpg&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/aaa.txt&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;oauth2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 5. è®©ShiroFilteræŒ‰è¿™ä¸ªè§„åˆ™æ‹¦æˆª
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilterChainDefinitionMap</span><span style=color:#f92672>(</span>filterMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 6. ç”¨æˆ·æ²¡ç™»å½•è¢«æ‹¦æˆªåï¼Œå½“ç„¶éœ€è¦è°ƒè½¬åˆ°ç™»å½•é¡µäº†ï¼Œè¿™é‡Œé…ç½®ç™»å½•é¡µ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//shiroFilterFactoryBean.setLoginUrl(&#34;/api/user/login&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> shiroFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;securityManager&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SecurityManager <span style=color:#a6e22e>securityManager</span><span style=color:#f92672>(</span>OAuth2Realm oAuth2Realm<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 7. æ–°å»ºä¸€ä¸ªSecurityManagerä¾›ShiroFilterFactoryBeanä½¿ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DefaultWebSecurityManager securityManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultWebSecurityManager<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 8. SecurityManageræ—¢ç„¶ç®¡ç†è®¤è¯ç­‰ä¿¡æ¯ï¼Œé‚£ä»–å°±éœ€è¦ä¸€ä¸ªç±»æ¥å¸®ä»–æŸ¥æ•°æ®åº“å§ã€‚è¿™å°±æ˜¯Realmç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        securityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>setRealm</span><span style=color:#f92672>(</span>oAuth2Realm<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        securityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>setRememberMeManager</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> securityManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;lifecycleBeanPostProcessor&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> LifecycleBeanPostProcessor <span style=color:#a6e22e>lifecycleBeanPostProcessor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LifecycleBeanPostProcessor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> AuthorizationAttributeSourceAdvisor <span style=color:#a6e22e>authorizationAttributeSourceAdvisor</span><span style=color:#f92672>(</span>SecurityManager securityManager<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        AuthorizationAttributeSourceAdvisor advisor <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AuthorizationAttributeSourceAdvisor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        advisor<span style=color:#f92672>.</span><span style=color:#a6e22e>setSecurityManager</span><span style=color:#f92672>(</span>securityManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> advisor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=63-xss-è„šæœ¬è¿‡æ»¤-1>6.3 XSS è„šæœ¬è¿‡æ»¤<a hidden class=anchor aria-hidden=true href=#63-xss-è„šæœ¬è¿‡æ»¤-1>#</a></h2><blockquote><p>XSSè·¨ç«™è„šæœ¬æ”»å‡»çš„åŸºæœ¬åŸç†å’ŒSQLæ³¨å…¥æ”»å‡»ç±»ä¼¼ï¼Œéƒ½æ˜¯åˆ©ç”¨ç³»ç»Ÿæ‰§è¡Œäº†æœªç»è¿‡æ»¤çš„å±é™©ä»£ç ï¼Œä¸åŒç‚¹ åœ¨äºXSSæ˜¯ä¸€ç§åŸºäºç½‘é¡µè„šæœ¬çš„æ³¨å…¥æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å°†è„šæœ¬æ”»å‡»è½½è·å†™å…¥ç½‘é¡µæ‰§è¡Œä»¥è¾¾åˆ°å¯¹ç½‘é¡µå®¢æˆ·ç«¯è®¿é—®ç”¨æˆ·æ”»å‡»çš„ç›®çš„ï¼Œå±äºå®¢æˆ·ç«¯æ”»å‡»ã€‚ç¨‹åºå‘˜å¾€å¾€ä¸å¤ªå…³å¿ƒå®‰å…¨è¿™å—ï¼Œè¿™å°±ç»™æœ‰å¿ƒä¹‹äººï¼Œæä¾›äº†æœºä¼šï¼Œæœ¬ç³»ç»Ÿé’ˆå¯¹XSSæ”»å‡»ï¼Œæä¾›äº†è¿‡æ»¤åŠŸèƒ½ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢XSSæ”»å‡»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XssFilter</span> <span style=color:#66d9ef>implements</span> Filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>(</span>FilterConfig config<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ServletException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>ServletRequest request<span style=color:#f92672>,</span> ServletResponse response<span style=color:#f92672>,</span> FilterChain chain<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ServletException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        XssHttpServletRequestWrapper xssRequest <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> XssHttpServletRequestWrapper<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>(</span>HttpServletRequest<span style=color:#f92672>)</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        chain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>xssRequest<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FilterConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> FilterRegistrationBean <span style=color:#a6e22e>xssFilterRegistration</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        FilterRegistrationBean registration <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FilterRegistrationBean<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setDispatcherTypes</span><span style=color:#f92672>(</span>DispatcherType<span style=color:#f92672>.</span><span style=color:#a6e22e>REQUEST</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilter</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> XssFilter<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>addUrlPatterns</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/*&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xssFilter&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        registration<span style=color:#f92672>.</span><span style=color:#a6e22e>setOrder</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_VALUE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> registration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>è‡ªå®šä¹‰XssFilterè¿‡æ»¤å™¨ï¼Œç”¨æ¥è¿‡æ»¤æ‰€æœ‰è¯·æ±‚ï¼Œå…·ä½“è¿‡æ»¤è¿˜æ˜¯åœ¨XssHttpServletRequestWrapperé‡Œå®ç°çš„ï¼Œ å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XssHttpServletRequestWrapper</span> <span style=color:#66d9ef>extends</span> HttpServletRequestWrapper <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//æ²¡è¢«åŒ…è£…è¿‡çš„HttpServletRequestï¼ˆç‰¹æ®Šåœºæ™¯ï¼Œéœ€è¦è‡ªå·±è¿‡æ»¤ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    HttpServletRequest orgRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//htmlè¿‡æ»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> HTMLFilter htmlFilter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HTMLFilter<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>XssHttpServletRequestWrapper</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        orgRequest <span style=color:#f92672>=</span> request<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ServletInputStream <span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//éjsonç±»å‹ï¼Œç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_JSON_VALUE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span><span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>CON</span>
</span></span><span style=display:flex><span>                TENT_TYPE<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ä¸ºç©ºï¼Œç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String json <span style=color:#f92672>=</span> IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(</span><span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;utf-8&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>json<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//xssè¿‡æ»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        json <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>json<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> ByteArrayInputStream bis <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>json<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;utf-8&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ServletInputStream<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isFinished</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isReady</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setReadListener</span><span style=color:#f92672>(</span>ReadListener readListener<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> bis<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span>xssEncode<span style=color:#f92672>(</span>name<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotBlank</span><span style=color:#f92672>(</span>value<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getParameterValues</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String<span style=color:#f92672>[]</span> parameters <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterValues</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parameters <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            parameters<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>parameters<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> parameters<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>[]&gt;</span> <span style=color:#a6e22e>getParameterMap</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>[]&gt;</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>[]&gt;</span> parameters <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String key <span style=color:#f92672>:</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>keySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String<span style=color:#f92672>[]</span> values <span style=color:#f92672>=</span> parameters<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> values<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                values<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>values<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> values<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> map<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>xssEncode<span style=color:#f92672>(</span>name<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotBlank</span><span style=color:#f92672>(</span>value<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> xssEncode<span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>xssEncode</span><span style=color:#f92672>(</span>String input<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> htmlFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>input<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å–æœ€åŸå§‹çš„request
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HttpServletRequest <span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> orgRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å–æœ€åŸå§‹çš„request
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> HttpServletRequest <span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>request <span style=color:#66d9ef>instanceof</span> XssHttpServletRequestWrapper<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>((</span>XssHttpServletRequestWrapper<span style=color:#f92672>)</span> request<span style=color:#f92672>).</span><span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> request<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>å¦‚æœéœ€è¦å¤„ç†å¯Œæ–‡æœ¬æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ XssHttpServletRequestWrapper.getOrgRequest(request) ï¼Œæ‹¿åˆ°åŸå§‹ çš„ request å¯¹è±¡åï¼Œå†è‡ªè¡Œå¤„ç†å¯Œæ–‡æœ¬æ•°æ®ï¼Œå¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>data</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        HttpServletRequest orgRequest<span style=color:#f92672>=</span>XssHttpServletRequestWrapper<span style=color:#f92672>.</span><span style=color:#a6e22e>getOrgRequest</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        String content<span style=color:#f92672>=</span>orgRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;content&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å¯Œæ–‡æœ¬æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>content<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=64-sql-æ³¨å…¥-1>6.4 SQL æ³¨å…¥<a hidden class=anchor aria-hidden=true href=#64-sql-æ³¨å…¥-1>#</a></h2><blockquote><p>æœ¬ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Mybatisï¼Œå¦‚æœä½¿ç”¨${}æ‹¼æ¥SQLï¼Œåˆ™å­˜åœ¨SQLæ³¨å…¥é£é™©ï¼Œå¯ä»¥å¯¹å‚æ•°è¿›è¡Œè¿‡æ»¤ï¼Œé¿å… SQLæ³¨å…¥ï¼Œå¦‚ä¸‹:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SQLFilter</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * SQLæ³¨å…¥è¿‡æ»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param str å¾…éªŒè¯çš„å­—ç¬¦ä¸²
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>sqlInject</span><span style=color:#f92672>(</span>String str<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>str<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å»æ‰&#39;|&#34;|;|\å­—ç¬¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;\&#34;&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;;&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        str <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;\\&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//è½¬æ¢æˆå°å†™\
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        str <span style=color:#f92672>=</span> str<span style=color:#f92672>.</span><span style=color:#a6e22e>toLowerCase</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//éæ³•å­—ç¬¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String<span style=color:#f92672>[]</span> keywords <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;master&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;truncate&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;insert&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;select&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;delete&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;update&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;declare&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;alter&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;drop&#34;</span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//åˆ¤æ–­æ˜¯å¦åŒ…å«éæ³•å­—ç¬¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String keyword <span style=color:#f92672>:</span> keywords<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>str<span style=color:#f92672>.</span><span style=color:#a6e22e>indexOf</span><span style=color:#f92672>(</span>keyword<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;åŒ…å«éæ³•å­—ç¬¦&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> str<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>åƒæŸ¥è¯¢åˆ—è¡¨ï¼Œæ¶‰åŠæ’åºé—®é¢˜ï¼Œæ’åºå­—æ®µæ˜¯ä»å‰å°ä¼ è¿‡æ¥çš„ï¼Œåˆ™å­˜åœ¨SQLæ³¨å…¥é£é™©ï¼Œéœ€ç»å¦‚ä¸‹å¤„ç†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Query</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IPage<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPage</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getPage</span><span style=color:#f92672>(</span>params<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IPage<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPage</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>,</span> String defaultOrderField<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isAsc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//åˆ†é¡µå‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> curPage <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> limit <span style=color:#f92672>=</span> 10<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>PAGE</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            curPage <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>PAGE</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>LIMIT</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            limit <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>LIMIT</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//åˆ†é¡µå¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Page<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> page <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Page<span style=color:#f92672>&lt;&gt;(</span>curPage<span style=color:#f92672>,</span> limit<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//åˆ†é¡µå‚æ•° 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        params<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>PAGE</span><span style=color:#f92672>,</span> page<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ’åºå­—æ®µ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//é˜²æ­¢SQLæ³¨å…¥ï¼ˆå› ä¸ºsidxã€orderæ˜¯é€šè¿‡æ‹¼æ¥SQLå®ç°æ’åºçš„ï¼Œä¼šæœ‰SQLæ³¨å…¥é£é™©ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String orderField <span style=color:#f92672>=</span> SQLFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>sqlInject</span><span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>ORDER_FIELD</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        String order <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>String<span style=color:#f92672>)</span> params<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>ORDER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å‰ç«¯å­—æ®µæ’åº
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotEmpty</span><span style=color:#f92672>(</span>orderField<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotEmpty</span><span style=color:#f92672>(</span>order<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>ASC</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equalsIgnoreCase</span><span style=color:#f92672>(</span>order<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> page<span style=color:#f92672>.</span><span style=color:#a6e22e>setAsc</span><span style=color:#f92672>(</span>orderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> page<span style=color:#f92672>.</span><span style=color:#a6e22e>setDesc</span><span style=color:#f92672>(</span>orderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//é»˜è®¤æ’åº
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isAsc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            page<span style=color:#f92672>.</span><span style=color:#a6e22e>setAsc</span><span style=color:#f92672>(</span>defaultOrderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            page<span style=color:#f92672>.</span><span style=color:#a6e22e>setDesc</span><span style=color:#f92672>(</span>defaultOrderField<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> page<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=65-redis-ç¼“å­˜-1>6.5 Redis ç¼“å­˜<a hidden class=anchor aria-hidden=true href=#65-redis-ç¼“å­˜-1>#</a></h2><blockquote><p>ç¼“å­˜å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œä½†èƒ½å¦çµæ´»è¿ç”¨ï¼Œå°±ä¸ä¸€å®šäº†ã€‚ä¸€èˆ¬è®¾è®¡ç¼“å­˜æ¶æ„æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä¸‹å‡ ä¸ªé—® é¢˜ï¼š</p></blockquote><ol><li><p>æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå°½é‡å‡å°‘DBæŸ¥è¯¢ï¼ŒDBä¸»è¦è´Ÿè´£å†™æ•°æ®</p></li><li><p>å°½é‡ä¸ä½¿ç”¨ LEFT JOIN ç­‰å…³è”æŸ¥è¯¢ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¸é«˜ï¼Œè¿˜æµªè´¹å†…å­˜</p></li><li><p>å¤šä½¿ç”¨å•è¡¨æŸ¥è¯¢ï¼Œç¼“å­˜å‘½ä¸­ç‡æœ€é«˜</p></li><li><p>æ•°æ®åº“ insert ã€ update ã€ delete æ—¶ï¼ŒåŒæ­¥æ›´æ–°ç¼“å­˜æ•°æ®</p></li><li><p>åˆç†è¿ç”¨Redisæ•°æ®ç»“æ„ï¼Œä¹Ÿè®¸æœ‰è´¨çš„é£è·ƒ</p></li><li><p>å¯¹äºè®¿é—®é‡ä¸å¤§çš„é¡¹ç›®ï¼Œä½¿ç”¨ç¼“å­˜åªä¼šå¢åŠ é¡¹ç›®çš„å¤æ‚åº¦</p></li></ol><p>æœ¬ç³»ç»Ÿé‡‡ç”¨Redisä½œä¸ºç¼“å­˜ï¼Œå¹¶å¯é…ç½®æ˜¯å¦å¼€å¯redisç¼“å­˜ï¼Œä¸»è¦è¿˜æ˜¯é€šè¿‡Spring AOPå®ç°çš„ï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre tabindex=0><code>redis:
  database: 0
  host: localhost
  port: 6379
  password: # å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰
  timeout: 6000ms # è¿æ¥è¶…æ—¶æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
  jedis:
    pool:
      max-active: 1000 # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
      max-wait: -1ms # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
      max-idle: 10 # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
      min-idle: 5 # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
renren:
  redis:
  	open: false #æ˜¯å¦å¼€å¯redisç¼“å­˜ trueå¼€å¯ falseå…³é—­
</code></pre><p>æœ¬é¡¹ç›®ä¸­ï¼Œä½¿ç”¨RedisæœåŠ¡çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysConfigServiceImpl</span> <span style=color:#66d9ef>implements</span> SysConfigService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysConfigDao sysConfigDao<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysConfigRedis sysConfigRedis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>saveOrUpdate</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>saveOrUpdate</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateValueByKey</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> String value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>updateValueByKey</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteBatch</span><span style=color:#f92672>(</span>Long<span style=color:#f92672>[]</span> ids<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sysConfigDao<span style=color:#f92672>.</span><span style=color:#a6e22e>deleteBatch</span><span style=color:#f92672>(</span>ids<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Long id <span style=color:#f92672>:</span> ids<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            SysConfigEntity config <span style=color:#f92672>=</span> queryObject<span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            sysConfigRedis<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysConfigRedis</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisUtils redisUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveOrUpdate</span><span style=color:#f92672>(</span>SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        String key <span style=color:#f92672>=</span> RedisKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>getSysConfigKey</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        redisUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>String configKey<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String key <span style=color:#f92672>=</span> RedisKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>getSysConfigKey</span><span style=color:#f92672>(</span>configKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        redisUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SysConfigEntity <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String configKey<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String key <span style=color:#f92672>=</span> RedisKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>getSysConfigKey</span><span style=color:#f92672>(</span>configKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redisUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> SysConfigEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisTemplate<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> redisTemplate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ValueOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> valueOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> HashOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> hashOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ListOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> listOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SetOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> setOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ZSetOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> zSetOperations<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * é»˜è®¤è¿‡æœŸæ—¶é•¿ï¼Œå•ä½ï¼šç§’
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>long</span> DEFAULT_EXPIRE <span style=color:#f92672>=</span> 60 <span style=color:#f92672>*</span> 60 <span style=color:#f92672>*</span> 24<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ä¸è®¾ç½®è¿‡æœŸæ—¶é•¿
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>long</span> NOT_EXPIRE <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> Gson gson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Object value<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        valueOperations<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> toJson<span style=color:#f92672>(</span>value<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>expire <span style=color:#f92672>!=</span> NOT_EXPIRE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> expire<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Object value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        set<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> DEFAULT_EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> valueOperations<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>expire <span style=color:#f92672>!=</span> NOT_EXPIRE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> expire<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> fromJson<span style=color:#f92672>(</span>value<span style=color:#f92672>,</span> clazz<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> clazz<span style=color:#f92672>,</span> NOT_EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#f92672>=</span> valueOperations<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>expire <span style=color:#f92672>!=</span> NOT_EXPIRE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> expire<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> NOT_EXPIRE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Objectè½¬æˆJSONæ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>Object object<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>object <span style=color:#66d9ef>instanceof</span> Integer <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> Long <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> Float <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                object <span style=color:#66d9ef>instanceof</span> Double <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> Boolean <span style=color:#f92672>||</span> object <span style=color:#66d9ef>instanceof</span> St
</span></span><span style=display:flex><span>                ring<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>object<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>object<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * JSONæ•°æ®ï¼Œè½¬æˆObject
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>String json<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>fromJson</span><span style=color:#f92672>(</span>json<span style=color:#f92672>,</span> clazz<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>å¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œè®¤ä¸ºè¿™ä¸ªé¡¹ç›®å¿…é¡»è¦é…ç½®Redisç¼“å­˜ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼Œå› ä¸ºæœ‰æ“ä½œRedisçš„ä»£ç ï¼Œå…¶å®ä¸ ç„¶ï¼Œé€šè¿‡Spring AOPï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ï¼Œæ˜¯å¦çœŸçš„ä½¿ç”¨Redisï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisAspect</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ˜¯å¦å¼€å¯redisç¼“å­˜ trueå¼€å¯ falseå…³é—­
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${renren.redis.open: false}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> open<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;execution(* io.renren.common.utils.RedisUtils.*(..))&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>around</span><span style=color:#f92672>(</span>ProceedingJoinPoint point<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Object result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>open<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                result <span style=color:#f92672>=</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;redis error&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RedisæœåŠ¡å¼‚å¸¸&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=66-å¼‚å¸¸å¤„ç†æœºåˆ¶-1>6.6 å¼‚å¸¸å¤„ç†æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#66-å¼‚å¸¸å¤„ç†æœºåˆ¶-1>#</a></h2><blockquote><p>æœ¬é¡¹ç›®é€šè¿‡RRExceptionå¼‚å¸¸ç±»ï¼ŒæŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼ŒRRExceptionç»§æ‰¿RuntimeExceptionï¼Œä¸èƒ½ç»§æ‰¿ Exceptionï¼Œå¦‚æœç»§æ‰¿Exceptionï¼Œåˆ™Springäº‹åŠ¡ä¸ä¼šå›æ»šã€‚</p></blockquote><p>RRExceptionä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RRException</span> <span style=color:#66d9ef>extends</span> RuntimeException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> serialVersionUID <span style=color:#f92672>=</span> 1L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> code <span style=color:#f92672>=</span> 500<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>,</span> Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RRException</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> code<span style=color:#f92672>,</span> Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getMsg</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setMsg</span><span style=color:#f92672>(</span>String msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>å¦‚ä½•å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸å‘¢ï¼Œæˆ‘ä»¬å®šä¹‰äº†RRExceptionHandlerç±»ï¼Œå¹¶åŠ ä¸Šæ³¨è§£@RestControllerAdviceï¼Œå°±å¯ä»¥å¤„ç†æ‰€æœ‰æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¹¶è¿”å›JSONæ•°æ®ã€‚@RestControllerAdviceæ˜¯ç”±@ControllerAdviceã€@ResponseBodyæ³¨è§£ç»„åˆè€Œæ¥çš„ï¼Œå¯ä»¥æŸ¥æ‰¾@ControllerAdviceç›¸å…³çš„èµ„æ–™ï¼Œç†è§£@ControllerAdviceæ³¨è§£ çš„ä½¿ç”¨ã€‚</p></blockquote><p>RRExceptionHandlerä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestControllerAdvice</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RRExceptionHandler</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * å¤„ç†è‡ªå®šä¹‰å¼‚å¸¸
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>RRException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleRRException</span><span style=color:#f92672>(</span>RRException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        R r <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> R<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;code&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>DuplicateKeyException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleDuplicateKeyException</span><span style=color:#f92672>(</span>DuplicateKeyException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;æ•°æ®åº“ä¸­å·²å­˜åœ¨è¯¥è®°å½•&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>AuthorizationException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleAuthorizationException</span><span style=color:#f92672>(</span>AuthorizationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;æ²¡æœ‰æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æˆæƒ&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>Exception<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>handleException</span><span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=67-åç«¯æ•ˆéªŒæœºåˆ¶-1>6.7 åç«¯æ•ˆéªŒæœºåˆ¶<a hidden class=anchor aria-hidden=true href=#67-åç«¯æ•ˆéªŒæœºåˆ¶-1>#</a></h2><blockquote><p>æœ¬é¡¹ç›®ï¼Œåç«¯æ•ˆéªŒä½¿ç”¨çš„æ˜¯Hibernate Validatoræ ¡éªŒæ¡†æ¶ï¼Œä¸”è‡ªå®šä¹‰ValidatorUtilså·¥å…·ç±»ï¼Œç”¨æ¥æ•ˆéªŒæ•° æ®ã€‚</p></blockquote><p>Hibernate Validatorå®˜æ–¹æ–‡æ¡£ï¼š <a href=http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/>http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/</a>
ValidatorUtilsä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ValidatorUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Validator validator<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        validator <span style=color:#f92672>=</span> Validation<span style=color:#f92672>.</span><span style=color:#a6e22e>buildDefaultValidatorFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getValidator</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ ¡éªŒå¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param object å¾…æ ¡éªŒå¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param groups å¾…æ ¡éªŒçš„ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @throws RRException æ ¡éªŒä¸é€šè¿‡ï¼Œåˆ™æŠ¥RRExceptionå¼‚å¸¸
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>Object object<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;...</span> groups<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RRException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Set<span style=color:#f92672>&lt;</span>ConstraintViolation<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;&gt;</span> constraintViolations <span style=color:#f92672>=</span> validator<span style=color:#f92672>.</span><span style=color:#a6e22e>validate</span><span style=color:#f92672>(</span>object<span style=color:#f92672>,</span> groups<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>constraintViolations<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ConstraintViolation<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> constraint <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ConstraintViolation<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;)</span> constraintV
</span></span><span style=display:flex><span>            iolations<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>().</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span>constraint<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ä½¿ç”¨æ¡ˆä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysUserController</span> <span style=color:#66d9ef>extends</span> AbstractController <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ä¿å­˜ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SysLog</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¿å­˜ç”¨æˆ·&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysUserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ä¿å­˜ç”¨æˆ·æ—¶ï¼Œæ•ˆéªŒSysUserEntityé‡Œï¼Œå¸¦æœ‰AddGroupæ³¨è§£çš„å±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateUserId</span><span style=color:#f92672>(</span>getUserId<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ä¿®æ”¹ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SysLog</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¿®æ”¹ç”¨æˆ·&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>update</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysUserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ä¿®æ”¹ç”¨æˆ·æ—¶ï¼Œæ•ˆéªŒSysUserEntityé‡Œï¼Œå¸¦æœ‰UpdateGroupæ³¨è§£çš„å±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateUserId</span><span style=color:#f92672>(</span>getUserId<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysUserEntity</span> <span style=color:#66d9ef>implements</span> Serializable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ç”¨æˆ·ID
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long userId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ç”¨æˆ·å
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * å¯†ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;å¯†ç ä¸èƒ½ä¸ºç©º&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ç›
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String salt<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * é‚®ç®±
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;é‚®ç®±ä¸èƒ½ä¸ºç©º&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Email</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&#34;</span><span style=color:#f92672>,</span> groups <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> UpdateGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String email<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ‰‹æœºå·
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String mobile<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     0ï¼šç¦ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>     1ï¼šæ­£å¸¸
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer status<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è§’è‰²IDåˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> roleIdList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * åˆ›å»ºè€…ID
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long createUserId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * åˆ›å»ºæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Date createTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>é€šè¿‡åˆ†æä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬æ¥ç†è§£Hibernate Validatoræ ¡éªŒæ¡†æ¶çš„ä½¿ç”¨ã€‚ å…¶ä¸­ï¼Œusernameå±æ€§ï¼Œè¡¨ç¤ºä¿å­˜æˆ–ä¿®æ”¹ç”¨æˆ·æ—¶ï¼Œéƒ½ä¼šæ•ˆéªŒusernameå±æ€§ï¼›è€Œpasswordå±æ€§ï¼Œè¡¨ç¤ºåªæœ‰ä¿å­˜ç”¨æˆ·æ—¶ï¼Œæ‰ä¼šæ•ˆéªŒpasswordå±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¿®æ”¹ç”¨æˆ·æ—¶ï¼Œpasswordå¯ä»¥ä¸å¡«å†™ï¼Œå…è®¸ä¸ºç©ºã€‚</p><p>å¦‚æœä¸æŒ‡å®šå±æ€§çš„groupsï¼Œåˆ™é»˜è®¤å±äºjavax.validation.groups.Default.classåˆ†ç»„ï¼Œå¯ä»¥é€šè¿‡ValidatorUtils.validateEntity(user)è¿›è¡Œæ•ˆéªŒã€‚</p><h2 id=68-ç³»ç»Ÿæ—¥å¿—-1>6.8 ç³»ç»Ÿæ—¥å¿—<a hidden class=anchor aria-hidden=true href=#68-ç³»ç»Ÿæ—¥å¿—-1>#</a></h2><p>ç³»ç»Ÿæ—¥å¿—æ˜¯é€šè¿‡Spring AOPå®ç°çš„ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†æ³¨è§£ @SysLog ï¼Œä¸”åªèƒ½åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>(</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>METHOD</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> SysLog <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>value</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>default</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ä¸‹é¢æ˜¯è‡ªå®šä¹‰æ³¨è§£ @SysLog çš„ä½¿ç”¨æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysUserController</span> <span style=color:#66d9ef>extends</span> AbstractController <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SysLog</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¿å­˜ç”¨æˆ·&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:user:save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysUserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> AddGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateUserId</span><span style=color:#f92672>(</span>getUserId<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        sysUserService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåªéœ€è¦åœ¨ä¿å­˜æ—¥å¿—çš„è¯·æ±‚æ–¹æ³•ä¸Šï¼ŒåŠ ä¸Š @SysLog æ³¨è§£ï¼Œå°±å¯ä»¥æŠŠæ—¥å¿—ä¿å­˜åˆ°æ•°æ®åº“é‡Œäº†ã€‚ å…·ä½“æ˜¯åœ¨å“ªé‡ŒæŠŠæ•°æ®ä¿å­˜åˆ°æ•°æ®åº“é‡Œçš„å‘¢ï¼Œæˆ‘ä»¬å®šä¹‰äº† SysLogAspect å¤„ç†ç±»ï¼Œå°±æ˜¯æ¥å¹²è¿™äº‹çš„ï¼Œå¦‚ä¸‹æ‰€ ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ç³»ç»Ÿæ—¥å¿—ï¼Œåˆ‡é¢å¤„ç†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysLogAspect</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SysLogService sysLogService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;@annotation(io.renren.common.annotation.SysLog)&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logPointCut</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;logPointCut()&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>around</span><span style=color:#f92672>(</span>ProceedingJoinPoint point<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> beginTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ‰§è¡Œæ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object result <span style=color:#f92672>=</span> point<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ‰§è¡Œæ—¶é•¿(æ¯«ç§’)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ä¿å­˜æ—¥å¿—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        saveSysLog<span style=color:#f92672>(</span>point<span style=color:#f92672>,</span> time<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveSysLog</span><span style=color:#f92672>(</span>ProceedingJoinPoint joinPoint<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> time<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        MethodSignature signature <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>MethodSignature<span style=color:#f92672>)</span> joinPoint<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Method method <span style=color:#f92672>=</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        SysLogEntity sysLog <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysLogEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        SysLog syslog <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>SysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>syslog <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ³¨è§£ä¸Šçš„æè¿°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setOperation</span><span style=color:#f92672>(</span>syslog<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è¯·æ±‚çš„æ–¹æ³•å
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String className <span style=color:#f92672>=</span> joinPoint<span style=color:#f92672>.</span><span style=color:#a6e22e>getTarget</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        String methodName <span style=color:#f92672>=</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setMethod</span><span style=color:#f92672>(</span>className <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;()&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è¯·æ±‚çš„å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> joinPoint<span style=color:#f92672>.</span><span style=color:#a6e22e>getArgs</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String params <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>args<span style=color:#f92672>[</span>0<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setParams</span><span style=color:#f92672>(</span>params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è·å–request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HttpServletRequest request <span style=color:#f92672>=</span> HttpContextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHttpServletRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è®¾ç½®IPåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setIp</span><span style=color:#f92672>(</span>IPUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getIpAddr</span><span style=color:#f92672>(</span>request<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ç”¨æˆ·å
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String username <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>SysUserEntity<span style=color:#f92672>)</span> SecurityUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubject</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getPrincipal</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>getUser</span>
</span></span><span style=display:flex><span>        name<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setUsername</span><span style=color:#f92672>(</span>username<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setTime</span><span style=color:#f92672>(</span>time<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sysLog<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateDate</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ä¿å­˜ç³»ç»Ÿæ—¥å¿—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sysLogService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>sysLog<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>SysLogAspect ç±»å®šä¹‰äº†ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œè¯·æ±‚ @SysLog æ³¨è§£çš„æ–¹æ³•æ—¶ï¼Œä¼šè¿›å…¥ aroundæ–¹æ³•ï¼ŒæŠŠç³»ç»Ÿæ—¥å¿—ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</p><h2 id=69-æ·»åŠ èœå•-1>6.9 æ·»åŠ èœå•<a hidden class=anchor aria-hidden=true href=#69-æ·»åŠ èœå•-1>#</a></h2><blockquote><p>èœå•ç®¡ç†ï¼Œä¸»è¦æ˜¯å¯¹ã€ç›®å½•ã€èœå•ã€æŒ‰é’®ã€‘è¿›è¡ŒåŠ¨æ€çš„æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œï¼Œæ–¹ä¾¿å¼€å‘è€…ç®¡ç†èœå•ã€‚</p></blockquote><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/G7kxHE.png alt></p><p>ä¸Šå›¾æ˜¯æ‹¿ç°æœ‰çš„èœå•è¿›è¡Œè®²è§£ã€‚å…¶ä¸­ï¼Œæˆæƒæ ‡è¯†ä¸shiroä¸­çš„æ³¨è§£@RequiresPermissionsï¼Œå®šä¹‰çš„æˆæƒæ ‡è¯†æ˜¯ ä¸€ä¸€å¯¹åº”çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sys/config&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SysConfigController</span> <span style=color:#66d9ef>extends</span> AbstractController <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:list&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>list</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/info/{id}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:info&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:save&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:update&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>update</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> SysConfigEntity config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/delete&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequiresPermissions</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sys:config:delete&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> Long<span style=color:#f92672>[]</span> ids<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=610-æ·»åŠ è§’è‰²-1>6.10 æ·»åŠ è§’è‰²<a hidden class=anchor aria-hidden=true href=#610-æ·»åŠ è§’è‰²-1>#</a></h2><blockquote><p>ç®¡ç†å‘˜æƒé™æ˜¯é€šè¿‡è§’è‰²è¿›è¡Œç®¡ç†çš„ï¼Œç»™ç®¡ç†å‘˜åˆ†é…æƒé™æ—¶ï¼Œè¦å…ˆåˆ›å»ºå¥½è§’è‰²ã€‚</p></blockquote><p>ä¸‹é¢åˆ›å»ºäº†ä¸€ä¸ªã€å¼€å‘è§’è‰²ã€‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/qsBkIQ.png alt></p><h2 id=611-æ·»åŠ ç®¡ç†å‘˜-1>6.11 æ·»åŠ ç®¡ç†å‘˜<a hidden class=anchor aria-hidden=true href=#611-æ·»åŠ ç®¡ç†å‘˜-1>#</a></h2><blockquote><p>æœ¬ç³»ç»Ÿé»˜è®¤å°±åˆ›å»ºäº†adminè´¦å·ï¼Œæ— éœ€åˆ†é…ä»»ä½•è§’è‰²ï¼Œå°±æ‹¥æœ‰æœ€é«˜æƒé™ã€‚ ä¸€ä¸ªç®¡ç†å‘˜æ˜¯å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’ è‰²çš„ã€‚</p></blockquote><p>ä¸‹é¢åˆ›å»ºä¸€ä¸ªã€zhangsanã€‘çš„ç®¡ç†å‘˜è´¦å·ï¼Œå¹¶å±äºã€å¼€å‘è§’è‰²ã€‘ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/xyolW8.png alt></p><h2 id=612-å®šæ—¶ä»»åŠ¡æ¨¡å—-1>6.12 å®šæ—¶ä»»åŠ¡æ¨¡å—<a hidden class=anchor aria-hidden=true href=#612-å®šæ—¶ä»»åŠ¡æ¨¡å—-1>#</a></h2><blockquote><p>æœ¬ç³»ç»Ÿä½¿ç”¨å¼€æºæ¡†æ¶Quartzï¼Œå®ç°çš„å®šæ—¶ä»»åŠ¡ï¼Œå·²å®ç°åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ï¼Œå¯éƒ¨ç½²å¤šå°æœåŠ¡å™¨ï¼Œä¸é‡å¤æ‰§è¡Œï¼Œä»¥åŠåŠ¨æ€å¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€æš‚åœã€æ¢å¤ã€ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚ Quartzè‡ªå¸¦äº†å„æ•°æ®åº“çš„SQLè„šæœ¬ï¼Œå¦‚æœæƒ³æ›´æ”¹æˆå…¶ä»–æ•°æ®åº“ï¼Œå¯å‚è€ƒQuartzç›¸åº”çš„SQLè„šæœ¬ã€‚</p></blockquote><h3 id=6121-æ–°å¢å®šæ—¶ä»»åŠ¡>6.12.1 æ–°å¢å®šæ—¶ä»»åŠ¡<a hidden class=anchor aria-hidden=true href=#6121-æ–°å¢å®šæ—¶ä»»åŠ¡>#</a></h3><p>æ–°å¢ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå…¶å®å¾ˆç®€å•ï¼Œåªè¦å®šä¹‰ä¸€ä¸ªæ™®é€šçš„Spring Beanå³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;testTask&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestTask</span> <span style=color:#66d9ef>implements</span> ITask <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>String params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;TestTaskå®šæ—¶ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œå‚æ•°ä¸ºï¼š{}&#34;</span><span style=color:#f92672>,</span> params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>å¦‚ä½•è®©Quartzï¼Œå®šæ—¶æ‰§è¡ŒtestTaské‡Œçš„æ–¹æ³•å‘¢ï¼Ÿåªéœ€è¦åœ¨ç®¡ç†åå°ï¼Œæ–°å¢ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/j1UF4l.png alt></p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/9d5CTr.png alt></p><p>åˆšæ‰é…ç½®çš„å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš” 30 åˆ†é’Ÿï¼Œå°±ä¼šè°ƒç”¨TestTaskçš„testæ–¹æ³•äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å•Šã€‚</p><h4 id=6122-æºç åˆ†æ>6.12.2 æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#6122-æºç åˆ†æ>#</a></h4><p>Quartzæä¾›äº†ç›¸å…³çš„APIï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨APIï¼Œå¯¹Quartzè¿›è¡Œå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€æš‚åœã€æ¢å¤ã€ç«‹å³æ‰§è¡Œç­‰ã€‚ æœ¬ç³»ç»Ÿä¸­ï¼Œ ScheduleUtils ç±»å°±æ˜¯å¯¹Quartz APIè¿›è¡Œçš„å°è£…ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScheduleUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String JOB_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TASK_&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å–è§¦å‘å™¨key
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> TriggerKey <span style=color:#a6e22e>getTriggerKey</span><span style=color:#f92672>(</span>Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> TriggerKey<span style=color:#f92672>.</span><span style=color:#a6e22e>triggerKey</span><span style=color:#f92672>(</span>JOB_NAME <span style=color:#f92672>+</span> jobId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å–jobKey
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> JobKey <span style=color:#a6e22e>getJobKey</span><span style=color:#f92672>(</span>Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> JobKey<span style=color:#f92672>.</span><span style=color:#a6e22e>jobKey</span><span style=color:#f92672>(</span>JOB_NAME <span style=color:#f92672>+</span> jobId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å–è¡¨è¾¾å¼è§¦å‘å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> CronTrigger <span style=color:#a6e22e>getCronTrigger</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>CronTrigger<span style=color:#f92672>)</span> scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>getTrigger</span><span style=color:#f92672>(</span>getTriggerKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;getCronTriggerå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥qrtzå¼€å¤´çš„è¡¨ï¼Œæ˜¯å¦æœ‰è„æ•°æ®&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * åˆ›å»ºå®šæ—¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createScheduleJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> ScheduleJobEntity scheduleJob<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ„å»ºjobä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            JobDetail jobDetail <span style=color:#f92672>=</span> JobBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newJob</span><span style=color:#f92672>(</span>ScheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getJobKey
</span></span><span style=display:flex><span>                    <span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è¡¨è¾¾å¼è°ƒåº¦æ„å»ºå™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            CronScheduleBuilder scheduleBuilder <span style=color:#f92672>=</span> CronScheduleBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>cronSchedule</span><span style=color:#f92672>(</span>scheduleJo
</span></span><span style=display:flex><span>                    b<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronExpression</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>withMisfireHandlingInstructionDoNothing</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æŒ‰æ–°çš„cronExpressionè¡¨è¾¾å¼æ„å»ºä¸€ä¸ªæ–°çš„trigger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            CronTrigger trigger <span style=color:#f92672>=</span> TriggerBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newTrigger</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getTriggerKey<span style=color:#f92672>(</span>sche
</span></span><span style=display:flex><span>                    duleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span>
</span></span><span style=display:flex><span>                    withSchedule<span style=color:#f92672>(</span>scheduleBuilder<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ”¾å…¥å‚æ•°ï¼Œè¿è¡Œæ—¶çš„æ–¹æ³•å¯ä»¥è·å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            jobDetail<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobDataMap</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    scheduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleJob</span><span style=color:#f92672>(</span>jobDetail<span style=color:#f92672>,</span> trigger<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æš‚åœä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> ScheduleStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>PAUSE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                pauseJob<span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ›´æ–°å®šæ—¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateScheduleJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> ScheduleJobEntity scheduleJob<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            TriggerKey triggerKey <span style=color:#f92672>=</span> getTriggerKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è¡¨è¾¾å¼è°ƒåº¦æ„å»ºå™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            CronScheduleBuilder scheduleBuilder <span style=color:#f92672>=</span> CronScheduleBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>cronSchedule</span><span style=color:#f92672>(</span>scheduleJo
</span></span><span style=display:flex><span>                    b<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronExpression</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>withMisfireHandlingInstructionDoNothing</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            CronTrigger trigger <span style=color:#f92672>=</span> getCronTrigger<span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æŒ‰æ–°çš„cronExpressionè¡¨è¾¾å¼é‡æ–°æ„å»ºtrigger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            trigger <span style=color:#f92672>=</span> trigger<span style=color:#f92672>.</span><span style=color:#a6e22e>getTriggerBuilder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>triggerKey<span style=color:#f92672>).</span><span style=color:#a6e22e>withSchedule</span><span style=color:#f92672>(</span>sched
</span></span><span style=display:flex><span>                    uleBuilder<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            trigger<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobDataMap</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>sc
</span></span><span style=display:flex><span>                    heduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>rescheduleJob</span><span style=color:#f92672>(</span>triggerKey<span style=color:#f92672>,</span> trigger<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æš‚åœä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> ScheduleStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>PAUSE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                pauseJob<span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;æ›´æ–°å®šæ—¶ä»»åŠ¡å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ç«‹å³æ‰§è¡Œä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> ScheduleJobEntity scheduleJob<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            JobDataMap dataMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JobDataMap<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            dataMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>triggerJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>()),</span> dataMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æš‚åœä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pauseJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>pauseJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;æš‚åœå®šæ—¶ä»»åŠ¡å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ¢å¤ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resumeJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;æš‚åœå®šæ—¶ä»»åŠ¡å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * åˆ é™¤å®šæ—¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteScheduleJob</span><span style=color:#f92672>(</span>Scheduler scheduler<span style=color:#f92672>,</span> Long jobId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>deleteJob</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>jobId<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SchedulerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯å‡ ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ï¼š</p><ul><li><p>createScheduleJobã€åˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‘ï¼šåœ¨ç®¡ç†åå°æ–°å¢ä»»åŠ¡æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼ŒæŠŠä»»åŠ¡æ·»åŠ åˆ°Quartz ä¸­ï¼Œå†æ ¹æ®cronè¡¨è¾¾å¼ï¼Œå®šæ—¶æ‰§è¡Œä»»åŠ¡ã€‚</p></li><li><p>updateScheduleJobã€æ›´æ–°å®šæ—¶ä»»åŠ¡ã€‘ï¼šä¿®æ”¹ä»»åŠ¡æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¿®æ”¹Quartzä¸­çš„ä»»åŠ¡ä¿¡æ¯ã€‚</p></li><li><p>runã€ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‘ï¼šé©¬ä¸Šæ‰§è¡Œä¸€æ¬¡è¯¥ä»»åŠ¡ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚</p></li><li><p>pauseJobã€æš‚åœå®šæ—¶ä»»åŠ¡ã€‘ï¼šè¿™ä¸ªä¸æ˜¯æš‚åœæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œæ˜¯ä»¥åä¸å†æ‰§è¡Œè¿™ä¸ªå®šæ—¶ä»»åŠ¡äº†ã€‚æ­£åœ¨ æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿˜æ˜¯ç…§å¸¸æ‰§è¡Œå®Œã€‚</p></li><li><p>resumeJobã€æ¢å¤å®šæ—¶ä»»åŠ¡ã€‘ï¼šè¿™ä¸ªæ˜¯é’ˆå¯¹pauseJobæ¥çš„ï¼Œå¦‚æœä»»åŠ¡æš‚åœäº†ï¼Œä»¥åéƒ½ä¸ä¼šå†æ‰§è¡Œï¼Œè¦æƒ³å†æ‰§è¡Œï¼Œåˆ™éœ€è¦è°ƒç”¨resumeJobï¼Œä½¿å®šæ—¶ä»»åŠ¡æ¢å¤æ‰§è¡Œã€‚</p></li><li><p>deleteScheduleJobã€åˆ é™¤å®šæ—¶ä»»åŠ¡ã€‘ï¼šåˆ é™¤å®šæ—¶ä»»åŠ¡</p></li></ul><p>å…¶ä¸­ï¼Œ <code>createScheduleJob</code> ã€ <code>updateScheduleJob</code> åœ¨å¯åŠ¨é¡¹ç›®çš„æ—¶å€™ï¼Œä¹Ÿä¼šè°ƒç”¨ï¼ŒæŠŠæ•°æ®åº“é‡Œï¼Œæ–°å¢æˆ–ä¿® æ”¹çš„ä»»åŠ¡ï¼Œæ›´æ–°åˆ°Quartzä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;scheduleJobService&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScheduleJobServiceImpl</span> <span style=color:#66d9ef>implements</span> ScheduleJobService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * é¡¹ç›®å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–å®šæ—¶å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>ScheduleJobEntity<span style=color:#f92672>&gt;</span> scheduleJobList <span style=color:#f92672>=</span> schedulerJobDao<span style=color:#f92672>.</span><span style=color:#a6e22e>queryList</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ScheduleJobEntity scheduleJob <span style=color:#f92672>:</span> scheduleJobList<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            CronTrigger cronTrigger <span style=color:#f92672>=</span> ScheduleUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronTrigger</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cronTrigger <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                ScheduleUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>createScheduleJob</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                ScheduleUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>updateScheduleJob</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>å¤§å®¶æ˜¯ä¸æ˜¯è¿˜æœ‰ç–‘é—®å‘¢ï¼Œæ€ä¹ˆå°±èƒ½å®šæ—¶æ‰§è¡Œï¼Œåˆšæ‰åœ¨ç®¡ç†åå°æ–°å¢çš„ä»»åŠ¡testTaskå‘¢ï¼Ÿ ä¸‹é¢æˆ‘ä»¬å†æ¥åˆ†æ ä¸‹ createScheduleJob æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡çš„æ—¶å€™ï¼Œè¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//æ„å»ºä¸€ä¸ªæ–°çš„å®šæ—¶ä»»åŠ¡ï¼ŒJobBuilder.newJob()åªèƒ½æ¥å—Jobç±»å‹çš„å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e>//æŠŠScheduleJob.classä½œä¸ºå‚æ•°ä¼ è¿›å»ï¼ŒScheduleJobç»§æ‰¿QuartzJobBeanï¼Œè€ŒQuartzJobBeanå®ç°äº†Jobæ¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>JobDetail jobDetail<span style=color:#f92672>=</span>JobBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newJob</span><span style=color:#f92672>(</span>ScheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getJobKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ„å»ºcronï¼Œå®šæ—¶ä»»åŠ¡çš„å‘¨æœŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CronScheduleBuilder scheduleBuilder<span style=color:#f92672>=</span>CronScheduleBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>cronSchedule</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getCronExpression</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>withMisfireHandlingInstructionDoNothing</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ ¹æ®cronï¼Œæ„å»ºä¸€ä¸ªCronTrigger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CronTrigger trigger<span style=color:#f92672>=</span>TriggerBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>newTrigger</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withIdentity</span><span style=color:#f92672>(</span>getTriggerKey<span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>withSchedule</span><span style=color:#f92672>(</span>scheduleBuilder<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ”¾å…¥å‚æ•°ï¼Œè¿è¡Œæ—¶çš„æ–¹æ³•å¯ä»¥è·å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        jobDetail<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobDataMap</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>,</span><span style=color:#66d9ef>new</span> Gson<span style=color:#f92672>().</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æŠŠä»»åŠ¡æ·»åŠ åˆ°Quartzä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        scheduler<span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleJob</span><span style=color:#f92672>(</span>jobDetail<span style=color:#f92672>,</span>trigger<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>æŠŠä»»åŠ¡æ·»åŠ åˆ° Quartz åï¼Œç­‰cronå®šä¹‰çš„æ—¶é—´å‘¨æœŸåˆ°äº†ï¼Œå°±ä¼šæ‰§è¡Œ ScheduleJob ç±»çš„ executeInternal æ–¹ æ³•ï¼Œ ScheduleJob ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScheduleJob</span> <span style=color:#66d9ef>extends</span> QuartzJobBean <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>executeInternal</span><span style=color:#f92672>(</span>JobExecutionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> JobExecutionException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ScheduleJobEntity scheduleJob <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>)</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getMergedJobDataMap</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>ScheduleJobEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>JOB_PARAM_KEY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//è·å–spring bean
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ScheduleJobLogService scheduleJobLogService <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ScheduleJobLogService<span style=color:#f92672>)</span> SpringContextUt
</span></span><span style=display:flex><span>        ils<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;scheduleJobLogService&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ•°æ®åº“ä¿å­˜æ‰§è¡Œè®°å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ScheduleJobLogEntity log <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ScheduleJobLogEntity<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setJobId</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setBeanName</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setParams</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getParams</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>setCreateTime</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//ä»»åŠ¡å¼€å§‹æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//æ‰§è¡Œä»»åŠ¡ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä»»åŠ¡å‡†å¤‡æ‰§è¡Œï¼Œä»»åŠ¡IDï¼š&#34;</span> <span style=color:#f92672>+</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Object target <span style=color:#f92672>=</span> SpringContextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span>scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            Method method <span style=color:#f92672>=</span> target<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredMethod</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;run&#34;</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            method<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>target<span style=color:#f92672>,</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getParams</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//ä»»åŠ¡æ‰§è¡Œæ€»æ—¶é•¿ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>long</span> times <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> startTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setTimes</span><span style=color:#f92672>((</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> times<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//ä»»åŠ¡çŠ¶æ€ 0 ï¼šæˆåŠŸ 1 ï¼šå¤±è´¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä»»åŠ¡IDï¼š&#34;</span> <span style=color:#f92672>+</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; æ€»å…±è€—æ—¶ï¼š&#34;</span> <span style=color:#f92672>+</span> tim es <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;æ¯«ç§’&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œä»»åŠ¡IDï¼š&#34;</span> <span style=color:#f92672>+</span> scheduleJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getJobId</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//ä»»åŠ¡æ‰§è¡Œæ€»æ—¶é•¿
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>long</span> times <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> startTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setTimes</span><span style=color:#f92672>((</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> times<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//ä»»åŠ¡çŠ¶æ€ 0 ï¼šæˆåŠŸ 1 ï¼šå¤±è´¥ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span><span style=color:#a6e22e>setError</span><span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(),</span> 0<span style=color:#f92672>,</span> 2000<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduleJobLogService<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>log<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=613-äº‘å­˜å‚¨æ¨¡å—-1>6.13 äº‘å­˜å‚¨æ¨¡å—<a hidden class=anchor aria-hidden=true href=#613-äº‘å­˜å‚¨æ¨¡å—-1>#</a></h2><blockquote><p>å›¾ç‰‡ã€æ–‡ä»¶ä¸Šä¼ ï¼Œä½¿ç”¨çš„æ˜¯ä¸ƒç‰›ã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘çš„å­˜å‚¨æœåŠ¡ï¼Œä¸èƒ½ä¸Šä¼ åˆ°æœ¬åœ°æœåŠ¡å™¨ã€‚ä¸Šä¼ åˆ°æœ¬åœ° æœåŠ¡å™¨ï¼Œä¸åˆ©äºç»´æŠ¤ï¼Œè®¿é—®é€Ÿåº¦æ…¢ç­‰ç¼ºç‚¹ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨äº‘å­˜å‚¨æœåŠ¡ã€‚</p></blockquote><h3 id=6131-ä¸ƒç‰›çš„é…ç½®>6.13.1 ä¸ƒç‰›çš„é…ç½®<a hidden class=anchor aria-hidden=true href=#6131-ä¸ƒç‰›çš„é…ç½®>#</a></h3><blockquote><p>å¦‚æœæ²¡æœ‰ä¸ƒç‰›è´¦å·ï¼Œåˆ™éœ€è¦æ³¨å†Œä¸ƒç‰›è´¦å·ï¼Œæ‰èƒ½è¿›è¡Œé…ç½®ï¼Œä¸‹é¢æ¼”ç¤ºæ³¨å†Œä¸ƒç‰›è´¦å·å¹¶é…ç½®ï¼Œæ­¥éª¤å¦‚ ä¸‹ï¼š</p></blockquote><ol><li>[æ³¨å†Œä¸ƒç‰›è´¦å·][34]ï¼Œå¹¶ç™»å½•åï¼Œå†åˆ›å»ºä¸ƒç‰›ç©ºé—´ï¼Œå¦‚ä¸‹å›¾ï¼š</li></ol><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/86h4oq.png alt></p><ol start=2><li>è¿›å…¥ç®¡ç†åç«¯ï¼Œå¡«å†™ä¸ƒç‰›é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ï¼š</li></ol><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tkisAZ.png alt></p><p>å¿…å¡«é¡¹æœ‰åŸŸåã€AccessKeyã€SecretKeyã€ç©ºé—´åã€‚å…¶ä¸­ï¼Œç©ºé—´åå°±æ˜¯æ‰åˆ›å»ºçš„ç©ºé—´å ios-app ï¼Œå¡«è¿›å»å°±å¯ ä»¥äº†ã€‚åŸŸåã€AccessKeyã€SecretKeyå¯ä»¥é€šè¿‡ä¸‹å›¾æ‰¾åˆ°ï¼š</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/v0K61m.png alt></p><h3 id=6132-é˜¿é‡Œäº‘çš„é…ç½®>6.13.2 é˜¿é‡Œäº‘çš„é…ç½®<a hidden class=anchor aria-hidden=true href=#6132-é˜¿é‡Œäº‘çš„é…ç½®>#</a></h3><ul><li>è¿›å…¥ç®¡ç†åç«¯ï¼Œå¡«å†™é˜¿é‡Œäº‘é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/bHjijJ.png alt></p><ul><li>è¿›å»é˜¿é‡Œäº‘ç®¡ç†åå°ï¼Œå¹¶åˆ›å»ºBucketï¼Œå¦‚ä¸‹å›¾ï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/zEeaHL.png alt></p><ul><li>é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°åŸŸåã€BucketNameã€EndPoint</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tB5WLW.png alt></p><ul><li>é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°AccessKeyIdã€AccessKeySecret</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/DIzny3.png alt></p><h4 id=6133-è…¾è®¯äº‘çš„é…ç½®>6.13.3 è…¾è®¯äº‘çš„é…ç½®<a hidden class=anchor aria-hidden=true href=#6133-è…¾è®¯äº‘çš„é…ç½®>#</a></h4><ul><li>è¿›å…¥ç®¡ç†åç«¯ï¼Œå¡«å†™è…¾è®¯äº‘é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/lH6UMH.png alt></p><ul><li>è¿›å»è…¾è®¯äº‘ç®¡ç†åå°ï¼Œå¹¶åˆ›å»ºBucketï¼Œå¦‚ä¸‹å›¾ï¼š</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/UGXMhL.png alt></p><ul><li>é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°åŸŸåã€BucketNameã€Bucketæ‰€å±åœ°åŒº</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/rLnoLL.png alt></p><ul><li>é€šè¿‡ä¸‹é¢çš„ç•Œé¢ï¼Œå¯ä»¥æ‰¾åˆ°AppIdã€SecretIdã€SecretKey</li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7XxX9S.png alt></p><h4 id=6134-æºç åˆ†æ>6.13.4 æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#6134-æºç åˆ†æ>#</a></h4><p>æœ¬é¡¹ç›®çš„æ–‡ä»¶ä¸Šä¼ ï¼Œä½¿ç”¨çš„æ˜¯ä¸ƒç‰›ã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼Œåˆ™éœ€è¦å¼•å…¥ä»–ä»¬çš„SDKï¼Œå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.qiniu<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>qiniu-java-sdk<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${qiniu.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;groupId&gt;</span>com.aliyun.oss<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;artifactId&gt;</span>aliyun-sdk-oss<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;version&gt;</span>${aliyun.oss.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;groupId&gt;</span>com.qcloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;artifactId&gt;</span>cos_api<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;version&gt;</span>${qcloud.cos.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>org.slf4j<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>slf4j-log4j12<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>å®šä¹‰æŠ½è±¡ç±» CloudStorageService ï¼Œç”¨æ¥å£°æ˜ä¸Šä¼ çš„å…¬å…±æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CloudStorageService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * äº‘å­˜å‚¨é…ç½®ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    CloudStorageConfig config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ–‡ä»¶è·¯å¾„
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param prefix å‰ç¼€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param suffix åç¼€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return è¿”å›ä¸Šä¼ è·¯å¾„
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPath</span><span style=color:#f92672>(</span>String prefix<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//ç”Ÿæˆuuid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String uuid <span style=color:#f92672>=</span> UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>().</span><span style=color:#a6e22e>replaceAll</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ–‡ä»¶è·¯å¾„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String path <span style=color:#f92672>=</span> DateUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;yyyyMMdd&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> uuid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isNotBlank</span><span style=color:#f92672>(</span>prefix<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            path <span style=color:#f92672>=</span> prefix <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> path <span style=color:#f92672>+</span> suffix<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ–‡ä»¶ä¸Šä¼ 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param data æ–‡ä»¶å­—èŠ‚æ•°ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param path æ–‡ä»¶è·¯å¾„ï¼ŒåŒ…å«æ–‡ä»¶å
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return è¿”å›httpåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ–‡ä»¶ä¸Šä¼ 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param data   æ–‡ä»¶å­—èŠ‚æ•°ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param suffix åç¼€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return è¿”å›httpåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ–‡ä»¶ä¸Šä¼ 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param inputStream å­—èŠ‚æµ
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param path        æ–‡ä»¶è·¯å¾„ï¼ŒåŒ…å«æ–‡ä»¶å
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return è¿”å›httpåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * æ–‡ä»¶ä¸Šä¼ 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param inputStream å­—èŠ‚æµ
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param suffix      åç¼€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return è¿”å›httpåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>ä¸ƒç‰›ä¸Šä¼ çš„å®ç°ï¼Œåªéœ€ç»§æ‰¿ CloudStorageService ï¼Œå¹¶å®ç°ç›¸åº”çš„ä¸Šä¼ æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.common.Zone<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.http.Response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.storage.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.storage.UploadManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qiniu.util.Auth<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.io.IOUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ä¸ƒç‰›äº‘å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QiniuCloudStorageService</span> <span style=color:#66d9ef>extends</span> CloudStorageService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UploadManager uploadManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>QiniuCloudStorageService</span><span style=color:#f92672>(</span>CloudStorageConfig config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        init<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        uploadManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UploadManager<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Configuration<span style=color:#f92672>(</span>Zone<span style=color:#f92672>.</span><span style=color:#a6e22e>autoZone</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        token <span style=color:#f92672>=</span> Auth<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuAccessKey</span><span style=color:#f92672>(),</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuSecretKey</span><span style=color:#f92672>()).</span>
</span></span><span style=display:flex><span>                uploadToken<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuBucketName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Response res <span style=color:#f92672>=</span> uploadManager<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> path<span style=color:#f92672>,</span> token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>res<span style=color:#f92672>.</span><span style=color:#a6e22e>isOK</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¸Šä¼ ä¸ƒç‰›å‡ºé”™ï¼š&#34;</span> <span style=color:#f92672>+</span> res<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ ¸å¯¹ä¸ƒç‰›é…ç½®ä¿¡æ¯&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuDomain</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data <span style=color:#f92672>=</span> IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¸Šä¼ æ–‡ä»¶å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQiniuPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>é˜¿é‡Œäº‘ä¸Šä¼ çš„å®ç°ï¼Œåªéœ€ç»§æ‰¿ CloudStorageService ï¼Œå¹¶å®ç°ç›¸åº”çš„ä¸Šä¼ æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤º</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.aliyun.oss.OSSClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.ByteArrayInputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * é˜¿é‡Œäº‘å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AliyunCloudStorageService</span> <span style=color:#66d9ef>extends</span> CloudStorageService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OSSClient client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>AliyunCloudStorageService</span><span style=color:#f92672>(</span>CloudStorageConfig config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        init<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OSSClient<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunEndPoint</span><span style=color:#f92672>(),</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunAccessKeyId</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunAccessKeySecret</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>data<span style=color:#f92672>),</span> path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span><span style=color:#a6e22e>putObject</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunBucketName</span><span style=color:#f92672>(),</span> path<span style=color:#f92672>,</span> inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ä¿¡æ¯&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunDomain</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getAliyunPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>è…¾è®¯äº‘ä¸Šä¼ çš„å®ç°ï¼Œåªéœ€ç»§æ‰¿ CloudStorageService ï¼Œå¹¶å®ç°ç›¸åº”çš„ä¸Šä¼ æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.COSClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.ClientConfig<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.request.UploadFileRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.qcloud.cos.sign.Credentials<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.sf.json.JSONObject<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.io.IOUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * è…¾è®¯äº‘å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Mark sunlightcs@gmail.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QcloudCloudStorageService</span> <span style=color:#66d9ef>extends</span> CloudStorageService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> COSClient client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>QcloudCloudStorageService</span><span style=color:#f92672>(</span>CloudStorageConfig config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        init<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Credentials credentials <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Credentials<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudAppId</span><span style=color:#f92672>(),</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudSe</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>cretId</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudSecretKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//åˆå§‹åŒ–å®¢æˆ·ç«¯é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ClientConfig clientConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClientConfig<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è®¾ç½®bucketæ‰€åœ¨çš„åŒºåŸŸï¼Œåå—ï¼šgz ååŒ—ï¼štj åä¸œï¼šsh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        clientConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>setRegion</span><span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudRegion</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> COSClient<span style=color:#f92672>(</span>clientConfig<span style=color:#f92672>,</span> credentials<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è…¾è®¯äº‘å¿…éœ€è¦ä»¥&#34;/&#34;å¼€å¤´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>path<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ä¸Šä¼ åˆ°è…¾è®¯äº‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        UploadFileRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UploadFileRequest<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudBucketName</span><span style=color:#f92672>(),</span> path<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        String response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>uploadFile</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        JSONObject jsonObject <span style=color:#f92672>=</span> JSONObject<span style=color:#f92672>.</span><span style=color:#a6e22e>fromObject</span><span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>jsonObject<span style=color:#f92672>.</span><span style=color:#a6e22e>getInt</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;code&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œ&#34;</span> <span style=color:#f92672>+</span> jsonObject<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;message&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudDomain</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String path<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data <span style=color:#f92672>=</span> IOUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¸Šä¼ æ–‡ä»¶å¤±è´¥&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSuffix</span><span style=color:#f92672>(</span>InputStream inputStream<span style=color:#f92672>,</span> String suffix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> upload<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>,</span> getPath<span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getQcloudPrefix</span><span style=color:#f92672>(),</span> suffix<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>å¯¹å¤–æä¾›äº†OSSFactoryå·¥å‚ï¼Œå¯æ–¹ä¾¿ä¸šåŠ¡çš„è°ƒç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OSSFactory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> SysConfigService sysConfigService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        OSSFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>sysConfigService</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>SysConfigService<span style=color:#f92672>)</span> SpringContextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sysConfi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                gService&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> CloudStorageService <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è·å–äº‘å­˜å‚¨é…ç½®ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CloudStorageConfig config <span style=color:#f92672>=</span> sysConfigService<span style=color:#f92672>.</span><span style=color:#a6e22e>getConfigObject</span><span style=color:#f92672>(</span>ConfigConstant<span style=color:#f92672>.</span><span style=color:#a6e22e>CLOUD_STO</span>
</span></span><span style=display:flex><span>                RAGE_CONFIG_KEY<span style=color:#f92672>,</span> CloudStorageConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>CloudService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>QINIU</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> QiniuCloudStorageService<span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>CloudService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ALIYUN</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AliyunCloudStorageService<span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Constant<span style=color:#f92672>.</span><span style=color:#a6e22e>CloudService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>QCLOUD</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> QcloudCloudStorageService<span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>æ–‡ä»¶ä¸Šä¼ çš„ä¾‹å­ï¼Œå¦‚ä¸‹ï¼š @RequestMapping("/upload")</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/upload&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;file&#34;</span><span style=color:#f92672>)</span> MultipartFile file<span style=color:#f92672>)</span><span style=color:#66d9ef>throws</span> Exception<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>()){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ä¸Šä¼ æ–‡ä»¶ä¸èƒ½ä¸ºç©º&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//ä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶è¿”å›æ–‡ä»¶çš„httpåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String url<span style=color:#f92672>=</span>OSSFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>().</span><span style=color:#a6e22e>upload</span><span style=color:#f92672>(</span>file<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=614-app-æ¨¡å—-1>6.14 APP æ¨¡å—<a hidden class=anchor aria-hidden=true href=#614-app-æ¨¡å—-1>#</a></h2><blockquote><p>APPæ¨¡å—ï¼Œæ˜¯é’ˆå¯¹APPä½¿ç”¨çš„ï¼Œå¦‚IOSã€Androidç­‰ï¼Œä¸»è¦æ˜¯è§£å†³ç”¨æˆ·è®¤è¯çš„é—®é¢˜ã€‚</p></blockquote><h3 id=6141-app-çš„ä½¿ç”¨>6.14.1 APP çš„ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#6141-app-çš„ä½¿ç”¨>#</a></h3><blockquote><p>APPçš„è®¾è®¡æ€è·¯ï¼šç”¨æˆ·é€šè¿‡APPï¼Œè¾“å…¥æ‰‹æœºå·ã€å¯†ç ç™»å½•åï¼Œç³»ç»Ÿä¼šç”Ÿæˆä¸ç™»å½•ç”¨æˆ·ä¸€ä¸€å¯¹åº”çš„ tokenï¼Œç”¨æˆ·è°ƒç”¨éœ€è¦ç™»å½•çš„æ¥å£æ—¶ï¼Œåªéœ€æŠŠtokenä¼ è¿‡æ¥ï¼ŒæœåŠ¡ç«¯å°±çŸ¥é“æ˜¯è°åœ¨è®¿é—®æ¥å£ï¼Œtokenå¦‚æœè¿‡æœŸï¼Œåˆ™æ‹’ç»è®¿é—®ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p></blockquote><p>ä½¿ç”¨å¾ˆç®€å•ï¼Œçœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå°±ä¼šä½¿ç”¨äº†ã€‚ä»”ç»†è§‚å¯Ÿï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œæœ‰ 2 ä¸ªè‡ªå®šä¹‰çš„æ³¨è§£ã€‚å…¶ä¸­ï¼Œ @LoginUseræ³¨è§£æ˜¯è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæœ‰å“ªäº›ä¿¡æ¯ï¼Œä¸‹é¢ä¼šåˆ†æçš„ã€‚@Loginæ³¨è§£åˆ™æ˜¯éœ€è¦ç”¨æˆ·è®¤è¯ï¼Œæ²¡æœ‰ç™»å½•çš„ç”¨æˆ·ï¼Œä¸èƒ½è®¿é—®è¯¥æ¥å£ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.annotation.Login<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.annotation.LoginUser<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.GetMapping<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestAttribute<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMapping<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RestController<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiTestController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Login</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userInfo&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>userInfo</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@LoginUser</span> UserEntity user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>,</span> user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å–ç”¨æˆ·ID
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Login</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>userInfo</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>)</span> Integer userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>,</span> userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * å¿½ç•¥TokenéªŒè¯æµ‹è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;notToken&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>notToken</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;æ— éœ€tokenä¹Ÿèƒ½è®¿é—®ã€‚ã€‚ã€‚&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=6142-æºç åˆ†æ>6.14.2 æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#6142-æºç åˆ†æ>#</a></h3><ul><li>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼ŒAPPç”¨æˆ·ç™»å½•çš„æ—¶å€™ï¼Œéƒ½å¹²äº†é‚£äº›äº‹æƒ…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;APPç™»å½•æ¥å£&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiLoginController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserService userService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> JwtUtils jwtUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ç™»å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;login&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ç™»å½•&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>login</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> LoginForm form<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//è¡¨å•æ ¡éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ValidatorUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>validateEntity</span><span style=color:#f92672>(</span>form<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//ç”¨æˆ·ç™»å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> userId <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>login</span><span style=color:#f92672>(</span>form<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//ç”Ÿæˆtoken
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String token <span style=color:#f92672>=</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>generateToken</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;token&#34;</span><span style=color:#f92672>,</span> token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;expire&#34;</span><span style=color:#f92672>,</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getExpire</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>(</span>map<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * jwtå·¥å…·ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;renren.jwt&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JwtUtils</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String secret<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> expire<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String header<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ç”Ÿæˆjwt token
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>generateToken</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Date nowDate <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//è¿‡æœŸæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Date expireDate <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>nowDate<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> expire <span style=color:#f92672>*</span> 1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Jwts<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeaderParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;typ&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;JWT&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setSubject</span><span style=color:#f92672>(</span>userId <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setIssuedAt</span><span style=color:#f92672>(</span>nowDate<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setExpiration</span><span style=color:#f92672>(</span>expireDate<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>signWith</span><span style=color:#f92672>(</span>SignatureAlgorithm<span style=color:#f92672>.</span><span style=color:#a6e22e>HS512</span><span style=color:#f92672>,</span> secret<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>compact</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Claims <span style=color:#a6e22e>getClaimByToken</span><span style=color:#f92672>(</span>String token<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Jwts<span style=color:#f92672>.</span><span style=color:#a6e22e>parser</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>setSigningKey</span><span style=color:#f92672>(</span>secret<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>parseClaimsJws</span><span style=color:#f92672>(</span>token<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;validate is token error &#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * tokenæ˜¯å¦è¿‡æœŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return trueï¼šè¿‡æœŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isTokenExpired</span><span style=color:#f92672>(</span>Date expiration<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> expiration<span style=color:#f92672>.</span><span style=color:#a6e22e>before</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getSecret</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> secret<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setSecret</span><span style=color:#f92672>(</span>String secret<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>secret</span> <span style=color:#f92672>=</span> secret<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getExpire</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> expire<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setExpire</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> expire<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span> <span style=color:#f92672>=</span> expire<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> header<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>String header<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>header</span> <span style=color:#f92672>=</span> header<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä»ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·æ¯æ¬¡ç™»å½•çš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„tokenï¼Œè¿™ä¸ªtokenæ˜¯é€šè¿‡jwtç”Ÿæˆ çš„ã€‚</p><ul><li>APPæ¨¡å—çš„æ ¸å¿ƒé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.interceptor.AuthorizationInterceptor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.resolver.LoginUserHandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WebMvcConfig</span> <span style=color:#66d9ef>extends</span> WebMvcConfigurerAdapter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> AuthorizationInterceptor authorizationInterceptor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LoginUserHandlerMethodArgumentResolver loginUserHandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addInterceptors</span><span style=color:#f92672>(</span>InterceptorRegistry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        registry<span style=color:#f92672>.</span><span style=color:#a6e22e>addInterceptor</span><span style=color:#f92672>(</span>authorizationInterceptor<span style=color:#f92672>).</span><span style=color:#a6e22e>addPathPatterns</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app/**&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addArgumentResolvers</span><span style=color:#f92672>(</span>List<span style=color:#f92672>&lt;</span>HandlerMethodArgumentResolver<span style=color:#f92672>&gt;</span> argumentResolvers<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        argumentResolvers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>loginUserHandlerMethodArgumentResolver<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé…ç½®äº†ä¸ªInterceptorï¼Œç”¨æ¥æ‹¦æˆª /app å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ï¼Œæ‹¦æˆªåï¼Œä¼šåˆ° AuthorizationInterceptorç±»preHandleæ–¹æ³•å¤„ç†ã€‚åªæœ‰ä»¥ /appå¼€å¤´çš„è¯·æ±‚ï¼ŒAPIæ¨¡å—è®¤è¯æ‰ä¼šèµ·ä½œç”¨ï¼Œå¦‚æœè¦ä»¥/api å¼€å¤´ï¼Œåˆ™éœ€è¦ä¿®æ”¹æ­¤å¤„ã€‚è¿˜é…ç½®äº†argumentResolverï¼Œåˆ«å¿½ç•¥äº†å•Šï¼Œä¸‹é¢ä¼šè®²è§£ã€‚</p><p>æ¸©é¦¨æç¤ºï¼Œåˆ«å¿˜äº†é…ç½®shiroï¼Œä¸ç„¶ä¼šè¢«shiroæ‹¦æˆªæ‰çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShiroConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;shiroFilter&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ShiroFilterFactoryBean <span style=color:#a6e22e>shirFilter</span><span style=color:#f92672>(</span>SecurityManager securityManager<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//éƒ¨åˆ†ä»£ç çœç•¥...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> filterMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è®©shiroæ”¾è¿‡ï¼Œä»¥/appå¼€å¤´çš„è¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        filterMap<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/app/**&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;anon&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//éƒ¨åˆ†ä»£ç çœç•¥...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        shiroFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>setFilterChainDefinitionMap</span><span style=color:#f92672>(</span>filterMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> shiroFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>åˆ†æAuthorizationInterceptorç±»ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ‹¦æˆª /app å¼€å¤´çš„è¯·æ±‚åï¼Œéƒ½å¹²äº†äº›ä»€ä¹ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#f92672>import</span> io.jsonwebtoken.Claims<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.common.exception.RRException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.utils.JwtUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.app.annotation.Login<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.lang.StringUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.HttpStatus<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.HandlerMethod<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.servlet.http.HttpServletRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.servlet.http.HttpServletResponse<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * æƒé™(Token)éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthorizationInterceptor</span> <span style=color:#66d9ef>extends</span> HandlerInterceptorAdapter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> JwtUtils jwtUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String USER_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>preHandle</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> Object
</span></span><span style=display:flex><span>            handler<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Login annotation<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>handler <span style=color:#66d9ef>instanceof</span> HandlerMethod<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            annotation <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>HandlerMethod<span style=color:#f92672>)</span> handler<span style=color:#f92672>).</span><span style=color:#a6e22e>getMethodAnnotation</span><span style=color:#f92672>(</span>Login<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotation <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//è·å–ç”¨æˆ·å‡­è¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String token <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//å‡­è¯ä¸ºç©º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;ä¸èƒ½ä¸ºç©º&#34;</span><span style=color:#f92672>,</span> HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>UNAUTHORIZED</span><span style=color:#f92672>.</span><span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>alue</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        Claims claims <span style=color:#f92672>=</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getClaimByToken</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>claims <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isTokenExpired</span><span style=color:#f92672>(</span>claims<span style=color:#f92672>.</span><span style=color:#a6e22e>getExpiration</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RRException<span style=color:#f92672>(</span>jwtUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•&#34;</span><span style=color:#f92672>,</span> HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>UNAUTHO</span>
</span></span><span style=display:flex><span>                    RIZED<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//è®¾ç½®userIdåˆ°requesté‡Œï¼Œåç»­æ ¹æ®userIdï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span>USER_KEY<span style=color:#f92672>,</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>(</span>claims<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubject</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿›å…¥ /app è¯·æ±‚çš„æ¥å£ä¹‹å‰ï¼Œä¼šåˆ¤æ–­è¯·æ±‚çš„æ¥å£ï¼Œæ˜¯å¦åŠ äº†@Loginæ³¨è§£(éœ€è¦tokenè®¤è¯)ï¼Œå¦‚æœæ²¡æœ‰@Loginæ³¨è§£ï¼Œåˆ™ä¸éªŒè¯tokenï¼Œå¯ä»¥ç›´æ¥è®¿é—®æ¥å£ã€‚å¦‚æœæœ‰@Loginæ³¨è§£ï¼Œåˆ™éœ€è¦éªŒè¯tokençš„æ­£ç¡®æ€§ï¼Œå¹¶æŠŠuserIdæ”¾åˆ°requestçš„USER_KEYé‡Œï¼Œåç»­ä¼šç”¨åˆ°ã€‚</p><ul><li>æ­¤æ—¶ï¼Œ@Loginæ³¨è§£çš„ä½œç”¨ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æ˜ç™½äº†ã€‚å†çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼ŒåŠ äº†@LoginUseræ³¨è§£åï¼Œuserå¯¹è±¡é‡Œï¼Œå°±å˜æˆå½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿™æ˜¯ä»€ä¹ˆæ—¶å€™è®¾ç½®è¿›å»çš„å‘¢ï¼Ÿ</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * è·å–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userInfo&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> R <span style=color:#a6e22e>userInfo</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@LoginUser</span> UserEntity user<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>  	<span style=color:#66d9ef>return</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;user&#34;</span><span style=color:#f92672>,</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>è®¾ç½®userå¯¹è±¡è¿›å»ï¼Œå…¶å®æ˜¯åœ¨LoginUserHandlerMethodArgumentResolveré‡Œå¹²çš„,LoginUserHandlerMethodArgumentResolveræ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å‚æ•°è½¬æ¢å™¨ï¼Œåªè¦å®ç°HandlerMethodArgumentResolveræ¥å£å³å¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.annotation.LoginUser<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.entity.UserEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.interceptor.AuthorizationInterceptor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.renren.modules.api.service.UserService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.MethodParameter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.support.WebDataBinderFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.context.request.NativeWebRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.context.request.RequestAttributes<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.method.support.ModelAndViewContainer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoginUserHandlerMethodArgumentResolver</span> <span style=color:#66d9ef>implements</span> HandlerMethodArgumentResolver <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserService userService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>supportsParameter</span><span style=color:#f92672>(</span>MethodParameter parameter<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//å¦‚æœæ–¹æ³•çš„å‚æ•°æ˜¯UserEntityï¼Œä¸”å‚æ•°å‰é¢æœ‰@LoginUseræ³¨è§£ï¼Œåˆ™è¿›å…¥resolveArgumentæ–¹æ³•ï¼Œè¿›è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        å¤„ç†
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> parameter<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterType</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>UserEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> parameter<span style=color:#f92672>.</span><span style=color:#a6e22e>h</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>asParameterAnnotation</span><span style=color:#f92672>(</span>LoginUser<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>resolveArgument</span><span style=color:#f92672>(</span>MethodParameter parameter<span style=color:#f92672>,</span> ModelAndViewContainer container<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                  NativeWebRequest request<span style=color:#f92672>,</span> WebDataBinderFactory factory<span style=color:#f92672>)</span> thr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ows Exception
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è·å–ç”¨æˆ·IDï¼Œä¹‹å‰è®¾ç½®è¿›å»çš„ï¼Œè¿˜æœ‰å°è±¡å§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object object <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span>AuthorizationInterceptor<span style=color:#f92672>.</span><span style=color:#a6e22e>USER_KEY</span><span style=color:#f92672>,</span> RequestAttrib
</span></span><span style=display:flex><span>                utes<span style=color:#f92672>.</span><span style=color:#a6e22e>SCOPE_REQUEST</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>object <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//é€šè¿‡userIdï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        UserEntity user <span style=color:#f92672>=</span> userService<span style=color:#f92672>.</span><span style=color:#a6e22e>queryObject</span><span style=color:#f92672>((</span>Long<span style=color:#f92672>)</span> object<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æŠŠå½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œè®¾ç½®åˆ°UserEntityå‚æ•°çš„userå¯¹è±¡é‡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> user<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=ç¬¬-7-ç« -ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²>ç¬¬ 7 ç«  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#ç¬¬-7-ç« -ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²>#</a></h1><blockquote><p>éƒ¨ç½²é¡¹ç›®å‰ï¼Œéœ€è¦å‡†å¤‡JDK8ã€Mavenã€MySQL5.5+ç¯å¢ƒï¼Œå‚è€ƒå¼€å‘ç¯å¢ƒæ­å»ºã€‚</p></blockquote><h2 id=71-jar-åŒ…éƒ¨ç½²>7.1 jar åŒ…éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#71-jar-åŒ…éƒ¨ç½²>#</a></h2><h2 id=72-docker-éƒ¨ç½²>7.2 docker éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#72-docker-éƒ¨ç½²>#</a></h2><h2 id=73-é›†ç¾¤éƒ¨ç½²>7.3 é›†ç¾¤éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#73-é›†ç¾¤éƒ¨ç½²>#</a></h2><h3 id=71-jar-åŒ…éƒ¨ç½²-1>7.1 jar åŒ…éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#71-jar-åŒ…éƒ¨ç½²-1>#</a></h3><blockquote><p>Spring Booté¡¹ç›®ï¼Œæ¨èæ‰“æˆjaråŒ…çš„æ–¹å¼ï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚</p></blockquote><ul><li>Spring Bootå†…ç½®äº†Tomcatï¼Œå¯é…ç½®Tomcatçš„ç«¯å£å·ã€åˆå§‹åŒ–çº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€è¿æ¥è¶…æ—¶æ—¶é•¿ã€https ç­‰ç­‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><pre tabindex=0><code class=language-YML data-lang=YML>server:
  tomcat:
    uri-encoding: UTF-8
    max-threads: 1000
    min-spare-threads: 30
  port: 8080
  connection-timeout: 5000ms
  servlet:
    context-path: /renren-fast
    session:
    cookie:
    http-only: true
  ssl:
    key-store: classpath:.keystore
    key-store-type: JKS
    key-password: 123456
    key-alias: tomcat
</code></pre><ul><li>å½“ç„¶ï¼Œè¿˜å¯ä»¥æŒ‡å®šjvmçš„å†…å­˜å¤§å°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>java -Xms4g -Xmx4g -Xmn1g -server -jar renren-fast.jar
</span></span></code></pre></div><ul><li>åœ¨windowsä¸‹éƒ¨ç½²ï¼Œåªéœ€æ‰“å¼€cmdçª—å£ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>java -jar renren-fast.jar --spring.profiles.active<span style=color:#f92672>=</span>prod
</span></span></code></pre></div><ul><li>åœ¨Linuxä¸‹éƒ¨ç½²ï¼Œåªéœ€è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯åœ¨Linuxåå°è¿è¡Œï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>nohup java -jar renren-fast.jar --spring.profiles.active<span style=color:#f92672>=</span>prod &gt; renren.log &amp;
</span></span></code></pre></div><ul><li>åœ¨Linuxç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥åˆ›å»ºshellè„šæœ¬ï¼Œç”¨äºé‡å¯é¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#åˆ›å»ºå¯åŠ¨çš„shellè„šæœ¬</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># vim start.sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>process<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>ps -fe|grep <span style=color:#e6db74>&#34;renren-fast.jar&#34;</span> |grep -ivE <span style=color:#e6db74>&#34;grep|cron&#34;</span> |awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> !$process <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		echo <span style=color:#e6db74>&#34;stop erp process </span>$process<span style=color:#e6db74> .....&#34;</span>
</span></span><span style=display:flex><span>		kill -9 $process
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;start erp process.....&#34;</span>
</span></span><span style=display:flex><span>nohup java -Dspring.profiles.active<span style=color:#f92672>=</span>prod -jar renren-fast.jar --server.port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span> --server.servlet.context-path<span style=color:#f92672>=</span>/renren-fast 2&gt;&amp;<span style=color:#ae81ff>1</span> | cronolog log.%Y-%m-%d.out &gt;&gt; /dev/null &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;start erp success!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#é€šè¿‡shellè„šæœ¬å¯åŠ¨é¡¹ç›®</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># yum install -y cronolog</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># chomd +x start.sh</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@renren renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># ./start.sh</span>
</span></span></code></pre></div><h2 id=72-docker-éƒ¨ç½²-1>7.2 docker éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#72-docker-éƒ¨ç½²-1>#</a></h2><p>å®‰è£…dockerç¯å¢ƒ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#å®‰è£…docker</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -sSL https://get.docker.com/ | sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#å¯åŠ¨docker</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark ~<span style=color:#f92672>]</span><span style=color:#75715e># service docker start</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#æŸ¥çœ‹dockerç‰ˆæœ¬ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark ~<span style=color:#f92672>]</span><span style=color:#75715e># docker version</span>
</span></span><span style=display:flex><span>Client:
</span></span><span style=display:flex><span>    Version: 17.07.0-ce
</span></span><span style=display:flex><span>    API version: 1.31
</span></span><span style=display:flex><span>    Go version: go1.8.3
</span></span><span style=display:flex><span>    Git commit: <span style=color:#ae81ff>8784753</span>
</span></span><span style=display:flex><span>    Built: Tue Aug <span style=color:#ae81ff>29</span> 17:42:01 <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>    OS/Arch: linux/amd64
</span></span><span style=display:flex><span>Server:
</span></span><span style=display:flex><span>    Version: 17.07.0-ce
</span></span><span style=display:flex><span>    API version: 1.31 <span style=color:#f92672>(</span>minimum version 1.12<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Go version: go1.8.3
</span></span><span style=display:flex><span>    Git commit: <span style=color:#ae81ff>8784753</span>
</span></span><span style=display:flex><span>    Built: Tue Aug <span style=color:#ae81ff>29</span> 17:43:23 <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>    OS/Arch: linux/amd64
</span></span><span style=display:flex><span>    Experimental: false
</span></span></code></pre></div><ul><li>è¿˜éœ€è¦å‡†å¤‡javaã€mavenç¯å¢ƒï¼Œè¯·è‡ªè¡Œå®‰è£…</li><li>é€šè¿‡mavenæ’ä»¶ï¼Œæ„å»ºdockeré•œåƒ</li></ul><h2 id=æ‰“åŒ…å¹¶æ„å»ºé¡¹ç›®é•œåƒ>æ‰“åŒ…å¹¶æ„å»ºé¡¹ç›®é•œåƒ<a hidden class=anchor aria-hidden=true href=#æ‰“åŒ…å¹¶æ„å»ºé¡¹ç›®é•œåƒ>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># mvn clean package docker:build</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#çœç•¥æ‰“åŒ…log...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> Building image renren/fast
</span></span><span style=display:flex><span>Step 1/6 : FROM java:8
</span></span><span style=display:flex><span>	---&gt; d23bdf5b1b1b
</span></span><span style=display:flex><span>Step 2/6 : EXPOSE <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>    ---&gt; Using cache
</span></span><span style=display:flex><span>    ---&gt; 8e33aadb2c18
</span></span><span style=display:flex><span>Step 3/6 : VOLUME /tmp
</span></span><span style=display:flex><span>  ---&gt; Using cache
</span></span><span style=display:flex><span>  ---&gt; c5dc0c509062
</span></span><span style=display:flex><span>Step 4/6 : ADD renren-fast-1.2.0.jar /app.jar
</span></span><span style=display:flex><span>  ---&gt; 831bc3ca84bc
</span></span><span style=display:flex><span>Step 5/6 : RUN bash -c <span style=color:#e6db74>&#39;touch /app.jar&#39;</span>
</span></span><span style=display:flex><span>  ---&gt; Running in fe3ef9343e4c
</span></span><span style=display:flex><span>  ---&gt; b3d6dd6fc297
</span></span><span style=display:flex><span>Removing intermediate container fe3ef9343e4c
</span></span><span style=display:flex><span>Step 6/6 : ENTRYPOINT java -jar /app.jar
</span></span><span style=display:flex><span>  ---&gt; Running in 89adce4ae167
</span></span><span style=display:flex><span>  ---&gt; a4ae60970a77
</span></span><span style=display:flex><span>Removing intermediate container 89adce4ae167
</span></span><span style=display:flex><span>ProgressMessage<span style=color:#f92672>{</span>id<span style=color:#f92672>=</span>null, status<span style=color:#f92672>=</span>null, stream<span style=color:#f92672>=</span>null, error<span style=color:#f92672>=</span>null, progress<span style=color:#f92672>=</span>null, progressDetail<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>null<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Successfully built a4ae60970a77
</span></span><span style=display:flex><span>Successfully tagged renren/fast:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹é•œåƒ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker images</span>
</span></span><span style=display:flex><span>REPOSITORY 		TAG 		IMAGE ID 				 CREATED 					SIZE
</span></span><span style=display:flex><span>renren/fast 	latest 	a4ae60970a77 		 <span style=color:#ae81ff>14</span> seconds ago 	714MB
</span></span><span style=display:flex><span>java 					<span style=color:#ae81ff>8</span> 			d23bdf5b1b1b 		 <span style=color:#ae81ff>7</span> months ago 		643MB
</span></span></code></pre></div><ul><li>å®‰è£…docker-composeï¼Œç”¨æ¥ç®¡ç†å®¹å™¨</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#ä¸‹è½½åœ°å€ï¼šhttps://github.com/docker/compose/releases</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ä¸‹è½½docker-compose</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#å¢åŠ å¯æ‰§è¡Œæƒé™</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># chmod +x /usr/local/bin/docker-compose</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose version</span>
</span></span><span style=display:flex><span>docker-compose version 1.16.1, build 6d1ac21
</span></span><span style=display:flex><span>docker-py version: 2.5.1
</span></span><span style=display:flex><span>CPython version: 2.7.13
</span></span><span style=display:flex><span>OpenSSL version: OpenSSL 1.0.1t <span style=color:#ae81ff>3</span> May <span style=color:#ae81ff>2016</span>
</span></span></code></pre></div><p>å¦‚æœä¸‹è½½ä¸äº†ï¼Œå¯ä»¥ç”¨è¿…é›·å°†https://github.com/docker/compose/releases/download/1.16.1/docker-compose-
Linux-x86_64ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå†ä¸Šä¼ åˆ°æœåŠ¡å™¨</p><ul><li>é€šè¿‡docker-composeï¼Œå¯åŠ¨é¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#75715e>#å¯åŠ¨é¡¹ç›®</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose up -d</span>
</span></span><span style=display:flex><span>Creating network <span style=color:#e6db74>&#34;renrenfast_default&#34;</span> with the default driver
</span></span><span style=display:flex><span>Creating renrenfast_campus_1 ...
</span></span><span style=display:flex><span>Creating renrenfast_campus_1 ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#æŸ¥çœ‹å¯åŠ¨çš„å®¹å™¨</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker ps</span>
</span></span><span style=display:flex><span>CONTAINER ID 	IMAGE 			COMMAND 							CREATED 						STATUS 				PORTS 				
</span></span><span style=display:flex><span>NAMES
</span></span><span style=display:flex><span>f4e3fcdd8dd4 	renren/fast <span style=color:#e6db74>&#34;java -jar /app.jar&#34;</span> 	<span style=color:#ae81ff>55</span> seconds ago 			Up <span style=color:#ae81ff>3</span> seconds 	0.0.0.0:8080-&gt;8080/tcp renrenfast_renren-fast_1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#åœæ‰å¹¶åˆ é™¤ï¼Œdocker-composeç®¡ç†çš„å®¹å™¨</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@mark renren-fast<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose down</span>
</span></span><span style=display:flex><span>Stopping renrenfast_renren-fast_1 ... <span style=color:#66d9ef>done</span> 
</span></span><span style=display:flex><span>Removing renrenfast_renren-fast_1 ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Removing network renrenfast_default
</span></span></code></pre></div><h2 id=73-é›†ç¾¤éƒ¨ç½²-1>7.3 é›†ç¾¤éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#73-é›†ç¾¤éƒ¨ç½²-1>#</a></h2><blockquote><p>æœ¬ç³»ç»Ÿæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé›†ç¾¤éƒ¨ç½²ï¼Œåªéœ€å¯åŠ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå¹¶é…ç½®Nginxå³å¯ã€‚</p></blockquote><ul><li>é…ç½®Nginx</li></ul><pre tabindex=0><code class=language-conf data-lang=conf>http {
    upstream renren {
        server localhost:8080;
        server localhost:8081;
    }
    
    server {
        listen 80;
        server_name localhost;
        location /renren-fast {
            proxy_pass http://renren;
            client_max_body_size 1024m;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;
            proxy_redirect off;
        }
    }
}
</code></pre><ul><li>é€šè¿‡http://localhost/renren-fastï¼Œå°±å¯ä»¥è®¿é—®äº†</li></ul><div class=post-meta></hr>æ³¨ï¼šæœ¬ä½œå“é‡‡ç”¨<a rel=license target=view_window href=http://creativecommons.org/licenses/by-nc-sa/4.0/> çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®® </a>è¿›è¡Œè®¸å¯ã€‚</div></div><footer class=post-footer><ul class=post-tags><li><a href=https://swimminghao1.github.io/tags/springboot/>ğŸ· SpringBoot</a></li><li><a href=https://swimminghao1.github.io/tags/%E8%84%9A%E6%89%8B%E6%9E%B6/>ğŸ· è„šæ‰‹æ¶</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ on twitter" href="https://twitter.com/intent/tweet/?text=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f&hashtags=SpringBoot%2c%e8%84%9a%e6%89%8b%e6%9e%b6"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f&title=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&summary=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&source=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f&title=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ on whatsapp" href="https://api.whatsapp.com/send?text=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88%20-%20https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share renren-fastå¼€å‘æ–‡æ¡£3.0æœ€æ–°ç‰ˆ on telegram" href="https://telegram.me/share/url?text=renren-fast%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a33.0%e6%9c%80%e6%96%b0%e7%89%88&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f02%25E4%25B8%25AA%25E4%25BA%25BA%25E5%25AD%25A6%25E4%25B9%25A0%2f06_04_spring%2f%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%2frenren-fast%25E5%25BC%2580%25E5%258F%2591%25E6%2596%2587%25E6%25A1%25A33.0%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><nav class=paginav><a class=prev href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/08_01_nas/nas%E6%95%99%E7%A8%8B/%E5%BD%B1%E9%9F%B3/emby-server%E5%AA%92%E4%BD%93%E5%BA%93%E7%A1%AC%E9%93%BE%E6%8E%A5/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>emby-serveråª’ä½“åº“ç¡¬é“¾æ¥</span></a>
<a class=next href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_04_spring/spring-boot-2.0-%E9%9B%86%E6%88%90-redis/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Spring Boot 2.0 é›†æˆ redis</span></a></nav></footer></article></main><footer class=footer><span>Copyright &copy; 2023 â€¢ <a href=https://swimminghao1.github.io/>swimminghao</a></span><div><span><a href=/about/>å…³äº</a>
â€¢ <a href=/disclaimer/>å…è´£å£°æ˜</a>
â€¢ <a href=/sitemap.xml target=view_window>ç«™ç‚¹åœ°å›¾</a>
â€¢ <a href=https://www.foreverblog.cn/go.html target=view_window>è™«æ´</a>
â€¢ PV <span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin"></i></span></span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><meta name=â€apple-mobile-web-app-capableâ€ content="â€yesâ€"><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js")})</script></body></html>