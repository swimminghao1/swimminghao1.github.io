<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>çº¿ç¨‹æ±  | swimminghao</title><meta name=keywords content="ç¼–ç¨‹,æ„Ÿæ‚Ÿ"><meta name=description content="çº¿ç¨‹æ±  ThreadPoolæºç å­¦ä¹  zodiac Â·2020-12-10 Â·20 æ¬¡é˜…è¯» ThreadPoolExecutor jdk1.5åœ¨jucåŒ…é‡Œæä¾›äº†æ–¹ä¾¿å¿«æ·çš„çº¿ç¨‹æ± apiï¼Œå¹¶æä¾›äº†åŸºäºå·¥"><meta name=author content="swimminghao"><link rel=canonical href=https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/><meta name=yandex-verification content="73b1a797f62c0e98"><meta name=baidu-site-verification content="code-gnOrbP1RyC"><meta name=baidu_union_verify content="4c552c344295cb984c46ebe74962b067"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/satouriko/LxgwWenKai_Webfonts@v1.101/dist/LXGWWenKai-Light.css><link crossorigin=anonymous href=/assets/css/stylesheet.min.0a5d9aa21e56d0b7d41b1d4b56af0b911caf526faf5060a8d3717579bf27cb93.css integrity="sha256-Cl2aoh5W0LfUGx1LVq8LkRyvUm+vUGCo03F1eb8ny5M=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://swimminghao1.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://swimminghao1.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://swimminghao1.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://swimminghao1.github.io/apple-touch-icon.png><link rel=mask-icon href=https://swimminghao1.github.io/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.97.0"><link rel=manifest href=/manifest.json><script type=text/javascript>function downloadJSAtOnload(){var e=document.createElement("script");e.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7296634171837358",document.body.appendChild(e)}window.addEventListener?window.addEventListener("load",downloadJSAtOnload,!1):window.attachEvent?window.attachEvent("onload",downloadJSAtOnload):window.onload=downloadJSAtOnload</script><script async defer data-website-id=3d947a98-2774-46b0-805f-fe2e4877a1d7 src=https://umami.frytea.com/umami.js></script>
<script async src=https://swimminghao1.github.io/js/busuanzi.pure.mini.js></script>
<link rel=stylesheet href=/libs/font-awesome-4.7.0/css/font-awesome.min.css><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=https://swimminghao1.github.io/js/mermaid.min.js crossorigin=anonymous></script>
<script>const config={startOnLoad:!0,theme:"forest",themeVariables:{lineColor:"#fafafa"},flowchart:{useMaxWidth:!1,htmlLabels:!0}};mermaid.initialize(config),window.onload=()=>{window.mermaid.init(void 0,document.querySelectorAll(".language-mermaid"))}</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?c49e2f5be5e009382be07455c33b1394",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-136094326-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="çº¿ç¨‹æ± "><meta property="og:description" content="çº¿ç¨‹æ±  ThreadPoolæºç å­¦ä¹  zodiac Â·2020-12-10 Â·20 æ¬¡é˜…è¯» ThreadPoolExecutor jdk1.5åœ¨jucåŒ…é‡Œæä¾›äº†æ–¹ä¾¿å¿«æ·çš„çº¿ç¨‹æ± apiï¼Œå¹¶æä¾›äº†åŸºäºå·¥"><meta property="og:type" content="article"><meta property="og:url" content="https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"><meta property="og:image" content="https://swimminghao1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-02-28T19:57:47+00:00"><meta property="article:modified_time" content="2022-02-28T19:57:47+00:00"><meta property="og:site_name" content="swimminghao"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://swimminghao1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="çº¿ç¨‹æ± "><meta name=twitter:description content="çº¿ç¨‹æ±  ThreadPoolæºç å­¦ä¹  zodiac Â·2020-12-10 Â·20 æ¬¡é˜…è¯» ThreadPoolExecutor jdk1.5åœ¨jucåŒ…é‡Œæä¾›äº†æ–¹ä¾¿å¿«æ·çš„çº¿ç¨‹æ± apiï¼Œå¹¶æä¾›äº†åŸºäºå·¥"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"https://swimminghao1.github.io/post/"},{"@type":"ListItem","position":2,"name":"çº¿ç¨‹æ± ","item":"https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"çº¿ç¨‹æ± ","name":"çº¿ç¨‹æ± ","description":"çº¿ç¨‹æ±  ThreadPoolæºç å­¦ä¹  zodiac Â·2020-12-10 Â·20 æ¬¡é˜…è¯» ThreadPoolExecutor jdk1.5åœ¨jucåŒ…é‡Œæä¾›äº†æ–¹ä¾¿å¿«æ·çš„çº¿ç¨‹æ± apiï¼Œå¹¶æä¾›äº†åŸºäºå·¥","keywords":["ç¼–ç¨‹","æ„Ÿæ‚Ÿ"],"articleBody":"çº¿ç¨‹æ±  ThreadPoolæºç å­¦ä¹  zodiac Â·2020-12-10 Â·20 æ¬¡é˜…è¯»\nThreadPoolExecutor jdk1.5åœ¨jucåŒ…é‡Œæä¾›äº†æ–¹ä¾¿å¿«æ·çš„çº¿ç¨‹æ± apiï¼Œå¹¶æä¾›äº†åŸºäºå·¥å‚æ¨¡å¼çš„Executorså·¥å…·ç±»ç”¨äºå¿«æ·åˆ›å»ºçº¿ç¨‹æ± ï¼Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼Œåº”å½“ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨Executors\n1ã€ç±»ç»§æ‰¿å…³ç³»\nExecutorä¸ºé¡¶çº§æ¥å£ï¼Œå…¶ä¸»è¦ç›®æ ‡æ˜¯å°†ä»»åŠ¡ã€ä»»åŠ¡çš„æäº¤ä¸ä»»åŠ¡çš„æ‰§è¡Œè§£è€¦\nExecutorServiceæ¥å£åˆ™å®šä¹‰äº†æ­£å¸¸çš„çº¿ç¨‹æ± åº”è¯¥æœ‰çš„åŠŸèƒ½ä¸è¡Œä¸ºï¼Œè¯¸å¦‚ä»»åŠ¡æäº¤ï¼Œå¼‚æ­¥æ‰§è¡Œç­‰ç­‰\nScheduledExecutorServiceæ¥å£åˆ™å®šä¹‰äº†ä¸€äº›å®šæ—¶çš„ç‰¹æ€§\n2ã€Executor Executoræ‰§è¡Œæäº¤çš„ä»»åŠ¡ï¼ˆRunnableï¼‰ï¼Œè¯¥æ¥å£æä¾›äº†ä¸€ç§å°†ä»»åŠ¡æäº¤ä¸ä»»åŠ¡æ‰§è¡Œï¼ˆåŒ…æ‹¬æ‰§è¡Œç»†èŠ‚ï¼šçº¿ç¨‹ã€å®šæ—¶ç­‰ï¼‰è§£è€¦çš„é€”å¾„ã€‚\né€šè¿‡ExecutoråŒ…è£…çš„çº¿ç¨‹ï¼ˆThreadï¼‰å¯¹è±¡ï¼Œé¿å…ç›´æ¥ä½¿ç”¨Threadå¯¹è±¡æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¯ä»¥æœ‰æ•ˆå°†çº¿ç¨‹ä¿¡æ¯å±è”½ï¼Œé¿å…ç›´æ¥å¯¹çº¿ç¨‹çš„æ“ä½œã€‚\nExecutoræœ¬èº«å¹¶ä¸å¼ºåˆ¶è¦æ±‚æ‰§è¡Œçš„ä»»åŠ¡å¿…é¡»æ˜¯å¼‚æ­¥æ‰§è¡Œ\nç”¨äºæ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œå™¨ï¼Œè€ŒRunnableåˆ™è¡¨ç¤ºå¯ä»¥ç”¨äºæ‰§è¡Œçš„ä»»åŠ¡ã€‚\n/**\n åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»æ‰§è¡Œç»™å®šçš„æŒ‡ä»¤ï¼Œå‘½ä»¤å¯ä»¥åœ¨æ–°çš„çº¿ç¨‹ä¸­ã€çº¿ç¨‹æ± æˆ–è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œ å®é™…æƒ…å†µå–å†³äºExecutorçš„å®ç° */ void execute(Runnable command); 3ã€ExecutorService èƒ½å¤Ÿç®¡ç†ä»»åŠ¡ç»ˆæ­¢ã€èƒ½å¤Ÿäº§ç”Ÿè¿½è¸ªä¸€ä¸ªæˆ–å¤šä¸ªå¼‚æ­¥ä»»åŠ¡å¤„ç†è¿›åº¦çš„Futureçš„æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰  æ¥å£çš„æ ¸å¿ƒå®šä¹‰ï¼š\næäº¤ä»»åŠ¡\n Future submit(Callable task);  Future submit(Runnable task, T result); Future submit(Runnable task); ç¬¬ä¸€ç§æäº¤Callable taskç±»å‹çš„ä»»åŠ¡è¾ƒå¥½ç†è§£ï¼Œä»»åŠ¡å®Œæˆæ—¶ä¼šå°†taskçš„ç»“æœæ”¾è‡³Futureä¸­ã€‚\nç¬¬äºŒç§æ–¹å¼ï¼ŒRunnable taskå’Œ T resultä½œä¸ºå‚æ•°ï¼Œå®é™…ä¸Šå†…éƒ¨é€šè¿‡åŒ…è£…å°†å…¥å‚resultä½œä¸ºè¿”å›å€¼ä¸Runnable taskä¸€åŒåŒ…è£…ä¸ºä¸€ä¸ªCallableï¼Œæœ€åä»»åŠ¡å®Œæˆæ—¶å°†Callableç»“æœæ”¾è‡³Futureä¸­ã€‚å› æ­¤é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå…¥å‚resultï¼Œè¿”å›ç»“æœåˆ™æ˜¯å¯èƒ½åœ¨ä»»åŠ¡ä¸­è¢«ä¿®æ”¹çš„resultã€‚\nAbstractExecutorService\npublic Future submit(Runnable task) { if (task == null) throw new NullPointerException(); RunnableFuture ftask = newTaskFor(task, null);//ç”Ÿæˆä¸€ä¸ªRunnableFutureä½œä¸ºä»»åŠ¡ execute(ftask); return ftask; }\n//å¼‚æ­¥ä»»åŠ¡çš„æŠ½è±¡ï¼Œå†…éƒ¨å°è£…äº†å®é™…çš„ä»»åŠ¡ã€ä»»åŠ¡çŠ¶æ€ã€çœŸæ­£çš„æ‰§è¡Œçº¿ç¨‹ä»¥åŠç­‰å¾…ä»»åŠ¡å®Œæˆçš„çº¿ç¨‹ç­‰ç»†èŠ‚ //å®é™…ä¸Šæ˜¯è°ƒç”¨FutureTask.run()çš„çº¿ç¨‹è¢«é˜»å¡ï¼Œä½œä¸ºçœŸæ­£çš„æ‰§è¡Œçº¿ç¨‹ protected  RunnableFuture newTaskFor(Runnable runnable, T value) { return new FutureTask(runnable, value);//åˆ›å»ºFutureTask } FutureTask\npublic FutureTask(Runnable runnable, V result) { this.callable = Executors.callable(runnable, result);//å°†Runnableé€‚é…ä¸ºCallable this.state = NEW; // ensure visibility of callable } Tipsï¼š\nFutureTaské‡Œæœ‰å¾ˆå¤šç‰¹æ€§ï¼ˆæ¯”å¦‚å¯¹ç­‰å¾…ä»»åŠ¡å®Œæˆçš„çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼Œä»»åŠ¡å®Œæˆåå¯¹ç­‰å¾…çº¿ç¨‹çš„å”¤é†’ï¼Œé˜²æ­¢ä»»åŠ¡è¢«å¹¶å‘è°ƒç”¨ç­‰ç­‰ï¼‰éƒ½å¯ä»¥ä½¿ç”¨AbstractQueuedSynchronizerï¼Œä½†åœ¨JDK1.8ä¸­çš„æºç å´æ²¡æœ‰å‘ç°AQSçš„ç—•è¿¹ï¼Œæƒ³æƒ³è¿™æ˜¯ä¸ºä½•ï¼Ÿ\næ—©æœŸFutureTaskç¡®å®æ˜¯ä½¿ç”¨AQSå®ç°ï¼Œåç»­ä¿®æ”¹ä¸ºäº†ç›®å‰çš„æ ·å­ï¼ˆå¾ˆå¤šé€šè¿‡å†…å­˜ç›´æ¥ä¿®æ”¹å¯¹è±¡çš„æ“ä½œï¼ŒUnsafeç±»ï¼‰ï¼Œæ ¸å¿ƒæ˜¯ä¸ºäº†æ€§èƒ½ã€‚è¿™ä¸€éƒ¨åˆ†å¯ä»¥å†å•ç‹¬æ·±å…¥çœ‹çœ‹\nExecutors.RunnableAdapter\n//ç®€å•çš„é€‚é…ï¼Œå°†RunnableåŒ…è£…ä¸ºCallable static final class RunnableAdapter implements Callable { final Runnable task; final T result; RunnableAdapter(Runnable task, T result) { this.task = task; this.result = result; } public T call() { task.run(); return result; } } ç¬¬ä¸‰ç§æ–¹å¼ï¼Œä¸ç¬¬äºŒç§ç±»ä¼¼ï¼Œä¼šåˆ›ä¸€ä¸ªresult ä¸º nullçš„Runnableé€‚é…å™¨ã€‚\nå¼‚æ­¥æ‰§è¡Œä»»åŠ¡\né€šè¿‡ä»»åŠ¡æäº¤ã€invokeAnyã€invokeAll\nç­‰å¾…ä»»ä¸€/å…¨éƒ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆ\ninvokeAny() ä¸€æ¬¡æ€§æäº¤æ‰¹é‡ä»»åŠ¡ï¼Œæœ‰ä»»ä¸€ä»»åŠ¡å®Œæˆæ—¶è¿”å›è¯¥ä»»åŠ¡çš„å¤„ç†ç»“æœï¼Œè°ƒç”¨çº¿ç¨‹é˜»å¡ã€‚\nprivate  T doInvokeAny(Collection tasks, boolean timed, long nanos) throws InterruptedException, ExecutionException, TimeoutException { if (tasks == null) throw new NullPointerException(); int ntasks = tasks.size(); if (ntasks == 0) throw new IllegalArgumentException(); ArrayList futures = new ArrayList(ntasks); ExecutorCompletionService ecs = new ExecutorCompletionService(this);//Wrapperæˆ–Decoratoræ¨¡å¼ï¼ˆç»„åˆæ¨¡å¼ï¼Ÿï¼Ÿï¼‰ï¼Œå¢å¼ºäº†å¯¹å·²å®Œæˆä»»åŠ¡çš„ç®¡ç†èƒ½åŠ›\ntry { ExecutionException ee = null; final long deadline = timed ? System.nanoTime() + nanos : 0L; Iterator it = tasks.iterator(); //1ã€æäº¤ç¬¬ä¸€ä¸ªä»»åŠ¡ futures.add(ecs.submit(it.next())); --ntasks; int active = 1; for (; ; ) { //2ã€åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ Future f = ecs.poll(); if (f == null) { //3ã€æ²¡æœ‰å®Œæˆï¼Œä¸”è¿˜æœ‰ä»»åŠ¡å¯ä»¥æäº¤æ—¶ï¼Œç»§ç»­æäº¤ if (ntasks  0) { --ntasks; futures.add(ecs.submit(it.next())); ++active; } else if (active == 0)//4ã€æ²¡æœ‰å®Œæˆã€æ²¡æœ‰ä»»åŠ¡å¯ä»¥æäº¤ã€æ— å¤„ç†ä¸­ä»»åŠ¡è·³å‡º break; else if (timed) {//5ã€æ— ä»»åŠ¡æäº¤ï¼Œä»»åŠ¡åœ¨å¤„ç†ä¸­æ—¶ï¼Œè®¾ç½®ç­‰å¾…ä»»åŠ¡å®Œæˆ f = ecs.poll(nanos, TimeUnit.NANOSECONDS); if (f == null) throw new TimeoutException(); nanos = deadline - System.nanoTime(); } else//6ã€æ— é™æœŸé˜»å¡ï¼Œç­‰å¾…å®Œæˆä»»åŠ¡çš„é˜Ÿåˆ—æœ‰å®Œæˆä»»åŠ¡å¯ä»¥è·å¾— f = ecs.take(); } if (f != null) {//7ã€è·å–åˆ°å®Œæˆä»»åŠ¡ --active; try { return f.get();//8ã€è¿”å›å®Œæˆä»»åŠ¡çš„ç»“æœ } catch (ExecutionException eex) { ee = eex; } catch (RuntimeException rex) { ee = new ExecutionException(rex); } } } if (ee == null) ee = new ExecutionException(); throw ee; } finally {//9ã€æœ€ç»ˆå–æ¶ˆæ‰€æœ‰ä»»åŠ¡ for (int i = 0, size = futures.size(); i  } invokeAll å¦‚æœæ— è¶…æ—¶æ—¶é—´ï¼ˆè¾ƒä¸ºç®€å•ï¼‰\nåˆ™éå†FutureTaskï¼Œé€šè¿‡FutureTask.get()æ–¹æ³•é˜»å¡è°ƒç”¨çº¿ç¨‹å³å¯ã€‚\nå¦‚æœå­˜åœ¨è¶…æ—¶æ—¶é—´\néå†FutureTaskï¼Œæ¯æäº¤ä¸€æ¬¡ä»»åŠ¡æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦è¶…æ—¶ã€‚ä»»åŠ¡æäº¤å®Œæˆåï¼Œéå†æœªç»“æŸFutureï¼Œè°ƒç”¨Future.get(timeout)ï¼Œæœ€ç»ˆè¿”å›ç»“æœï¼Œä»»åŠ¡æ¸…ç†ã€‚\npublic  List invokeAll(Collection tasks, long timeout, TimeUnit unit) throws InterruptedException { if (tasks == null) throw new NullPointerException(); long nanos = unit.toNanos(timeout); ArrayList futures = new ArrayList(tasks.size()); boolean done = false; try { for (Callable t : tasks) futures.add(newTaskFor(t));\n final long deadline = System.nanoTime() + nanos; final int size = futures.size(); // Interleave time checks and calls to execute in case // executor doesn't have any/much parallelism. for (int i = 0; i f = futures.get(i); if (!f.isDone()) {//æœªå®Œæˆfuture if (nanos  } ç»ˆæ­¢ä»»åŠ¡æäº¤\nshutdown()\nå·²æäº¤çš„ä»»åŠ¡ï¼Œä»å°†è¢«æ‰§è¡Œï¼Œä½†æ–°çš„ä»»åŠ¡ä¸å†è¢«æ¥æ”¶ã€‚å¦‚æœå·²ç»è¢«shutdownï¼Œå†æ¬¡è°ƒç”¨æ— å½±å“\nç»ˆæ­¢ä»»åŠ¡æ‰§è¡Œ\nList shutdownNow();\nç«‹å³å°è¯•åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿”å›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¸ä¼šç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ç»ˆç»“ã€‚\nè¯¥æ–¹æ³•ä¼šå°è¯•å°½æœ€å¤§åŠªåŠ›ç»ˆç»“æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œä½†æ— æ³•ä¿è¯æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡è¢«ç»ˆç»“ï¼Œå› æ­¤ï¼Œå¦‚æœæœ‰ä»»åŠ¡ç»ˆç»“å¤±è´¥ï¼Œè¯¥ä»»åŠ¡ä¹Ÿè®¸æ°¸è¿œæ— æ³•è¢«ç»ˆæ­¢ã€‚\nç­‰å¾…æ‰§è¡Œå™¨è¿›å…¥ç»ˆæ­¢çŠ¶æ€\nboolean awaitTermination(long timeout, TimeUnit unit) throws InterruptedException;\nå½“è°ƒç”¨äº†showdown()åï¼Œåœ¨è¶…æ—¶é—´å†…ã€è°ƒç”¨çº¿ç¨‹è¢«ä¸­æ–­å‰é˜»å¡è°ƒç”¨çº¿ç¨‹ç­‰å¾…å·²æäº¤ä»»åŠ¡å®Œæˆã€‚\n4ã€AbstractExecutorService é€šè¿‡æ¨¡æ¿æ¨¡å¼çš„è®¾è®¡æ¨¡å¼ï¼Œå¯¹ExecutorServiceæ¥å£ä¸­å®šä¹‰çš„æŸäº›æ–¹æ³•ï¼Œè¿›è¡Œäº†é€šç”¨å®ç°ã€‚\npublic Future submit(Runnable task){â€¦} public  Future submit(Runnable task, T result) {â€¦} public  Future submit(Callable task) {â€¦}\npublic  T invokeAny(Collection tasks) throws InterruptedException, ExecutionException {â€¦} public  List invokeAll(Collection tasks) throws InterruptedException {â€¦} submit(â€¦)ï¼š\nä¸»è¦é€»è¾‘ï¼š\n1ã€åŒ…è£…Callableã€Runnableã€resultä¸ºRunnableFutureï¼ˆå®é™…é»˜è®¤å®ç°æ˜¯FutureTaskï¼Œé€‚é…Runableæ¥å£ï¼‰\n2ã€è°ƒç”¨å®ç°ç±»execute()æ–¹æ³•æ‰§è¡ŒRunnableFuture\ninvokeAny(â€¦)\ninvokeAll(â€¦)\nä¸Šè¿°æ–¹æ³•çš„å…·ä½“æºç å¯ä»¥å‚è§ExecutorServiceéƒ¨åˆ†\n5ã€ThreadPoolExecutor è™½ç„¶AbstractExecutorServiceè¿›è¡Œäº†ä¸€äº›é€šç”¨å®ç°ï¼Œä½†è¯¸å¦‚execute()ã€shutdown()ç­‰ä¾èµ–å®é™…æ‰§è¡Œè·¯å¾„ä¸æ‰§è¡Œå™¨å†…éƒ¨çŠ¶æ€çš„æ–¹æ³•å¹¶æœªè¢«å®ç°ï¼Œå› æ­¤è¿™äº›æ–¹æ³•çš„å®ç°é€»è¾‘å°†æ˜¯å¯¹Executorè¿›è¡ŒåŒºåˆ†çš„é‡è¦å› ç´ ã€‚\nThreadPoolExecutorç›´è¯‘ä¸ºçº¿ç¨‹æ± æ‰§è¡Œå™¨ï¼Œè¯¥ç±»é€šè¿‡ç»´æŠ¤å†…çº¿ç¨‹æ± ï¼Œæœ€å¤§ç¨‹åº¦å¤ç”¨çº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºã€é”€æ¯ä¸ç»´æŠ¤çš„å¼€é”€ï¼Œæé«˜ä»»åŠ¡çš„æ‰§è¡Œæ•ˆç‡ã€‚é€šå¸¸ä¼šä½œä¸ºç³»ç»Ÿçš„ä¸€ä¸ªå¼‚æ­¥å¤„ç†æ¨¡å—å‡ºç°ï¼Œæœ€å¤§ç¨‹åº¦é™ä½ç³»ç»Ÿå¯¹ç¡¬ä»¶èµ„æºçš„å ç”¨ã€‚åŒæ—¶ä¹Ÿæä¾›äº†å‹å–„çš„apiï¼Œé€šè¿‡å¯¹çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°çš„è®¾è®¡ï¼Œå¯ä»¥è®¾è®¡å‡ºä¸åŒç±»å‹çš„çº¿ç¨‹æ± ï¼Œæ‰©å±•çº¿ç¨‹æ± çš„å¯åº”ç”¨åœºæ™¯ã€‚\nåŸºç¡€æ¦‚å¿µ åŒ…å«çº¿ç¨‹æ§åˆ¶çŠ¶æ€ã€ä½œä¸šé˜Ÿåˆ—ã€å·¥äººï¼ˆworkerï¼‰ã€å·¥äººé›†åˆï¼ˆworker setï¼‰ã€å·¥äººæ•°é‡ï¼ˆworker countï¼‰ã€ç»ˆæ­¢æ¡ä»¶ã€çº¿ç¨‹å·¥å‚ã€ä»»åŠ¡æ‹’ç»å¤„ç†å™¨ã€æ ¸å¿ƒæ± å¤§å°ã€æœ€å¤§æ± å¤§å°ç­‰ç­‰\næ§åˆ¶çŠ¶æ€ã€å·¥äººæ•°é‡\næ§åˆ¶çŠ¶æ€ï¼š\næ ‡è®°äº†æ‰§è¡Œå™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œè®°å½•çº¿ç¨‹æ± çš„å½“å‰çŠ¶æ€ï¼Œåˆ†ä¸ºRUNNINGã€SHUTDOWNã€STOPã€TIDYINGã€TERMINATEDï¼Œä¸»è¦æ˜¯ä¸ºäº†å®ç°shutdown()ç­‰æ¶‰åŠåˆ°æ‰§è¡Œå™¨çŠ¶æ€çš„æ–¹æ³•ï¼Œå¦‚æœä¸å­˜åœ¨æ§åˆ¶çŠ¶æ€ï¼Œåˆ™æ— æ³•å®ç°ç±»ä¼¼ï¼šæ‹’ç»æ–°ä»»åŠ¡çš„æ·»åŠ ã€ç»ˆç»“æ‰§è¡Œå™¨ç­‰åŠŸèƒ½ã€‚\né˜¶æ®µ\tè¯´æ˜\tçŠ¶æ€è½¬æ¢ RUNING\tä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ­¤æ—¶å¯ä»¥æ¥æ”¶æ–°çš„ä»»åŠ¡\tSHUTDOWNï¼šè°ƒç”¨shutdown() STOPï¼šè°ƒç”¨shutdownNow() SHUTDOWN\tä»»åŠ¡æ‰§è¡Œä¸­ï¼Œä½†ä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡\tSTOPï¼šè°ƒç”¨shutdownNow() TIDYINGï¼šä»»åŠ¡å®Œæˆã€çº¿ç¨‹æ± æ¸…ç©º STOP\tæ‰§è¡Œä¸­çš„ä»»åŠ¡å°†è¢«ç»ˆæ­¢ï¼Œä¸”ä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä¸å†ç»§ç»­å¤„ç†ä»»åŠ¡\tTIDYINGï¼šçº¿ç¨‹æ± æ¸…ç©º TIDYING\tæ•´ç†é˜¶æ®µï¼Œä¸»è¦æ˜¯å›æ”¶èµ„æºä¸æ”¶å°¾å·¥ä½œã€‚æ‰€æœ‰çš„ä»»åŠ¡å·²ç»ç»“æŸï¼Œå·¥äººæ•°é‡ä¸º0ï¼ˆçº¿ç¨‹å·²ç»å®Œæˆå›æ”¶ï¼‰ï¼Œåœ¨è¯¥é˜¶æ®µå¯¹åº”çº¿ç¨‹å°†è°ƒç”¨é’©å­å‡½æ•°terminated()å‘ŠçŸ¥å­ç±»å³å°†è¦ç»ˆç»“\tTERMINATEDï¼šterminated()æ‰§è¡Œå TERMINATED\tterminated()å®Œæˆ ThreadPoolExecutorå®ç°ä¸­å°†çº¿ç¨‹æ± çŠ¶æ€ä¸å·¥äººæ•°é‡æ•´åˆåˆ°ä¸€ä¸ªIntegerå†…ï¼Œä¸ºäº†ä¿è¯å¹¶å‘å®‰å…¨ï¼ŒIntegerä½¿ç”¨AtomicIntegerã€‚æ§åˆ¶çŠ¶æ€ä¸€å…±5ç§ï¼Œåœ¨è®¾è®¡ä¸­é€šè¿‡ä¿è¯å„ä¸ªçŠ¶æ€åœ¨çŠ¶æ€ç©ºé—´ä¸­çš„æœ‰åºï¼Œç›´æ¥ä½¿ç”¨æ•°å€¼çš„æ–¹å¼åˆ¤æ–­å½“å‰çŠ¶æ€ã€‚\nå·¥äººæ•°é‡ï¼ˆworkerCountï¼‰ï¼š\nè®°å½•å½“å‰çº¿ç¨‹æ± ä¸­çš„æœ‰æ•ˆçº¿ç¨‹æ•°é‡ï¼Œä¸»è¦ç”¨äºçŠ¶æ€å˜æ›´ã€åˆ¤æ–­æ˜¯å¦éœ€è¦æ–°å¢çº¿ç¨‹ã€çº¿ç¨‹æ•°é‡æ˜¯å¦å·²è¾¾è®¾å®šå€¼ç­‰ã€‚\nçŠ¶æ€å­—æ®µï¼š\nprivate final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0)); private static final int COUNT_BITS = Integer.SIZE - 3;//29 private static final int CAPACITY = (1 Â« COUNT_BITS) - 1;//0001111111111â€¦\n// runState is stored in the high-order bits private static final int RUNNING = -1 Â« COUNT_BITS;//RUNINGçŠ¶æ€ä¸‹ï¼Œctl// Packing and unpacking ctl private static int runStateOf(int c) { return c \u0026 ~CAPACITY; }//å–é«˜ä¸‰ä½çš„ç»“æœ private static int workerCountOf(int c) { return c \u0026 CAPACITY; }//ä½ä½å³wokerCount private static int ctlOf(int rs, int wc) { return rs | wc; } ä½œä¸šé˜Ÿåˆ—(workQueue)-BlockingQueue\nç”¨äºä¿å­˜å¾…å¤„ç†ä»»åŠ¡å¹¶å°†ä»»åŠ¡ç§»äº¤ç»™å·¥ä½œçº¿ç¨‹ã€‚å£°æ˜ç±»å‹ä¸ºé˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰\nä¸è¦æ±‚poll()è¿”å›nullæ—¶ä»£è¡¨é˜Ÿåˆ—ä¸ºç©ºï¼ˆisEmptyï¼‰ï¼Œåœ¨å†³å®šæ˜¯å¦è¿›è¡Œçº¿ç¨‹æ± çŠ¶æ€è½¬ç§»æ—¶ï¼ˆæ¯”å¦‚ç”±SHUTDOWNè½¬ç§»ä¸ºTIDYINGéœ€è¦åˆ¤æ–­ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼‰ä½¿ç”¨isEmptyåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚è¿™ç§è®¾è®¡å°±å¯ä»¥è®©workQueueä½¿ç”¨ä¸€äº›ç‰¹æ®Šè®¾è®¡çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆDelayQueueï¼Œå³ä¾¿poll()ä¸ºnullï¼Œä½†å»¶è¿Ÿä¸€æ®µæ—¶é—´åå¯ä»¥è¿”å›non-nullï¼Œå³æ— æ³•é€šè¿‡poll()æ˜¯å¦ä¸ºnullåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼‰ï¼ŒThreadPoolExecutoré€šè¿‡isEmptyè€Œépoll() == null çš„æ–¹å¼åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œèƒ½å¤Ÿå¯¹å·¥ä½œé˜Ÿåˆ—çš„å®ç°ç±»å‹æ›´åŠ åŒ…å®¹ã€‚\nThreadPoolExecutorå¹¶æ²¡æœ‰ä¸ºBlokingQueueæä¾›é»˜è®¤å®ç°ï¼ˆå£°æ˜æ—¶æ²¡æœ‰æŒ‡å®šå®ä¾‹ï¼Œä¸”æ‰€æœ‰çš„æ„é€ æ–¹æ³•æ²¡æœ‰ä¸ºå…¶æä¾›é»˜è®¤å®ç°ï¼‰ï¼Œä½†ä½¿ç”¨Executorsåˆ›å»ºThreadPoolExecutorsæ—¶é»˜è®¤ä¼šä½¿ç”¨LinkedBlockedQueueä½œä¸ºé»˜è®¤å®ç°ã€‚\nå…³äºé˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰\nåˆé€‚çš„é˜»å¡é˜Ÿåˆ—ï¼Œå½“é˜Ÿåˆ—ç©ºæ—¶ä¼šé˜»å¡æ¶ˆè´¹è€…ï¼Œé˜Ÿåˆ—æ»¡æ—¶é˜»å¡ç”Ÿäº§è€…ã€‚\nå¦‚æœä¸é€‚ç”¨é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥ä½¿ç”¨çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—+æ ‡å¿—é”å®ç°~ï¼ˆä½†è‡ªå·±å®ç°çš„æ–¹å¼å¯èƒ½ä¼šå­˜åœ¨å¾ˆå¤šç»†èŠ‚é—®é¢˜ï¼Œæœ‰ç©ºå¯ä»¥æŠŠè¿™ä¸ªç»†èŠ‚æ·±å…¥ç ”ç©¶ä¸€ä¸‹ï¼‰\nå·¥äººï¼ˆworkerï¼‰\nä¿å­˜äº†æ‰€æœ‰åœ¨çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹çš„é›†åˆ\nprivate final HashSet workers = new HashSet(); è¯¥å£°æ˜å¹¶æœªä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„Setç±»ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æœ€ä¸ºç®€å•çš„HashSetï¼Œå› æ­¤å…¶å†…éƒ¨è¦æ±‚ï¼Œä»»ä½•å¯¹è¯¥é›†åˆçš„è®¿é—®éƒ½éœ€è¦è·å–private final ReentrantLock mainLock = new ReentrantLock();çš„é”æƒé™ã€‚\nWorkerç±»å±äºThreadPoolExecutorçš„ç§æœ‰å†…éƒ¨ç±»ï¼Œå› æ­¤åªæœ‰ThreadPoolExecutorèƒ½å¤Ÿåˆ›å»ºè¯¥ç±»çš„å®ä¾‹ï¼Œä½œä¸ºå†…éƒ¨ç±»ï¼Œè¯¥ç±»çš„å®ä¾‹èƒ½å¤Ÿç›´æ¥è®¿é—®ThreadPoolExecutorçš„å±æ€§ä¸æ–¹æ³•ã€‚\nWokeræºç ï¼š\nprivate final class Worker extends AbstractQueuedSynchronizer implements Runnable { //é€šè¿‡ThreadPoolExecutorå†…çš„ThreadFactoryç”Ÿæˆçš„æ‰§è¡Œçº¿ç¨‹ //wokeræŒæœ‰è¯¥threadï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¿è¯å¯ä»¥è·å–åˆ°æ˜¯å“ªä¸ªçº¿ç¨‹æ˜¯è¯¥wokerçš„è¿è¡Œçº¿ç¨‹ final Thread thread; //è¯¥wokerçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¯èƒ½ä¸ºnull Runnable firstTask; //è¯¥wokerå®Œæˆçš„ä»»åŠ¡æ€»é‡ volatile long completedTasks;\n//AQSä¸­stateæ ‡å¿—ä½ï¼Œ0ï¼šæ— é”çŠ¶æ€ï¼Œ1ï¼šè¢«æŒæœ‰é”çŠ¶æ€ï¼Œ=0ï¼šå¯è¢«ä¸­æ–­çŠ¶æ€ Worker(Runnable firstTask) { setState(-1); // ç¦æ­¢ä¸­æ–­è¯¥worker this.firstTask = firstTask; this.thread = getThreadFactory().newThread(this);//workerä¹Ÿæ˜¯runnableï¼Œå°†workerä½œä¸ºå…¶æ‰§è¡Œçº¿ç¨‹çš„targetï¼Œå½“å…¶æ‰§è¡Œçº¿ç¨‹start()æ—¶ï¼ŒJVMä¼šè°ƒç”¨worker.run() } //è¯¥æ–¹æ³•è¡¨æ˜wokeræ˜¯ä¸ªRunnableï¼Œå½“å…¶æ‰§è¡Œçº¿ç¨‹startæ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³• public void run() { runWorker(this);//å°†è‡ªå·±ä½œä¸ºå‚æ•°ï¼Œè¿è¡Œè‡ªå·± } protected boolean isHeldExclusively() { return getState() != 0; } protected boolean tryAcquire(int unused) { if (compareAndSetState(0, 1)) { setExclusiveOwnerThread(Thread.currentThread()); return true; } return false; } protected boolean tryRelease(int unused) { setExclusiveOwnerThread(null); setState(0); return true; } public void lock() { acquire(1); } public boolean tryLock() { return tryAcquire(1); } public void unlock() { release(1); } public boolean isLocked() { return isHeldExclusively(); } //ä»…å½“wokerçº¿ç¨‹è¿è¡Œæ—¶ï¼Œå…è®¸ä¸­æ–­ void interruptIfStarted() { Thread t; //getState() = 0 é€šè¿‡åˆ¤æ–­stateæ˜¯å¦å¤§äº0ï¼Œåˆå§‹æƒ…å†µä¸‹state=-1 //å½“state = 0 \u0026\u0026 (t = thread) != null \u0026\u0026 !t.isInterrupted()) { try { t.interrupt();//ä¸­æ–­æ‰§è¡Œçº¿ç¨‹ } catch (SecurityException ignore) { } } }  } ThreadPoolExecutor.runWoker()\nfinal void runWorker(ThreadPoolExecutor.Worker w) { //runWokerï¼ˆï¼‰æ–¹æ³•åªä¼šè¢«Woker.run()è°ƒç”¨ï¼Œè€ŒWoker.run()åªä¼šåœ¨å…¶æ‰§è¡Œçº¿ç¨‹startåç”±jvmè°ƒç”¨ï¼Œå› æ­¤runWokerï¼ˆï¼‰å¿…å®šåªä¼šè¢«å¯¹åº”Workerçš„æ‰§è¡Œçº¿ç¨‹è°ƒç”¨ Thread wt = Thread.currentThread();//æ‰€ä»¥è¿™é‡Œå½“å‰çº¿ç¨‹å°±æ˜¯w.threadï¼Œä¹Ÿå°±æ˜¯wokerçš„æ‰§è¡Œçº¿ç¨‹ Runnable task = w.firstTask; w.firstTask = null; w.unlock();//æ­¤æ—¶wokerçš„æ‰§è¡Œçº¿ç¨‹å·²ç»å¯åŠ¨ï¼Œå…è®¸å¤–éƒ¨è¿›è¡Œä¸­æ–­ï¼Œå› æ­¤å°†wokerçš„stateç½®ä¸º0 boolean completedAbruptly = true; try { //getTask()é‡ç‚¹ï¼Œå†…éƒ¨å…¶å®æ˜¯ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡ï¼ŒåŒ…å«äº†çº¿ç¨‹é˜»å¡ã€æŒ‚èµ·ã€æ·˜æ±°ç­‰ä¸€ç³»åˆ—é€»è¾‘ //æ­£å¸¸æƒ…å†µä¸‹å°±æ˜¯è¯¥çº¿ç¨‹ä¸æ–­ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œå–ä»»åŠ¡ while (task != null || (task = getTask()) != null) { //è¿™é‡Œçš„è¿™ä¸ªlockå¾ˆæœ‰æ„æ€ //å¦‚æœä»…ä»…æ˜¯æ‰§è¡Œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„è¯ï¼Œå…¶å®æ‰§è¡Œçº¿ç¨‹è·å–wokeré”å¹¶æ— å¤ªå¤§æ„ä¹‰ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºè¯¥æ–¹æ³•(runWoker(â€¦))åªä¼šè¿è¡Œåœ¨æ‰§è¡Œçº¿ç¨‹ä¸­ï¼Œä¸å¯èƒ½æœ‰å¹¶å‘æƒ…å†µï¼Œå¦ä¸€æ–¹é¢wokeræœ¬èº«æ²¡æœ‰å¯ä»¥å…±äº«çš„èµ„æºï¼ˆè¿™ä¸ªåœ°æ–¹å¯ä»¥å†è€ƒè™‘ä¸€ä¸‹ï¼šè·å–çš„ä»»åŠ¡ã€æœ¬èº«æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦ç®—å¯å…±äº«èµ„æºå‘¢ï¼‰ï¼Œæ²¡å¿…è¦è·å–è¿™ä¸ªé”ï¼Œä½†è¿™ä¸ªåœ°æ–¹æœ‰ä¸ªéšè—é€»è¾‘ï¼Œå°±æ˜¯ä¸€æ—¦wokeråœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™wokerå¿…å®šæ˜¯è¢«å…¶æ‰§è¡Œçº¿ç¨‹é”ä½çš„ï¼Œå› æ­¤é€šè¿‡wokeré”çš„çŠ¶æ€å¯ä»¥åˆ¤æ–­wokeræ˜¯å¦åœ¨æ‰§è¡Œä»»åŠ¡ã€‚å½“å¤–éƒ¨çº¿ç¨‹æƒ³è¦è®©workeræ­£å¸¸æ‰§è¡Œå®Œä»»åŠ¡ï¼Œç„¶åå†åœæ­¢wokeræ—¶ï¼Œå°±å¿…é¡»è·å–è¯¥wokerçš„é”ï¼Œå¦‚æ­¤å°±èƒ½å¤Ÿä¿è¯wokerå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡è¢«æ­£å¸¸å®Œæˆ w.lock(); //ç®€çŸ­çš„ä»£ç ï¼Œé€»è¾‘å¤æ‚ï¼Œå…·ä½“åˆ†æå‚è§â€œWorkeræ£€æµ‹ThreadPoolExecutoræ˜¯å¦StopingåŠçº¿ç¨‹çŠ¶æ€æœºåˆ¶â€ if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() \u0026\u0026 runStateAtLeast(ctl.get(), STOP))) \u0026\u0026 !wt.isInterrupted()) wt.interrupt(); try { beforeExecute(wt, task);//å•ä¸ªä»»åŠ¡æ‰§è¡Œä¹‹å‰çš„é’©å­å‡½æ•° Throwable thrown = null; try { task.run();//çœŸæ­£çš„æ‰§è¡Œä»»åŠ¡ } catch (RuntimeException x) { thrown = x; throw x; } catch (Error x) { thrown = x; throw x; } catch (Throwable x) { thrown = x; throw new Error(x); } finally { afterExecute(task, thrown);//ä»»åŠ¡æ‰§è¡Œä¹‹åçš„é’©å­å‡½æ•° } } finally { task = null; w.completedTasks++;//å®Œæˆä»»åŠ¡è®¡æ•° w.unlock();//é‡Šæ”¾é”ï¼Œè¡¨æ˜å½“å‰workerå·²ç»å®ŒæˆæŸä¸ªä»»åŠ¡çš„æ‰§è¡Œ } } completedAbruptly = false;//è¡¨æ˜çº¿ç¨‹æ­£å¸¸æ‰§è¡Œå®Œä»»åŠ¡ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™è¯´æ˜æ‰§è¡Œå½¢æˆå¯èƒ½ä¸­é€”è¢«ä¸­æ–­ï¼Œæˆ–æ˜¯ç”¨æˆ·ä»»åŠ¡å‘ç”Ÿäº†å¼‚å¸¸ } finally { /* *å¤„ç†å°†è¦ç»“æŸçš„workerçš„æ”¶å°¾å·¥ä½œã€‚ * 1ã€å°†å½“å‰workerä»workerSetä¸­ç§»é™¤ * 2ã€å°è¯•å°†çº¿ç¨‹æ± è¿‡åº¦ä¸ºTerminatedçŠ¶æ€ * 3ã€åœ¨çº¿ç¨‹æ± ä»ç„¶éœ€è¦æ‰§è¡Œä»»åŠ¡çš„çŠ¶æ€ä¸‹ï¼ˆRUNINGã€SHUTDOWNï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ æ–°çš„workerè‡³çº¿ç¨‹æ± ï¼Œæ·»åŠ æ¡ä»¶ä¸ºï¼š1ï¼‰å½“å‰workerä¸ºçªç„¶ç»ˆæ­¢ï¼›2ï¼‰å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡å°äºæœ€å°éœ€æ±‚çº¿ç¨‹æ•°é‡ * 4ã€èµ°åˆ°è¿™è¡Œä»£ç ä¸€èˆ¬æœ‰ä¸¤ç§åœºæ™¯ï¼š1ï¼‰æ— ä»»åŠ¡å¯åšï¼Œä¸”ä¸ä¼šæœ‰æ–°ä»»åŠ¡æ¥äº†ï¼›2ï¼‰ç”¨æˆ·ä»»åŠ¡æ‰§è¡ŒæœŸé—´å‘ç”Ÿäº†å¼‚å¸¸ */ processWorkerExit(w, completedAbruptly); } } Workeræ£€æµ‹ThreadPoolExecutoræ˜¯å¦StopingåŠçº¿ç¨‹çŠ¶æ€æœºåˆ¶\n1ã€å¦‚æœThreadPoolå¤„äºStopã€Tidyingæˆ–Terminatedï¼Œä¸”å½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œåˆ™ä¸­æ–­å½“å‰çº¿ç¨‹ï¼›2ã€å¦‚æœå¤„ç†Runingã€ShutdownçŠ¶æ€ï¼Œåˆ™æ¸…é™¤å½“å‰ä¸­æ–­æ ‡å¿—ä½ï¼Œè¿”å›ä¹‹å‰çš„ä¸­æ–­æ ‡å¿—ï¼Œå¦‚æœä¹‹å‰æ˜¯ä¸­æ–­çš„ï¼Œä¸”ThreadPoolçŠ¶æ€å˜ä¸ºäº†Stopã€Tidyingæˆ–Terminatedï¼Œåˆ™å†æ¬¡ä¸­æ–­æ‰§è¡Œçº¿ç¨‹ï¼›3ã€è¿™æ®µé€»è¾‘ä¿è¯äº†ï¼šå¦‚æœå½“å‰ThreadPoolExecutorå¤„äºRUNINGã€SHUTDOWNï¼Œåˆ™ä¸­æ–­æ ‡å¿—ä½è¢«æ¸…é™¤ï¼›å¦åˆ™ï¼Œç›´æ¥ä¸­æ–­æ‰§è¡Œçº¿ç¨‹ã€‚4ã€è¿›ä¸€æ­¥æ€è€ƒï¼šå¦‚æœä¸è¿™æ ·å®ç°ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ\nä¸‹å›¾ä¸ºå®é™…çš„åˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœæ²¡æœ‰çº¢æ¡†éƒ¨åˆ†é€»è¾‘ï¼Œåˆ™ä¹‹å‰çš„æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½å¯èƒ½ä¼šå¯¼è‡´åœ¨ç®­å¤´å¤„æ’å…¥çš„ShutdownNowäº‹ä»¶è¢«å¿½ç•¥ã€‚\nå¤„ç†wokerç»“æŸçš„å·¥ä½œ\nprivate void processWorkerExit(Worker w, boolean completedAbruptly) { if (completedAbruptly) // If abrupt, then workerCount wasnâ€™t adjusted //æ­£å¸¸ç»“æŸä¸éœ€è¦å†å»å‡å°‘workerCountï¼ŒåŸå› æ˜¯åœ¨getTask()çš„åœ°æ–¹å·²ç»é¢„å…ˆå‡è¿‡äº† decrementWorkerCount();\nfinal ReentrantLock mainLock = this.mainLock; mainLock.lock(); try { completedTaskCount += w.completedTasks; workers.remove(w); } finally { mainLock.unlock(); } tryTerminate(); int c = ctl.get(); if (runStateLessThan(c, STOP)) { if (!completedAbruptly) { int min = allowCoreThreadTimeOut ? 0 : corePoolSize; if (min == 0 \u0026\u0026 ! workQueue.isEmpty()) min = 1; if (workerCountOf(c) = min) return; // replacement not needed } addWorker(null, false); }  } çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹åˆ›å»ºä¸é”€æ¯\nå¤±æ•ˆåœºæ™¯ï¼š1ã€ç©ºé—²workerï¼ˆå½“å‰workeræ•°é‡è¶…è¿‡corePoolSizeï¼Œä¸”çº¿ç¨‹keepAliveTimeæ—¶é—´å†…æœªè·å–åˆ°ä»»åŠ¡ï¼Œè¿™ä¹Ÿæ˜¯çº¿ç¨‹æ± æ§åˆ¶workerè¶…æ—¶å¤±æ•ˆçš„æœºåˆ¶ï¼‰ï¼›2ã€ç”¨æˆ·ç¨‹åºå¼‚å¸¸ï¼›3ã€ä»»åŠ¡å®Œå…¨å¤„ç†å®Œæˆ\nçº¿ç¨‹æ± åœ¨å¤„ç†å¤±æ•ˆçº¿ç¨‹æ—¶ï¼Œå¦‚æœä»ç„¶éœ€è¦å¢åŠ çº¿ç¨‹ï¼Œé‚£ä¹ˆä¼šå†æ¬¡é€šè¿‡ThreadFactoryåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚\nå‡è®¾å¦‚ä¸‹åœºæ™¯ï¼šçº¿ç¨‹æ± æŒç»­æ¥æ”¶æ–°ä»»åŠ¡ï¼Œå¦‚æœæ–°çš„ä»»åŠ¡æ­£å¸¸æ‰§è¡Œï¼Œé‚£ä¹ˆæ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹è¿˜ä¼šç»§ç»­æœå½¹ï¼Œå¤„ç†åç»­çš„æ–°ä»»åŠ¡ï¼Œä½†æ˜¯å¦‚æœæ–°çš„ä»»åŠ¡æ— æ³•æ­£å¸¸æ‰§è¡Œï¼ŒæŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†ç”±äºè¯¥å¼‚å¸¸è€Œè€Œç»ˆç»“ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹ç»§ç»­å¤„ç†åç»­ä»»åŠ¡ã€‚æ‰€ä»¥å½“æ‰€æœ‰çš„æ–°ä»»åŠ¡éƒ½æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹æ± å•ä¸ªçº¿ç¨‹çš„å¯¿å‘½æçŸ­ï¼Œé¢‘ç¹åˆ›å»ºçº¿ç¨‹ï¼Œäº‹å®ä¸Šå¯¼è‡´çº¿ç¨‹æ± å¤±æ•ˆã€‚\nå®é™…ä¸Šå‘¢ï¼Ÿ\né€šè¿‡submit()æäº¤ç»™çº¿ç¨‹æ± çš„RunnableTaskéƒ½è¢«åŒ…è£…ä¸ºFutureTaskäº†ï¼Œè€ŒFutureTaskåœ¨runï¼ˆï¼‰çš„æ—¶å€™ï¼Œå¯¹å¼‚å¸¸è¿›è¡ŒåŒ…è£…ï¼Œå°†outComeè¾“å‡ºä¸ºExceptionï¼Œä¹Ÿå°±æ˜¯è¯´æ­£å¸¸çš„ç”¨æˆ·å¼‚å¸¸æ ¹æœ¬ä¸ä¼šæŠ›å‡ºåˆ°Workerçš„runWoker loopé‡Œâ€¦\nä½†æ˜¯å¦‚æœç›´æ¥è°ƒç”¨ThreadPoolExecutor.execute()æ–¹æ³•ï¼Œåˆ™ä¸ä¼šä½¿ç”¨FutureTaskåŒ…è£…è¯¥Runnableäº†ï¼ŒåŒ…è£…çš„è¿‡ç¨‹éƒ½æ˜¯åœ¨AbstractExecutorServiceé‡Œå®Œæˆçš„ï¼Œç›´æ¥é€šè¿‡executeæ‰§è¡Œä»»åŠ¡çš„è¯ï¼Œåˆ™ä¼šäº§ç”Ÿä¹‹å‰æ‰€è¿°çš„åœºæ™¯ï¼Œçº¿ç¨‹å°†é¢‘ç¹åˆ›å»º\nThreadPoolExecutor executorService = (ThreadPoolExecutor) Executors.newFixedThreadPool(5, new NamedThreadFactory()); while (true) { try { Thread.sleep(100); } catch (InterruptedException e) { e.printStackTrace(); } executorService.execute(() - {//ä½¿ç”¨Executor.executeï¼ˆï¼‰æ‰§è¡Œï¼Œåˆ™ä¼šå‡ºç°é¢‘ç¹åˆ›å»ºçº¿ç¨‹æ± çš„æƒ…å†µï¼Œä½¿ç”¨submitï¼ˆï¼‰åˆ™ä¸ä¼šï¼Œä½†å…¶å®executeä¸submitéƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œ throw new RuntimeException(); }); } 6ã€æ€»ç»“ çº¿ç¨‹æ± çš„æ ¸å¿ƒå…¶å®æ˜¯ä¸€ä¸ªåŸºäºBlockingQueueçš„ä»»åŠ¡ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ï¼Œä»»åŠ¡çš„ç”Ÿäº§æ–¹ä¸ºThreadPoolçš„ä½¿ç”¨æ–¹ï¼Œé€šè¿‡submitä¸executeç”Ÿäº§Runnableä»»åŠ¡ï¼Œä»»åŠ¡çš„æ¶ˆè´¹æ–¹åˆ™ä¸ºThreadPoolå†…éƒ¨çš„Workerã€‚TheadPoolåšäº†å¾ˆå¤šå…³äºçº¿ç¨‹æ± ç‰¹æ€§çš„æ§åˆ¶ï¼šæ¯”å¦‚æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ã€æœ€å¤§çº¿ç¨‹æ± å¤§å°ã€ç©ºé—²çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´ç­‰ç­‰ï¼Œä¸»è¦å°±æ˜¯é€šè¿‡Workerä»BlockingQueueä¸­è·å–ä»»åŠ¡çš„çŠ¶æ€æ¥æ§åˆ¶Workerçš„é”€æ¯ã€‚\næºç ååˆ†ç²¾å·§ï¼Œéƒ¨åˆ†ä»£ç å†™çš„ç›¸å½“ç®€ç»ƒï¼Œä½†åŒ…å«äº†å¾ˆæ·±çš„å…³äºçŠ¶æ€å®šä¹‰ã€ä»»åŠ¡ç”Ÿäº§ã€ä»»åŠ¡æ¶ˆè´¹ã€è¶…æ—¶æ§åˆ¶ã€åŒæ­¥æ§åˆ¶ã€ç©ºé—²çº¿ç¨‹é”€æ¯ã€æ–°å¢çº¿ç¨‹ç­‰ä¸€ç³»åˆ—ç‰¹æ€§çš„å®ç°é€»è¾‘ï¼Œæ¯ä¸€æ­¥çš„åŠ¨ä½œéƒ½å€¼å¾—è¿›ä¸€æ­¥æ€è€ƒã€‚\nå¦‚æœè®©è‡ªå·±å»å®ç°ä¸€éè¿™æ ·çš„çº¿ç¨‹æ± ï¼Œè¯¥å¦‚ä½•å»å®ç°å‘¢ï¼Ÿ\næœ€åé™„ä¸Šå‘ThreadPoolExecutor submitä»»åŠ¡çš„æ‰§è¡Œæµç¨‹å›¾~\n","wordCount":"8443","inLanguage":"zh","datePublished":"2022-02-28T19:57:47Z","dateModified":"2022-02-28T19:57:47Z","author":{"@type":"Person","name":"swimminghao"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"},"publisher":{"@type":"Organization","name":"swimminghao","logo":{"@type":"ImageObject","url":"https://swimminghao1.github.io/favicon.ico"}}}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://swimminghao1.github.io/ accesskey=h title="ğŸ€ swimminghao (Alt + H)">ğŸ€ swimminghao</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://swimminghao1.github.io/categories/ title="ğŸ—‚ å½’ç±»"><span>ğŸ—‚ å½’ç±»</span></a></li><li><a href=https://swimminghao1.github.io/tags/ title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li><li><a href=https://swimminghao1.github.io/archives/ title="â±ï¸ æ—¶é—´è½´"><span>â±ï¸ æ—¶é—´è½´</span></a></li><li><a href=https://swimminghao1.github.io/search/ title="ğŸ” ç´¢å¼• (Alt + /)" accesskey=/><span>ğŸ” ç´¢å¼•</span></a></li><li><a href=https://swimminghao1.github.io/friends title="ğŸ§‘â€ğŸ¤â€ğŸ§‘ å‹é“¾"><span>ğŸ§‘â€ğŸ¤â€ğŸ§‘ å‹é“¾</span></a></li><li><a href=https://www.travellings.cn/go.html title=ğŸš‡><span>ğŸš‡</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://swimminghao1.github.io/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://swimminghao1.github.io/post/>ğŸ“šæ–‡ç« </a></div><h1 class=post-title><a href=https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/>çº¿ç¨‹æ± </a></h1><div class=post-meta>February 28, 2022&nbsp;Â·&nbsp;17 åˆ†é’Ÿ&nbsp;Â·&nbsp;8443 å­—&nbsp;Â·&nbsp;swimminghao&nbsp;|&nbsp;<a href=https://github.com/songtianlun/songtianlun.github.io/edit/main/content/post/08%e5%ad%98%e6%a1%a3%e6%96%87%e4%bb%b6/%e6%96%87%e6%a1%a3/%e7%ba%bf%e7%a8%8b%e6%b1%a0.md rel="noopener noreferrer" target=_blank>PR</a>
<span>| <span class=waline-pageview-count data-path=/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/><i class="fa fa-spinner fa-spin"></i></span> Hits</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0 aria-label=çº¿ç¨‹æ± >çº¿ç¨‹æ± </a></li></ul></div><div><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7296634171837358 data-ad-slot=9161921641 data-ad-format=auto data-full-width-responsive=true></ins></div><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></details></div><div class=post-content><blockquote style=margin-top:8px><p style=text-align:center;text-indent:0><a href=https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/>æœ¬æ–‡</a>
é¦–å‘äº
<a href=https://swimminghao1.github.io/>ğŸ€ æ°¸æµ©</a>ï¼Œ
<a href=/disclaimer/>è½¬è½½</a> è¯·æ³¨æ˜
<a href=https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E6%96%87%E6%A1%A3/%E7%BA%BF%E7%A8%8B%E6%B1%A0/>æ¥æº</a>ã€‚</p></blockquote><h1 id=çº¿ç¨‹æ± >çº¿ç¨‹æ± <a hidden class=anchor aria-hidden=true href=#çº¿ç¨‹æ± >#</a></h1><p>ThreadPoolæºç å­¦ä¹ 
zodiac Â·2020-12-10 Â·20 æ¬¡é˜…è¯»</p><p>ThreadPoolExecutor
jdk1.5åœ¨jucåŒ…é‡Œæä¾›äº†æ–¹ä¾¿å¿«æ·çš„çº¿ç¨‹æ± apiï¼Œå¹¶æä¾›äº†åŸºäºå·¥å‚æ¨¡å¼çš„Executorså·¥å…·ç±»ç”¨äºå¿«æ·åˆ›å»ºçº¿ç¨‹æ± ï¼Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼Œåº”å½“ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨Executors</p><p>1ã€ç±»ç»§æ‰¿å…³ç³»</p><p>Executorä¸ºé¡¶çº§æ¥å£ï¼Œå…¶ä¸»è¦ç›®æ ‡æ˜¯å°†ä»»åŠ¡ã€ä»»åŠ¡çš„æäº¤ä¸ä»»åŠ¡çš„æ‰§è¡Œè§£è€¦</p><p>ExecutorServiceæ¥å£åˆ™å®šä¹‰äº†æ­£å¸¸çš„çº¿ç¨‹æ± åº”è¯¥æœ‰çš„åŠŸèƒ½ä¸è¡Œä¸ºï¼Œè¯¸å¦‚ä»»åŠ¡æäº¤ï¼Œå¼‚æ­¥æ‰§è¡Œç­‰ç­‰</p><p>ScheduledExecutorServiceæ¥å£åˆ™å®šä¹‰äº†ä¸€äº›å®šæ—¶çš„ç‰¹æ€§</p><p>2ã€Executor
Executoræ‰§è¡Œæäº¤çš„ä»»åŠ¡ï¼ˆRunnableï¼‰ï¼Œè¯¥æ¥å£æä¾›äº†ä¸€ç§å°†ä»»åŠ¡æäº¤ä¸ä»»åŠ¡æ‰§è¡Œï¼ˆåŒ…æ‹¬æ‰§è¡Œç»†èŠ‚ï¼šçº¿ç¨‹ã€å®šæ—¶ç­‰ï¼‰è§£è€¦çš„é€”å¾„ã€‚</p><p>é€šè¿‡ExecutoråŒ…è£…çš„çº¿ç¨‹ï¼ˆThreadï¼‰å¯¹è±¡ï¼Œé¿å…ç›´æ¥ä½¿ç”¨Threadå¯¹è±¡æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¯ä»¥æœ‰æ•ˆå°†çº¿ç¨‹ä¿¡æ¯å±è”½ï¼Œé¿å…ç›´æ¥å¯¹çº¿ç¨‹çš„æ“ä½œã€‚</p><p>Executoræœ¬èº«å¹¶ä¸å¼ºåˆ¶è¦æ±‚æ‰§è¡Œçš„ä»»åŠ¡å¿…é¡»æ˜¯å¼‚æ­¥æ‰§è¡Œ</p><p>ç”¨äºæ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œå™¨ï¼Œè€ŒRunnableåˆ™è¡¨ç¤ºå¯ä»¥ç”¨äºæ‰§è¡Œçš„ä»»åŠ¡ã€‚</p><p>/**</p><ul><li>åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»æ‰§è¡Œç»™å®šçš„æŒ‡ä»¤ï¼Œå‘½ä»¤å¯ä»¥åœ¨æ–°çš„çº¿ç¨‹ä¸­ã€çº¿ç¨‹æ± æˆ–è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œ</li><li>å®é™…æƒ…å†µå–å†³äºExecutorçš„å®ç°
*/
void execute(Runnable command);
3ã€ExecutorService
èƒ½å¤Ÿç®¡ç†ä»»åŠ¡ç»ˆæ­¢ã€èƒ½å¤Ÿäº§ç”Ÿè¿½è¸ªä¸€ä¸ªæˆ–å¤šä¸ªå¼‚æ­¥ä»»åŠ¡å¤„ç†è¿›åº¦çš„Futureçš„æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰</li></ul><p>æ¥å£çš„æ ¸å¿ƒå®šä¹‰ï¼š</p><p>æäº¤ä»»åŠ¡</p><p><t>Future<t> submit(Callable<t> task);
<t>Future<t> submit(Runnable task, T result);
Future submit(Runnable task);
ç¬¬ä¸€ç§æäº¤Callable<t> taskç±»å‹çš„ä»»åŠ¡è¾ƒå¥½ç†è§£ï¼Œä»»åŠ¡å®Œæˆæ—¶ä¼šå°†taskçš„ç»“æœæ”¾è‡³Futureä¸­ã€‚</p><p>ç¬¬äºŒç§æ–¹å¼ï¼ŒRunnable taskå’Œ T resultä½œä¸ºå‚æ•°ï¼Œå®é™…ä¸Šå†…éƒ¨é€šè¿‡åŒ…è£…å°†å…¥å‚resultä½œä¸ºè¿”å›å€¼ä¸Runnable taskä¸€åŒåŒ…è£…ä¸ºä¸€ä¸ªCallableï¼Œæœ€åä»»åŠ¡å®Œæˆæ—¶å°†Callableç»“æœæ”¾è‡³Futureä¸­ã€‚å› æ­¤é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå…¥å‚resultï¼Œè¿”å›ç»“æœåˆ™æ˜¯å¯èƒ½åœ¨ä»»åŠ¡ä¸­è¢«ä¿®æ”¹çš„resultã€‚</p><p>AbstractExecutorService</p><p>public Future submit(Runnable task) {
if (task == null) throw new NullPointerException();
RunnableFuture<void> ftask = newTaskFor(task, null);//ç”Ÿæˆä¸€ä¸ªRunnableFutureä½œä¸ºä»»åŠ¡
execute(ftask);
return ftask;
}</p><p>//å¼‚æ­¥ä»»åŠ¡çš„æŠ½è±¡ï¼Œå†…éƒ¨å°è£…äº†å®é™…çš„ä»»åŠ¡ã€ä»»åŠ¡çŠ¶æ€ã€çœŸæ­£çš„æ‰§è¡Œçº¿ç¨‹ä»¥åŠç­‰å¾…ä»»åŠ¡å®Œæˆçš„çº¿ç¨‹ç­‰ç»†èŠ‚
//å®é™…ä¸Šæ˜¯è°ƒç”¨FutureTask.run()çš„çº¿ç¨‹è¢«é˜»å¡ï¼Œä½œä¸ºçœŸæ­£çš„æ‰§è¡Œçº¿ç¨‹
protected <t>RunnableFuture<t> newTaskFor(Runnable runnable, T value) {
return new FutureTask<t>(runnable, value);//åˆ›å»ºFutureTask
}
FutureTask</p><p>public FutureTask(Runnable runnable, V result) {
this.callable = Executors.callable(runnable, result);//å°†Runnableé€‚é…ä¸ºCallable
this.state = NEW; // ensure visibility of callable
}
Tipsï¼š</p><p>FutureTaské‡Œæœ‰å¾ˆå¤šç‰¹æ€§ï¼ˆæ¯”å¦‚å¯¹ç­‰å¾…ä»»åŠ¡å®Œæˆçš„çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼Œä»»åŠ¡å®Œæˆåå¯¹ç­‰å¾…çº¿ç¨‹çš„å”¤é†’ï¼Œé˜²æ­¢ä»»åŠ¡è¢«å¹¶å‘è°ƒç”¨ç­‰ç­‰ï¼‰éƒ½å¯ä»¥ä½¿ç”¨AbstractQueuedSynchronizerï¼Œä½†åœ¨JDK1.8ä¸­çš„æºç å´æ²¡æœ‰å‘ç°AQSçš„ç—•è¿¹ï¼Œæƒ³æƒ³è¿™æ˜¯ä¸ºä½•ï¼Ÿ</p><p>æ—©æœŸFutureTaskç¡®å®æ˜¯ä½¿ç”¨AQSå®ç°ï¼Œåç»­ä¿®æ”¹ä¸ºäº†ç›®å‰çš„æ ·å­ï¼ˆå¾ˆå¤šé€šè¿‡å†…å­˜ç›´æ¥ä¿®æ”¹å¯¹è±¡çš„æ“ä½œï¼ŒUnsafeç±»ï¼‰ï¼Œæ ¸å¿ƒæ˜¯ä¸ºäº†æ€§èƒ½ã€‚è¿™ä¸€éƒ¨åˆ†å¯ä»¥å†å•ç‹¬æ·±å…¥çœ‹çœ‹</p><p>Executors.RunnableAdapter</p><p>//ç®€å•çš„é€‚é…ï¼Œå°†RunnableåŒ…è£…ä¸ºCallable
static final class RunnableAdapter<t> implements Callable<t> {
final Runnable task;
final T result;
RunnableAdapter(Runnable task, T result) {
this.task = task;
this.result = result;
}
public T call() {
task.run();
return result;
}
}
ç¬¬ä¸‰ç§æ–¹å¼ï¼Œä¸ç¬¬äºŒç§ç±»ä¼¼ï¼Œä¼šåˆ›ä¸€ä¸ªresult ä¸º nullçš„Runnableé€‚é…å™¨ã€‚</p><p>å¼‚æ­¥æ‰§è¡Œä»»åŠ¡</p><p>é€šè¿‡ä»»åŠ¡æäº¤ã€invokeAnyã€invokeAll</p><p>ç­‰å¾…ä»»ä¸€/å…¨éƒ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆ</p><p>invokeAny()
ä¸€æ¬¡æ€§æäº¤æ‰¹é‡ä»»åŠ¡ï¼Œæœ‰ä»»ä¸€ä»»åŠ¡å®Œæˆæ—¶è¿”å›è¯¥ä»»åŠ¡çš„å¤„ç†ç»“æœï¼Œè°ƒç”¨çº¿ç¨‹é˜»å¡ã€‚</p><p>private <t>T doInvokeAny(Collection&lt;? extends Callable<t>> tasks,
boolean timed, long nanos)
throws InterruptedException, ExecutionException, TimeoutException {
if (tasks == null)
throw new NullPointerException();
int ntasks = tasks.size();
if (ntasks == 0)
throw new IllegalArgumentException();
ArrayList&lt;Future<t>> futures = new ArrayList&lt;Future<t>>(ntasks);
ExecutorCompletionService<t> ecs =
new ExecutorCompletionService<t>(this);//Wrapperæˆ–Decoratoræ¨¡å¼ï¼ˆç»„åˆæ¨¡å¼ï¼Ÿï¼Ÿï¼‰ï¼Œå¢å¼ºäº†å¯¹å·²å®Œæˆä»»åŠ¡çš„ç®¡ç†èƒ½åŠ›</p><pre><code>try {
    ExecutionException ee = null;
    final long deadline = timed ? System.nanoTime() + nanos : 0L;
    Iterator&lt;? extends Callable&lt;T&gt;&gt; it = tasks.iterator();
    //1ã€æäº¤ç¬¬ä¸€ä¸ªä»»åŠ¡
    futures.add(ecs.submit(it.next()));
    --ntasks;
    int active = 1;
    for (; ; ) {
        //2ã€åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ
        Future&lt;T&gt; f = ecs.poll();
        if (f == null) {
            //3ã€æ²¡æœ‰å®Œæˆï¼Œä¸”è¿˜æœ‰ä»»åŠ¡å¯ä»¥æäº¤æ—¶ï¼Œç»§ç»­æäº¤
            if (ntasks &gt; 0) {
                --ntasks;
                futures.add(ecs.submit(it.next()));
                ++active;
            } else if (active == 0)//4ã€æ²¡æœ‰å®Œæˆã€æ²¡æœ‰ä»»åŠ¡å¯ä»¥æäº¤ã€æ— å¤„ç†ä¸­ä»»åŠ¡è·³å‡º
                break;
            else if (timed) {//5ã€æ— ä»»åŠ¡æäº¤ï¼Œä»»åŠ¡åœ¨å¤„ç†ä¸­æ—¶ï¼Œè®¾ç½®ç­‰å¾…ä»»åŠ¡å®Œæˆ
                f = ecs.poll(nanos, TimeUnit.NANOSECONDS);
                if (f == null)
                    throw new TimeoutException();
                nanos = deadline - System.nanoTime();
            } else//6ã€æ— é™æœŸé˜»å¡ï¼Œç­‰å¾…å®Œæˆä»»åŠ¡çš„é˜Ÿåˆ—æœ‰å®Œæˆä»»åŠ¡å¯ä»¥è·å¾—
                f = ecs.take();
        }
        if (f != null) {//7ã€è·å–åˆ°å®Œæˆä»»åŠ¡
            --active;
            try {
                return f.get();//8ã€è¿”å›å®Œæˆä»»åŠ¡çš„ç»“æœ
            } catch (ExecutionException eex) {
                ee = eex;
            } catch (RuntimeException rex) {
                ee = new ExecutionException(rex);
            }
        }
    }
 
    if (ee == null)
        ee = new ExecutionException();
    throw ee;
} finally {//9ã€æœ€ç»ˆå–æ¶ˆæ‰€æœ‰ä»»åŠ¡
    for (int i = 0, size = futures.size(); i &lt; size; i++)
        futures.get(i).cancel(true);//FutureTask.cancel()åªæœ‰å½“æœªNEWçŠ¶æ€æ‰ä¼šå–æ¶ˆ
}
</code></pre><p>}
invokeAll
å¦‚æœæ— è¶…æ—¶æ—¶é—´ï¼ˆè¾ƒä¸ºç®€å•ï¼‰</p><p>åˆ™éå†FutureTaskï¼Œé€šè¿‡FutureTask.get()æ–¹æ³•é˜»å¡è°ƒç”¨çº¿ç¨‹å³å¯ã€‚</p><p>å¦‚æœå­˜åœ¨è¶…æ—¶æ—¶é—´</p><p>éå†FutureTaskï¼Œæ¯æäº¤ä¸€æ¬¡ä»»åŠ¡æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦è¶…æ—¶ã€‚ä»»åŠ¡æäº¤å®Œæˆåï¼Œéå†æœªç»“æŸFutureï¼Œè°ƒç”¨Future.get(timeout)ï¼Œæœ€ç»ˆè¿”å›ç»“æœï¼Œä»»åŠ¡æ¸…ç†ã€‚</p><p>public <t>List&lt;Future<t>> invokeAll(Collection&lt;? extends Callable<t>> tasks,
long timeout, TimeUnit unit)
throws InterruptedException {
if (tasks == null)
throw new NullPointerException();
long nanos = unit.toNanos(timeout);
ArrayList&lt;Future<t>> futures = new ArrayList&lt;Future<t>>(tasks.size());
boolean done = false;
try {
for (Callable<t> t : tasks)
futures.add(newTaskFor(t));</p><pre><code>    final long deadline = System.nanoTime() + nanos;
    final int size = futures.size();
 
    // Interleave time checks and calls to execute in case
    // executor doesn't have any/much parallelism.
    for (int i = 0; i &lt; size; i++) {
        execute((Runnable)futures.get(i));//æ‰§è¡Œä»»åŠ¡ï¼Œexecutorä¸ä¿è¯å¼‚æ­¥æ‰§è¡Œ
        nanos = deadline - System.nanoTime();//æ£€æµ‹è¶…æ—¶æ—¶é—´
        if (nanos &lt;= 0L)
            return futures;//è¶…æ—¶é—´å†…æœªæäº¤çš„ä»»åŠ¡ï¼Œä¸ä¼šå†è¢«æ‰§è¡Œ
    }
 
    for (int i = 0; i &lt; size; i++) {
        Future&lt;T&gt; f = futures.get(i);
        if (!f.isDone()) {//æœªå®Œæˆfuture
            if (nanos &lt;= 0L)//é˜»å¡å‰å…ˆåˆ¤æ–­ä¸€æ¬¡æ˜¯å¦è¶…æ—¶
                return futures;
            try {
                f.get(nanos, TimeUnit.NANOSECONDS);//è¶…æ—¶æ—¶é—´å†…è·å–
            } catch (CancellationException ignore) {
            } catch (ExecutionException ignore) {
            } catch (TimeoutException toe) {
                return futures;
            }
            nanos = deadline - System.nanoTime();//æ›´æ–°è¶…æ—¶æ—¶é—´
        }
    }
    done = true;
    return futures;
} finally {
    if (!done)
        for (int i = 0, size = futures.size(); i &lt; size; i++)
            futures.get(i).cancel(true);//æœ€ç»ˆæœªå®Œæˆçš„ä»»åŠ¡ï¼Œä¸ä¼šå†è¢«æ‰§è¡Œ
}
</code></pre><p>}
ç»ˆæ­¢ä»»åŠ¡æäº¤</p><p>shutdown()</p><p>å·²æäº¤çš„ä»»åŠ¡ï¼Œä»å°†è¢«æ‰§è¡Œï¼Œä½†æ–°çš„ä»»åŠ¡ä¸å†è¢«æ¥æ”¶ã€‚å¦‚æœå·²ç»è¢«shutdownï¼Œå†æ¬¡è°ƒç”¨æ— å½±å“</p><p>ç»ˆæ­¢ä»»åŠ¡æ‰§è¡Œ</p><p>List<runnable> shutdownNow();</p><p>ç«‹å³å°è¯•åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿”å›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¸ä¼šç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ç»ˆç»“ã€‚</p><p>è¯¥æ–¹æ³•ä¼šå°è¯•å°½æœ€å¤§åŠªåŠ›ç»ˆç»“æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œä½†æ— æ³•ä¿è¯æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡è¢«ç»ˆç»“ï¼Œå› æ­¤ï¼Œå¦‚æœæœ‰ä»»åŠ¡ç»ˆç»“å¤±è´¥ï¼Œè¯¥ä»»åŠ¡ä¹Ÿè®¸æ°¸è¿œæ— æ³•è¢«ç»ˆæ­¢ã€‚</p><p>ç­‰å¾…æ‰§è¡Œå™¨è¿›å…¥ç»ˆæ­¢çŠ¶æ€</p><p>boolean awaitTermination(long timeout, TimeUnit unit) throws InterruptedException;</p><p>å½“è°ƒç”¨äº†showdown()åï¼Œåœ¨è¶…æ—¶é—´å†…ã€è°ƒç”¨çº¿ç¨‹è¢«ä¸­æ–­å‰é˜»å¡è°ƒç”¨çº¿ç¨‹ç­‰å¾…å·²æäº¤ä»»åŠ¡å®Œæˆã€‚</p><p>4ã€AbstractExecutorService
é€šè¿‡æ¨¡æ¿æ¨¡å¼çš„è®¾è®¡æ¨¡å¼ï¼Œå¯¹ExecutorServiceæ¥å£ä¸­å®šä¹‰çš„æŸäº›æ–¹æ³•ï¼Œè¿›è¡Œäº†é€šç”¨å®ç°ã€‚</p><p>public Future submit(Runnable task){&mldr;}
public <t>Future<t> submit(Runnable task, T result) {&mldr;}
public <t>Future<t> submit(Callable<t> task) {&mldr;}</p><p>public <t>T invokeAny(Collection&lt;? extends Callable<t>> tasks) throws InterruptedException, ExecutionException {&mldr;}
public <t>List&lt;Future<t>> invokeAll(Collection&lt;? extends Callable<t>> tasks) throws InterruptedException {&mldr;}
submit(&mldr;)ï¼š</p><p>ä¸»è¦é€»è¾‘ï¼š</p><p>1ã€åŒ…è£…Callableã€Runnableã€resultä¸ºRunnableFutureï¼ˆå®é™…é»˜è®¤å®ç°æ˜¯FutureTaskï¼Œé€‚é…Runableæ¥å£ï¼‰</p><p>2ã€è°ƒç”¨å®ç°ç±»execute()æ–¹æ³•æ‰§è¡ŒRunnableFuture</p><p>invokeAny(&mldr;)</p><p>invokeAll(&mldr;)</p><p>ä¸Šè¿°æ–¹æ³•çš„å…·ä½“æºç å¯ä»¥å‚è§ExecutorServiceéƒ¨åˆ†</p><p>5ã€ThreadPoolExecutor
è™½ç„¶AbstractExecutorServiceè¿›è¡Œäº†ä¸€äº›é€šç”¨å®ç°ï¼Œä½†è¯¸å¦‚execute()ã€shutdown()ç­‰ä¾èµ–å®é™…æ‰§è¡Œè·¯å¾„ä¸æ‰§è¡Œå™¨å†…éƒ¨çŠ¶æ€çš„æ–¹æ³•å¹¶æœªè¢«å®ç°ï¼Œå› æ­¤è¿™äº›æ–¹æ³•çš„å®ç°é€»è¾‘å°†æ˜¯å¯¹Executorè¿›è¡ŒåŒºåˆ†çš„é‡è¦å› ç´ ã€‚</p><p>ThreadPoolExecutorç›´è¯‘ä¸ºçº¿ç¨‹æ± æ‰§è¡Œå™¨ï¼Œè¯¥ç±»é€šè¿‡ç»´æŠ¤å†…çº¿ç¨‹æ± ï¼Œæœ€å¤§ç¨‹åº¦å¤ç”¨çº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºã€é”€æ¯ä¸ç»´æŠ¤çš„å¼€é”€ï¼Œæé«˜ä»»åŠ¡çš„æ‰§è¡Œæ•ˆç‡ã€‚é€šå¸¸ä¼šä½œä¸ºç³»ç»Ÿçš„ä¸€ä¸ªå¼‚æ­¥å¤„ç†æ¨¡å—å‡ºç°ï¼Œæœ€å¤§ç¨‹åº¦é™ä½ç³»ç»Ÿå¯¹ç¡¬ä»¶èµ„æºçš„å ç”¨ã€‚åŒæ—¶ä¹Ÿæä¾›äº†å‹å–„çš„apiï¼Œé€šè¿‡å¯¹çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°çš„è®¾è®¡ï¼Œå¯ä»¥è®¾è®¡å‡ºä¸åŒç±»å‹çš„çº¿ç¨‹æ± ï¼Œæ‰©å±•çº¿ç¨‹æ± çš„å¯åº”ç”¨åœºæ™¯ã€‚</p><p>åŸºç¡€æ¦‚å¿µ
åŒ…å«çº¿ç¨‹æ§åˆ¶çŠ¶æ€ã€ä½œä¸šé˜Ÿåˆ—ã€å·¥äººï¼ˆworkerï¼‰ã€å·¥äººé›†åˆï¼ˆworker setï¼‰ã€å·¥äººæ•°é‡ï¼ˆworker countï¼‰ã€ç»ˆæ­¢æ¡ä»¶ã€çº¿ç¨‹å·¥å‚ã€ä»»åŠ¡æ‹’ç»å¤„ç†å™¨ã€æ ¸å¿ƒæ± å¤§å°ã€æœ€å¤§æ± å¤§å°ç­‰ç­‰</p><p>æ§åˆ¶çŠ¶æ€ã€å·¥äººæ•°é‡</p><p>æ§åˆ¶çŠ¶æ€ï¼š</p><p>æ ‡è®°äº†æ‰§è¡Œå™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œè®°å½•çº¿ç¨‹æ± çš„å½“å‰çŠ¶æ€ï¼Œåˆ†ä¸ºRUNNINGã€SHUTDOWNã€STOPã€TIDYINGã€TERMINATEDï¼Œä¸»è¦æ˜¯ä¸ºäº†å®ç°shutdown()ç­‰æ¶‰åŠåˆ°æ‰§è¡Œå™¨çŠ¶æ€çš„æ–¹æ³•ï¼Œå¦‚æœä¸å­˜åœ¨æ§åˆ¶çŠ¶æ€ï¼Œåˆ™æ— æ³•å®ç°ç±»ä¼¼ï¼šæ‹’ç»æ–°ä»»åŠ¡çš„æ·»åŠ ã€ç»ˆç»“æ‰§è¡Œå™¨ç­‰åŠŸèƒ½ã€‚</p><p>é˜¶æ®µ è¯´æ˜ çŠ¶æ€è½¬æ¢
RUNING ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ­¤æ—¶å¯ä»¥æ¥æ”¶æ–°çš„ä»»åŠ¡ SHUTDOWNï¼šè°ƒç”¨shutdown()
STOPï¼šè°ƒç”¨shutdownNow()
SHUTDOWN ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œä½†ä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ STOPï¼šè°ƒç”¨shutdownNow()
TIDYINGï¼šä»»åŠ¡å®Œæˆã€çº¿ç¨‹æ± æ¸…ç©º
STOP æ‰§è¡Œä¸­çš„ä»»åŠ¡å°†è¢«ç»ˆæ­¢ï¼Œä¸”ä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä¸å†ç»§ç»­å¤„ç†ä»»åŠ¡ TIDYINGï¼šçº¿ç¨‹æ± æ¸…ç©º
TIDYING æ•´ç†é˜¶æ®µï¼Œä¸»è¦æ˜¯å›æ”¶èµ„æºä¸æ”¶å°¾å·¥ä½œã€‚æ‰€æœ‰çš„ä»»åŠ¡å·²ç»ç»“æŸï¼Œå·¥äººæ•°é‡ä¸º0ï¼ˆçº¿ç¨‹å·²ç»å®Œæˆå›æ”¶ï¼‰ï¼Œåœ¨è¯¥é˜¶æ®µå¯¹åº”çº¿ç¨‹å°†è°ƒç”¨é’©å­å‡½æ•°terminated()å‘ŠçŸ¥å­ç±»å³å°†è¦ç»ˆç»“ TERMINATEDï¼šterminated()æ‰§è¡Œå
TERMINATED terminated()å®Œæˆ
ThreadPoolExecutorå®ç°ä¸­å°†çº¿ç¨‹æ± çŠ¶æ€ä¸å·¥äººæ•°é‡æ•´åˆåˆ°ä¸€ä¸ªIntegerå†…ï¼Œä¸ºäº†ä¿è¯å¹¶å‘å®‰å…¨ï¼ŒIntegerä½¿ç”¨AtomicIntegerã€‚æ§åˆ¶çŠ¶æ€ä¸€å…±5ç§ï¼Œåœ¨è®¾è®¡ä¸­é€šè¿‡ä¿è¯å„ä¸ªçŠ¶æ€åœ¨çŠ¶æ€ç©ºé—´ä¸­çš„æœ‰åºï¼Œç›´æ¥ä½¿ç”¨æ•°å€¼çš„æ–¹å¼åˆ¤æ–­å½“å‰çŠ¶æ€ã€‚</p><p>å·¥äººæ•°é‡ï¼ˆworkerCountï¼‰ï¼š</p><p>è®°å½•å½“å‰çº¿ç¨‹æ± ä¸­çš„æœ‰æ•ˆçº¿ç¨‹æ•°é‡ï¼Œä¸»è¦ç”¨äºçŠ¶æ€å˜æ›´ã€åˆ¤æ–­æ˜¯å¦éœ€è¦æ–°å¢çº¿ç¨‹ã€çº¿ç¨‹æ•°é‡æ˜¯å¦å·²è¾¾è®¾å®šå€¼ç­‰ã€‚</p><p>çŠ¶æ€å­—æ®µï¼š</p><p>private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
private static final int COUNT_BITS = Integer.SIZE - 3;//29
private static final int CAPACITY = (1 &#171; COUNT_BITS) - 1;//0001111111111&mldr;</p><p>// runState is stored in the high-order bits
private static final int RUNNING = -1 &#171; COUNT_BITS;//RUNINGçŠ¶æ€ä¸‹ï¼Œctl&lt;0
private static final int SHUTDOWN = 0 &#171; COUNT_BITS;//SHUTDOWNçŠ¶æ€ä¸‹ï¼Œå½“workercount=0æ—¶ï¼Œctl=0
private static final int STOP = 1 &#171; COUNT_BITS;
private static final int TIDYING = 2 &#171; COUNT_BITS;
private static final int TERMINATED = 3 &#171; COUNT_BITS;</p><p>// Packing and unpacking ctl
private static int runStateOf(int c) { return c & ~CAPACITY; }//å–é«˜ä¸‰ä½çš„ç»“æœ
private static int workerCountOf(int c) { return c & CAPACITY; }//ä½ä½å³wokerCount
private static int ctlOf(int rs, int wc) { return rs | wc; }
ä½œä¸šé˜Ÿåˆ—(workQueue)-BlockingQueue</p><p>ç”¨äºä¿å­˜å¾…å¤„ç†ä»»åŠ¡å¹¶å°†ä»»åŠ¡ç§»äº¤ç»™å·¥ä½œçº¿ç¨‹ã€‚å£°æ˜ç±»å‹ä¸ºé˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰</p><p>ä¸è¦æ±‚poll()è¿”å›nullæ—¶ä»£è¡¨é˜Ÿåˆ—ä¸ºç©ºï¼ˆisEmptyï¼‰ï¼Œåœ¨å†³å®šæ˜¯å¦è¿›è¡Œçº¿ç¨‹æ± çŠ¶æ€è½¬ç§»æ—¶ï¼ˆæ¯”å¦‚ç”±SHUTDOWNè½¬ç§»ä¸ºTIDYINGéœ€è¦åˆ¤æ–­ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼‰ä½¿ç”¨isEmptyåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚è¿™ç§è®¾è®¡å°±å¯ä»¥è®©workQueueä½¿ç”¨ä¸€äº›ç‰¹æ®Šè®¾è®¡çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆDelayQueueï¼Œå³ä¾¿poll()ä¸ºnullï¼Œä½†å»¶è¿Ÿä¸€æ®µæ—¶é—´åå¯ä»¥è¿”å›non-nullï¼Œå³æ— æ³•é€šè¿‡poll()æ˜¯å¦ä¸ºnullåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼‰ï¼ŒThreadPoolExecutoré€šè¿‡isEmptyè€Œépoll() == null çš„æ–¹å¼åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œèƒ½å¤Ÿå¯¹å·¥ä½œé˜Ÿåˆ—çš„å®ç°ç±»å‹æ›´åŠ åŒ…å®¹ã€‚</p><p>ThreadPoolExecutorå¹¶æ²¡æœ‰ä¸ºBlokingQueueæä¾›é»˜è®¤å®ç°ï¼ˆå£°æ˜æ—¶æ²¡æœ‰æŒ‡å®šå®ä¾‹ï¼Œä¸”æ‰€æœ‰çš„æ„é€ æ–¹æ³•æ²¡æœ‰ä¸ºå…¶æä¾›é»˜è®¤å®ç°ï¼‰ï¼Œä½†ä½¿ç”¨Executorsåˆ›å»ºThreadPoolExecutorsæ—¶é»˜è®¤ä¼šä½¿ç”¨LinkedBlockedQueueä½œä¸ºé»˜è®¤å®ç°ã€‚</p><p>å…³äºé˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰</p><p>åˆé€‚çš„é˜»å¡é˜Ÿåˆ—ï¼Œå½“é˜Ÿåˆ—ç©ºæ—¶ä¼šé˜»å¡æ¶ˆè´¹è€…ï¼Œé˜Ÿåˆ—æ»¡æ—¶é˜»å¡ç”Ÿäº§è€…ã€‚</p><p>å¦‚æœä¸é€‚ç”¨é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥ä½¿ç”¨çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—+æ ‡å¿—é”å®ç°~ï¼ˆä½†è‡ªå·±å®ç°çš„æ–¹å¼å¯èƒ½ä¼šå­˜åœ¨å¾ˆå¤šç»†èŠ‚é—®é¢˜ï¼Œæœ‰ç©ºå¯ä»¥æŠŠè¿™ä¸ªç»†èŠ‚æ·±å…¥ç ”ç©¶ä¸€ä¸‹ï¼‰</p><p>å·¥äººï¼ˆworkerï¼‰</p><p>ä¿å­˜äº†æ‰€æœ‰åœ¨çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹çš„é›†åˆ</p><p>private final HashSet<worker> workers = new HashSet<worker>();
è¯¥å£°æ˜å¹¶æœªä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„Setç±»ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æœ€ä¸ºç®€å•çš„HashSetï¼Œå› æ­¤å…¶å†…éƒ¨è¦æ±‚ï¼Œä»»ä½•å¯¹è¯¥é›†åˆçš„è®¿é—®éƒ½éœ€è¦è·å–private final ReentrantLock mainLock = new ReentrantLock();çš„é”æƒé™ã€‚</p><p>Workerç±»å±äºThreadPoolExecutorçš„ç§æœ‰å†…éƒ¨ç±»ï¼Œå› æ­¤åªæœ‰ThreadPoolExecutorèƒ½å¤Ÿåˆ›å»ºè¯¥ç±»çš„å®ä¾‹ï¼Œä½œä¸ºå†…éƒ¨ç±»ï¼Œè¯¥ç±»çš„å®ä¾‹èƒ½å¤Ÿç›´æ¥è®¿é—®ThreadPoolExecutorçš„å±æ€§ä¸æ–¹æ³•ã€‚</p><p>Wokeræºç ï¼š</p><p>private final class Worker extends AbstractQueuedSynchronizer implements Runnable {
//é€šè¿‡ThreadPoolExecutorå†…çš„ThreadFactoryç”Ÿæˆçš„æ‰§è¡Œçº¿ç¨‹
//wokeræŒæœ‰è¯¥threadï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¿è¯å¯ä»¥è·å–åˆ°æ˜¯å“ªä¸ªçº¿ç¨‹æ˜¯è¯¥wokerçš„è¿è¡Œçº¿ç¨‹
final Thread thread;
//è¯¥wokerçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¯èƒ½ä¸ºnull
Runnable firstTask;
//è¯¥wokerå®Œæˆçš„ä»»åŠ¡æ€»é‡
volatile long completedTasks;</p><pre><code>//AQSä¸­stateæ ‡å¿—ä½ï¼Œ0ï¼šæ— é”çŠ¶æ€ï¼Œ1ï¼šè¢«æŒæœ‰é”çŠ¶æ€ï¼Œ&gt;=0ï¼šå¯è¢«ä¸­æ–­çŠ¶æ€
Worker(Runnable firstTask) {
    setState(-1); // ç¦æ­¢ä¸­æ–­è¯¥worker
    this.firstTask = firstTask;
    this.thread = getThreadFactory().newThread(this);//workerä¹Ÿæ˜¯runnableï¼Œå°†workerä½œä¸ºå…¶æ‰§è¡Œçº¿ç¨‹çš„targetï¼Œå½“å…¶æ‰§è¡Œçº¿ç¨‹start()æ—¶ï¼ŒJVMä¼šè°ƒç”¨worker.run()
}
 
//è¯¥æ–¹æ³•è¡¨æ˜wokeræ˜¯ä¸ªRunnableï¼Œå½“å…¶æ‰§è¡Œçº¿ç¨‹startæ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•
public void run() {
    runWorker(this);//å°†è‡ªå·±ä½œä¸ºå‚æ•°ï¼Œè¿è¡Œè‡ªå·±
}
 
protected boolean isHeldExclusively() {
    return getState() != 0;
}
 
protected boolean tryAcquire(int unused) {
    if (compareAndSetState(0, 1)) {
        setExclusiveOwnerThread(Thread.currentThread());
        return true;
    }
    return false;
}
 
protected boolean tryRelease(int unused) {
    setExclusiveOwnerThread(null);
    setState(0);
    return true;
}
 
public void lock() {
    acquire(1);
}
 
public boolean tryLock() {
    return tryAcquire(1);
}
 
public void unlock() {
    release(1);
}
 
public boolean isLocked() {
    return isHeldExclusively();
}
 
//ä»…å½“wokerçº¿ç¨‹è¿è¡Œæ—¶ï¼Œå…è®¸ä¸­æ–­
void interruptIfStarted() {
    Thread t;
    //getState() &gt;= 0 é€šè¿‡åˆ¤æ–­stateæ˜¯å¦å¤§äº0ï¼Œåˆå§‹æƒ…å†µä¸‹state=-1
    //å½“state &lt; 0ï¼Œå³state = -1æ—¶ï¼Œå…¶æ‰§è¡Œçº¿ç¨‹å°šæœªstartï¼Œå› æ­¤æ— éœ€ä¸­æ–­å…¶æ‰§è¡Œçº¿ç¨‹
    //å¹¶ä¸è¦æ±‚è·å–äº†wokerçš„é”
    if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) {
        try {
            t.interrupt();//ä¸­æ–­æ‰§è¡Œçº¿ç¨‹
        } catch (SecurityException ignore) {
        }
    }
}
</code></pre><p>}
ThreadPoolExecutor.runWoker()</p><p>final void runWorker(ThreadPoolExecutor.Worker w) {
//runWokerï¼ˆï¼‰æ–¹æ³•åªä¼šè¢«Woker.run()è°ƒç”¨ï¼Œè€ŒWoker.run()åªä¼šåœ¨å…¶æ‰§è¡Œçº¿ç¨‹startåç”±jvmè°ƒç”¨ï¼Œå› æ­¤runWokerï¼ˆï¼‰å¿…å®šåªä¼šè¢«å¯¹åº”Workerçš„æ‰§è¡Œçº¿ç¨‹è°ƒç”¨
Thread wt = Thread.currentThread();//æ‰€ä»¥è¿™é‡Œå½“å‰çº¿ç¨‹å°±æ˜¯w.threadï¼Œä¹Ÿå°±æ˜¯wokerçš„æ‰§è¡Œçº¿ç¨‹
Runnable task = w.firstTask;
w.firstTask = null;
w.unlock();//æ­¤æ—¶wokerçš„æ‰§è¡Œçº¿ç¨‹å·²ç»å¯åŠ¨ï¼Œå…è®¸å¤–éƒ¨è¿›è¡Œä¸­æ–­ï¼Œå› æ­¤å°†wokerçš„stateç½®ä¸º0
boolean completedAbruptly = true;
try {
//getTask()é‡ç‚¹ï¼Œå†…éƒ¨å…¶å®æ˜¯ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡ï¼ŒåŒ…å«äº†çº¿ç¨‹é˜»å¡ã€æŒ‚èµ·ã€æ·˜æ±°ç­‰ä¸€ç³»åˆ—é€»è¾‘
//æ­£å¸¸æƒ…å†µä¸‹å°±æ˜¯è¯¥çº¿ç¨‹ä¸æ–­ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œå–ä»»åŠ¡
while (task != null || (task = getTask()) != null) {
//è¿™é‡Œçš„è¿™ä¸ªlockå¾ˆæœ‰æ„æ€
//å¦‚æœä»…ä»…æ˜¯æ‰§è¡Œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„è¯ï¼Œå…¶å®æ‰§è¡Œçº¿ç¨‹è·å–wokeré”å¹¶æ— å¤ªå¤§æ„ä¹‰ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºè¯¥æ–¹æ³•(runWoker(&mldr;))åªä¼šè¿è¡Œåœ¨æ‰§è¡Œçº¿ç¨‹ä¸­ï¼Œä¸å¯èƒ½æœ‰å¹¶å‘æƒ…å†µï¼Œå¦ä¸€æ–¹é¢wokeræœ¬èº«æ²¡æœ‰å¯ä»¥å…±äº«çš„èµ„æºï¼ˆè¿™ä¸ªåœ°æ–¹å¯ä»¥å†è€ƒè™‘ä¸€ä¸‹ï¼šè·å–çš„ä»»åŠ¡ã€æœ¬èº«æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦ç®—å¯å…±äº«èµ„æºå‘¢ï¼‰ï¼Œæ²¡å¿…è¦è·å–è¿™ä¸ªé”ï¼Œä½†è¿™ä¸ªåœ°æ–¹æœ‰ä¸ªéšè—é€»è¾‘ï¼Œå°±æ˜¯ä¸€æ—¦wokeråœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™wokerå¿…å®šæ˜¯è¢«å…¶æ‰§è¡Œçº¿ç¨‹é”ä½çš„ï¼Œå› æ­¤é€šè¿‡wokeré”çš„çŠ¶æ€å¯ä»¥åˆ¤æ–­wokeræ˜¯å¦åœ¨æ‰§è¡Œä»»åŠ¡ã€‚å½“å¤–éƒ¨çº¿ç¨‹æƒ³è¦è®©workeræ­£å¸¸æ‰§è¡Œå®Œä»»åŠ¡ï¼Œç„¶åå†åœæ­¢wokeræ—¶ï¼Œå°±å¿…é¡»è·å–è¯¥wokerçš„é”ï¼Œå¦‚æ­¤å°±èƒ½å¤Ÿä¿è¯wokerå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡è¢«æ­£å¸¸å®Œæˆ
w.lock();
//ç®€çŸ­çš„ä»£ç ï¼Œé€»è¾‘å¤æ‚ï¼Œå…·ä½“åˆ†æå‚è§â€œWorkeræ£€æµ‹ThreadPoolExecutoræ˜¯å¦StopingåŠçº¿ç¨‹çŠ¶æ€æœºåˆ¶â€
if ((runStateAtLeast(ctl.get(), STOP) ||
(Thread.interrupted() &&
runStateAtLeast(ctl.get(), STOP))) &&
!wt.isInterrupted())
wt.interrupt();
try {
beforeExecute(wt, task);//å•ä¸ªä»»åŠ¡æ‰§è¡Œä¹‹å‰çš„é’©å­å‡½æ•°
Throwable thrown = null;
try {
task.run();//çœŸæ­£çš„æ‰§è¡Œä»»åŠ¡
} catch (RuntimeException x) {
thrown = x;
throw x;
} catch (Error x) {
thrown = x;
throw x;
} catch (Throwable x) {
thrown = x;
throw new Error(x);
} finally {
afterExecute(task, thrown);//ä»»åŠ¡æ‰§è¡Œä¹‹åçš„é’©å­å‡½æ•°
}
} finally {
task = null;
w.completedTasks++;//å®Œæˆä»»åŠ¡è®¡æ•°
w.unlock();//é‡Šæ”¾é”ï¼Œè¡¨æ˜å½“å‰workerå·²ç»å®ŒæˆæŸä¸ªä»»åŠ¡çš„æ‰§è¡Œ
}
}
completedAbruptly = false;//è¡¨æ˜çº¿ç¨‹æ­£å¸¸æ‰§è¡Œå®Œä»»åŠ¡ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™è¯´æ˜æ‰§è¡Œå½¢æˆå¯èƒ½ä¸­é€”è¢«ä¸­æ–­ï¼Œæˆ–æ˜¯ç”¨æˆ·ä»»åŠ¡å‘ç”Ÿäº†å¼‚å¸¸
} finally {
/* *å¤„ç†å°†è¦ç»“æŸçš„workerçš„æ”¶å°¾å·¥ä½œã€‚
* 1ã€å°†å½“å‰workerä»workerSetä¸­ç§»é™¤
* 2ã€å°è¯•å°†çº¿ç¨‹æ± è¿‡åº¦ä¸ºTerminatedçŠ¶æ€
* 3ã€åœ¨çº¿ç¨‹æ± ä»ç„¶éœ€è¦æ‰§è¡Œä»»åŠ¡çš„çŠ¶æ€ä¸‹ï¼ˆRUNINGã€SHUTDOWNï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ æ–°çš„workerè‡³çº¿ç¨‹æ± ï¼Œæ·»åŠ æ¡ä»¶ä¸ºï¼š1ï¼‰å½“å‰workerä¸ºçªç„¶ç»ˆæ­¢ï¼›2ï¼‰å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡å°äºæœ€å°éœ€æ±‚çº¿ç¨‹æ•°é‡
* 4ã€èµ°åˆ°è¿™è¡Œä»£ç ä¸€èˆ¬æœ‰ä¸¤ç§åœºæ™¯ï¼š1ï¼‰æ— ä»»åŠ¡å¯åšï¼Œä¸”ä¸ä¼šæœ‰æ–°ä»»åŠ¡æ¥äº†ï¼›2ï¼‰ç”¨æˆ·ä»»åŠ¡æ‰§è¡ŒæœŸé—´å‘ç”Ÿäº†å¼‚å¸¸
*/
processWorkerExit(w, completedAbruptly);
}
}
Workeræ£€æµ‹ThreadPoolExecutoræ˜¯å¦StopingåŠçº¿ç¨‹çŠ¶æ€æœºåˆ¶</p><p>1ã€å¦‚æœThreadPoolå¤„äºStopã€Tidyingæˆ–Terminatedï¼Œä¸”å½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œåˆ™ä¸­æ–­å½“å‰çº¿ç¨‹ï¼›2ã€å¦‚æœå¤„ç†Runingã€ShutdownçŠ¶æ€ï¼Œåˆ™æ¸…é™¤å½“å‰ä¸­æ–­æ ‡å¿—ä½ï¼Œè¿”å›ä¹‹å‰çš„ä¸­æ–­æ ‡å¿—ï¼Œå¦‚æœä¹‹å‰æ˜¯ä¸­æ–­çš„ï¼Œä¸”ThreadPoolçŠ¶æ€å˜ä¸ºäº†Stopã€Tidyingæˆ–Terminatedï¼Œåˆ™å†æ¬¡ä¸­æ–­æ‰§è¡Œçº¿ç¨‹ï¼›3ã€è¿™æ®µé€»è¾‘ä¿è¯äº†ï¼šå¦‚æœå½“å‰ThreadPoolExecutorå¤„äºRUNINGã€SHUTDOWNï¼Œåˆ™ä¸­æ–­æ ‡å¿—ä½è¢«æ¸…é™¤ï¼›å¦åˆ™ï¼Œç›´æ¥ä¸­æ–­æ‰§è¡Œçº¿ç¨‹ã€‚4ã€è¿›ä¸€æ­¥æ€è€ƒï¼šå¦‚æœä¸è¿™æ ·å®ç°ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><p>ä¸‹å›¾ä¸ºå®é™…çš„åˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœæ²¡æœ‰çº¢æ¡†éƒ¨åˆ†é€»è¾‘ï¼Œåˆ™ä¹‹å‰çš„æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½å¯èƒ½ä¼šå¯¼è‡´åœ¨ç®­å¤´å¤„æ’å…¥çš„ShutdownNowäº‹ä»¶è¢«å¿½ç•¥ã€‚</p><p>å¤„ç†wokerç»“æŸçš„å·¥ä½œ</p><p>private void processWorkerExit(Worker w, boolean completedAbruptly) {
if (completedAbruptly) // If abrupt, then workerCount wasn&rsquo;t adjusted
//æ­£å¸¸ç»“æŸä¸éœ€è¦å†å»å‡å°‘workerCountï¼ŒåŸå› æ˜¯åœ¨getTask()çš„åœ°æ–¹å·²ç»é¢„å…ˆå‡è¿‡äº†
decrementWorkerCount();</p><pre><code>final ReentrantLock mainLock = this.mainLock;
mainLock.lock();
try {
    completedTaskCount += w.completedTasks;
    workers.remove(w);
} finally {
    mainLock.unlock();
}
 
tryTerminate();
 
int c = ctl.get();
if (runStateLessThan(c, STOP)) {
    if (!completedAbruptly) {
        int min = allowCoreThreadTimeOut ? 0 : corePoolSize;
        if (min == 0 &amp;&amp; ! workQueue.isEmpty())
            min = 1;
        if (workerCountOf(c) &gt;= min)
            return; // replacement not needed
    }
    addWorker(null, false);
}
</code></pre><p>}
çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹åˆ›å»ºä¸é”€æ¯</p><p>å¤±æ•ˆåœºæ™¯ï¼š1ã€ç©ºé—²workerï¼ˆå½“å‰workeræ•°é‡è¶…è¿‡corePoolSizeï¼Œä¸”çº¿ç¨‹keepAliveTimeæ—¶é—´å†…æœªè·å–åˆ°ä»»åŠ¡ï¼Œè¿™ä¹Ÿæ˜¯çº¿ç¨‹æ± æ§åˆ¶workerè¶…æ—¶å¤±æ•ˆçš„æœºåˆ¶ï¼‰ï¼›2ã€ç”¨æˆ·ç¨‹åºå¼‚å¸¸ï¼›3ã€ä»»åŠ¡å®Œå…¨å¤„ç†å®Œæˆ</p><p>çº¿ç¨‹æ± åœ¨å¤„ç†å¤±æ•ˆçº¿ç¨‹æ—¶ï¼Œå¦‚æœä»ç„¶éœ€è¦å¢åŠ çº¿ç¨‹ï¼Œé‚£ä¹ˆä¼šå†æ¬¡é€šè¿‡ThreadFactoryåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚</p><p>å‡è®¾å¦‚ä¸‹åœºæ™¯ï¼šçº¿ç¨‹æ± æŒç»­æ¥æ”¶æ–°ä»»åŠ¡ï¼Œå¦‚æœæ–°çš„ä»»åŠ¡æ­£å¸¸æ‰§è¡Œï¼Œé‚£ä¹ˆæ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹è¿˜ä¼šç»§ç»­æœå½¹ï¼Œå¤„ç†åç»­çš„æ–°ä»»åŠ¡ï¼Œä½†æ˜¯å¦‚æœæ–°çš„ä»»åŠ¡æ— æ³•æ­£å¸¸æ‰§è¡Œï¼ŒæŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†ç”±äºè¯¥å¼‚å¸¸è€Œè€Œç»ˆç»“ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹ç»§ç»­å¤„ç†åç»­ä»»åŠ¡ã€‚æ‰€ä»¥å½“æ‰€æœ‰çš„æ–°ä»»åŠ¡éƒ½æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹æ± å•ä¸ªçº¿ç¨‹çš„å¯¿å‘½æçŸ­ï¼Œé¢‘ç¹åˆ›å»ºçº¿ç¨‹ï¼Œäº‹å®ä¸Šå¯¼è‡´çº¿ç¨‹æ± å¤±æ•ˆã€‚</p><p>å®é™…ä¸Šå‘¢ï¼Ÿ</p><p>é€šè¿‡submit()æäº¤ç»™çº¿ç¨‹æ± çš„RunnableTaskéƒ½è¢«åŒ…è£…ä¸ºFutureTaskäº†ï¼Œè€ŒFutureTaskåœ¨runï¼ˆï¼‰çš„æ—¶å€™ï¼Œå¯¹å¼‚å¸¸è¿›è¡ŒåŒ…è£…ï¼Œå°†outComeè¾“å‡ºä¸ºExceptionï¼Œä¹Ÿå°±æ˜¯è¯´æ­£å¸¸çš„ç”¨æˆ·å¼‚å¸¸æ ¹æœ¬ä¸ä¼šæŠ›å‡ºåˆ°Workerçš„runWoker loopé‡Œâ€¦</p><p>ä½†æ˜¯å¦‚æœç›´æ¥è°ƒç”¨ThreadPoolExecutor.execute()æ–¹æ³•ï¼Œåˆ™ä¸ä¼šä½¿ç”¨FutureTaskåŒ…è£…è¯¥Runnableäº†ï¼ŒåŒ…è£…çš„è¿‡ç¨‹éƒ½æ˜¯åœ¨AbstractExecutorServiceé‡Œå®Œæˆçš„ï¼Œç›´æ¥é€šè¿‡executeæ‰§è¡Œä»»åŠ¡çš„è¯ï¼Œåˆ™ä¼šäº§ç”Ÿä¹‹å‰æ‰€è¿°çš„åœºæ™¯ï¼Œçº¿ç¨‹å°†é¢‘ç¹åˆ›å»º</p><p>ThreadPoolExecutor executorService = (ThreadPoolExecutor) Executors.newFixedThreadPool(5, new NamedThreadFactory());
while (true) {
try {
Thread.sleep(100);
} catch (InterruptedException e) {
e.printStackTrace();
}
executorService.execute(() -> {//ä½¿ç”¨Executor.executeï¼ˆï¼‰æ‰§è¡Œï¼Œåˆ™ä¼šå‡ºç°é¢‘ç¹åˆ›å»ºçº¿ç¨‹æ± çš„æƒ…å†µï¼Œä½¿ç”¨submitï¼ˆï¼‰åˆ™ä¸ä¼šï¼Œä½†å…¶å®executeä¸submitéƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œ
throw new RuntimeException();
});
}
6ã€æ€»ç»“
çº¿ç¨‹æ± çš„æ ¸å¿ƒå…¶å®æ˜¯ä¸€ä¸ªåŸºäºBlockingQueueçš„ä»»åŠ¡ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ï¼Œä»»åŠ¡çš„ç”Ÿäº§æ–¹ä¸ºThreadPoolçš„ä½¿ç”¨æ–¹ï¼Œé€šè¿‡submitä¸executeç”Ÿäº§Runnableä»»åŠ¡ï¼Œä»»åŠ¡çš„æ¶ˆè´¹æ–¹åˆ™ä¸ºThreadPoolå†…éƒ¨çš„Workerã€‚TheadPoolåšäº†å¾ˆå¤šå…³äºçº¿ç¨‹æ± ç‰¹æ€§çš„æ§åˆ¶ï¼šæ¯”å¦‚æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ã€æœ€å¤§çº¿ç¨‹æ± å¤§å°ã€ç©ºé—²çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´ç­‰ç­‰ï¼Œä¸»è¦å°±æ˜¯é€šè¿‡Workerä»BlockingQueueä¸­è·å–ä»»åŠ¡çš„çŠ¶æ€æ¥æ§åˆ¶Workerçš„é”€æ¯ã€‚</p><p>æºç ååˆ†ç²¾å·§ï¼Œéƒ¨åˆ†ä»£ç å†™çš„ç›¸å½“ç®€ç»ƒï¼Œä½†åŒ…å«äº†å¾ˆæ·±çš„å…³äºçŠ¶æ€å®šä¹‰ã€ä»»åŠ¡ç”Ÿäº§ã€ä»»åŠ¡æ¶ˆè´¹ã€è¶…æ—¶æ§åˆ¶ã€åŒæ­¥æ§åˆ¶ã€ç©ºé—²çº¿ç¨‹é”€æ¯ã€æ–°å¢çº¿ç¨‹ç­‰ä¸€ç³»åˆ—ç‰¹æ€§çš„å®ç°é€»è¾‘ï¼Œæ¯ä¸€æ­¥çš„åŠ¨ä½œéƒ½å€¼å¾—è¿›ä¸€æ­¥æ€è€ƒã€‚</p><p>å¦‚æœè®©è‡ªå·±å»å®ç°ä¸€éè¿™æ ·çš„çº¿ç¨‹æ± ï¼Œè¯¥å¦‚ä½•å»å®ç°å‘¢ï¼Ÿ</p><p>æœ€åé™„ä¸Šå‘ThreadPoolExecutor submitä»»åŠ¡çš„æ‰§è¡Œæµç¨‹å›¾~</p><div class=post-meta></hr>æ³¨ï¼šæœ¬ä½œå“é‡‡ç”¨<a rel=license target=view_window href=http://creativecommons.org/licenses/by-nc-sa/4.0/> çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®® </a>è¿›è¡Œè®¸å¯ã€‚</div></div><footer class=post-footer><ul class=post-tags><li><a href=https://swimminghao1.github.io/tags/%E7%BC%96%E7%A8%8B/>ğŸ· ç¼–ç¨‹</a></li><li><a href=https://swimminghao1.github.io/tags/%E6%84%9F%E6%82%9F/>ğŸ· æ„Ÿæ‚Ÿ</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share çº¿ç¨‹æ±  on twitter" href="https://twitter.com/intent/tweet/?text=%e7%ba%bf%e7%a8%8b%e6%b1%a0&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f08%25E5%25AD%2598%25E6%25A1%25A3%25E6%2596%2587%25E4%25BB%25B6%2f%25E6%2596%2587%25E6%25A1%25A3%2f%25E7%25BA%25BF%25E7%25A8%258B%25E6%25B1%25A0%2f&hashtags=%e7%bc%96%e7%a8%8b%2c%e6%84%9f%e6%82%9f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share çº¿ç¨‹æ±  on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f08%25E5%25AD%2598%25E6%25A1%25A3%25E6%2596%2587%25E4%25BB%25B6%2f%25E6%2596%2587%25E6%25A1%25A3%2f%25E7%25BA%25BF%25E7%25A8%258B%25E6%25B1%25A0%2f&title=%e7%ba%bf%e7%a8%8b%e6%b1%a0&summary=%e7%ba%bf%e7%a8%8b%e6%b1%a0&source=https%3a%2f%2fswimminghao1.github.io%2fpost%2f08%25E5%25AD%2598%25E6%25A1%25A3%25E6%2596%2587%25E4%25BB%25B6%2f%25E6%2596%2587%25E6%25A1%25A3%2f%25E7%25BA%25BF%25E7%25A8%258B%25E6%25B1%25A0%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share çº¿ç¨‹æ±  on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f08%25E5%25AD%2598%25E6%25A1%25A3%25E6%2596%2587%25E4%25BB%25B6%2f%25E6%2596%2587%25E6%25A1%25A3%2f%25E7%25BA%25BF%25E7%25A8%258B%25E6%25B1%25A0%2f&title=%e7%ba%bf%e7%a8%8b%e6%b1%a0"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share çº¿ç¨‹æ±  on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fswimminghao1.github.io%2fpost%2f08%25E5%25AD%2598%25E6%25A1%25A3%25E6%2596%2587%25E4%25BB%25B6%2f%25E6%2596%2587%25E6%25A1%25A3%2f%25E7%25BA%25BF%25E7%25A8%258B%25E6%25B1%25A0%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share çº¿ç¨‹æ±  on whatsapp" href="https://api.whatsapp.com/send?text=%e7%ba%bf%e7%a8%8b%e6%b1%a0%20-%20https%3a%2f%2fswimminghao1.github.io%2fpost%2f08%25E5%25AD%2598%25E6%25A1%25A3%25E6%2596%2587%25E4%25BB%25B6%2f%25E6%2596%2587%25E6%25A1%25A3%2f%25E7%25BA%25BF%25E7%25A8%258B%25E6%25B1%25A0%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share çº¿ç¨‹æ±  on telegram" href="https://telegram.me/share/url?text=%e7%ba%bf%e7%a8%8b%e6%b1%a0&url=https%3a%2f%2fswimminghao1.github.io%2fpost%2f08%25E5%25AD%2598%25E6%25A1%25A3%25E6%2596%2587%25E4%25BB%25B6%2f%25E6%2596%2587%25E6%25A1%25A3%2f%25E7%25BA%25BF%25E7%25A8%258B%25E6%25B1%25A0%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><nav class=paginav><a class=prev href=https://swimminghao1.github.io/post/08%E5%AD%98%E6%A1%A3%E6%96%87%E4%BB%B6/%E7%89%9B%E5%AE%A2%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F/%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F%E6%80%BB%E7%BB%932/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>é—®ç­”ç³»ç»Ÿæ€»ç»“2</span></a>
<a class=next href=https://swimminghao1.github.io/post/02%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0/06_02_java%E9%9D%A2%E8%AF%95/%E7%BA%BF%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>çº¿ç¨‹ä¸è¿›ç¨‹</span></a></nav></footer><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>è¯„è®º</span><br></div><div id=tcomment></div><script src=https://utteranc.es/client.js repo=swimminghao1/swimminghao1.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></article></main><footer class=footer><span>Copyright &copy; 2023 â€¢ <a href=https://swimminghao1.github.io/>swimminghao</a></span><div><span><a href=/about/>å…³äº</a>
â€¢ <a href=/disclaimer/>å…è´£å£°æ˜</a>
â€¢ <a href=/sitemap.xml target=view_window>ç«™ç‚¹åœ°å›¾</a>
â€¢ <a href=https://www.foreverblog.cn/go.html target=view_window>è™«æ´</a>
â€¢ PV <span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin"></i></span></span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><meta name=â€apple-mobile-web-app-capableâ€ content="â€yesâ€"><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js")})</script></body></html>